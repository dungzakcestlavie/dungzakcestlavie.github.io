<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Lightflow Admin Î©.3 â€” DUNGZAK CESTLAVIE</title>
<style>
:root{ --bg:#070c1a; --panel:#0b1020; --soft:#11182b; --fg:#e9eef7;
  --muted:#a9b2c7; --accent:#cdb37a; --warn:#ffd95f; --bad:#ff6b6b; --good:#7bed9f; }
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Pretendard,sans-serif}
.header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0a0f1f,transparent);padding:.9rem 1rem}
h1{margin:0;font-size:1.1rem;color:var(--accent);font-weight:800;letter-spacing:.2px}
.container{max-width:880px;margin:0 auto;padding:0 10px 84px}
.card{background:var(--panel);border:1px solid #1b2540;border-radius:14px;padding:14px;margin:10px 0}
.card h3{margin:4px 0 12px;font-size:1.0rem;color:#f2d9a2}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
input,select,textarea,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #233058;background:var(--soft);color:var(--fg);font-size:16px}
textarea{min-height:110px;resize:none}
button{background:var(--accent);color:#000;font-weight:800;border:none}
.btn-row{display:flex;gap:8px}
.btn{border:none;border-radius:12px;padding:12px 14px;font-weight:800}
.btn-ghost{background:#10182c;color:var(--fg);border:1px solid #22304f}
.btn-bad{background:var(--bad);color:#000}
.btn-good{background:var(--good);color:#033a1d}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#12203e;border:1px solid #223252;color:var(--muted);font-size:12px}
.tabs{display:flex;overflow:auto;gap:6px;padding-bottom:6px}
.tabs button{flex:0 0 auto;background:#0c1224;color:var(--fg);border:1px solid #22304f;border-radius:999px;padding:10px 12px;font-size:14px}
.tabs button.active{background:var(--accent);color:#000}
.kv{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center}
.kv label{font-size:14px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
hr{border:0;height:1px;background:#1a2442;margin:12px 0}
.row{display:flex;gap:8px}
.row > *{flex:1}
.preview{width:100%;max-height:260px;object-fit:contain;border-radius:10px;border:1px solid #22304f;background:#0b1223}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1223;border:1px solid #22304f;color:var(--fg);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:999;opacity:0;pointer-events:none;transition:opacity .25s ease}
.toast.show{opacity:1}
a.link{color:#bcd2ff;text-decoration:underline;text-underline-offset:3px}
@media(min-width:640px){
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>
<div class="header">
  <h1>âœ¨ Lightflow Admin Î©.3 <span class="badge">iPhone Ready Â· Auto-Sync</span></h1>
</div>

<div class="container">
  <!-- 0. ì—°ê²° -->
  <div class="card">
    <h3>0) GitHub ì—°ê²° Â· Connection</h3>
    <div class="grid grid-2">
      <input id="owner" placeholder="GitHub Owner (ì˜ˆ: dungzakcestlavie)">
      <input id="repo" placeholder="Repository (ì˜ˆ: dungzakcestlavie.github.io)">
      <input id="branch" placeholder="Branch (ì˜ˆ: main)" value="main">
      <input id="token" placeholder="Personal Access Token (repo ê¶Œí•œ)">
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn" onclick="saveConfig()">ì €ì¥(ë¡œì»¬)</button>
      <button class="btn btn-ghost" onclick="logout()">ë¡œê·¸ì•„ì›ƒ/í† í°ì‚­ì œ</button>
      <button class="btn btn-good" onclick="testConn()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </div>
    <div class="small" style="margin-top:6px">í† í°ì€ ì´ ë¸Œë¼ìš°ì €ì˜ <b>localStorage</b>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
  </div>

  <!-- 1. ì‘í’ˆ ì•„ì¹´ì´ë¸Œ -->
  <div class="card">
    <h3>1) ì‘í’ˆ ì•„ì¹´ì´ë¸Œ Â· Artworks (â… â€“â…¤)</h3>
    <div class="tabs" id="workTabs"></div>
    <div id="workForm"></div>
    <div class="btn-row" style="margin-top:6px">
      <button class="btn btn-ghost" onclick="loadArtworks()">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn" onclick="saveArtworksJson()">artworks.json ì €ì¥</button>
    </div>
    <div class="small">JSON: <code>/data/artworks.json</code> Â· ì´ë¯¸ì§€: <code>/img/{section}/</code></div>
  </div>

  <!-- 2. ë¯¸í•™ ë³´ê³ ì„œ -->
  <div class="card" id="reportsCard">
    <h3>2) ë¯¸í•™ ë³´ê³ ì„œ Â· Aesthetic Reports (DCAR 1â€“8)</h3>
    <div class="tabs" id="reportTabs"></div>
    <div id="reportForm"></div>
    <div class="btn-row" style="margin-top:6px">
      <button class="btn btn-ghost" onclick="loadReports()">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn" onclick="saveReportsJson()">reports.json ì €ì¥</button>
    </div>
    <div class="small">í…ìŠ¤íŠ¸: <code>/reports/DCAR-XX.md</code> Â· PDF: <code>/reports/DCAR-XX.pdf</code> Â· JSON: <code>/data/reports.json</code></div>
  </div>

  <!-- 3. ìœ í‹¸ -->
  <div class="card">
    <h3>3) ë¹ ë¥¸ ìœ í‹¸</h3>
    <div class="row">
      <button class="btn" onclick="purgeCache()">GitHub Pages ìºì‹œ ë¬´íš¨í™” (dummy commit)</button>
      <button class="btn btn-ghost" onclick="openNewTab('https://dungzak.art')">ì‚¬ì´íŠ¸ ì—´ê¸°</button>
    </div>
  </div>

  <footer class="small" style="text-align:center;padding:22px 0">
    Â© 2025 ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Â· Orchestrated with Lumera â€” Light Â· Memory Â· Being.
  </footer>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===============================
   ê³µí†µ: ì„¤ì • / GitHub API í—¬í¼
   =============================== */
const SECTIONS = [
  { id:'light',  label:'â…  Light & Memory' },
  { id:'human',  label:'â…¡ Human Being' },
  { id:'rebirth',label:'â…¢ Rebirth of Mind' },
  { id:'restore',label:'â…£ Restoration of Being' },
  { id:'meta',   label:'â…¤ Metaconsciousness of Light' },
];
const DCAR_IDS = Array.from({length:8},(_,i)=>`dcar${String(i+1).padStart(2,'0')}`);

const $  = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);
const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
function cfg(k){ return localStorage.getItem(k)||''; }
function setcfg(k,v){ localStorage.setItem(k,v); }
function saveConfig(){ ['owner','repo','branch','token'].forEach(id=>setcfg(id,$('#'+id).value.trim())); toast('âœ… ì—°ê²°ì •ë³´ ì €ì¥'); }
function logout(){ localStorage.removeItem('token'); toast('ğŸ”’ í† í° ì‚­ì œ ì™„ë£Œ'); }
function openNewTab(url){ window.open(url,'_blank'); }
function testConn(){ gh('GET', `repos/${cfg('owner')}/${cfg('repo')}`).then(()=>toast('âœ… ì—°ê²° ì„±ê³µ')).catch(()=>toast('âš ï¸ ì—°ê²° ì‹¤íŒ¨ â€” ì…ë ¥ê°’ í™•ì¸')); }

async function gh(method, path, body, isJson=true){
  const token = cfg('token'); if(!token) throw new Error('Missing token');
  const res = await fetch(`https://api.github.com/${path}`,{
    method,
    headers:{ 'Accept':'application/vnd.github+json','Authorization':`token ${token}` },
    body: body ? (isJson ? JSON.stringify(body) : body) : null
  });
  if(!res.ok){ const txt = await res.text(); throw new Error(`GitHub ${res.status}: ${txt}`); }
  return res.json();
}
async function getContent(path){
  const {owner,repo,branch} = {owner:cfg('owner'), repo:cfg('repo'), branch:cfg('branch')||'main'};
  try{
    const r = await gh('GET', `repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`);
    const content = r.content ? atob(r.content.replace(/\n/g,'')) : null;
    return { sha:r.sha, content, exists:true };
  }catch(e){ return { sha:null, content:null, exists:false }; }
}
async function putFile(path, base64Content, message){
  // ìµœì‹  sha ë™ê¸°í™” + 1íšŒ ì¬ì‹œë„
  const {owner,repo,branch} = {owner:cfg('owner'), repo:cfg('repo'), branch:cfg('branch')||'main'};
  const prev = await getContent(path);
  const body = {message: message || `Update ${path}`, content: base64Content, branch};
  if(prev.exists) body.sha = prev.sha;
  try{
    return await gh('PUT', `repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, body);
  }catch(e){
    // í˜¹ì‹œ ë¸Œëœì¹˜ ê°±ì‹  ì¶©ëŒ ë°œìƒ â†’ sha ì¬ì¡°íšŒ í›„ 1íšŒ ì¬ì‹œë„
    const again = await getContent(path);
    if(again.exists) body.sha = again.sha; else delete body.sha;
    return await gh('PUT', `repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, body);
  }
}
async function deleteFile(path, message){
  const {owner,repo,branch} = {owner:cfg('owner'), repo:cfg('repo'), branch:cfg('branch')||'main'};
  const prev = await getContent(path);
  if(!prev.exists){ return; }
  return gh('DELETE', `repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {message: message || `Delete ${path}`, sha: prev.sha, branch});
}
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* ===============================
   1) ì‘í’ˆ ì•„ì¹´ì´ë¸Œ (JSON + ì´ë¯¸ì§€)
   =============================== */
let artworks = { light:[], human:[], rebirth:[], restore:[], meta:[] };
const ARTWORKS_JSON = 'data/artworks.json';

function buildWorkUI(){
  const tabs = $("#workTabs"); tabs.innerHTML='';
  SECTIONS.forEach((s,i)=>{
    const b=document.createElement('button');
    b.textContent=s.label; if(i===0) b.classList.add('active');
    b.onclick=()=>{ $$("#workTabs button").forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderWorkForm(s.id); };
    tabs.appendChild(b);
  });
  renderWorkForm(SECTIONS[0].id);
}
function nextNumericId(id){
  // ëì˜ ìˆ«ìë¥¼ +1 (ì—†ìœ¼ë©´ -1 ë¶™ì´ê¸°)
  const m = id.match(/(.*?)(\d+)$/
  );
  if(!m) return id.replace(/-?$/,'-1');
  const n = String(parseInt(m[2],10)+1);
  return m[1]+n;
}
function renderWorkForm(sec){
  const el=$("#workForm");
  el.innerHTML = `
    <div class="grid grid-2">
      <div class="card">
        <div class="kv"><label>Section</label><input value="${sec}" disabled></div>
        <div class="kv"><label>Artwork ID</label><input id="w-id" placeholder="ì˜ˆ: ${sec}-01"></div>
        <div class="kv"><label>Title</label><input id="w-title" placeholder="ì‘í’ˆ ì œëª©"></div>
        <div class="kv"><label>Year</label><input id="w-year" placeholder="2025"></div>
        <div class="kv"><label>Medium</label><input id="w-medium" placeholder="Acrylic on Canvas"></div>
        <div class="kv"><label>Size</label><input id="w-size" placeholder="162.2Ã—130.3 cm"></div>
        <div class="kv"><label>Image</label><input id="w-file" type="file" accept="image/*"></div>
        <img id="w-preview" class="preview" style="display:none">
        <div class="btn-row">
          <button class="btn" onclick="uploadArtwork('${sec}')">ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ + JSON ì €ì¥</button>
          <button class="btn btn-ghost" onclick="updateArtwork('${sec}')">âœï¸ ë©”íƒ€ë§Œ ì €ì¥</button>
          <button class="btn btn-ghost" onclick="replaceImage('${sec}')">ğŸ–¼ ì´ë¯¸ì§€(íŒŒì¼ë§Œ) êµì²´</button>
          <button class="btn btn-bad" onclick="deleteArtwork('${sec}')">ğŸ—‘ ì´ ì‘í’ˆ ì‚­ì œ</button>
        </div>
        <div class="btn-row">
          <button class="btn" onclick="autoNextId()">ì €ì¥ í›„ ë‹¤ìŒ ì‘í’ˆ(ID ìë™ ì¦ê°€)</button>
        </div>
      </div>

      <div class="card">
        <div class="kv"><label>ëª©ë¡</label><select id="w-list" onchange="fillFromList('${sec}')"></select></div>
        <input id="w-search" placeholder="ID/ì œëª©/ì‹œë¦¬ì¦ˆ ê²€ìƒ‰â€¦" oninput="filterList('${sec}')">
        <div class="btn-row"><button class="btn btn-ghost" onclick="refreshList('${sec}')">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button></div>
        <div class="small">ì´ ì„¹ì…˜ì˜ JSON í•­ëª© ìˆ˜: <b id="w-count">0</b></div>
      </div>
    </div>`;
  $("#w-file").addEventListener('change',ev=>{
    const f=ev.target.files?.[0]; if(!f) return;
    const url=URL.createObjectURL(f); const p=$("#w-preview"); p.src=url; p.style.display='block';
  });
  refreshList(sec);
}
function findIndexById(sec,id){ return (artworks[sec]||[]).findIndex(x=>x.id===id); }
function filterList(sec){
  const q=$("#w-search").value.toLowerCase();
  const list=$("#w-list"); list.innerHTML='';
  (artworks[sec]||[]).filter(a=>{
    const s=[a.id,a.title,sec].join(' ').toLowerCase();
    return s.includes(q);
  }).forEach(a=>{
    const opt=document.createElement('option'); opt.value=a.id; opt.textContent=`${a.id} â€” ${a.title||''}`;
    list.appendChild(opt);
  });
}
function refreshList(sec){
  const list=$("#w-list"); list.innerHTML='';
  (artworks[sec]||[]).forEach(a=>{
    const opt=document.createElement('option'); opt.value=a.id; opt.textContent=`${a.id} â€” ${a.title||''}`;
    list.appendChild(opt);
  });
  $("#w-count").textContent = artworks[sec]?.length||0;
}
function fillFromList(sec){
  const id=$("#w-list").value; const a=(artworks[sec]||[]).find(x=>x.id===id);
  if(!a) return;
  $("#w-id").value=a.id||''; $("#w-title").value=a.title||''; $("#w-year").value=a.year||'';
  $("#w-medium").value=a.medium||''; $("#w-size").value=a.size||'';
  const p=$("#w-preview"); if(a.image){ p.src=a.image; p.style.display='block'; } else { p.style.display='none'; }
}
function autoNextId(){ const id=$("#w-id").value.trim()||'work-1'; $("#w-id").value = nextNumericId(id); }

async function loadArtworks(){
  const r=await getContent(ARTWORKS_JSON);
  if(r.exists){
    try{ artworks = JSON.parse(r.content); }catch{ artworks = { light:[],human:[],rebirth:[],restore:[],meta:[] }; }
    toast('âœ… artworks.json ë¡œë“œ ì™„ë£Œ');
    // í˜„ì¬ ì„¹ì…˜ ê°±ì‹ 
    const active = [...$$("#workTabs button")].find(b=>b.classList.contains('active'));
    if(active){ const sec = SECTIONS.find(s=>s.label===active.textContent).id; refreshList(sec); }
  }else{
    toast('â„¹ï¸ artworks.jsonì´ ì—†ì–´ ìƒˆë¡œ ìƒì„±ë©ë‹ˆë‹¤');
  }
}
async function saveArtworksJson(){
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(artworks,null,2))));
  await putFile(ARTWORKS_JSON,b64,'Update artworks.json');
  toast('ğŸ’¾ artworks.json ì €ì¥ ì™„ë£Œ');
}
async function uploadArtwork(sec){
  const file=$("#w-file").files[0];
  const id=$("#w-id").value.trim(); if(!id){ toast('âš ï¸ Artwork IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  let imageUrl = artworks[sec].find(x=>x.id===id)?.image || '';
  if(file){
    const b64 = await fileToBase64(file);
    const safeName = (id.replace(/\s+/g,'_')||'image') + (file.name.match(/\.\w+$/)?.[0]||'.jpg');
    const imgPath = `img/${sec}/${safeName}`;
    await putFile(imgPath,b64,`Add ${imgPath}`);
    imageUrl = `/${imgPath}`;
  }
  const entry = {
    id,
    title: $("#w-title").value.trim(),
    year: $("#w-year").value.trim(),
    medium: $("#w-medium").value.trim(),
    size: $("#w-size").value.trim(),
    image: imageUrl
  };
  const idx = findIndexById(sec,id);
  if(idx>=0) artworks[sec][idx]=entry; else artworks[sec].push(entry);
  await saveArtworksJson();
  refreshList(sec);
  toast('âœ… ì‘í’ˆ ì €ì¥ ì™„ë£Œ');
}
async function updateArtwork(sec){
  const id=$("#w-id").value.trim(); if(!id){ toast('IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  const idx = findIndexById(sec,id); if(idx<0){ toast('ëª©ë¡ì— ì—†ìŒ â€” ë¨¼ì € ì—…ë¡œë“œ'); return; }
  Object.assign(artworks[sec][idx],{
    title: $("#w-title").value.trim(),
    year: $("#w-year").value.trim(),
    medium: $("#w-medium").value.trim(),
    size: $("#w-size").value.trim()
  });
  await saveArtworksJson();
  toast('âœï¸ ë©”íƒ€ë°ì´í„° ìˆ˜ì • ì™„ë£Œ');
}
async function replaceImage(sec){
  const id=$("#w-id").value.trim(); if(!id){ toast('IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  const idx=findIndexById(sec,id); if(idx<0){ toast('ëª©ë¡ì— ì—†ìŒ'); return; }
  const file=$("#w-file").files[0]; if(!file){ toast('êµì²´í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
  const b64 = await fileToBase64(file);
  const safeName = (id.replace(/\s+/g,'_')||'image') + (file.name.match(/\.\w+$/)?.[0]||'.jpg');
  const imgPath = `img/${sec}/${safeName}`;
  await putFile(imgPath,b64,`Replace ${imgPath}`);
  artworks[sec][idx].image = `/${imgPath}`;
  await saveArtworksJson();
  toast('ğŸ–¼ ì´ë¯¸ì§€ êµì²´ ì™„ë£Œ');
}
async function deleteArtwork(sec){
  const id=$("#w-id").value.trim(); if(!id){ toast('IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  const idx = findIndexById(sec,id); if(idx<0){ toast('ëª©ë¡ì— ì—†ìŒ'); return; }
  const url = artworks[sec][idx].image||'';
  if(url.startsWith('/img/')){ try{ await deleteFile(url.replace(/^\//,''), `Delete ${url}`);}catch{} }
  artworks[sec].splice(idx,1);
  await saveArtworksJson();
  refreshList(sec);
  toast('ğŸ—‘ ì‘í’ˆ ì‚­ì œ ì™„ë£Œ');
}

/* ===============================
   2) ë¯¸í•™ ë³´ê³ ì„œ (DCAR 1â€“8)
   =============================== */
let reports = {};                      // { dcar01:{id,titleEN,titleKO,year,series,text,textUrl,pdfUrl,textChars,updatedAt} }
const REPORTS_JSON = 'data/reports.json';
let r_autosave_on = true;
let r_autosave_timer = null;

function buildReportUI(){
  const tabs = $("#reportTabs"); tabs.innerHTML='';
  DCAR_IDS.forEach((rid,i)=>{
    const b=document.createElement('button');
    b.textContent=rid.toUpperCase(); if(i===0) b.classList.add('active');
    b.onclick=()=>{ $$("#reportTabs button").forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderReportForm(rid); };
    tabs.appendChild(b);
  });
  renderReportForm(DCAR_IDS[0]);
}
function currentRid(){ return $("#r-id").value; }
function collectReportMeta(){ return {
  id: currentRid(),
  titleEN: $("#r-en").value.trim(),
  titleKO: $("#r-ko").value.trim(),
  series:  $("#r-series").value.trim()||'Aesthetic Reports',
  year:    $("#r-year").value.trim()
};}

function renderReportForm(rid){
  const d = reports[rid] || {};
  const pdfPath = `/reports/${rid.toUpperCase()}.pdf`;
  const mdPath  = `/reports/${rid.toUpperCase()}.md`;
  $("#reportForm").innerHTML = `
    <div class="grid grid-2">
      <div class="card">
        <div class="kv"><label>Report ID</label><input id="r-id" value="${rid}" disabled></div>
        <div class="kv"><label>Title (EN)</label><input id="r-en" placeholder="On Light, Memory, and Being" value="${d.titleEN||''}"></div>
        <div class="kv"><label>Title (KO)</label><input id="r-ko" placeholder="ë¹›, ê¸°ì–µ, ì¡´ì¬ì— ê´€í•˜ì—¬" value="${d.titleKO||''}"></div>
        <div class="kv"><label>Series</label><input id="r-series" placeholder="Aesthetic Reports" value="${d.series||'Aesthetic Reports'}"></div>
        <div class="kv"><label>Year</label><input id="r-year" placeholder="2025" value="${d.year||''}"></div>
        <div class="kv"><label>Auto Save</label>
          <select id="r-autosave">
            <option value="on" ${r_autosave_on?'selected':''}>ON (ë¶™ì—¬ë„£ê¸° í›„ 1.5ì´ˆ ìë™ ì €ì¥)</option>
            <option value="off" ${!r_autosave_on?'selected':''}>OFF (ë²„íŠ¼ ì €ì¥)</option>
          </select>
        </div>
      </div>

      <div class="card">
        <div class="kv"><label>PDF</label><input id="r-pdf" type="file" accept=".pdf"></div>
        <div class="btn-row" style="margin-bottom:6px">
          <button class="btn" onclick="uploadReportPDF()">ğŸ“¤ PDF ì—…ë¡œë“œ</button>
          <button class="btn btn-ghost" onclick="openNewTab('${pdfPath}')">ğŸ”— PDF ì—´ê¸°</button>
        </div>
        <textarea id="r-text" placeholder="ì—¬ê¸°ì— DCAR ë³¸ë¬¸ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (KR/EN í˜¼ìš© ê°€ëŠ¥)">${d.text||''}</textarea>
        <div class="small">Markdown ì €ì¥ ê²½ë¡œ: <a class="link" target="_blank" href="${mdPath}">${mdPath}</a></div>
        <div class="btn-row" style="margin-top:8px">
          <button class="btn" onclick="saveReportText()">ğŸ“ í…ìŠ¤íŠ¸ ì €ì¥(.md + JSON)</button>
          <button class="btn btn-ghost" onclick="updateReportMeta()">âœï¸ ë©”íƒ€ë§Œ ì €ì¥(JSON)</button>
          <button class="btn btn-bad" onclick="deleteReportAll()">ğŸ—‘ ë³´ê³ ì„œ ì‚­ì œ(í…ìŠ¤íŠ¸Â·PDFÂ·JSON)</button>
        </div>
        <div class="small" id="r-stats">ê¸€ììˆ˜: ${(d.text||'').length.toLocaleString()} Â· ë§ˆì§€ë§‰ ì €ì¥: ${d.updatedAt||'-'}</div>
      </div>
    </div>`;
  // ì´ë²¤íŠ¸
  $("#r-autosave").onchange=(e)=>{ r_autosave_on = e.target.value==='on'; };
  const t=$("#r-text"); t.addEventListener('input',()=>{
    $("#r-stats").textContent = `ê¸€ììˆ˜: ${t.value.length.toLocaleString()} Â· ì„ì‹œí¸ì§‘`;
    if(!r_autosave_on) return;
    if(r_autosave_timer) clearTimeout(r_autosave_timer);
    r_autosave_timer = setTimeout(()=>saveReportText(),1500);
  });
}

async function loadReports(){
  const r = await getContent(REPORTS_JSON);
  if(r.exists){ try{ reports = JSON.parse(r.content)||{}; }catch{ reports={}; } toast('âœ… reports.json ë¡œë“œ ì™„ë£Œ'); }
  else{ reports={}; toast('â„¹ï¸ reports.jsonì´ ì—†ì–´ ìƒˆë¡œ ìƒì„±ë©ë‹ˆë‹¤'); }
  const activeBtn=[...$$("#reportTabs button")].find(b=>b.classList.contains('active'));
  const rid=activeBtn?activeBtn.textContent.toLowerCase():DCAR_IDS[0];
  renderReportForm(rid);
}
async function saveReportsJson(){
  const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(reports,null,2))));
  await putFile(REPORTS_JSON,b64,'Update reports.json');
  toast('ğŸ’¾ reports.json ì €ì¥ ì™„ë£Œ');
}

async function saveReportText(){
  const rid = currentRid();
  const meta = collectReportMeta();
  const text = $("#r-text").value;
  // front-matter + ë³¸ë¬¸ â†’ .md
  const fm = ['---',`report_id: ${rid.toUpperCase()}`,`title_en: "${meta.titleEN||''}"`,`title_ko: "${meta.titleKO||''}"`,`year: "${meta.year||''}"`,'---',''].join('\n');
  const md = fm + text + '\n';
  const b64 = btoa(unescape(encodeURIComponent(md)));
  await putFile(`reports/${rid.toUpperCase()}.md`, b64, `Save ${rid.toUpperCase()}.md`);
  const updatedAt = new Date().toISOString();
  reports[rid] = { ...(reports[rid]||{}), ...meta, text, textUrl:`/reports/${rid.toUpperCase()}.md`, textChars:text.length, updatedAt };
  await saveReportsJson();
  $("#r-stats").textContent = `ê¸€ììˆ˜: ${text.length.toLocaleString()} Â· ë§ˆì§€ë§‰ ì €ì¥: ${updatedAt}`;
  toast('âœ… í…ìŠ¤íŠ¸ ì €ì¥ ì™„ë£Œ');
}
async function updateReportMeta(){
  const rid = currentRid(); const meta = collectReportMeta();
  if(!reports[rid]) reports[rid]={ id:rid };
  Object.assign(reports[rid], meta, { updatedAt:new Date().toISOString() });
  await saveReportsJson(); toast('âœï¸ ë©”íƒ€ë°ì´í„° ì €ì¥ ì™„ë£Œ');
}
async function uploadReportPDF(){
  const rid = currentRid(); const pdf = $("#r-pdf").files[0];
  if(!pdf){ toast('âš ï¸ PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  const b64 = await fileToBase64(pdf);
  await putFile(`reports/${rid.toUpperCase()}.pdf`, b64, `Add ${rid.toUpperCase()}.pdf`);
  if(!reports[rid]) reports[rid]={ id:rid };
  reports[rid].pdfUrl = `/reports/${rid.toUpperCase()}.pdf`;
  reports[rid].updatedAt = new Date().toISOString();
  await saveReportsJson(); toast('âœ… PDF ì—…ë¡œë“œ ì™„ë£Œ');
}
async function deleteReportAll(){
  const rid = currentRid();
  try{ await deleteFile(`reports/${rid.toUpperCase()}.md`,  `Delete ${rid.toUpperCase()}.md`);}catch{}
  try{ await deleteFile(`reports/${rid.toUpperCase()}.pdf`, `Delete ${rid.toUpperCase()}.pdf`);}catch{}
  delete reports[rid]; await saveReportsJson(); toast('ğŸ—‘ ë³´ê³ ì„œ ì‚­ì œ ì™„ë£Œ');
}

/* ===============================
   3) ìœ í‹¸
   =============================== */
async function purgeCache(){
  const path = 'data/.pages-touch';
  const b64 = btoa(`touched: ${new Date().toISOString()}`);
  await putFile(path,b64,'Touch pages cache'); toast('ğŸš€ ìºì‹œ ë¬´íš¨í™” commit ì™„ë£Œ');
}

/* ===============================
   Init
   =============================== */
function init(){
  ['owner','repo','branch','token'].forEach(id=>{ const v=cfg(id); if(v) $('#'+id).value=v; });
  // UI êµ¬ì¶•
  buildWorkUI(); buildReportUI();
  // JSON ì„ ë¡œë“œ
  loadArtworks().catch(()=>{}); loadReports().catch(()=>{});
}
// Build work tabs initially
window.addEventListener('load', init);
</script>
</body>
</html>