<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Lightflow Trigger Ω.14 — Pages Deploy Tools</title>
<meta name="theme-color" content="#070c1a">
<style>
:root{--bg:#070c1a;--panel:#0b1020;--soft:#0f1730;--fg:#e8edf7;--muted:#9fb0cc;--border:#1e2744;--ok:#72e0a7;--bad:#ff6b6b;--accent:#d4b97a}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Pretendard,system-ui,sans-serif}
header{position:sticky;top:0;z-index:9999;background:linear-gradient(180deg,#091227,transparent);border-bottom:1px solid var(--border);padding:14px 12px;font-weight:800;color:var(--accent)}
.container{max-width:880px;margin:0 auto;padding:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0}
h2{margin:0 0 10px;color:var(--accent);font-size:18px}
input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--soft);color:var(--fg);font-size:15px}
.btn{background:var(--accent);color:#000;border:none;font-weight:800}
.btn-ok{background:var(--ok);color:#012d1a;border:none}
.btn-bad{background:var(--bad);color:#000;border:none}
.grid2{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:760px){.grid2{grid-template-columns:1fr 1fr}}
.small{font-size:12px;color:var(--muted)}
/* tap reliability */
header,.container,.card{pointer-events:auto}
button{pointer-events:auto;touch-action:manipulation}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1223;border:1px solid var(--border);border-radius:12px;color:var(--fg);padding:10px 14px;opacity:0;transition:opacity .2s;z-index:10000}
.toast.show{opacity:1}
</style>
</head>
<body>
<header>🚀 Lightflow Admin Ω.14 — Trigger</header>
<div class="container">

  <div class="card">
    <h2>0. 연결 상태</h2>
    <div class="grid2">
      <div>
        <input id="owner" placeholder="Owner">
        <input id="repo" placeholder="Repo">
        <input id="branch" placeholder="Branch" value="main">
        <input id="token" type="password" placeholder="Token(repo)">
      </div>
      <div>
        <button type="button" class="btn" onclick="saveCfg()">저장</button>
        <button type="button" class="btn-ok" onclick="testConn()">연결 테스트</button>
        <button type="button" onclick="goAdmin()">Admin 열기</button>
        <button type="button" class="btn-bad" onclick="resetLocal()">localStorage 초기화</button>
        <div id="status" class="small" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>1. 강제 트리거</h2>
    <div class="grid2">
      <button type="button" class="btn" onclick="commitTouch()">✏️ Commit Touch (캐시 무효)</button>
      <button type="button" class="btn-ok" onclick="pagesBuild()">🚀 Pages Build 요청</button>
    </div>
    <div class="small" style="margin-top:8px">touch 파일이 <code>/data/.touch</code>·<code>/data/.pages-touch</code> 로 커밋됩니다.</div>
  </div>

</div>
<div id="toast" class="toast"></div>

<script>
const $=s=>document.querySelector(s);
const say=(m,e=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=e?'#ff6b6b':'#22304f';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800);};
const cfg=k=>localStorage.getItem(k)||""; const setcfg=(k,v)=>localStorage.setItem(k,v);
["owner","repo","branch","token"].forEach(id=>{if(cfg(id))$("#"+id).value=cfg(id);});
function saveCfg(){["owner","repo","branch","token"].forEach(id=>setcfg(id,$("#"+id).value.trim()));loadStatus();say("저장됨");}
function loadStatus(){ $("#status").textContent=`Owner ${cfg("owner")} · Repo ${cfg("repo")} · Branch ${cfg("branch")}`;}
function resetLocal(){localStorage.clear();location.reload()}
function goAdmin(){location.href='admin.html'}
loadStatus();

async function gh(m,p,b=null,isJson=true){
  const tk=cfg("token"); if(!tk) throw new Error("토큰 없음");
  const r=await fetch(`https://api.github.com/${p}`,{method:m,headers:{Accept:"application/vnd.github+json","Authorization":`token ${tk}`},body:b?(isJson?JSON.stringify(b):b):null});
  if(!r.ok) throw new Error(`GitHub ${r.status}: ${(await r.text()).slice(0,200)}`);
  return r.json();
}
async function getContent(path){
  try{const j=await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(path)}?ref=${cfg("branch")}`);return{exists:true,sha:j.sha}}catch(e){return{exists:false,sha:null}}
}
async function putFile(path,b64,msg){
  const old=await getContent(path);
  const body={message:msg||`update ${path}`,content:b64,branch:cfg("branch")};
  if(old.exists) body.sha=old.sha;
  return gh("PUT",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(path)}`,body);
}
function b64(s){return btoa(unescape(encodeURIComponent(s)))}

async function testConn(){try{await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}`);say("연결 OK (200)");}catch(e){say("연결 실패: "+e.message,true)}}
async function commitTouch(){
  try{const stamp=new Date().toISOString();await putFile("data/.touch",b64("touch "+stamp),"touch");await putFile("data/.pages-touch",b64(stamp),"pages-touch");say("Touch 커밋 완료");}
  catch(e){say("Touch 실패: "+e.message,true)}
}
async function pagesBuild(){
  try{await gh("POST",`repos/${cfg("owner")}/${cfg("repo")}/pages/builds`,{});say("Pages Build 요청됨");}
  catch(e){say("Pages API 권한 없음 — touch만 사용 가능",true)}
}

/* iOS touch→click bridge */
(function(){const isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);if(!isiOS)return;function bind(el){if(el.__tap) return;el.__tap=1;let sx=0,sy=0;el.addEventListener("touchstart",e=>{const t=e.changedTouches[0];sx=t.clientX;sy=t.clientY;},{passive:true});el.addEventListener("touchend",e=>{const t=e.changedTouches[0];if(Math.abs(t.clientX-sx)<10&&Math.abs(t.clientY-sy)<10){e.preventDefault();el.dispatchEvent(new MouseEvent("click",{bubbles:true,cancelable:true}))}},{passive:false})}function scan(){document.querySelectorAll("button,[onclick]").forEach(bind)}window.addEventListener("load",scan);new MutationObserver(scan).observe(document.body,{subtree:true,childList:true});})();
</script>
</body>
</html>