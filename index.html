<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>âœ¨ Lightflow Admin Î©.12 â€” Final Binder (KRÂ·EN)</title>
<meta name="color-scheme" content="dark light" />
<style>
:root{
  --bg:#0b132b;--panel:#0f1c3b;--soft:#142751;
  --fg:#f2f6ff;--muted:#9fb2d9;--accent:#ffd782;
  --good:#78f0b0;--bad:#ff6b6b;--line:#1d3158;--chip:#0f234a;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Pretendard,sans-serif;font-size:16px;line-height:1.45}
.header{position:sticky;top:0;z-index:3;background:linear-gradient(180deg,rgba(11,19,43,.96),rgba(11,19,43,0));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06);padding:12px 14px}
h1{margin:0;font-size:1.12rem;color:var(--accent);font-weight:800}
.container{max-width:980px;margin:0 auto;padding:10px 14px 120px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.card h3{margin:4px 0 10px;font-size:1.02rem;color:#ffe9a5}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:1fr}
@media(min-width:880px){.grid-2{grid-template-columns:1.05fr .95fr}}
.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
.kv label{font-size:13px;color:#cfe0ff}
input,textarea,select,button{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:var(--soft);color:var(--fg);font-size:15.5px}
textarea{min-height:130px;resize:none}
button{background:var(--accent);color:#000;font-weight:800;border:none;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.btn-row{display:flex;gap:10px;flex-wrap:wrap}
.btn-ghost{background:var(--chip);color:var(--fg);border:1px solid var(--line)}
.btn-good{background:var(--good);color:#002a14}
.btn-bad{background:var(--bad);color:#000}
.small{font-size:12.5px;color:var(--muted)}
pre.log{background:#0b214b;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;word-break:break-word;max-height:280px;overflow:auto}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0c1f43;border:1px solid var(--line);color:var(--fg);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:9;opacity:0;pointer-events:none;transition:opacity .22s}
.toast.show{opacity:1}
.spinner{display:none;margin-left:6px;width:14px;height:14px;border:2px solid #cfe0ff;border-top-color:transparent;border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
.tabs button{flex:0 0 auto;background:#102657;color:#e7efff;border:1px solid var(--line);border-radius:999px;padding:10px 14px;font-size:14px}
.tabs button.active{background:var(--accent);color:#000}
.drop{border:2px dashed var(--line);border-radius:12px;padding:12px;text-align:center;background:#0c1f43}
.drop.drag{background:#103064}
.preview{width:100%;max-height:260px;object-fit:contain;border-radius:12px;border:1px solid var(--line);background:#0b1733}
</style>
</head>
<body>
<div class="header"><h1>âœ¨ Lightflow Admin Î©.12 <span class="small">Final Binder Â· Cache + Commit Â· KRÂ·EN</span></h1></div>
<div class="container">

  <!-- 0) GitHub ì—°ê²° -->
  <div class="card">
    <h3>0) GitHub ì—°ê²° Â· Connection</h3>
    <div class="grid grid-2">
      <div class="kv"><label>GitHub Owner</label><input id="owner" placeholder="ì˜ˆ: dungzakcestlavie" /></div>
      <div class="kv"><label>Repository</label><input id="repo" placeholder="ì˜ˆ: dungzakcestlavie.github.io" /></div>
      <div class="kv"><label>Branch</label><input id="branch" placeholder="main" value="main" /></div>
      <div class="kv"><label>Personal Access Token</label><input id="token" placeholder="github_pat_..." /></div>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button data-act="save">ì €ì¥(ë¡œì»¬) Â· Save (Local)</button>
      <button class="btn-ghost" data-act="logout">ë¡œê·¸ì•„ì›ƒ/í† í°ì‚­ì œ Â· Logout</button>
      <button class="btn-good" data-act="test">ì—°ê²° í…ŒìŠ¤íŠ¸ Â· Test <span id="spinTest" class="spinner"></span></button>
      <button class="btn-ghost" data-act="touch">GitHub Pages ìºì‹œ ë¬´íš¨í™” Â· Cache Bust <span id="spinTouch" class="spinner"></span></button>
      <button class="btn-ghost" data-act="health">ì—°ê²° ì§„ë‹¨ Â· Health</button>
    </div>
    <div class="small" style="margin-top:6px">í† í°ì€ ì´ ë¸Œë¼ìš°ì €ì˜ <b>localStorage</b>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤. Token is stored locally only.</div>
  </div>

  <!-- 1) ì‘í’ˆ ì•„ì¹´ì´ë¸Œ (í•„ìˆ˜ í•„ë“œ+ì´ë¯¸ì§€ ì—…ë¡œë“œ í•µì‹¬ë§Œ ê°„ì†Œí™”) -->
  <div class="card">
    <h3>1) ì‘í’ˆ ì•„ì¹´ì´ë¸Œ Â· Artworks (Iâ€“V)</h3>
    <div class="tabs" id="workTabs"></div>
    <div id="workForm"></div>
    <div class="small">JSON: <code>/data/artworks.json</code> Â· ì´ë¯¸ì§€: <code>/img/{section}/</code></div>
  </div>

  <!-- 2) ë¯¸í•™ ë³´ê³ ì„œ â€” ë¹ ë¥¸ ë¶™ì—¬ë„£ê¸°(.md + JSON ìš”ì•½) -->
  <div class="card">
    <h3>2) ë¯¸í•™ ë³´ê³ ì„œ Â· Aesthetic Reports (DCAR 01â€“08)</h3>
    <div class="grid grid-2">
      <div class="kv"><label>Report</label>
        <select id="r-sel"></select>
      </div>
      <div class="kv"><label>Auto Save</label>
        <select id="r-auto"><option value="on" selected>ON (ë¶™ì—¬ë„£ê¸° 1.5s í›„ ì €ì¥)</option><option value="off">OFF</option></select>
      </div>
    </div>
    <textarea id="r-text" placeholder="ì—¬ê¸°ì— DCAR ë³¸ë¬¸(í•œ/ì˜ ë¬´ì œí•œ) ë¶™ì—¬ë„£ê¸° Â· Paste KR/EN unlimited"></textarea>
    <div class="btn-row" style="margin-top:8px">
      <button data-act="r-save">ğŸ“ ë¶™ì—¬ë„£ê¸° ì €ì¥ Â· Save Paste (.md + JSON)</button>
      <button class="btn-ghost" data-act="r-open">ì—´ê¸° Â· Open (.md)</button>
    </div>
    <div class="small">.mdëŠ” <code>/reports/DCAR-XX.md</code> ë¡œ ì €ì¥, <code>/data/reports.json</code>ì—ëŠ” 1000ì ìš”ì•½ ì €ì¥.</div>
  </div>

  <!-- 3) Index.html ì»¤ë°‹ ì—ë””í„° -->
  <div class="card">
    <h3>3) Index Commit Â· index.html í¸ì§‘/ì»¤ë°‹</h3>
    <div class="btn-row">
      <button class="btn-ghost" data-act="idx-load">ğŸ“¥ index.html ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button data-act="idx-commit">ğŸš€ index.html ì»¤ë°‹í•˜ê¸°</button>
    </div>
    <textarea id="idx-content" placeholder="index.html ë‚´ìš©ì„ ë¶ˆëŸ¬ì™€ ìˆ˜ì • í›„, ì»¤ë°‹í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”."></textarea>
    <pre class="log" id="idx-log">Ready.</pre>
  </div>

  <!-- 4) ìœ í‹¸ -->
  <div class="card">
    <h3>4) ìœ í‹¸ Â· Utilities</h3>
    <div class="btn-row" id="utilButtons">
      <button data-act="openSite">ì‚¬ì´íŠ¸ ì—´ê¸° Â· Open Site</button>
      <button class="btn-ghost" data-act="touch">GitHub Pages ìºì‹œ ë¬´íš¨í™” Â· Cache Bust</button>
    </div>
  </div>

  <div class="small" style="text-align:center;padding:22px 0">Â© 2025 DUNGZAK CESTLAVIE Â· Orchestrated with Lumera</div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ========= ê¸°ë³¸ê°’(ë‚´ì¥) ========= */
const DEFAULTS = {
  owner: "dungzakcestlavie",
  repo:  "dungzakcestlavie.github.io",
  branch:"main"
};
const DCAR_IDS = Array.from({length:8},(_,i)=>`dcar${String(i+1).padStart(2,'0')}`);
const SECTIONS = [
  {id:'light',  label:'â…  Light & Memory / ë¹›ê³¼ ê¸°ì–µ'},
  {id:'human',  label:'â…¡ Human Being / ì¸ê°„'},
  {id:'rebirth',label:'â…¢ Rebirth of Mind / ë§ˆìŒì˜ ì¬ìƒ'},
  {id:'restore',label:'â…£ Restoration of Being / ì¡´ì¬ì˜ ë³µì›'},
  {id:'meta',   label:'â…¤ Metaconsciousness of Light / ë¹›ì˜ ì´ˆì˜ì‹'}
];

/* ========= ë„ìš°ë¯¸ ========= */
const $=s=>document.querySelector(s); const $$=s=>document.querySelectorAll(s);
const say=(m,err=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=err?'#ff6b6b':'#1d3158';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2300)};
const cfgGet=k=>localStorage.getItem(k)||DEFAULTS[k]||""; const cfgSet=(k,v)=>localStorage.setItem(k,v||"");
function saveCfg(){["owner","repo","branch","token"].forEach(id=>cfgSet(id,$("#"+id).value.trim())); say("âœ… ì €ì¥ Â· Saved (Local)");}
function logout(){localStorage.removeItem("token"); $("#token").value=""; say("ğŸ”’ í† í° ì‚­ì œë¨");}
function b64utf8(s){return btoa(unescape(encodeURIComponent(s)));}
function f2b64(file){return new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(file);});}
function baseUrl(){
  const loc=location, path=loc.pathname.replace(/\/admin\/.*$/,'/'); // /admin/... -> /
  return loc.origin+path;
}

/* ========= GitHub API ========= */
async function gh(method, path, body, isJson=true){
  const token = cfgGet('token');
  if(!token) throw new Error("Missing token");
  const res = await fetch(`https://api.github.com/${path}`,{
    method,
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization":`token ${token}`
    },
    body: body ? (isJson?JSON.stringify(body):body) : null,
    cache:"no-store",mode:"cors",redirect:"follow",referrerPolicy:"no-referrer",credentials:"omit",keepalive:true
  });
  if(!res.ok){
    const txt = await res.text().catch(()=>String(res.status));
    const msg = `GitHub ${res.status}: ${txt.slice(0,400)}`;
    if(/401/.test(msg)) say("ğŸ”‘ 401 Unauthorized â€” í† í°/ê¶Œí•œ í™•ì¸",true);
    else if(/403/.test(msg)) say("â›” 403 Forbidden â€” repo / pages:builds ê¶Œí•œ í•„ìš”",true);
    else if(/404/.test(msg)) say("ğŸ“¦ 404 Not Found â€” Owner/Repo/Branch í™•ì¸",true);
    else if(/409/.test(msg)) say("ğŸ” 409 Conflict â€” SHA ì¶©ëŒ. ìë™ ì¬ì‹œë„ ê¶Œì¥",true);
    else say("âš ï¸ "+msg,true);
    throw new Error(msg);
  }
  return res.json();
}
async function getContent(path){
  const o=cfgGet('owner'), r=cfgGet('repo'), b=cfgGet('branch')||'main';
  try{
    const j=await gh('GET',`repos/${o}/${r}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(b)}`);
    const c=j.content?atob(j.content.replace(/\n/g,'')):null;
    return {sha:j.sha, content:c, exists:true};
  }catch(e){return {sha:null,content:null,exists:false};}
}
async function putFile(path,b64,message){
  const o=cfgGet('owner'), r=cfgGet('repo'), b=cfgGet('branch')||'main';
  let prev=await getContent(path);
  const body={message:message||`Update ${path}`,content:b64,branch:b};
  if(prev.exists) body.sha=prev.sha;
  try{
    return await gh('PUT',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body);
  }catch(e){
    // SHA mismatch â†’ ìµœì‹  sha ë‹¤ì‹œ ê°€ì ¸ì™€ ì¬ì‹œë„
    prev=await getContent(path); if(prev.exists) body.sha=prev.sha; else delete body.sha;
    return gh('PUT',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body);
  }
}
async function delFile(path,message){
  const o=cfgGet('owner'), r=cfgGet('repo'), b=cfgGet('branch')||'main';
  const prev=await getContent(path); if(!prev.exists) return;
  return gh('DELETE',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,{message:message||`Delete ${path}`,sha:prev.sha,branch:b});
}
async function testConn(){
  $("#spinTest").style.display='inline-block';
  try{ await gh('GET',`repos/${cfgGet('owner')}/${cfgGet('repo')}`); say("âœ… ì—°ê²° ì„±ê³µ"); }
  catch(e){ /* ghì—ì„œ í† ìŠ¤íŠ¸ */ }
  finally{ $("#spinTest").style.display='none';}
}

/* ========= Cache Bust ========= */
async function touchPages(){
  const owner=cfgGet('owner'), repo=cfgGet('repo'), tok=cfgGet('token');
  if(!owner||!repo||!tok){say("âš ï¸ Owner/Repo/Token ì €ì¥ í•„ìš”",true);return;}
  $("#spinTouch").style.display='inline-block';
  try{
    const stamp=new Date().toISOString(), msg=`touch ${stamp}`;
    await putFile('data/.touch',       b64utf8('touch '+stamp), msg+' [.touch]');
    await putFile('data/.pages-touch', b64utf8('pages-touch '+stamp), msg+' [.pages-touch]');
    await putFile('data/.ping',        b64utf8('ping '+stamp), msg+' [.ping]');
    try{ await gh('POST', `repos/${owner}/${repo}/pages/builds`, {}); say("ğŸš€ Cache commit + Pages build ìš”ì²­"); }
    catch(_){ say("âœ… Cache commit ì™„ë£Œ(ë¹Œë“œ ìš”ì²­ì€ ì˜µì…˜)"); }
  }catch(e){ /* ghì—ì„œ ì•ˆë‚´ */ }
  finally{ $("#spinTouch").style.display='none'; }
}
async function health(){
  try{
    await gh('GET',`repos/${cfgGet('owner')}/${cfgGet('repo')}`); say("ğŸ©º Repo ì ‘ê·¼ OK");
    await putFile('data/.health', b64utf8('ok '+new Date().toISOString()), 'health check'); say("ğŸ©º ì“°ê¸° ê¶Œí•œ OK (.health)");
    fetch(baseUrl()+'?_health='+Date.now(),{mode:'no-cors'}).then(()=>say("ğŸŒ ì‚¬ì´íŠ¸ ì ‘ê·¼ OK")).catch(()=>{});
  }catch(e){ /* ghì—ì„œ ì•ˆë‚´ */ }
}

/* ========= Artworks (í•µì‹¬ë§Œ) ========= */
let artworks={light:[],human:[],rebirth:[],restore:[],meta:[]};
let currentSection='light';
const ART_JSON='data/artworks.json';

function buildWorkTabs(){
  const tabs=$("#workTabs");
  tabs.innerHTML=SECTIONS.map((s,i)=>`<button data-sec="${s.id}" class="${i?"" :"active"}">${s.label}</button>`).join('');
}
function selectSection(sec,btn){
  currentSection=sec; $$('#workTabs button').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderWorkForm(sec);
}
function renderWorkForm(sec){
  $("#workForm").innerHTML=`
    <div class="grid grid-2">
      <div class="card">
        <div class="kv"><label>Section</label><input id="w-sec" value="${sec}" disabled></div>
        <div class="kv"><label>Artwork ID</label><input id="w-id" placeholder="${sec}-01"></div>
        <div class="kv"><label>Title</label><input id="w-title"></div>
        <div class="kv"><label>Year</label><input id="w-year" placeholder="2025"></div>
        <div class="kv"><label>Medium</label><input id="w-medium" placeholder="Acrylic on Canvas"></div>
        <div class="kv"><label>Size</label><input id="w-size" placeholder="120x90 cm"></div>
        <div class="kv"><label>Image</label><input id="w-file" type="file" accept="image/*"></div>
        <div id="w-drop" class="drop">ğŸ“¥ ë“œë¡­/íƒ­í•˜ì—¬ ì„ íƒ Â· Drop or tap</div>
        <img id="w-prev" class="preview" style="display:none">
        <div class="btn-row" style="margin-top:8px">
          <button data-act="w-upload">ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ + JSON</button>
          <button class="btn-ghost" data-act="w-meta">âœï¸ ë©”íƒ€ë§Œ ì €ì¥</button>
          <button class="btn-ghost" data-act="w-replace">ğŸ–¼ ì´ë¯¸ì§€ êµì²´</button>
          <button class="btn-bad" data-act="w-delete">ğŸ—‘ ì‚­ì œ</button>
        </div>
      </div>
      <div class="card">
        <div class="kv"><label>ê²€ìƒ‰</label><input id="w-q" placeholder="ID/ì œëª© ê²€ìƒ‰â€¦" oninput="window.renderWorkList()"></div>
        <div class="small">ì„¹ì…˜: <b>${sec}</b> Â· ì´ <b id="w-count">0</b>ê°œ</div>
        <div id="w-list" class="grid" style="margin-top:6px"></div>
      </div>
    </div>`;
  $("#w-file").addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f) return; const p=$("#w-prev"); p.src=URL.createObjectURL(f); p.style.display='block';});
  const dz=$("#w-drop"); const setDrag=x=>dz.classList.toggle('drag',x);
  dz.addEventListener('click',()=>$("#w-file").click());
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();setDrag(true)}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();setDrag(false)}));
  dz.addEventListener('drop',e=>{const f=e.dataTransfer?.files?.[0]; if(!f) return; const dt=new DataTransfer();dt.items.add(f);$("#w-file").files=dt.files; const p=$("#w-prev"); p.src=URL.createObjectURL(f); p.style.display='block';});
  renderWorkList();
}
function idxById(sec,id){return (artworks[sec]||[]).findIndex(x=>x.id===id)}
async function loadArtworks(){
  try{const r=await getContent(ART_JSON); if(r.exists){artworks=JSON.parse(r.content||'{}')||artworks; say("âœ… artworks.json ë¡œë“œ");} else say("â„¹ï¸ artworks.json ì—†ìŒ â€” ì €ì¥ ì‹œ ìƒì„±");}
  catch(e){ /* gh ì•ˆë‚´ */ }
}
async function saveArtworksJson(){await putFile(ART_JSON,b64utf8(JSON.stringify(artworks,null,2)),'Update artworks.json'); say("ğŸ’¾ ì €ì¥ ì™„ë£Œ");}
async function uploadArtwork(){
  try{
    const sec=currentSection, id=$("#w-id").value.trim(); if(!id) return say("ID í•„ìš”",true);
    const f=$("#w-file").files[0];
    let url=(artworks[sec].find(x=>x.id===id)||{}).image||'';
    if(f){const b=await f2b64(f); const name=(id.replace(/\s+/g,'_')||'image')+(f.name.match(/\.\w+$/)?.[0]||'.jpg'); const path=`img/${sec}/${name}`; await putFile(path,b,`Add ${path}`); url=`/${path}`;}
    const e={id,title:$("#w-title").value.trim(),year:$("#w-year").value.trim(),medium:$("#w-medium").value.trim(),size:$("#w-size").value.trim(),image:url};
    const i=idxById(sec,id); if(i>=0) artworks[sec][i]=e; else artworks[sec].push(e);
    await saveArtworksJson(); renderWorkList(); say("âœ… ì‘í’ˆ ì €ì¥ ì™„ë£Œ");
  }catch(e){ /* gh ì•ˆë‚´ */ }
}
async function updateArtwork(){
  const sec=currentSection, id=$("#w-id").value.trim(); const i=idxById(sec,id); if(i<0) return say("ëª©ë¡ì— ì—†ìŒ",true);
  Object.assign(artworks[sec][i],{title:$("#w-title").value.trim(),year:$("#w-year").value.trim(),medium:$("#w-medium").value.trim(),size:$("#w-size").value.trim()});
  await saveArtworksJson(); renderWorkList(); say("âœï¸ ë©”íƒ€ ì €ì¥ ì™„ë£Œ");
}
async function replaceImage(){
  try{
    const sec=currentSection, id=$("#w-id").value.trim(); const i=idxById(sec,id); if(i<0) return say("ëª©ë¡ì— ì—†ìŒ",true);
    const f=$("#w-file").files[0]; if(!f) return say("ì´ë¯¸ì§€ ì„ íƒ",true);
    const b=await f2b64(f); const name=(id.replace(/\s+/g,'_')||'image')+(f.name.match(/\.\w+$/)?.[0]||'.jpg'); const path=`img/${sec}/${name}`;
    await putFile(path,b,`Replace ${path}`); artworks[sec][i].image=`/${path}`;
    await saveArtworksJson(); renderWorkList(); say("ğŸ–¼ êµì²´ ì™„ë£Œ");
  }catch(e){ /* gh ì•ˆë‚´ */ }
}
async function deleteArtwork(){
  try{
    const sec=currentSection, id=$("#w-id").value.trim(); const i=idxById(sec,id); if(i<0) return say("ëª©ë¡ì— ì—†ìŒ",true);
    const u=artworks[sec][i].image||''; if(u.startsWith('/img/')){try{await delFile(u.slice(1),`Delete ${u}`)}catch{}}
    artworks[sec].splice(i,1); await saveArtworksJson(); renderWorkList(); say("ğŸ—‘ ì‚­ì œ ì™„ë£Œ");
  }catch(e){ /* gh ì•ˆë‚´ */ }
}
function renderWorkList(){
  const sec=currentSection; const list=$("#w-list"); const q=($("#w-q")?.value||"").toLowerCase();
  const arr=(artworks[sec]||[]).filter(a=>`${a.id} ${a.title}`.toLowerCase().includes(q));
  $("#w-count").textContent=(artworks[sec]||[]).length||0;
  list.innerHTML = arr.map(a=>`<button class="btn-ghost" style="text-align:left" data-act="w-pick" data-id="${a.id}">${a.id}${a.title?` Â· ${a.title}`:''}</button>`).join('');
}

/* ========= Reports (Quick Paste) ========= */
let reports={}; const REP_JSON='data/reports.json'; const SUMMARY_LIMIT=1000;
function initReportSel(){ const s=$("#r-sel"); s.innerHTML=DCAR_IDS.map(id=>`<option value="${id}">${id.toUpperCase()}</option>`).join(''); }
async function loadReports(){
  try{const r=await getContent(REP_JSON); if(r.exists){reports=JSON.parse(r.content||'{}')||{}; say("âœ… reports.json ë¡œë“œ");}}
  catch(e){ /* gh ì•ˆë‚´ */ }
}
async function saveReportsJson(){ await putFile(REP_JSON,b64utf8(JSON.stringify(reports,null,2)),'Update reports.json'); }
async function saveReportPaste(){
  const id=$("#r-sel").value, txt=$("#r-text").value.trim(); if(!txt) return say("ë‚´ìš©ì´ ë¹„ì–´ìˆì–´ìš”",true);
  const fm=['---',`report_id: ${id.toUpperCase()}`,'---',''].join('\n');
  await putFile(`reports/${id.toUpperCase()}.md`, b64utf8(fm+txt+'\n'), `Save ${id.toUpperCase()}.md`);
  const short=txt.slice(0,SUMMARY_LIMIT);
  reports[id]={...(reports[id]||{id}), text:txt, textShort:short, updatedAt:new Date().toISOString(), textUrl:`/reports/${id.toUpperCase()}.md`};
  await saveReportsJson(); say("âœ… ë¶™ì—¬ë„£ê¸° ì €ì¥ ì™„ë£Œ");
}
function autoSaveHook(){ if($("#r-auto").value!=='on') return; clearTimeout(window.__rs); window.__rs=setTimeout(saveReportPaste,1500); }

/* ========= Index Commit ========= */
async function idxLoad(){
  $("#idx-log").textContent="Loadingâ€¦";
  try{
    const j=await getContent('index.html'); if(!j.exists) return $("#idx-log").textContent="âš ï¸ index.html ì—†ìŒ";
    $("#idx-content").value=j.content||""; $("#idx-log").textContent="ğŸ“¥ index.html ë¶ˆëŸ¬ì˜´";
  }catch(e){ $("#idx-log").textContent="âš ï¸ "+(e.message||e); }
}
async function idxCommit(){
  $("#idx-log").textContent="Committingâ€¦";
  try{
    const content=$("#idx-content").value; if(!content) return $("#idx-log").textContent="âš ï¸ ë‚´ìš© ì—†ìŒ";
    const b64=b64utf8(content);
    // ê¸°ì¡´ SHA í™•ì¸
    let sha=null; try{ const j=await getContent('index.html'); if(j.exists) sha=j.sha; }catch(_){}
    const body={message:"Update index.html via Admin Î©.12",content:b64,branch:cfgGet('branch')}; if(sha) body.sha=sha;
    const o=cfgGet('owner'), r=cfgGet('repo');
    const res=await gh('PUT',`repos/${o}/${r}/contents/index.html`,body);
    $("#idx-log").textContent="âœ… ì»¤ë°‹ ì™„ë£Œ\n\n"+JSON.stringify(res,null,2);
    say("âœ… index.html ì»¤ë°‹ ì„±ê³µ");
  }catch(e){ $("#idx-log").textContent="âš ï¸ "+(e.message||e); }
}

/* ========= iOS ì•ˆì „ ë°”ì¸ë” (ëª¨ë“  ë²„íŠ¼ì„ click+touchstart+mousedownë¡œ ë³´ê°•) ========= */
function bindAll(){
  document.querySelectorAll('[data-act],[data-sec],[data-id]').forEach(el=>{
    if(el.__bound) return; el.__bound=true;
    ['click','touchstart','mousedown'].forEach(ev=>{
      el.addEventListener(ev,(e)=>{
        e.preventDefault(); e.stopPropagation();
        const act=el.dataset.act, sec=el.dataset.sec, id=el.dataset.id;
        if(act){
          const map={
            save:saveCfg, logout:logout, test:testConn, touch:touchPages, health:health,
            'w-upload':uploadArtwork, 'w-meta':updateArtwork, 'w-replace':replaceImage, 'w-delete':deleteArtwork,
            'w-pick':()=>{ const s=currentSection; const a=(artworks[s]||[]).find(x=>x.id===id)||{}; $("#w-id").value=a.id||''; $("#w-title").value=a.title||''; $("#w-year").value=a.year||''; $("#w-medium").value=a.medium||''; $("#w-size").value=a.size||''; },
            'r-save':saveReportPaste, 'r-open':()=>window.open(`/reports/${($("#r-sel").value||'DCAR01').toUpperCase()}.md`,'_blank'),
            'idx-load':idxLoad,'idx-commit':idxCommit,'openSite':()=>window.open(baseUrl(),'_blank','noopener')
          };
          return map[act]?.();
        }
        if(sec){ selectSection(sec,el); }
      },{passive:false});
    });
    el.setAttribute('tabindex','0');
    el.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }});
  });
}
const mo=new MutationObserver(bindAll);

/* ========= Init ========= */
async function init(){
  // restore + defaults
  ["owner","repo","branch","token"].forEach(id=>{$("#"+id).value = cfgGet(id);});
  // tabs/forms
  buildWorkTabs(); selectSection('light',$('#workTabs button[data-sec="light"]'));
  await loadArtworks(); renderWorkList();
  initReportSel(); await loadReports();
  // report autosave
  $("#r-text").addEventListener('input',autoSaveHook);
  // binder
  bindAll(); mo.observe(document.body,{childList:true,subtree:true});
}
window.addEventListener('load',init);
</script>
<div id="toast" class="toast"></div>
</body>
</html>