name: DUNGZAK CESTLAVIE Content Pipeline & Auto Deploy

on:
  push:
    branches: [ main ]
    paths:
      - "data/**"
      - "reports/**"
      - "images/**"
      - "works/**"
      - ".github/workflows/content-pipeline.yml"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  pipeline:
    name: Build & Sync Reports
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1) Adminì´ ì‘ì„±í•˜ëŠ” reports/reports.jsonì„ ì›ë³¸(source of truth)ìœ¼ë¡œ ì‚¬ìš©
      - name: Validate admin reports.json (source of truth)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          if [ -f "reports/reports.json" ]; then
            jq . reports/reports.json > /dev/null
            echo "âœ… reports/reports.json is valid"
          else
            echo "âŒ reports/reports.json not found"
            exit 1
          fi

      # 2) data/reports.json ìœ¼ë¡œ ë³µì‚¬ë§Œ (HTML ìŠ¤ìº”, ìë™ ìƒì„± ì—†ìŒ)
      - name: Sync reports.json to data folder
        run: |
          mkdir -p data
          cp ./reports/reports.json ./data/reports.json
          echo "ğŸ“‚ Copied reports/reports.json â†’ data/reports.json"

      # 3) ì´ë¯¸ì§€ ì¸ë„¤ì¼ ìƒì„± (ê¸°ì¡´ ImageMagick ë‹¨ê³„, HTML ì˜ì¡´ X)
      - name: Prepare thumbnails with ImageMagick
        run: |
          sudo apt-get install -y imagemagick
          mkdir -p public/thumbs
          if [ -d "images" ]; then
            for img in $(find images -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \)); do
              out="public/thumbs/$(basename "$img")"
              convert "$img" -resize 1024x1024 "$out"
              echo "ğŸ–¼ thumb: $out"
            done
          else
            echo "âš ï¸ images folder not found, skipping thumbnails."
          fi

      # 4) ë³€ê²½ íŒŒì¼ë§Œ ì»¤ë°‹ & í‘¸ì‹œ (ì—†ìœ¼ë©´ ì¡°ìš©íˆ íŒ¨ìŠ¤)
      - name: Commit & Push changes
        run: |
          git config user.name "Lumera Bot"
          git config user.email "actions@github.com"
          git add data/reports.json public/thumbs || true
          git commit -m "Auto-sync reports.json & thumbnails" || echo "No changes to commit"
          git push || echo "No changes to push"
