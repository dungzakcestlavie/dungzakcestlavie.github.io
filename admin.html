<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>등작 燈酌 DUNGZAK CESTLAVIE · Admin Ω.30 — Works & DCAR Auto Manager</title>
  <meta name="color-scheme" content="dark light">
  <meta name="google" content="notranslate" />
  <meta name="googlebot" content="notranslate" />

  <style>
  :root{
    --bg:#070c1a;
    --panel:#0f1630;
    --ink:#eaf0ff;
    --muted:#9faee6;
    --accent:#e6c777;
    --accent-soft:rgba(230,199,119,.16);
    --danger:#ff6b7a;
    --line:#1b2652;
    --max:980px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html{scroll-behavior:smooth}
  body{
    min-height:100vh;
    font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
    background:
      radial-gradient(circle at top,#111a3a,#050814),
      radial-gradient(circle at 120% 0,#1c3255,#050814);
    color:var(--ink);
    -webkit-font-smoothing:antialiased;
  }
  main{max-width:var(--max);margin:0 auto 80px;padding:76px 14px 32px;position:relative;z-index:1}
  header{
    position:sticky;top:0;z-index:5;
    padding:10px 14px 8px;
    background:linear-gradient(180deg,rgba(5,9,22,.96),rgba(5,9,22,.82));
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter:blur(10px);
  }
  .brand{
    text-align:center;
    color:var(--accent);
    font-weight:900;
    letter-spacing:.06em;
    font-size:clamp(18px,4.6vw,23px);
  }
  .sub{
    text-align:center;
    margin-top:4px;
    font-size:12px;
    color:var(--muted);
  }
  .top-tabs{
    display:flex;justify-content:center;gap:8px;margin-top:10px;
    flex-wrap:wrap;
  }
  .top-tabs button{
    all:unset;cursor:pointer;
    padding:6px 14px;
    border-radius:999px;
    border:1px solid rgba(140,165,230,.45);
    font-size:.9rem;
    color:var(--ink);
    background:radial-gradient(circle at top,rgba(230,199,119,.18),rgba(3,6,18,0));
  }
  .top-tabs button.active{
    background:linear-gradient(180deg,#f7e4a5,#e6c777);
    color:#050814;
    border-color:#f0de98;
    box-shadow:0 0 18px rgba(230,199,119,.45);
  }

  section.box{
    margin-top:18px;
    border-radius:18px;
    border:1px solid rgba(130,160,230,.65);
    background:
      radial-gradient(circle at top,rgba(230,199,119,.08),transparent 60%),
      linear-gradient(180deg,#0b122c,#050816);
    padding:18px 14px 18px;
  }
  @media(min-width:768px){
    section.box{padding:22px 20px 22px}
  }
  h2{
    font-size:17px;
    color:var(--accent);
    letter-spacing:.04em;
    margin-bottom:6px;
  }
  .help{
    font-size:12px;
    color:var(--muted);
    margin-bottom:10px;
  }
  .field{
    margin:10px 0;
  }
  .field label{
    display:block;
    font-size:13px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .field small{
    display:block;
    font-size:11px;
    color:#6f7bc0;
    margin-top:2px;
  }
  input[type="text"],
  input[type="number"],
  textarea,
  select{
    width:100%;
    border-radius:10px;
    border:1px solid #273564;
    padding:8px 10px;
    font:inherit;
    color:var(--ink);
    background:linear-gradient(180deg,#061029,#050814);
  }
  textarea{min-height:70px;resize:vertical}
  input::placeholder,
  textarea::placeholder{color:#616caa}

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .row .col{flex:1 1 0}
  .row .col-2{flex:0 0 calc(50% - 6px)}
  .row .col-3{flex:0 0 calc(33.33% - 7px)}
  @media(max-width:640px){
    .row .col-2,.row .col-3{flex-basis:100%}
  }

  .btn-row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:12px;
  }
  button.btn{
    border-radius:999px;
    border:1px solid #32406d;
    background:#0f1838;
    color:var(--ink);
    padding:8px 16px;
    font-size:.9rem;
    font-weight:700;
    cursor:pointer;
  }
  button.btn.gold{
    background:linear-gradient(180deg,#f7e4a5,#e6c777);
    color:#050814;
    border-color:#f0de98;
    box-shadow:0 0 14px rgba(230,199,119,.45);
  }
  button.btn.danger{
    border-color:rgba(255,107,122,.7);
    color:#ffd3d8;
  }
  button.btn:disabled{
    opacity:.55;
    cursor:not-allowed;
  }

  .note{
    margin-top:10px;
    font-size:12px;
    color:#7c8ad0;
  }
  .note strong{color:var(--accent)}
  .pill{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #3a4676;
    font-size:11px;
    margin-right:4px;
  }

  .log{
    margin-top:10px;
    font-size:12px;
    border-radius:10px;
    padding:8px 10px;
    background:rgba(7,14,40,.9);
    border:1px solid #283561;
    color:#b9c7ff;
    max-height:140px;
    overflow:auto;
    white-space:pre-wrap;
  }
  .log span.ok{color:#b6f3a6}
  .log span.err{color:#ffb1c0}

  .switch-tabs{
    display:flex;
    gap:8px;
    margin-bottom:10px;
  }
  .switch-tabs button{
    all:unset;cursor:pointer;
    padding:5px 11px;
    font-size:.85rem;
    border-radius:999px;
    border:1px solid #394571;
    color:#cfd9ff;
  }
  .switch-tabs button.active{
    background:#141f45;
    border-color:#4e62a3;
    color:var(--accent);
  }

  footer{
    text-align:center;
    margin:20px 0 26px;
    font-size:11px;
    color:#7a89c0;
  }
  footer strong{color:var(--accent)}

  .tagline{
    text-align:center;
    margin-top:10px;
    font-size:11px;
    color:#8fa0dd;
  }
  </style>
</head>
<body>
<header>
  <div class="brand">등작 燈酌 DUNGZAK CESTLAVIE · Admin Ω.30</div>
  <div class="sub">Works(100) · /data/works.json 자동 관리 · DCAR 보고서 한·영 혼용 텍스트 그대로 유지 · GitHub Pages 연동</div>
  <div class="top-tabs">
    <button type="button" data-top="works" class="active">Works Manager</button>
    <button type="button" data-top="dcar">DCAR Reports Manager</button>
  </div>
</header>

<main>
  <!-- I. GITHUB 연결 설정 -->
  <section class="box" id="github-box">
    <h2>I. GITHUB 연결 설정</h2>
    <p class="help">
      아래 값은 브라우저 <code>localStorage</code>에만 저장됩니다. 서버로 전송되지 않습니다.<br>
      한 번 설정 저장 후에는 다시 입력할 필요가 없습니다.
    </p>

    <div class="field">
      <label for="ghOwner">GitHub Owner</label>
      <input id="ghOwner" type="text" placeholder="예: dungzakcestlavie">
    </div>

    <div class="field">
      <label for="ghRepo">Repository</label>
      <input id="ghRepo" type="text" placeholder="예: dungzakcestlavie.github.io">
    </div>

    <div class="field row">
      <div class="col-2">
        <label for="ghBranch">Branch</label>
        <input id="ghBranch" type="text" placeholder="예: main" value="main">
      </div>
      <div class="col-2">
        <label>알림</label>
        <div class="note">
          GitHub 토큰에는 <strong>repo &gt; contents: read/write</strong> 권한만 있으면 됩니다.
        </div>
      </div>
    </div>

    <div class="field">
      <label for="ghToken">Personal Access Token (github_pat_…)</label>
      <input id="ghToken" type="text" placeholder="github_pat_ 로 시작하는 토큰을 입력하세요">
      <small>이 토큰은 <strong>브라우저 안</strong>에만 저장되며, 다른 서버로 전송되지 않습니다.</small>
    </div>

    <div class="btn-row">
      <button type="button" class="btn gold" id="btnSaveCfg">설정 저장</button>
      <button type="button" class="btn" id="btnLoadCfg">불러오기</button>
      <button type="button" class="btn danger" id="btnResetCfg">초기화</button>
    </div>

    <div class="note">
      설정을 저장한 뒤 아래 Works / DCAR 업로드를 진행해 주세요.<br>
      저장된 설정은 언제든 다시 불러올 수 있습니다.
    </div>

    <div class="log" id="logCfg"></div>
  </section>

  <!-- TOP SWITCH: WORKS / DCAR -->
  <section class="box" id="works-box">
    <div class="switch-tabs" aria-label="Admin Mode">
      <button type="button" class="active" data-mode="works">Works</button>
      <button type="button" data-mode="dcar">DCAR (보고서)</button>
    </div>

    <!-- II-a. Works 업로드 -->
    <div id="works-panel">
      <h2>II. 작품 업로드 · 메타데이터 자동 관리 (Works 100)</h2>
      <p class="help">
        한 번에 <strong>1점씩</strong> 업로드합니다.<br>
        이미지는 <code>/images/zoom/파일명</code> &amp; <code>/images/standard/파일명</code> 두 위치에 저장되고,<br>
        <code>/data/works.json</code>에 자동으로 작품 정보가 추가됩니다.
      </p>

      <div class="field">
        <label for="workFile">1 · 작품 이미지 파일 (3000px 이상 JPG 권장)</label>
        <input id="workFile" type="file" accept="image/*">
      </div>

      <div class="field">
        <label for="workSection">2 · 섹션 선택 (Index · Works 섹션과 동일)</label>
        <select id="workSection">
          <option value="Light & Memory">Ⅰ 우리를 위해 기도해 주세요 · Pray for Us · Light & Memory</option>
          <option value="Human Prayer">Ⅱ 인간 · Human Being · Human Prayer</option>
          <option value="Rebirth">Ⅲ 정신의 재탄생 · Rebirth of Mind · Rebirth</option>
          <option value="Existence">Ⅳ 존재의 회복 · Restoration of Being · Existence</option>
          <option value="Cosmos">Ⅴ 빛의 초의식 · Metaconsciousness of Light · Cosmos</option>
        </select>
        <small>섹션 이름은 <code>Lightflow Ω.11</code> Index와 완전히 동일하게 유지됩니다.</small>
      </div>

      <div class="row">
        <div class="field col-2">
          <label for="workTitleKr">3 · 작품 제목 (KR)</label>
          <input id="workTitleKr" type="text" placeholder="예: 우리를 위해 기도해 주세요">
        </div>
        <div class="field col-2">
          <label for="workTitleEn">작품 제목 (EN)</label>
          <input id="workTitleEn" type="text" placeholder="예: Pray for Us">
        </div>
      </div>

      <div class="row">
        <div class="field col-2">
          <label for="workMatKr">재료 (KR)</label>
          <input id="workMatKr" type="text" placeholder="예: 아크릴릭 on canvas">
        </div>
        <div class="field col-2">
          <label for="workMatEn">Material (EN · 소문자)</label>
          <input id="workMatEn" type="text" placeholder="예: acrylic on canvas">
        </div>
      </div>

      <div class="row">
        <div class="field col-2">
          <label for="workSizeKr">사이즈 (KR)</label>
          <input id="workSizeKr" type="text" placeholder="예: 162.2×130.3cm">
        </div>
        <div class="field col-2">
          <label for="workSizeEn">Size (EN)</label>
          <input id="workSizeEn" type="text" placeholder="예: 162.2 × 130.3 cm">
        </div>
      </div>

      <div class="row">
        <div class="field col-2">
          <label for="workYear">제작 연도 (Year)</label>
          <input id="workYear" type="number" value="2025">
        </div>
        <div class="field col-2">
          <label>ID 자동 생성</label>
          <div class="note">
            기존 <code>works.json</code> 내 <code>DZ-XXX</code> 최대값을 찾아<br>
            그 다음 번호로 <strong>자동 ID</strong>가 부여됩니다. (예: DZ-001 → DZ-002)
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="btn gold" id="btnUploadWork">작품 업로드 · works.json 자동 갱신</button>
      </div>

      <div class="note">
        <span class="pill">중요</span>
        파일 이름은 공백이 있을 경우 자동으로 <code>_</code>(언더바)로 바뀌어 저장됩니다.<br>
        동일 파일명이 이미 존재하면 GitHub의 <code>sha</code>를 사용해 안전하게 덮어씁니다.
      </div>

      <div class="log" id="logWorks"></div>
    </div>

    <!-- II-b. DCAR 업로드 -->
    <div id="dcar-panel" style="display:none">
      <h2>II. DCAR 미학 보고서 업로드 · 파일은 그대로 유지</h2>
      <p class="help">
        Markdown 파일(.md)을 <strong>한·영 혼용 그대로</strong> 업로드합니다.<br>
        파일 내용은 <strong>절대 수정하지 않고</strong> GitHub에 저장되며,<br>
        <code>/reports/reports.json</code> 메타데이터만 자동 갱신됩니다.<br>
        Index(Reports)에서는 이 메타데이터를 사용해 카드와 제목을 보여주고,<br>
        <strong>본문은 항상 KR+EN 혼용</strong>으로 그대로 출력됩니다.
      </p>

      <div class="row">
        <div class="field col-3">
          <label for="dcarNumber">DCAR 번호</label>
          <input id="dcarNumber" type="number" placeholder="예: 10">
          <small>예: 10 → <code>DCAR-10-2025.md</code></small>
        </div>
        <div class="field col-3">
          <label for="dcarYear">연도 (Year)</label>
          <input id="dcarYear" type="number" value="2025">
        </div>
        <div class="field col-3">
          <label for="dcarCategory">카테고리</label>
          <select id="dcarCategory">
            <option value="theory">Theory</option>
            <option value="archive">Archive</option>
            <option value="practice">Practice</option>
          </select>
          <small>Index의 Reports 탭 필터와 연동됩니다.</small>
        </div>
      </div>

      <div class="row">
        <div class="field col-2">
          <label for="dcarTitleKo">보고서 제목 (KR)</label>
          <input id="dcarTitleKo" type="text" placeholder="예: 빛의 초의식">
        </div>
        <div class="field col-2">
          <label for="dcarTitleEn">Report Title (EN)</label>
          <input id="dcarTitleEn" type="text" placeholder="예: The Metaconsciousness of Light">
        </div>
      </div>

      <div class="row">
        <div class="field col-2">
          <label for="dcarSummaryKo">요약 (KR · 카드용)</label>
          <textarea id="dcarSummaryKo" placeholder="Index 카드에 들어갈 한국어 요약 텍스트"></textarea>
        </div>
        <div class="field col-2">
          <label for="dcarSummaryEn">Summary (EN · card)</label>
          <textarea id="dcarSummaryEn" placeholder="English abstract for the report card"></textarea>
        </div>
      </div>

      <div class="field">
        <label for="dcarFile">보고서 파일 (Markdown · .md)</label>
        <input id="dcarFile" type="file" accept=".md,text/markdown,text/plain">
        <small>
          기존 DCAR처럼 <strong>한 줄 KR / 한 줄 EN</strong> 혹은 단락 단위로<br>
          <strong>한·영 혼용 전체 텍스트를 그대로 붙여넣은 .md 파일</strong>을 선택해 주세요.
        </small>
      </div>

      <div class="btn-row">
        <button type="button" class="btn gold" id="btnUploadDcar">DCAR 파일 업로드 + reports.json 메타 갱신</button>
        <button type="button" class="btn" id="btnRefreshDcarList">현재 DCAR 목록 새로고침</button>
      </div>

      <div class="note">
        업로드 후: Index Reports 섹션에서 카드가 자동으로 추가되고,<br>
        <strong>전체 보기 / Open</strong>을 누르면 위 .md 파일이 <strong>KR+EN 혼용 그대로</strong> 표기됩니다.
      </div>

      <div class="log" id="logDcar"></div>

      <div class="field" style="margin-top:12px">
        <label>III. 현재 REPO의 DCAR 파일 목록 (reports/ 폴더)</label>
        <div class="log" id="logDcarList"></div>
      </div>
    </div>
  </section>

  <p class="tagline">
    Orchestrated with Lumera — Light, Memory, and Being.
  </p>
</main>

<footer>
  <div>© <strong>등작 燈酌 DUNGZAK CESTLAVIE</strong> · Admin Ω.30 — Works & DCAR Auto Manager</div>
</footer>

<script>
/* ========== 공통 헬퍼 ========== */
const $  = (q, root=document) => root.querySelector(q);
const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

function appendLog(el, msg, type){
  if(!el) return;
  const prefix = (type === 'err') ? '✖ ' : (type === 'ok') ? '✔ ' : '• ';
  const span = document.createElement('span');
  if(type) span.className = type;
  span.textContent = prefix + msg + '\\n';
  el.appendChild(span);
  el.scrollTop = el.scrollHeight;
}

function toBase64String(str){
  return btoa(unescape(encodeURIComponent(str)));
}

/* ========== GitHub 설정 ========== */
const CFG_KEY = 'dz_admin_github_v2';
function loadCfg(){
  try{
    const raw = localStorage.getItem(CFG_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_){ return null; }
}
function saveCfg(cfg){
  localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
}
function getCfgFromInputs(){
  return {
    owner : $('#ghOwner').value.trim(),
    repo  : $('#ghRepo').value.trim(),
    branch: $('#ghBranch').value.trim() || 'main',
    token : $('#ghToken').value.trim()
  };
}
function setInputsFromCfg(cfg){
  $('#ghOwner').value  = cfg?.owner  || '';
  $('#ghRepo').value   = cfg?.repo   || '';
  $('#ghBranch').value = cfg?.branch || 'main';
  $('#ghToken').value  = cfg?.token  || '';
}
function validateCfg(cfg){
  if(!cfg.owner || !cfg.repo || !cfg.branch || !cfg.token){
    throw new Error('Owner / Repo / Branch / Token 을 모두 입력해 주세요.');
  }
}
async function ghRequest(path, options={}, cfg){
  if(!cfg) cfg = loadCfg();
  validateCfg(cfg);

  const headers = Object.assign({
    'Accept':'application/vnd.github+json',
    'Authorization':'Bearer ' + cfg.token
  }, options.headers || {});

  const res = await fetch('https://api.github.com' + path, {
    method: options.method || 'GET',
    headers,
    body: options.body
  });

  if(!res.ok){
    const errText = await res.text().catch(()=> '');
    const msg = 'GitHub API 오류 (' + res.status + '): ' + (errText || res.statusText);
    throw new Error(msg);
  }
  if(res.status === 204) return null;
  return res.json();
}

/* ========== 헤더 / 탭 스위치 ========== */
(function(){
  // 상단 Works / DCAR 탭
  $$('.top-tabs button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.top-tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const mode = btn.getAttribute('data-top');
      if(mode === 'works'){
        $('#works-box').style.display = 'block';
      }else{
        $('#works-box').style.display = 'block'; // 하나의 박스 안에서 모드 전환
      }
      // 아래 내부 모드도 같이 전환
      if(mode === 'works'){
        $('#works-panel').style.display = 'block';
        $('#dcar-panel').style.display  = 'none';
      }else{
        $('#works-panel').style.display = 'none';
        $('#dcar-panel').style.display  = 'block';
      }
    });
  });

  // 내부 Works / DCAR 스위치
  $$('.switch-tabs button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.switch-tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const mode = btn.getAttribute('data-mode');
      if(mode === 'works'){
        $('#works-panel').style.display = 'block';
        $('#dcar-panel').style.display  = 'none';
      }else{
        $('#works-panel').style.display = 'none';
        $('#dcar-panel').style.display  = 'block';
      }
    });
  });
})();

/* ========== GitHub 설정 UI ========== */
(function(){
  const logEl = $('#logCfg');

  $('#btnSaveCfg').addEventListener('click', ()=>{
    logEl.textContent='';
    try{
      const cfg = getCfgFromInputs();
      validateCfg(cfg);
      saveCfg(cfg);
      appendLog(logEl,'설정을 localStorage에 저장했습니다.','ok');
    }catch(e){
      appendLog(logEl,e.message || String(e),'err');
    }
  });

  $('#btnLoadCfg').addEventListener('click', ()=>{
    logEl.textContent='';
    const cfg = loadCfg();
    if(!cfg){
      appendLog(logEl,'저장된 설정이 없습니다.','err');
      return;
    }
    setInputsFromCfg(cfg);
    appendLog(logEl,'저장된 설정을 불러왔습니다.','ok');
  });

  $('#btnResetCfg').addEventListener('click', ()=>{
    logEl.textContent='';
    localStorage.removeItem(CFG_KEY);
    setInputsFromCfg({owner:'',repo:'',branch:'main',token:''});
    appendLog(logEl,'설정을 초기화했습니다.','ok');
  });

  // 초기 로드 시 자동 로드
  const cfg = loadCfg();
  if(cfg) setInputsFromCfg(cfg);
})();

/* ========== Works 업로드 ========== */
(async function(){
  const log = $('#logWorks');

  async function readFileAsBase64(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> {
        const result = fr.result;
        const base64 = String(result).split(',')[1];
        resolve(base64);
      };
      fr.onerror = ()=>reject(fr.error || new Error('파일 읽기 실패'));
      fr.readAsDataURL(file);
    });
  }

  async function getWorksJson(cfg){
    const path = `/repos/${cfg.owner}/${cfg.repo}/contents/data/works.json?ref=${cfg.branch}`;
    try{
      const res = await ghRequest(path, {}, cfg);
      const content = atob(res.content.replace(/\\n/g,''));
      const json = JSON.parse(content || '{}');
      return { json, sha:res.sha || null };
    }catch(e){
      // 404 인 경우 새로 생성
      if(String(e.message||'').includes('404')){
        const empty = {
          "Light & Memory":[],
          "Human Prayer":[],
          "Rebirth":[],
          "Existence":[],
          "Cosmos":[]
        };
        appendLog(log,'기존 works.json 이 없어 새 파일을 생성합니다.','ok');
        return { json:empty, sha:null };
      }
      throw e;
    }
  }

  function nextId(worksObj){
    let max = 0;
    Object.values(worksObj).forEach(arr=>{
      if(!Array.isArray(arr)) return;
      arr.forEach(w=>{
        const m = /DZ-(\\d+)/.exec(w.id || '');
        if(m){
          const n = parseInt(m[1],10);
          if(!Number.isNaN(n) && n>max) max = n;
        }
      });
    });
    const next = max + 1;
    return 'DZ-' + String(next).padStart(3,'0');
  }

  async function uploadBinaryFile(pathInRepo, file, cfg){
    const base64 = await readFileAsBase64(file);

    // 기존 sha 확인 (있으면 덮어쓰기)
    let sha = null;
    try{
      const meta = await ghRequest(`/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(pathInRepo)}?ref=${cfg.branch}`, {}, cfg);
      sha = meta.sha || null;
    }catch(e){
      // 404면 무시
    }

    const body = {
      message:`Add image ${pathInRepo}`,
      content: base64,
      branch: cfg.branch
    };
    if(sha) body.sha = sha;

    await ghRequest(`/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(pathInRepo)}`, {
      method:'PUT',
      body: JSON.stringify(body),
      headers:{'Content-Type':'application/json'}
    }, cfg);
  }

  async function saveWorksJson(worksObj, sha, cfg){
    const content = JSON.stringify(worksObj,null,2);
    const body = {
      message:'Update data/works.json via Admin Ω.30',
      content: toBase64String(content),
      branch: cfg.branch
    };
    if(sha) body.sha = sha;

    await ghRequest(`/repos/${cfg.owner}/${cfg.repo}/contents/data/works.json`, {
      method:'PUT',
      body: JSON.stringify(body),
      headers:{'Content-Type':'application/json'}
    }, cfg);
  }

  $('#btnUploadWork').addEventListener('click', async ()=>{
    log.textContent='';

    const cfg = loadCfg();
    if(!cfg){
      appendLog(log,'먼저 GitHub 설정을 저장해 주세요.','err');
      return;
    }

    const file = $('#workFile').files[0];
    if(!file){
      appendLog(log,'작품 이미지 파일을 선택해 주세요.','err');
      return;
    }

    const section   = $('#workSection').value;
    const titleKr   = $('#workTitleKr').value.trim();
    const titleEn   = $('#workTitleEn').value.trim();
    const matKr     = $('#workMatKr').value.trim();
    const matEn     = $('#workMatEn').value.trim();
    const sizeKr    = $('#workSizeKr').value.trim();
    const sizeEn    = $('#workSizeEn').value.trim();
    const year      = String($('#workYear').value || '').trim();

    if(!titleKr && !titleEn){
      appendLog(log,'최소한 제목(KR 또는 EN) 하나는 입력해 주세요.','err');
      return;
    }

    try{
      appendLog(log,'works.json 을 불러오는 중…');
      const {json:worksObj, sha} = await getWorksJson(cfg);

      const id = nextId(worksObj);
      appendLog(log,`새 작품 ID: ${id}`,'ok');

      // 파일명 정리
      const origName = file.name;
      const safeName = origName.replace(/\\s+/g,'_');
      const zoomPath = `images/zoom/${safeName}`;
      const stdPath  = `images/standard/${safeName}`;

      appendLog(log,`이미지 업로드 (zoom): ${zoomPath}`);
      await uploadBinaryFile(zoomPath, file, cfg);
      appendLog(log,'zoom 업로드 완료','ok');

      appendLog(log,`이미지 업로드 (standard): ${stdPath}`);
      await uploadBinaryFile(stdPath, file, cfg);
      appendLog(log,'standard 업로드 완료','ok');

      const entry = {
        id,
        title_kr: titleKr,
        title_en: titleEn,
        material_kr: matKr,
        material_en: matEn,
        size_kr: sizeKr,
        size_en: sizeEn,
        year,
        image: safeName
      };

      if(!Array.isArray(worksObj[section])) worksObj[section] = [];
      worksObj[section].unshift(entry);

      appendLog(log,'data/works.json 저장 중…');
      await saveWorksJson(worksObj, sha, cfg);
      appendLog(log,'data/works.json 이 성공적으로 갱신되었습니다.','ok');
      appendLog(log,'→ 이제 Index(Works)에서 새 작품이 자동으로 보입니다.','ok');
    }catch(e){
      appendLog(log,e.message || String(e),'err');
    }
  });
})();

/* ========== DCAR 업로드 & 목록 ========== */
(function(){
  const log   = $('#logDcar');
  const logList = $('#logDcarList');

  async function readFileText(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=>resolve(String(fr.result||''));
      fr.onerror = ()=>reject(fr.error || new Error('파일 읽기 실패'));
      fr.readAsText(file,'utf-8');
    });
  }

  async function loadReportsJson(cfg){
    const path = `/repos/${cfg.owner}/${cfg.repo}/contents/reports/reports.json?ref=${cfg.branch}`;
    try{
      const res = await ghRequest(path, {}, cfg);
      const content = atob(res.content.replace(/\\n/g,''));
      const json = JSON.parse(content || '{}');
      const arr = Array.isArray(json.reports) ? json.reports : [];
      return { list:arr, sha:res.sha || null };
    }catch(e){
      if(String(e.message||'').includes('404')){
        appendLog(log,'기존 reports.json 이 없어 새 파일을 생성합니다.','ok');
        return { list:[], sha:null };
      }
      throw e;
    }
  }

  async function saveReportsJson(list, sha, cfg){
    const obj = { reports:list };
    const content = JSON.stringify(obj,null,2);
    const body = {
      message:'Update reports/reports.json via Admin Ω.30',
      content: toBase64String(content),
      branch: cfg.branch
    };
    if(sha) body.sha = sha;

    await ghRequest(`/repos/${cfg.owner}/${cfg.repo}/contents/reports/reports.json`, {
      method:'PUT',
      body: JSON.stringify(body),
      headers:{'Content-Type':'application/json'}
    }, cfg);
  }

  async function uploadDcarFile(id, year, file, cfg){
    const text = await readFileText(file);
    const base64 = toBase64String(text);
    const filename = id + '.md';
    const path = `reports/${filename}`;

    // 기존 sha 확인
    let sha = null;
    try{
      const meta = await ghRequest(`/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}?ref=${cfg.branch}`, {}, cfg);
      sha = meta.sha || null;
    }catch(e){
      // 404면 무시
    }

    const body = {
      message:`Add/Update ${filename} via Admin Ω.30`,
      content: base64,
      branch: cfg.branch
    };
    if(sha) body.sha = sha;

    await ghRequest(`/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`, {
      method:'PUT',
      body: JSON.stringify(body),
      headers:{'Content-Type':'application/json'}
    }, cfg);

    return '/reports/' + filename;
  }

  $('#btnUploadDcar').addEventListener('click', async ()=>{
    log.textContent='';
    const cfg = loadCfg();
    if(!cfg){
      appendLog(log,'먼저 GitHub 설정을 저장해 주세요.','err');
      return;
    }

    const num  = String($('#dcarNumber').value || '').trim();
    const year = String($('#dcarYear').value || '').trim() || '2025';
    const cat  = ($('#dcarCategory').value || 'theory').toLowerCase();
    const titleKo = $('#dcarTitleKo').value.trim();
    const titleEn = $('#dcarTitleEn').value.trim();
    const sumKo   = $('#dcarSummaryKo').value.trim();
    const sumEn   = $('#dcarSummaryEn').value.trim();
    const file    = $('#dcarFile').files[0];

    if(!num){
      appendLog(log,'DCAR 번호를 입력해 주세요. (예: 10)','err');
      return;
    }
    if(!file){
      appendLog(log,'.md 보고서 파일을 선택해 주세요.','err');
      return;
    }

    const id = `DCAR-${num}-${year}`;
    appendLog(log,`ID: ${id}`,'ok');

    try{
      appendLog(log,'DCAR .md 파일 업로드 중…');
      const mdPath = await uploadDcarFile(id, year, file, cfg);
      appendLog(log,`보고서 파일 업로드 완료: ${mdPath}`,'ok');

      appendLog(log,'reports.json 불러오는 중…');
      const {list, sha} = await loadReportsJson(cfg);

      const existingIdx = list.findIndex(r=>r.id===id);
      const entry = {
        id,
        title_ko: titleKo || titleEn || '',
        title_en: titleEn || titleKo || '',
        summary_ko: sumKo,
        summary_en: sumEn,
        category: cat,
        md_path: mdPath
      };

      if(existingIdx >= 0){
        list[existingIdx] = entry;
        appendLog(log,'기존 reports.json 항목을 덮어썼습니다.','ok');
      }else{
        list.push(entry);
        appendLog(log,'reports.json 에 새 항목을 추가했습니다.','ok');
      }

      appendLog(log,'reports.json 저장 중…');
      await saveReportsJson(list, sha, cfg);
      appendLog(log,'reports/reports.json 이 성공적으로 갱신되었습니다.','ok');
      appendLog(log,'→ Index Reports 카드 및 전체 보기가 한·영 혼용 본문과 함께 업데이트됩니다.','ok');

      await refreshDcarList(cfg);
    }catch(e){
      appendLog(log,e.message || String(e),'err');
    }
  });

  async function refreshDcarList(cfg){
    logList.textContent='';
    try{
      const res = await ghRequest(`/repos/${cfg.owner}/${cfg.repo}/contents/reports?ref=${cfg.branch}`, {}, cfg);
      if(!Array.isArray(res)){
        appendLog(logList,'reports/ 폴더 내용을 불러오지 못했습니다.','err');
        return;
      }
      res
        .filter(x=>x.type==='file' && /\\.md$/i.test(x.name))
        .sort((a,b)=>a.name.localeCompare(b.name))
        .forEach(f=>{
          appendLog(logList, f.name + ' — ' + (f.path || ''), 'ok');
        });
      if(!logList.textContent){
        appendLog(logList,'아직 DCAR .md 파일이 없습니다.','');
      }
    }catch(e){
      appendLog(logList,e.message || String(e),'err');
    }
  }

  $('#btnRefreshDcarList').addEventListener('click', async ()=>{
    const cfg = loadCfg();
    if(!cfg){
      appendLog(logList,'먼저 GitHub 설정을 저장해 주세요.','err');
      return;
    }
    await refreshDcarList(cfg);
  });

  // 초기 로드시 한번만 시도 (설정이 있을 때)
  const cfg0 = loadCfg();
  if(cfg0) refreshDcarList(cfg0).catch(()=>{});
})();
</script>
</body>
</html>