<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Lightflow Admin Ω.14 — Trigger</title>
<meta name="theme-color" content="#070c1a">
<style>
:root{--bg:#070c1a;--panel:#0b1020;--soft:#0f1730;--border:#1e2744;--fg:#e8edf7;--muted:#9fb0cc;--accent:#d4b97a;--ok:#72e0a7;--bad:#ff6b6b}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Pretendard,sans-serif}
header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#091227,transparent);padding:12px;border-bottom:1px solid var(--border);font-weight:800;color:var(--accent)}
.sub{font-size:12px;color:var(--muted)}
.container{max-width:880px;margin:0 auto;padding:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0}
h3{margin:0 0 10px;color:var(--accent);font-size:1.05rem}
input,button{width:100%;padding:10px 12px;font-size:15px;border-radius:10px;border:1px solid var(--border);background:var(--soft);color:var(--fg)}
button{cursor:pointer;font-weight:800}
.btn{background:var(--accent);color:#000;border:none}
.btn-ok{background:var(--ok);color:#012c1a;border:none}
.btn-ghost{background:#0f1a39;color:#cfe0ff;border:1px solid var(--border)}
.btn-bad{background:var(--bad);color:#000;border:none}
.grid2{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:760px){.grid2{grid-template-columns:1fr 1fr}}
small{color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1223;border:1px solid var(--border);border-radius:12px;color:var(--fg);padding:10px 14px;opacity:0;transition:opacity .2s;z-index:9}
.toast.show{opacity:1}
</style>
</head>
<body>
<header>🚀 Lightflow Admin Ω.14 — Trigger
  <div class="sub">등작 燈酌 DUNGZAK CESTLAVIE × Lumera · Pages Deploy Tools</div>
</header>

<div class="container">
  <!-- 0. 연결 상태 -->
  <div class="card">
    <h3>0. 연결 상태</h3>
    <div class="grid2">
      <div>
        <input id="owner"  placeholder="Owner (예: dungzakcestlavie)">
        <input id="repo"   placeholder="Repo (예: dungzakcestlavie.github.io)">
        <input id="branch" placeholder="Branch" value="main">
        <input id="token"  type="password" placeholder="GitHub Token (repo)">
      </div>
      <div>
        <button id="saveBtn"  class="btn">저장</button>
        <button id="testBtn"  class="btn-ok">연결 테스트</button>
        <button id="openAdmin" class="btn-ghost">Admin 열기</button>
        <button id="resetBtn" class="btn-bad">localStorage 초기화</button>
        <div id="hint" style="font-size:13px;color:var(--muted);margin-top:8px"></div>
      </div>
    </div>
    <small>Owner <span id="sOwner">-</span> · Repo <span id="sRepo">-</span> · Branch <span id="sBranch">-</span></small>
  </div>

  <!-- 1. 강제 트리거 -->
  <div class="card">
    <h3>1. 강제 트리거</h3>
    <div class="grid2">
      <button id="touchBtn" class="btn">✏️ Commit Touch (캐시 무효)</button>
      <button id="buildBtn" class="btn-ok">🚀 Pages Build 요청</button>
    </div>
    <small>touch 파일 커밋 후 Pages 빌드를 요청해 최신화합니다.</small>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ---------- helpers ---------- */
const $=s=>document.querySelector(s);
const say=(m,e=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=e?'#ff6b6b':'#22304f';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800);};
const cfg=k=>localStorage.getItem(k)||""; const setcfg=(k,v)=>localStorage.setItem(k,v);
const b64=s=>btoa(unescape(encodeURIComponent(s)));

/* iOS touch→click 안정 브리지 */
(function(){const isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);if(!isiOS)return;
function bind(el){if(el.__tapBound)return;el.__tapBound=1;let sx=0,sy=0;
el.addEventListener('touchstart',e=>{const t=e.changedTouches[0];sx=t.clientX;sy=t.clientY;},{passive:true});
el.addEventListener('touchend',e=>{const t=e.changedTouches[0];if(Math.abs(t.clientX-sx)<10&&Math.abs(t.clientY-sy)<10){e.preventDefault();el.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true}))}},{passive:false});}
function scan(){document.querySelectorAll('button,[onclick]').forEach(bind)}
window.addEventListener('load',scan);new MutationObserver(scan).observe(document.body,{subtree:true,childList:true});})();

/* ---------- config load ---------- */
function loadForm(){
  ["owner","repo","branch","token"].forEach(id=>{ if(cfg(id)) $("#"+id).value = cfg(id);});
  $("#sOwner").textContent = cfg("owner")||"–";
  $("#sRepo").textContent  = cfg("repo")||"–";
  $("#sBranch").textContent= cfg("branch")||"–";
  $("#hint").textContent   = "설정은 admin 페이지(localStorage)와 동일 값 사용.";
}
loadForm();

/* ---------- GitHub core ---------- */
async function gh(method,path,body=null,isJson=true){
  const token = cfg("token"); if(!token) throw new Error("토큰 없음");
  const r = await fetch(`https://api.github.com/${path}`,{
    method, headers:{Accept:"application/vnd.github+json","Authorization":`token ${token}`},
    body: body ? (isJson?JSON.stringify(body):body) : null
  });
  if(!r.ok) throw new Error(`GitHub ${r.status}: ${(await r.text()).slice(0,200)}`);
  return r.json();
}
async function getContent(p){
  try{
    const j=await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(p)}?ref=${cfg("branch")}`);
    return {exists:true,sha:j.sha};
  }catch(e){return {exists:false,sha:null};}
}
async function putFile(p,content,msg){
  const old=await getContent(p);
  const body={message:msg||`update ${p}`,content,branch:cfg("branch")};
  if(old.exists) body.sha=old.sha;
  return gh("PUT",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(p)}`,body);
}

/* ---------- actions ---------- */
function bind(id,fn){const el=$(id); if(!el) return; el.addEventListener("click",fn);}

bind("#saveBtn",()=>{["owner","repo","branch","token"].forEach(id=>setcfg(id,$("#"+id).value.trim()));loadForm();say("저장됨 ✅");});
bind("#openAdmin",()=>{location.href="/admin/admin-plus.html";});
bind("#resetBtn",()=>{localStorage.clear();say("초기화 완료");setTimeout(()=>location.reload(),350);});

bind("#testBtn", async ()=>{
  try{await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}`); say("연결 성공 (200) ✅");}
  catch(e){say("연결 실패: "+e.message,true);}
});

bind("#touchBtn", async ()=>{
  try{
    const stamp=new Date().toISOString();
    await putFile("data/.touch", b64("touch "+stamp), "touch");
    await putFile("data/.pages-touch", b64(stamp), "touch pages");
    say("Touch 커밋 완료 ✏️");
  }catch(e){say("Touch 실패: "+e.message,true);}
});

bind("#buildBtn", async ()=>{
  try{
    await gh("POST",`repos/${cfg("owner")}/${cfg("repo")}/pages/builds`,{});
    say("Pages Build 요청됨 🚀");
  }catch(e){say("Pages API 권한 없음 — touch로만 갱신됨",true);}
});
</script>
</body>
</html>