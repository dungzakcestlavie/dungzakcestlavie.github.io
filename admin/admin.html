<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Lightflow Admin Î©.15 â€” Unified Â· Reports</title>
<meta name="theme-color" content="#070c1a"/>
<style>
:root{
  --bg:#070c1a;--panel:#0b1020;--soft:#101835;--muted:#9fa8c0;
  --accent:#d4b97a;--ok:#74e0a1;--bad:#ff6b6b;--border:#1e2744;--radius:14px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:#e6edf6;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;line-height:1.5}
header{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,#101835,#0b1020);padding:.9rem 1rem;border-bottom:1px solid var(--border)}
h1{margin:0;font-size:18px;color:var(--accent);font-weight:800}
.sub{font-size:12px;color:var(--muted)}
.container{max-width:980px;margin:0 auto;padding:14px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin:14px 0}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,textarea,select{width:100%;background:#0e1733;color:#e6edf6;border:1px solid var(--border);border-radius:10px;padding:12px}
textarea{min-height:120px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{font-weight:800;cursor:pointer;border-radius:12px;border:1px solid var(--border);padding:12px 16px}
.btn-prim{background:var(--accent);color:#000}
.btn-sec{background:#0f1a39}
.btn-ok{background:var(--ok);color:#001a10}
.btn-bad{background:var(--bad);color:#000}
small{display:block;color:var(--muted);margin-top:6px}
hr{border:none;border-top:1px dashed var(--border);margin:14px 0}
pre{background:#0e1733;border:1px solid var(--border);border-radius:12px;padding:12px;white-space:pre-wrap}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1a39;border:1px solid var(--border);color:#e6edf6;padding:10px 14px;border-radius:12px;display:none}
.toast.show{display:block}
.nav{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.nav .chip{background:#0f1a39;border:1px solid var(--border);padding:10px 14px;border-radius:999px;color:#e6edf6}
code.k{color:#9ad}
@media (max-width:860px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>âœ¨ Lightflow Admin Î©.15 â€” Reports</h1>
  <div class="sub">ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Ã— Lumera Â· iPhone-Stable</div>
</header>

<div class="container">

  <!-- 0. GitHub ì—°ê²° -->
  <div class="card">
    <h3 style="margin:0 0 6px">0ï¸âƒ£ GitHub ì—°ê²°</h3>
    <div class="row">
      <div>
        <label>Owner</label>
        <input id="ghOwner" placeholder="ì˜ˆ: dungzakcestlavie">
      </div>
      <div>
        <label>Repo</label>
        <input id="ghRepo" placeholder="ì˜ˆ: dungzakcestlavie.github.io">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Branch</label>
        <input id="ghBranch" value="main">
      </div>
      <div>
        <label>Token (PAT) <small>Fine-grained Â· Contents: Read/Write</small></label>
        <input id="ghToken" type="password" placeholder="github_pat_...">
      </div>
    </div>
    <div class="btns">
      <button class="btn btn-prim" id="btnSaveCfg">ì €ì¥</button>
      <button class="btn btn-ok" id="btnTest">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <button class="btn btn-sec" id="btnPurge">ğŸš€ Pages ìºì‹œ ë¬´íš¨í™”(ì»¤ë°‹)</button>
      <button class="btn btn-bad" id="btnClearTok">í† í° ì‚­ì œ</button>
    </div>
    <small>ì„¤ì •/í† í°ì€ ì´ ë¸Œë¼ìš°ì €ì˜ <code class="k">localStorage</code>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</small>
    <div id="testResult" style="margin-top:8px;color:#9fa8c0"></div>
  </div>

  <!-- 1. ë¯¸í•™ ë³´ê³ ì„œ (DCAR) â€” í•œ/ì˜ ì œëª© + ë³¸ë¬¸ -->
  <div class="card">
    <h3 style="margin:0 0 6px">1ï¸âƒ£ ë¯¸í•™ ë³´ê³ ì„œ (DCAR) â€” í•œ/ì˜ ì œëª© + ë³¸ë¬¸</h3>
    <div class="row">
      <div>
        <label>Report ID</label>
        <input id="repId" placeholder="ì˜ˆ: DCAR01">
        <small>íŒŒì¼ ê²½ë¡œ: <code class="k">/reports/&lt;ID&gt;.md</code> Â· ìš”ì•½: <code class="k">/data/reports.json</code></small>
      </div>
      <div>
        <label>ì‘ì„±ì í‘œê¸°</label>
        <input id="repAuthor" value="ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Â· ë£¨ë©”ë¼ Lumera">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Title (EN)</label>
        <input id="titleEN" placeholder="English title">
      </div>
      <div>
        <label>ì œëª© (KO)</label>
        <input id="titleKO" placeholder="í•œêµ­ì–´ ì œëª©">
      </div>
    </div>

    <div class="row">
      <div>
        <label>ë³¸ë¬¸ (EN) â€” Paste</label>
        <textarea id="bodyEN" placeholder="Paste English body here"></textarea>
      </div>
      <div>
        <label>ë³¸ë¬¸ (KO) â€” ë¶™ì—¬ë„£ê¸°</label>
        <textarea id="bodyKO" placeholder="ì—¬ê¸°ì— í•œêµ­ì–´ ë³¸ë¬¸ì„ ë¶™ì—¬ë„£ê¸°"></textarea>
      </div>
    </div>

    <div class="btns">
      <button class="btn btn-prim" id="btnPreview">ë¯¸ë¦¬ë³´ê¸°</button>
      <button class="btn btn-ok" id="btnSaveReport">ğŸ“ ì €ì¥</button>
      <button class="btn btn-bad" id="btnDeleteReport">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button class="btn btn-sec" id="btnResetReport">í¼ ì¬ì„¤ì •</button>
      <button class="btn btn-sec" id="btnLoadReport">ë¶ˆëŸ¬ì˜¤ê¸°(ê¸°ì¡´ íŒŒì¼ â†’ í¼)</button>
    </div>

    <hr/>
    <details>
      <summary>ğŸ“„ ë¯¸ë¦¬ë³´ê¸°</summary>
      <pre id="previewBox">â€”</pre>
    </details>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
/* ========= Core Utils ========= */
const $ = sel => document.querySelector(sel);
const enc = str => btoa(unescape(encodeURIComponent(str))); // base64
const dec = b64 => decodeURIComponent(escape(atob(b64)));

const LS = {
  get(){ try{ return JSON.parse(localStorage.getItem('lf_cfg')||'{}'); }catch(e){ return {}; } },
  set(v){ localStorage.setItem('lf_cfg', JSON.stringify(v)); },
  clearToken(){
    const v = LS.get(); delete v.token; LS.set(v);
  }
};

function cfg(){
  const v = LS.get();
  return {
    owner: $('#ghOwner').value || v.owner || '',
    repo: $('#ghRepo').value || v.repo || '',
    branch: $('#ghBranch').value || v.branch || 'main',
    token: $('#ghToken').value || v.token || ''
  };
}

function saveCfg(){
  const v = cfg();
  LS.set({owner:v.owner, repo:v.repo, branch:v.branch, token:v.token});
  toast('ì„¤ì • ì €ì¥ ì™„ë£Œ');
}

function loadCfgForm(){
  const v = LS.get();
  if(v.owner) $('#ghOwner').value = v.owner;
  if(v.repo) $('#ghRepo').value = v.repo;
  if(v.branch) $('#ghBranch').value = v.branch;
  if(v.token) $('#ghToken').value = v.token;
}

/* ========= GitHub API ========= */
async function gh(path, method='GET', body=null){
  const v = cfg();
  if(!v.owner||!v.repo||!v.branch||!v.token) throw new Error('GitHub ì„¤ì •ì´ ë¹„ì–´ ìˆìŒ');
  const url = `https://api.github.com/repos/${v.owner}/${v.repo}${path}`;
  const res = await fetch(url, {
    method,
    headers: {
      'Accept':'application/vnd.github+json',
      'Authorization':`Bearer ${v.token}`
    },
    body: body ? JSON.stringify(body) : null
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`GitHub ${res.status}: ${t}`);
  }
  return res.json();
}

async function getContent(path){
  // GET /contents
  try{
    const v = cfg();
    return await gh(`/contents${path}?ref=${encodeURIComponent(v.branch)}`,'GET');
  }catch(e){
    if(String(e).includes('404')) return null; // not exist
    throw e;
  }
}

async function putContent(path, message, text, sha=null){
  const v = cfg();
  return gh(`/contents${path}`,'PUT',{
    message,
    content: enc(text),
    branch: v.branch,
    sha: sha || undefined
  });
}

async function deleteContent(path, message, sha){
  const v = cfg();
  return gh(`/contents${path}`,'DELETE',{
    message,
    sha,
    branch: v.branch
  });
}

/* ========= UI: Toast ========= */
let toastTimer;
function toast(msg){
  const el = $('#toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove('show'), 2200);
}

/* ========= Buttons ========= */
$('#btnSaveCfg').onclick = saveCfg;

$('#btnClearTok').onclick = () => {
  LS.clearToken();
  $('#ghToken').value='';
  toast('í† í° ì‚­ì œë¨');
};

$('#btnTest').onclick = async () => {
  try{
    const v = cfg();
    const r = await gh('/git/refs/heads/'+v.branch, 'GET');
    $('#testResult').textContent = 'ì—°ê²° OK (200) Â· head: ' + (r.object && r.object.sha ? r.object.sha.slice(0,7) : 'â€”');
    toast('ì—°ê²° OK');
  }catch(e){
    $('#testResult').textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + e.message;
    toast('ì—°ê²° ì‹¤íŒ¨');
  }
};

$('#btnPurge').onclick = async () => {
  try{
    const now = new Date().toISOString();
    await putContent('/touch.txt','chore: pages cache bust',`touch ${now}`);
    toast('Pages ìºì‹œ ë¬´íš¨í™” ì»¤ë°‹ ì™„ë£Œ');
  }catch(e){ toast('ì‹¤íŒ¨: '+e.message); }
};

/* ========= Reports (DCAR) ========= */

function buildMarkdown(meta){
  const {id, titleEN, titleKO, bodyEN, bodyKO, author} = meta;
  const updated = new Date().toISOString();
  return `---
id: ${id}
titleEN: "${(titleEN||'').replace(/"/g,'\\"')}"
titleKO: "${(titleKO||'').replace(/"/g,'\\"')}"
author: "${(author||'').replace(/"/g,'\\"')}"
updated: ${updated}
---

# ${titleKO||''}
${bodyKO||''}

---

# ${titleEN||''}
${bodyEN||''}
`;
}

function gatherForm(){
  return {
    id: ($('#repId').value||'').trim(),
    titleEN: $('#titleEN').value,
    titleKO: $('#titleKO').value,
    bodyEN: $('#bodyEN').value,
    bodyKO: $('#bodyKO').value,
    author: $('#repAuthor').value
  };
}

$('#btnPreview').onclick = () => {
  const md = buildMarkdown(gatherForm());
  $('#previewBox').textContent = md || 'â€”';
};

$('#btnResetReport').onclick = () => {
  $('#titleEN').value='';
  $('#titleKO').value='';
  $('#bodyEN').value='';
  $('#bodyKO').value='';
  $('#previewBox').textContent='â€”';
  toast('í¼ ì´ˆê¸°í™”');
};

$('#btnLoadReport').onclick = async () => {
  try{
    const { id } = gatherForm();
    if(!id) return toast('Report ID ì…ë ¥');
    const path = `/reports/${id}.md`;
    const obj = await getContent(path);
    if(!obj) return toast('íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
    const text = dec(obj.content);
    // front-matter ë‹¨ìˆœ íŒŒì‹±
    const tEN = /titleEN:\s*"(.*)"/.exec(text)?.[1] || '';
    const tKO = /titleKO:\s*"(.*)"/.exec(text)?.[1] || '';
    const author = /author:\s*"(.*)"/.exec(text)?.[1] || '';
    const parts = text.split('---');
    let body = parts.slice(2).join('---').trim();
    // ì¶”ì • ë¶„ë¦¬: KO ì•, EN ë’¤
    const sep = /\n---\n/.exec(body) ? body.indexOf('\n---\n') : -1;
    let ko='', en='';
    if(sep>0){ ko = body.slice(0,sep).trim(); en = body.slice(sep+5).trim(); }
    else { ko = body; en=''; }
    $('#titleEN').value = tEN;
    $('#titleKO').value = tKO;
    $('#repAuthor').value = author || $('#repAuthor').value;
    $('#bodyKO').value = ko.replace(/^# .*\n/,'');
    $('#bodyEN').value = en.replace(/^# .*\n/,'');
    toast('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
  }catch(e){ toast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message); }
};

async function updateReportsJson(meta){
  const path = '/data/reports.json';
  const now = new Date().toISOString();
  const stub = { id: meta.id, titleEN: meta.titleEN, titleKO: meta.titleKO, updated: now };
  const exist = await getContent(path);
  let data = [];
  if(exist){
    try{ data = JSON.parse(dec(exist.content)); }catch(_){}
    const i = data.findIndex(x=>x.id===meta.id);
    if(i>=0) data[i]=stub; else data.unshift(stub);
    await putContent(path,`chore: update reports.json (${meta.id})`, JSON.stringify(data,null,2), exist.sha);
  }else{
    data = [stub];
    await putContent(path,`chore: create reports.json (${meta.id})`, JSON.stringify(data,null,2));
  }
}

$('#btnSaveReport').onclick = async () => {
  try{
    const m = gatherForm();
    if(!m.id) return toast('Report IDê°€ í•„ìš”í•©ë‹ˆë‹¤');
    if(!m.titleEN || !m.titleKO) return toast('í•œ/ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
    const md = buildMarkdown(m);
    const path = `/reports/${m.id}.md`;
    const exist = await getContent(path);
    if(exist){
      await putContent(path, `feat(reports): update ${m.id}`, md, exist.sha);
    }else{
      await putContent(path, `feat(reports): create ${m.id}`, md);
    }
    await updateReportsJson(m);
    toast('ë³´ê³ ì„œ ì €ì¥ ì™„ë£Œ');
  }catch(e){ toast('ì €ì¥ ì‹¤íŒ¨: '+e.message); }
};

$('#btnDeleteReport').onclick = async () => {
  try{
    const { id } = gatherForm();
    if(!id) return toast('Report ID ì…ë ¥');
    const path = `/reports/${id}.md`;
    const exist = await getContent(path);
    if(!exist) return toast('íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
    await deleteContent(path, `chore(reports): delete ${id}`, exist.sha);
    // reports.jsonì—ì„œë„ ì œê±°
    const rj = await getContent('/data/reports.json');
    if(rj){
      let list = [];
      try{ list = JSON.parse(dec(rj.content)); }catch(_){}
      list = list.filter(x=>x.id!==id);
      await putContent('/data/reports.json', `chore: remove ${id} from reports.json`, JSON.stringify(list,null,2), rj.sha);
    }
    toast('ë³´ê³ ì„œ ì‚­ì œ ì™„ë£Œ');
  }catch(e){ toast('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
};

/* ========= Boot ========= */
loadCfgForm();
</script>
</body>
</html>