<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Lightflow Admin Ω.15 — Unified · Reports</title>
<meta name="theme-color" content="#070c1a"/>
<style>
:root{
  --bg:#070c1a;--panel:#0b1020;--soft:#101835;--muted:#9fa8c0;
  --accent:#d4b97a;--ok:#74e0a1;--bad:#ff6b6b;--border:#1e2744;--radius:14px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:#e6edf6;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;line-height:1.5}
header{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,#101835,#0b1020);padding:.9rem 1rem;border-bottom:1px solid var(--border)}
h1{margin:0;font-size:18px;color:var(--accent);font-weight:800}
.sub{font-size:12px;color:var(--muted)}
.container{max-width:980px;margin:0 auto;padding:14px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin:14px 0}
label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input,textarea,select{width:100%;background:#0e1733;color:#e6edf6;border:1px solid var(--border);border-radius:10px;padding:12px}
textarea{min-height:120px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{font-weight:800;cursor:pointer;border-radius:12px;border:1px solid var(--border);padding:12px 16px}
.btn-prim{background:var(--accent);color:#000}
.btn-sec{background:#0f1a39}
.btn-ok{background:var(--ok);color:#001a10}
.btn-bad{background:var(--bad);color:#000}
small{display:block;color:var(--muted);margin-top:6px}
hr{border:none;border-top:1px dashed var(--border);margin:14px 0}
pre{background:#0e1733;border:1px solid var(--border);border-radius:12px;padding:12px;white-space:pre-wrap}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1a39;border:1px solid var(--border);color:#e6edf6;padding:10px 14px;border-radius:12px;display:none}
.toast.show{display:block}
.nav{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.nav .chip{background:#0f1a39;border:1px solid var(--border);padding:10px 14px;border-radius:999px;color:#e6edf6}
code.k{color:#9ad}
@media (max-width:860px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>✨ Lightflow Admin Ω.15 — Reports</h1>
  <div class="sub">등작 燈酌 DUNGZAK CESTLAVIE × Lumera · iPhone-Stable</div>
</header>

<div class="container">

  <!-- 0. GitHub 연결 -->
  <div class="card">
    <h3 style="margin:0 0 6px">0️⃣ GitHub 연결</h3>
    <div class="row">
      <div>
        <label>Owner</label>
        <input id="ghOwner" placeholder="예: dungzakcestlavie">
      </div>
      <div>
        <label>Repo</label>
        <input id="ghRepo" placeholder="예: dungzakcestlavie.github.io">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Branch</label>
        <input id="ghBranch" value="main">
      </div>
      <div>
        <label>Token (PAT) <small>Fine-grained · Contents: Read/Write</small></label>
        <input id="ghToken" type="password" placeholder="github_pat_...">
      </div>
    </div>
    <div class="btns">
      <button class="btn btn-prim" id="btnSaveCfg">저장</button>
      <button class="btn btn-ok" id="btnTest">연결 테스트</button>
      <button class="btn btn-sec" id="btnPurge">🚀 Pages 캐시 무효화(커밋)</button>
      <button class="btn btn-bad" id="btnClearTok">토큰 삭제</button>
    </div>
    <small>설정/토큰은 이 브라우저의 <code class="k">localStorage</code>에만 저장됩니다.</small>
    <div id="testResult" style="margin-top:8px;color:#9fa8c0"></div>
  </div>

  <!-- 1. 미학 보고서 (DCAR) — 한/영 제목 + 본문 -->
  <div class="card">
    <h3 style="margin:0 0 6px">1️⃣ 미학 보고서 (DCAR) — 한/영 제목 + 본문</h3>
    <div class="row">
      <div>
        <label>Report ID</label>
        <input id="repId" placeholder="예: DCAR01">
        <small>파일 경로: <code class="k">/reports/&lt;ID&gt;.md</code> · 요약: <code class="k">/data/reports.json</code></small>
      </div>
      <div>
        <label>작성자 표기</label>
        <input id="repAuthor" value="등작 燈酌 DUNGZAK CESTLAVIE · 루메라 Lumera">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Title (EN)</label>
        <input id="titleEN" placeholder="English title">
      </div>
      <div>
        <label>제목 (KO)</label>
        <input id="titleKO" placeholder="한국어 제목">
      </div>
    </div>

    <div class="row">
      <div>
        <label>본문 (EN) — Paste</label>
        <textarea id="bodyEN" placeholder="Paste English body here"></textarea>
      </div>
      <div>
        <label>본문 (KO) — 붙여넣기</label>
        <textarea id="bodyKO" placeholder="여기에 한국어 본문을 붙여넣기"></textarea>
      </div>
    </div>

    <div class="btns">
      <button class="btn btn-prim" id="btnPreview">미리보기</button>
      <button class="btn btn-ok" id="btnSaveReport">📝 저장</button>
      <button class="btn btn-bad" id="btnDeleteReport">🗑️ 삭제</button>
      <button class="btn btn-sec" id="btnResetReport">폼 재설정</button>
      <button class="btn btn-sec" id="btnLoadReport">불러오기(기존 파일 → 폼)</button>
    </div>

    <hr/>
    <details>
      <summary>📄 미리보기</summary>
      <pre id="previewBox">—</pre>
    </details>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
/* ========= Core Utils ========= */
const $ = sel => document.querySelector(sel);
const enc = str => btoa(unescape(encodeURIComponent(str))); // base64
const dec = b64 => decodeURIComponent(escape(atob(b64)));

const LS = {
  get(){ try{ return JSON.parse(localStorage.getItem('lf_cfg')||'{}'); }catch(e){ return {}; } },
  set(v){ localStorage.setItem('lf_cfg', JSON.stringify(v)); },
  clearToken(){
    const v = LS.get(); delete v.token; LS.set(v);
  }
};

function cfg(){
  const v = LS.get();
  return {
    owner: $('#ghOwner').value || v.owner || '',
    repo: $('#ghRepo').value || v.repo || '',
    branch: $('#ghBranch').value || v.branch || 'main',
    token: $('#ghToken').value || v.token || ''
  };
}

function saveCfg(){
  const v = cfg();
  LS.set({owner:v.owner, repo:v.repo, branch:v.branch, token:v.token});
  toast('설정 저장 완료');
}

function loadCfgForm(){
  const v = LS.get();
  if(v.owner) $('#ghOwner').value = v.owner;
  if(v.repo) $('#ghRepo').value = v.repo;
  if(v.branch) $('#ghBranch').value = v.branch;
  if(v.token) $('#ghToken').value = v.token;
}

/* ========= GitHub API ========= */
async function gh(path, method='GET', body=null){
  const v = cfg();
  if(!v.owner||!v.repo||!v.branch||!v.token) throw new Error('GitHub 설정이 비어 있음');
  const url = `https://api.github.com/repos/${v.owner}/${v.repo}${path}`;
  const res = await fetch(url, {
    method,
    headers: {
      'Accept':'application/vnd.github+json',
      'Authorization':`Bearer ${v.token}`
    },
    body: body ? JSON.stringify(body) : null
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`GitHub ${res.status}: ${t}`);
  }
  return res.json();
}

async function getContent(path){
  // GET /contents
  try{
    const v = cfg();
    return await gh(`/contents${path}?ref=${encodeURIComponent(v.branch)}`,'GET');
  }catch(e){
    if(String(e).includes('404')) return null; // not exist
    throw e;
  }
}

async function putContent(path, message, text, sha=null){
  const v = cfg();
  return gh(`/contents${path}`,'PUT',{
    message,
    content: enc(text),
    branch: v.branch,
    sha: sha || undefined
  });
}

async function deleteContent(path, message, sha){
  const v = cfg();
  return gh(`/contents${path}`,'DELETE',{
    message,
    sha,
    branch: v.branch
  });
}

/* ========= UI: Toast ========= */
let toastTimer;
function toast(msg){
  const el = $('#toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove('show'), 2200);
}

/* ========= Buttons ========= */
$('#btnSaveCfg').onclick = saveCfg;

$('#btnClearTok').onclick = () => {
  LS.clearToken();
  $('#ghToken').value='';
  toast('토큰 삭제됨');
};

$('#btnTest').onclick = async () => {
  try{
    const v = cfg();
    const r = await gh('/git/refs/heads/'+v.branch, 'GET');
    $('#testResult').textContent = '연결 OK (200) · head: ' + (r.object && r.object.sha ? r.object.sha.slice(0,7) : '—');
    toast('연결 OK');
  }catch(e){
    $('#testResult').textContent = '연결 실패: ' + e.message;
    toast('연결 실패');
  }
};

$('#btnPurge').onclick = async () => {
  try{
    const now = new Date().toISOString();
    await putContent('/touch.txt','chore: pages cache bust',`touch ${now}`);
    toast('Pages 캐시 무효화 커밋 완료');
  }catch(e){ toast('실패: '+e.message); }
};

/* ========= Reports (DCAR) ========= */

function buildMarkdown(meta){
  const {id, titleEN, titleKO, bodyEN, bodyKO, author} = meta;
  const updated = new Date().toISOString();
  return `---
id: ${id}
titleEN: "${(titleEN||'').replace(/"/g,'\\"')}"
titleKO: "${(titleKO||'').replace(/"/g,'\\"')}"
author: "${(author||'').replace(/"/g,'\\"')}"
updated: ${updated}
---

# ${titleKO||''}
${bodyKO||''}

---

# ${titleEN||''}
${bodyEN||''}
`;
}

function gatherForm(){
  return {
    id: ($('#repId').value||'').trim(),
    titleEN: $('#titleEN').value,
    titleKO: $('#titleKO').value,
    bodyEN: $('#bodyEN').value,
    bodyKO: $('#bodyKO').value,
    author: $('#repAuthor').value
  };
}

$('#btnPreview').onclick = () => {
  const md = buildMarkdown(gatherForm());
  $('#previewBox').textContent = md || '—';
};

$('#btnResetReport').onclick = () => {
  $('#titleEN').value='';
  $('#titleKO').value='';
  $('#bodyEN').value='';
  $('#bodyKO').value='';
  $('#previewBox').textContent='—';
  toast('폼 초기화');
};

$('#btnLoadReport').onclick = async () => {
  try{
    const { id } = gatherForm();
    if(!id) return toast('Report ID 입력');
    const path = `/reports/${id}.md`;
    const obj = await getContent(path);
    if(!obj) return toast('파일이 존재하지 않음');
    const text = dec(obj.content);
    // front-matter 단순 파싱
    const tEN = /titleEN:\s*"(.*)"/.exec(text)?.[1] || '';
    const tKO = /titleKO:\s*"(.*)"/.exec(text)?.[1] || '';
    const author = /author:\s*"(.*)"/.exec(text)?.[1] || '';
    const parts = text.split('---');
    let body = parts.slice(2).join('---').trim();
    // 추정 분리: KO 앞, EN 뒤
    const sep = /\n---\n/.exec(body) ? body.indexOf('\n---\n') : -1;
    let ko='', en='';
    if(sep>0){ ko = body.slice(0,sep).trim(); en = body.slice(sep+5).trim(); }
    else { ko = body; en=''; }
    $('#titleEN').value = tEN;
    $('#titleKO').value = tKO;
    $('#repAuthor').value = author || $('#repAuthor').value;
    $('#bodyKO').value = ko.replace(/^# .*\n/,'');
    $('#bodyEN').value = en.replace(/^# .*\n/,'');
    toast('불러오기 완료');
  }catch(e){ toast('불러오기 실패: '+e.message); }
};

async function updateReportsJson(meta){
  const path = '/data/reports.json';
  const now = new Date().toISOString();
  const stub = { id: meta.id, titleEN: meta.titleEN, titleKO: meta.titleKO, updated: now };
  const exist = await getContent(path);
  let data = [];
  if(exist){
    try{ data = JSON.parse(dec(exist.content)); }catch(_){}
    const i = data.findIndex(x=>x.id===meta.id);
    if(i>=0) data[i]=stub; else data.unshift(stub);
    await putContent(path,`chore: update reports.json (${meta.id})`, JSON.stringify(data,null,2), exist.sha);
  }else{
    data = [stub];
    await putContent(path,`chore: create reports.json (${meta.id})`, JSON.stringify(data,null,2));
  }
}

$('#btnSaveReport').onclick = async () => {
  try{
    const m = gatherForm();
    if(!m.id) return toast('Report ID가 필요합니다');
    if(!m.titleEN || !m.titleKO) return toast('한/영 제목을 입력하세요');
    const md = buildMarkdown(m);
    const path = `/reports/${m.id}.md`;
    const exist = await getContent(path);
    if(exist){
      await putContent(path, `feat(reports): update ${m.id}`, md, exist.sha);
    }else{
      await putContent(path, `feat(reports): create ${m.id}`, md);
    }
    await updateReportsJson(m);
    toast('보고서 저장 완료');
  }catch(e){ toast('저장 실패: '+e.message); }
};

$('#btnDeleteReport').onclick = async () => {
  try{
    const { id } = gatherForm();
    if(!id) return toast('Report ID 입력');
    const path = `/reports/${id}.md`;
    const exist = await getContent(path);
    if(!exist) return toast('파일이 존재하지 않습니다');
    await deleteContent(path, `chore(reports): delete ${id}`, exist.sha);
    // reports.json에서도 제거
    const rj = await getContent('/data/reports.json');
    if(rj){
      let list = [];
      try{ list = JSON.parse(dec(rj.content)); }catch(_){}
      list = list.filter(x=>x.id!==id);
      await putContent('/data/reports.json', `chore: remove ${id} from reports.json`, JSON.stringify(list,null,2), rj.sha);
    }
    toast('보고서 삭제 완료');
  }catch(e){ toast('삭제 실패: '+e.message); }
};

/* ========= Boot ========= */
loadCfgForm();
</script>
</body>
</html>