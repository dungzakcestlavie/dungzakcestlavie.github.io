name: DUNGZAK CESTLAVIE Content Pipeline & Auto Deploy

on:
  push:
    branches: [ main ]
    paths:
      - "reports/**"
      - "images/**"
      - "works/**"
      - "data/**"
      - ".github/workflows/content-pipeline.yml"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  pipeline:
    name: Build & Sync Reports
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1) Admin Î©.20ì´ ê´€ë¦¬í•˜ëŠ” reports/reports.json ê²€ì¦ (ì†ŒìŠ¤ ì˜¤ë¸Œ íŠ¸ë£¨ìŠ¤)
      - name: Validate reports/reports.json (source of truth)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          if [ -f "reports/reports.json" ]; then
            jq . reports/reports.json > /dev/null
            echo "âœ… reports/reports.json is valid"
          else
            echo "âŒ reports/reports.json not found"
            exit 1
          fi

      # 2) data/reports.json ìœ¼ë¡œ ë³µì‚¬ (í”„ë¡ íŠ¸ì—”ë“œ/ì‚¬ì´íŠ¸ì—ì„œ ì°¸ì¡°í•  JSON)
      - name: Sync reports.json to data folder
        run: |
          mkdir -p data
          cp ./reports/reports.json ./data/reports.json
          echo "ğŸ“‚ Copied reports/reports.json â†’ data/reports.json"

      # 3) ì´ë¯¸ì§€ ì¸ë„¤ì¼ ìƒì„± (images í´ë”ê°€ ìˆì„ ë•Œë§Œ ë™ì‘)
      - name: Prepare thumbnails with ImageMagick
        run: |
          sudo apt-get install -y imagemagick
          mkdir -p public/thumbs
          if [ -d "images" ]; then
            find images -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | while read img; do
              out="public/thumbs/$(basename "$img")"
              convert "$img" -resize 1024x1024 "$out"
              echo "ğŸ–¼ thumb: $out"
            done
          else
            echo "âš ï¸ images folder not found, skipping thumbnails."
          fi

      # 4) ë³€ê²½ì‚¬í•­ë§Œ ì»¤ë°‹ & í‘¸ì‹œ (ì—†ìœ¼ë©´ ìŠ¤í‚µ)
      - name: Commit & Push changes
        run: |
          git config user.name "Lumera Bot"
          git config user.email "actions@github.com"

          git add data/reports.json public/thumbs || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-sync reports.json & thumbnails"
            git push
          fi
