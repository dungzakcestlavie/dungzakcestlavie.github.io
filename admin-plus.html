<script>
/* ==== Helpers (DOM/Store/Log) ==== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const log=(...a)=>{const el=$('#log'); el.textContent+=a.join(' ')+'\\n'; el.scrollTop=el.scrollHeight;};
const L={get:k=>localStorage.getItem(k)||'', set:(k,v)=>localStorage.setItem(k,v), del:k=>localStorage.removeItem(k)};
const S={get:k=>sessionStorage.getItem(k)||'', set:(k,v)=>sessionStorage.setItem(k,v), del:k=>sessionStorage.removeItem(k)};

/* ==== Config ==== */
const REPORTS=['DCAR01','DCAR02','DCAR03','DCAR04','DCAR05','DCAR06','DCAR07','DCAR08','DCAR09'];
const SECT_NAMES={pray:'Ⅰ Light & Memory',human:'Ⅱ Human Prayer',rebirth:'Ⅲ Rebirth',exist:'Ⅳ Restoration',cosmos:'Ⅴ Metaconsciousness'};

/* ==== UTF-8 Base64 ==== */
const b64enc=str=>{const b=new TextEncoder().encode(str); let bin=''; b.forEach(x=>bin+=String.fromCharCode(x)); return btoa(bin);};
const b64dec=b64=>{const bin=atob(b64||''); const u8=Uint8Array.from(bin,c=>c.charCodeAt(0)); return new TextDecoder().decode(u8);};

/* ==== GitHub API ==== */
const apiBase=()=>`https://api.github.com/repos/${L.get('o')}/${L.get('r')}`;
const headers=()=>{const h={Accept:'application/vnd.github+json'}; const t=S.get('t')||L.get('t'); if(t) h.Authorization=`token ${t}`; return h;};
async function ghGet(path){
  const r=await fetch(`${apiBase()}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(L.get('b')||'main')}`,{headers:headers()});
  if(!r.ok) return null; const j=await r.json(); return {sha:j.sha, text:b64dec(j.content||'')};
}
async function ghPutText(path,text,sha){
  const body={message:`update ${path}`,content:b64enc(text),branch:L.get('b')||'main'}; if(sha) body.sha=sha;
  const r=await fetch(`${apiBase()}/contents/${encodeURIComponent(path)}`,{method:'PUT',headers:{...headers(),'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){ const e=await r.json().catch(()=>({message:''})); throw new Error(`PUT ${r.status}: ${e.message||''}`); }
  return r.json();
}
async function ghPutBinary(path, fileOrBlob){
  const buf = await (fileOrBlob.arrayBuffer ? fileOrBlob.arrayBuffer() : fileOrBlob);
  const u8 = new Uint8Array(buf); let bin=''; for(let i=0;i<u8.length;i++) bin+=String.fromCharCode(u8[i]);
  const body={message:`upload ${path}`,content:btoa(bin),branch:L.get('b')||'main'};
  const r=await fetch(`${apiBase()}/contents/${encodeURIComponent(path)}`,{method:'PUT',headers:{...headers(),'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){ const e=await r.json().catch(()=>({message:''})); throw new Error(`UPLOAD ${r.status}: ${e.message||''}`); }
  return r.json();
}
async function ghDelete(path, sha){
  const r=await fetch(`${apiBase()}/contents/${encodeURIComponent(path)}`,{method:'DELETE',headers:{...headers(),'Content-Type':'application/json'},body:JSON.stringify({message:`delete ${path}`,sha,branch:L.get('b')||'main'})});
  if(!r.ok){ const e=await r.json().catch(()=>({message:''})); throw new Error(`DELETE ${r.status}: ${e.message||''}`); }
  return r.json();
}
async function safePut(path, text){
  try{ const f=await ghGet(path); return await ghPutText(path,text,f?f.sha:null); }
  catch(e){
    if((''+e.message).includes('409')||(''+e.message).includes('sha')){ const f=await ghGet(path); return await ghPutText(path,text,f?f.sha:null); }
    if((''+e.message).toLowerCase().includes('secondary rate limit')){ await new Promise(r=>setTimeout(r,1200)); const f=await ghGet(path); return await ghPutText(path,text,f?f.sha:null); }
    throw e;
  }
}

/* ==== Cache bust ==== */
async function bust(toast){
  const v=Date.now(); await safePut('data/cachebust.json', JSON.stringify({v}));
  if(toast) alert('캐시 갱신 완료'); try{ fetch(`/?_bust=${v}`,{mode:'no-cors'}); }catch{}
}

/* ==== Settings ==== */
function loadCfg(){
  $('#owner').value=L.get('o')||'dungzakcestlavie';
  $('#repo').value=L.get('r')||'dungzakcestlavie.github.io';
  $('#branch').value=L.get('b')||'main';
  $('#token').value=S.get('t')||L.get('t')||'';
  $('#remember').checked=!!L.get('t');
  $('#reportId').innerHTML = REPORTS.map(x=>`<option value="${x}">${x}</option>`).join('');
}
function saveCfg(){
  L.set('o',$('#owner').value.trim()); L.set('r',$('#repo').value.trim()); L.set('b',$('#branch').value.trim());
  const t=$('#token').value.trim(); S.set('t',t); if($('#remember').checked) L.set('t',t); else L.del('t');
  log('cfg saved.');
}
async function testConn(){
  $('#connMsg').textContent='테스트 중…';
  try{
    const r=await fetch(apiBase(),{headers:headers()}); const ok=r.ok; const j=await r.json().catch(()=>({}));
    $('#connMsg').textContent = ok ? `연결 OK · default=${j.default_branch}` : `실패(${r.status})`;
    if(!ok) log('conn fail:', r.status, j.message||''); else log('conn ok.');
  }catch(e){ $('#connMsg').textContent='실패'; log('conn err:', e.message||e); }
}

/* ==== Works.json ==== */
let WORKS = {pray:[],human:[],rebirth:[],exist:[],cosmos:[]};
const FIELDS=['title_kr','title_en','material_kr','material_en','size_kr','size_en','year','image','zoom','id'];
function sanitize(v){return String(v??'').replace(/\u00A0/g,' ').replace(/\r?\n+/g,' ').trim();}
function ensureWorksShape(){
  ['pray','human','rebirth','exist','cosmos'].forEach(k=>{ if(!Array.isArray(WORKS[k])) WORKS[k]=[]; });
}
async function loadWorks(){
  const f=await ghGet('data/works.json'); WORKS = f ? JSON.parse(f.text||'{}') : {pray:[],human:[],rebirth:[],exist:[],cosmos:[]};
  ensureWorksShape(); renderList(); log('works loaded.');
}
function findArtById(id){
  for(const k of Object.keys(WORKS)){ const i=WORKS[k].findIndex(x=>(x.id||'').toLowerCase()===id.toLowerCase()); if(i>-1) return {k,i}; }
  return null;
}
function upsertArtwork(obj, sectionKey){
  const id=(obj.id||'').trim(); if(!id) throw new Error('Artwork ID가 필요합니다.');
  const found=findArtById(id);
  if(found){ WORKS[found.k][found.i]=obj; }
  else{ (WORKS[sectionKey]=WORKS[sectionKey]||[]).push(obj); }
}
function removeArtwork(id){
  const f=findArtById(id); if(!f) return false;
  WORKS[f.k].splice(f.i,1); return true;
}
async function saveWorksJson(){
  await safePut('data/works.json', JSON.stringify(WORKS,null,2)); log('works saved.');
}

/* ==== ID 제안 ==== */
function suggestNextId(){
  const ids=[];
  for(const k of Object.keys(WORKS)){ for(const it of WORKS[k]) if(it.id) ids.push(it.id); }
  let max=0;
  ids.forEach(s=>{ const m=s.match(/(\d{1,4})$/); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; }});
  const nxt = String(max+1).padStart(3,'0');
  $('#artId').value = `DZ-${nxt}`; return `DZ-${nxt}`;
}

/* ==== 이미지 리사이즈 ==== */
async function resizeIfNeeded(file, maxPx, quality){
  if(!maxPx||maxPx<=0) return file;
  const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
  let {width:w,height:h}=img; const ratio=Math.max(w,h)/maxPx;
  if(ratio<=1) return file;
  w=Math.round(w/ratio); h=Math.round(h/ratio);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',Math.min(Math.max(quality||0.9,0.1),1)));
  return blob;
}

/* ==== Artworks Save/Delete ==== */
async function saveArtwork(withImages){
  try{
    const id=sanitize($('#artId').value); if(!id) throw new Error('Artwork ID가 필요합니다.');
    const section=$('#series').value;
    const stdFile=$('#imgStd').files[0]||null, zoomFile=$('#imgZoom').files[0]||null;
    const maxPx=parseInt($('#resizePx').value||'0',10)||0; const q=parseFloat($('#jpegQ').value||'0.9')||0.9;

    if(withImages){
      if(stdFile){ const f=await resizeIfNeeded(stdFile,maxPx,q); await ghPutBinary(`images/standard/${id}.jpg`, f); log('uploaded standard:', id); }
      if(zoomFile){ const f=await resizeIfNeeded(zoomFile,maxPx,q); await ghPutBinary(`images/zoom/${id}.jpg`, f); log('uploaded zoom:', id); }
    }

    const obj={
      id,
      title_kr:sanitize($('#titleKr').value),
      title_en:sanitize($('#titleEn').value),
      material_kr:sanitize($('#matKr').value),
      material_en:sanitize($('#matEn').value),
      size_kr:sanitize($('#size').value),
      size_en:sanitize($('#size').value),
      year:sanitize($('#year').value),
      image:`${id}.jpg`,
      zoom:`${id}.jpg`
    };
    upsertArtwork(obj, section); await saveWorksJson(); $('#artMsg').textContent='저장 완료';
    await bust(); // 즉시 반영
  }catch(e){ alert(e.message||e); }
}
async function deleteArtwork(){
  try{
    const id=sanitize($('#artId').value); if(!id) throw new Error('Artwork ID가 필요합니다.');
    const s=await ghGet(`images/standard/${id}.jpg`); if(s) await ghDelete(`images/standard/${id}.jpg`, s.sha);
    const z=await ghGet(`images/zoom/${id}.jpg`); if(z) await ghDelete(`images/zoom/${id}.jpg`, z.sha);
    const removed = removeArtwork(id); await saveWorksJson(); await bust();
    alert(removed ? '작품/이미지 삭제 완료' : '목록에 작품이 없어 메타만 건너뜀');
  }catch(e){ alert(e.message||e); }
}
async function saveAndNext(){ await saveArtwork(true); suggestNextId(); clearArtFieldsExceptId(); }
function clearArtFieldsExceptId(){
  ['titleKr','titleEn','year','matKr','matEn','size'].forEach(id=>$('#'+id).value='');
  $('#imgStd').value=''; $('#imgZoom').value='';
}

/* ==== 불러오기(단일 작품) ==== */
function loadById(){
  const id=sanitize($('#artId').value); if(!id){ alert('ID를 입력하세요.'); return; }
  const f=findArtById(id); if(!f){ alert('목록에 해당 ID가 없습니다. 먼저 목록 로드하세요.'); return; }
  const it=WORKS[f.k][f.i];
  $('#series').value=f.k;
  $('#titleKr').value=it.title_kr||''; $('#titleEn').value=it.title_en||'';
  $('#year').value=it.year||''; $('#matKr').value=it.material_kr||''; $('#matEn').value=it.material_en||''; $('#size').value=it.size_kr||it.size_en||'';
}

/* ==== 목록/검색/일괄 ==== */
function renderList(){
  const q=(($('#search').value)||'').toLowerCase();
  let rows=[];
  for(const k of Object.keys(WORKS)){
    for(const it of WORKS[k]){
      const hay=[it.id,it.title_kr,it.title_en,it.year,SECT_NAMES[k]].join(' ').toLowerCase();
      if(!q || hay.includes(q)){
        rows.push(`<tr><td>${SECT_NAMES[k]}</td><td>${it.id||''}</td><td>${it.title_kr||''}</td><td>${it.title_en||''}</td><td>${it.year||''}</td></tr>`);
      }
    }
  }
  $('#listWrap').innerHTML = `<table class="table"><thead><tr><th>섹션</th><th>ID</th><th>KR</th><th>EN</th><th>Year</th></tr></thead><tbody>${rows.join('')||'<tr><td colspan="5" class="note">데이터 없음</td></tr>'}</tbody></table>`;
}
function parseRows(raw){
  const lines=raw.split(/\r?\n/).filter(x=>x.trim());
  return lines.map(line=>{
    if(/\t/.test(line)) return line.split('\t');
    const out=[]; let cur='',q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){ if(line[i+1]==='"'){cur+='"'; i++;} else q=!q; }
      else if(c===',' && !q){ out.push(cur); cur=''; }
      else cur+=c;
    }
    out.push(cur); return out;
  });
}
function openBulkPaste(){
  const raw=prompt('표/CSV/탭 구분 텍스트를 붙여넣으세요.\n열: section(id: pray/human/rebirth/exist/cosmos), id, title_kr, title_en, material_kr, material_en, size_kr, size_en, year, image, zoom');
  if(!raw) return;
  const rows=parseRows(raw);
  rows.forEach(c=>{
    const o={};
    o.section=(c[0]||'').trim()||'pray';
    o.id=(c[1]||'').trim(); o.title_kr=(c[2]||'').trim(); o.title_en=(c[3]||'').trim();
    o.material_kr=(c[4]||'').trim(); o.material_en=(c[5]||'').trim();
    o.size_kr=(c[6]||'').trim(); o.size_en=(c[7]||'').trim();
    o.year=(c[8]||'').trim(); o.image=(c[9]||`${o.id}.jpg`); o.zoom=(c[10]||`${o.id}.jpg`);
    upsertArtwork({...o}, o.section);
  });
  saveWorksJson().then(()=>{renderList(); bust(); alert('일괄 반영 완료');});
}
function downloadWorks(){
  const blob=new Blob([JSON.stringify(WORKS,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='works.json'; a.click();
}

/* ==== Reports (MD) ==== */
function fmBuild(id,kr,en,bodyKr,bodyEn){
  return `---\\nid: ${id}\\ntitle_kr: "${kr.replace(/"/g,'\\"')}"\\ntitle_en: "${en.replace(/"/g,'\\"')}"\\n---\\n\\n# (KR)\\n${bodyKr}\\n\\n# (EN)\\n${bodyEn}\\n`;
}
function fmParse(text){
  const m = text.match(/^---\\s*[\\r\\n]+([\\s\\S]*?)---\\s*([\\s\\S]*)$/);
  let meta={}, rest=text;
  if(m){ const head=m[1], body=m[2]; rest=body;
    head.split(/\\r?\\n/).forEach(line=>{
      const mm=line.match(/^(\\w+):\\s*"(.*)"\\s*$/) || line.match(/^(\\w+):\\s*(.*)\\s*$/);
      if(mm) meta[mm[1]]=mm[2];
    });
  }
  const mk = rest.split(/\\n# \\(EN\\)\\n/);
  const bodyKr = mk[0].replace(/^# \\(KR\\)\\n/,'');
  const bodyEn = mk[1]||'';
  return {meta, bodyKr, bodyEn};
}
async function loadReport(){
  const id=$('#reportId').value;
  const f=await ghGet(`reports/${id}.md`);
  if(f){
    const {meta,bodyKr,bodyEn}=fmParse(f.text);
    $('#rTitleKr').value = meta.title_kr||''; $('#rTitleEn').value = meta.title_en||'';
    $('#rBodyKr').value = (bodyKr||'').trim(); $('#rBodyEn').value = (bodyEn||'').trim();
    alert(`${id} 불러오기 완료`);
  }else{
    $('#rTitleKr').value=''; $('#rTitleEn').value=''; $('#rBodyKr').value=''; $('#rBodyEn').value='';
    alert(`${id} 파일이 없어 새로 작성합니다.`);
  }
}
async function saveReport(){
  const id=$('#reportId').value;
  const text=fmBuild(id,$('#rTitleKr').value,$('#rTitleEn').value,$('#rBodyKr').value,$('#rBodyEn').value);
  await safePut(`reports/${id}.md`, text); await bust(true);
}
function openPrint(){
  const id=$('#reportId').value;
  window.open(`reports/print-preview.html?file=${encodeURIComponent(id+'.md')}`,'_blank');
}

/* ==== 임의 파일 ==== */
async function anyUpload(){
  try{
    const p=sanitize($('#anyPath').value); const f=$('#anyFile').files[0]; if(!p||!f) throw new Error('경로와 파일을 모두 지정하세요.');
    await ghPutBinary(p,f); await bust(true);
  }catch(e){ alert(e.message||e); }
}
async function anyDelete(){
  try{
    const p=sanitize($('#anyPath').value); if(!p) throw new Error('경로를 입력하세요.');
    const g=await ghGet(p); if(!g) throw new Error('파일이 없습니다.');
    await ghDelete(p,g.sha); await bust(true);
  }catch(e){ alert(e.message||e); }
}

/* ==== Drag & Drop ==== */
function inferKind(name){ return /zoom/i.test(name) ? 'zoom' : 'standard'; }
function inferId(name){
  const m = name.match(/([A-Za-z]+-\\d{1,4})/); if(m) return m[1];
  return ($('#artId').value||'').trim();
}
async function handleFiles(files){
  const maxPx=parseInt($('#resizePx').value||'0',10)||0; const q=parseFloat($('#jpegQ').value||'0.9')||0.9;
  for(const f of files){
    const id=inferId(f.name); if(!id){ log('skip (ID없음):', f.name); continue; }
    const kind=inferKind(f.name);
    const blob=await resizeIfNeeded(f,maxPx,q);
    await ghPutBinary(`images/${kind}/${id}.jpg`, blob);
    log('uploaded', kind, id);
  }
  await bust(true);
}
(function initDrop(){
  const dz=$('#dropZone');
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault(); dz.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault(); dz.classList.remove('drag');}));
  dz.addEventListener('drop', e=>{ const files=[...e.dataTransfer.files]; handleFiles(files);});
})();

/* ==== Events / Boot ==== */
function bind(){
  $('#btnCfgSave').onclick=saveCfg;
  $('#btnConnTest').onclick=testConn;

  $('#btnSuggest').onclick=suggestNextId;
  $('#btnLoadById').onclick=loadById;
  $('#btnArtSave').onclick=()=>saveArtwork(true);
  $('#btnMetaOnly').onclick=()=>saveArtwork(false);
  $('#btnArtDelete').onclick=deleteArtwork;
  $('#btnSaveNext').onclick=saveAndNext;
  $('#btnBust1').onclick=()=>bust(true);

  $('#btnWorksLoad').onclick=loadWorks;
  $('#search').oninput=renderList;
  $('#btnBulkPaste').onclick=openBulkPaste;
  $('#btnWorksDownload').onclick=downloadWorks;

  $('#reportId').innerHTML = REPORTS.map(x=>`<option value="${x}">${x}</option>`).join('');
  $('#btnReportLoad').onclick=loadReport;
  $('#btnReportSave').onclick=saveReport;
  $('#btnReportPreview').onclick=openPrint;
  $('#btnBust2').onclick=()=>bust(true);
}
loadCfg(); bind();
</script>
</body>
</html>