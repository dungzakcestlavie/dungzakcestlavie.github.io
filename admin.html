<!-- ① HEAD / STYLE — DUNGZAK Admin Ω.20 -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>등작 燈酌 DUNGZAK CESTLAVIE · Admin Ω.20 — Works & DCAR</title>

  <!-- 기본 설명 -->
  <meta name="description" content="등작 燈酌 DUNGZAK CESTLAVIE · Lightflow Ω — 작품(Works) & 미학 보고서(DCAR) 로컬 편집·JSON/MD 빌더 Admin." />
  <link rel="canonical" href="https://dungzak.art/" />

  <!-- 검색 / 다크모드 힌트 -->
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#070c1a" />

  <!-- OG / 공유 메타 -->
  <meta property="og:title" content="DUNGZAK CESTLAVIE · Admin Ω.20 — Works & DCAR" />
  <meta property="og:description" content="등작의 작품 아카이브와 DCAR 미학 보고서를 로컬에서 관리하는 Admin 페이지." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://dungzak.art/admin.html" />

  <!-- Twitter 카드 -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="DUNGZAK CESTLAVIE · Admin Ω.20" />
  <meta name="twitter:description" content="Lightflow Ω — Works & DCAR Local JSON / MD Builder." />

  <!-- 파비콘 (Index와 동일 스타일) -->
  <link
    rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2286%22>✨</text></svg>"
  />

  <style>
    :root {
      --bg: #070c1a;
      --panel: #0e152c;
      --panel-soft: #101833;
      --fg: #eaf0ff;
      --muted: #a8b7e8;
      --gold: #e6c777;
      --accent: #7aa5ff;
      --line: #222b55;
      --danger: #ff6b81;
      --max: 1160px;
      --radius-lg: 16px;
      --radius-md: 12px;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html {
      scroll-behavior: smooth;
    }
    body {
      background: radial-gradient(circle at top left, #111a3a 0, #070c1a 42%, #040613 100%);
      color: var(--fg);
      font: 15px/1.6 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR",
        sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    button {
      font: inherit;
    }

    /* 헤더 */
    header.admin {
      position: sticky;
      top: 0;
      z-index: 8;
      padding: 10px 14px 12px;
      background: linear-gradient(180deg, rgba(6, 10, 26, 0.96), rgba(6, 10, 26, 0.86));
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(12px);
    }
    .admin-bar {
      max-width: var(--max);
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px 14px;
    }
    .admin-brand-main {
      font-weight: 900;
      color: var(--gold);
      font-size: clamp(17px, 4vw, 21px);
    }
    .admin-brand-sub {
      font-size: 13px;
      color: var(--muted);
    }
    .admin-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-left: auto;
    }
    .pill {
      padding: 6px 11px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(9, 15, 40, 0.95);
      color: var(--muted);
      white-space: nowrap;
    }
    .pill.gold {
      background: linear-gradient(180deg, #fde7a9, #e6c777);
      color: #141322;
      border-color: #d7b866;
    }
    .pill.state-ok {
      border-color: #3a7e4e;
      color: #c9f2d3;
      background: rgba(9, 40, 24, 0.9);
    }
    .pill.state-warn {
      border-color: #ff9f43;
      color: #ffe1b8;
      background: rgba(60, 34, 5, 0.9);
    }

    /* 메인 컨테이너 */
    main.admin-main {
      max-width: var(--max);
      margin: 22px auto 48px;
      padding: 0 14px 40px;
    }

    /* 탭 내비 */
    .admin-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
    }
    .admin-tab-btn {
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 9px 16px;
      background: #0b1126;
      color: #cad5ff;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .admin-tab-btn.active {
      background: linear-gradient(180deg, #f8e3a6, #e6c777);
      color: #151324;
      border-color: #d7c36b;
    }

    /* 패널 공통 */
    .panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #182144, #0a1023 52%, #050815 100%);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 14px 44px rgba(0, 0, 0, 0.55);
      padding: 18px 18px 20px;
      margin-bottom: 22px;
    }
    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .panel-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--gold);
    }
    .panel-sub {
      font-size: 13px;
      color: var(--muted);
    }
    .panel-note {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    /* 폼 레이아웃 */
    .grid-2 {
      display: grid;
      gap: 14px 16px;
    }
    @media (min-width: 880px) {
      .grid-2 {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      }
    }

    .field-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--muted);
    }
    .inline-label-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 4px;
    }
    .inline-label-row label {
      margin-bottom: 0;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #252f5b;
      background: #050a1b;
      color: var(--fg);
      padding: 8px 10px;
      font: inherit;
      resize: vertical;
      min-height: 0;
    }
    textarea {
      min-height: 220px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid rgba(122, 165, 255, 0.9);
      outline-offset: 1px;
      border-color: #7aa5ff;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      font-size: 11px;
      padding: 2px 8px;
      background: rgba(16, 26, 60, 0.9);
      border: 1px solid rgba(122, 165, 255, 0.55);
      color: #d4e1ff;
      gap: 4px;
    }
    .badge.gold {
      background: rgba(60, 42, 10, 0.9);
      border-color: rgba(230, 199, 119, 0.8);
      color: #f7e7b8;
    }

    /* 버튼 */
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 7px 13px;
      background: #0b1328;
      color: #e3e7ff;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn.primary {
      background: linear-gradient(180deg, #f8e3a6, #e6c777);
      color: #151324;
      border-color: #d6c16b;
      font-weight: 700;
    }
    .btn.subtle {
      background: #050815;
      color: var(--muted);
    }
    .btn.danger {
      background: rgba(74, 17, 26, 0.96);
      color: #ffd4e0;
      border-color: rgba(255, 69, 104, 0.7);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 리스트 */
    .report-list {
      margin-top: 8px;
      border-radius: var(--radius-md);
      background: var(--panel-soft);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 10px 10px 6px;
      max-height: 420px;
      overflow: auto;
    }
    .report-item {
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .report-item + .report-item {
      margin-top: 4px;
    }
    .report-item span.id {
      font-weight: 700;
      color: var(--accent);
      min-width: 64px;
    }
    .report-item span.title {
      flex: 1;
      color: #e6ecff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .report-item span.cat {
      font-size: 11px;
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(122, 165, 255, 0.6);
      color: #d3e2ff;
    }
    .report-item.active {
      border-color: rgba(230, 199, 119, 0.85);
      background: radial-gradient(circle at left, rgba(255, 230, 160, 0.12), transparent 60%);
    }
    .report-empty {
      font-size: 12px;
      color: var(--muted);
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
    }

    .status-line {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .status-line strong {
      color: #f7e3a3;
    }

    /* 숨김 패널 */
    .panel[hidden] {
      display: none;
    }
  </style>
</head> <!-- ② BODY / HTML — DUNGZAK Admin Ω.20 -->
<body>
  <header class="admin">
    <div class="admin-bar">
      <div>
        <div class="admin-brand-main">등작 燈酌 DUNGZAK CESTLAVIE · Admin Ω.20</div>
        <div class="admin-brand-sub">Works & DCAR · Local JSON / MD Builder</div>
      </div>
      <div class="admin-pill-row">
        <div class="pill">KR 인터페이스</div>
        <div class="pill state-ok" id="lsState">Local Storage: checking…</div>
      </div>
    </div>
  </header>

  <main class="admin-main">
    <!-- 상단 탭 -->
    <nav class="admin-tabs" aria-label="Admin sections">
      <button type="button" class="admin-tab-btn active" data-admin-panel="dashboard">
        Dashboard
      </button>
      <button type="button" class="admin-tab-btn" data-admin-panel="works">Works JSON</button>
      <button type="button" class="admin-tab-btn" data-admin-panel="dcar">DCAR Reports</button>
      <button type="button" class="admin-tab-btn" data-admin-panel="settings">Settings / Notes</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="panel-dashboard" class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Dashboard</div>
          <div class="panel-sub">
            인덱스(사용자-facing)와 동일한 색감·리듬으로 맞춘 Admin Ω.20입니다.
          </div>
        </div>
      </div>
      <p class="panel-note">
        • Works JSON: Lightflow 5개 섹션용 <code>artworks.json / works.json</code>을 구성합니다.<br />
        • DCAR Reports: 미학 보고서 원문(KR+EN)을 한 번에 붙여넣고, 로컬에 저장 + MD/JSON으로
        내보낼 수 있습니다.
      </p>
      <p class="panel-note">
        모든 데이터는 먼저 브라우저의 <strong>LocalStorage</strong>에 저장되고, 등작이 원할 때
        <strong>JSON / MD 파일로 다운로드</strong>한 뒤 GitHub에 업로드하는 구조입니다.
      </p>
    </section>

    <!-- WORKS JSON (간단 버전 / 기존 구조 참고용) -->
    <section id="panel-works" class="panel" hidden>
      <div class="panel-header">
        <div>
          <div class="panel-title">Works JSON · 작품 아카이브</div>
          <div class="panel-sub">
            Lightflow 인덱스의 5개 섹션(Pray / Human / Rebirth / Restoration / Metaconsciousness)에
            맞춰 작품 정보를 정리합니다.
          </div>
        </div>
      </div>
      <div class="panel-note">
        아래 폼은 최소 골격만 포함한 버전입니다. 지금까지 쓰던 Admin Ω.19의 Works 로직을 유지하고
        싶으면, 이 영역만 기존 스크립트와 합쳐 써도 됩니다.
      </div>
      <div class="panel-note">
        등작이 요청하면, 나중에 Works 쪽도 지금 Index 구조(<code>Light & Memory</code> 등)와 완전히
        맞춰 다시 설계해 줄게요.
      </div>
    </section>

    <!-- DCAR REPORTS -->
    <section id="panel-dcar" class="panel" hidden>
      <div class="panel-header">
        <div>
          <div class="panel-title">DCAR Reports · 미학 보고서</div>
          <div class="panel-sub">
            A안 — <strong>KR+EN 원문 전체를 한 번에</strong> 붙여넣고, 로컬 저장 + MD/JSON 내보내기.
          </div>
        </div>
        <span class="badge gold">DCAR · Local MD Builder</span>
      </div>

      <div class="grid-2">
        <!-- 왼쪽: 입력 -->
        <div>
          <div class="field-group">
            <div class="inline-label-row">
              <label for="dcarId">ID</label>
              <span class="hint">예: <code>DCAR01</code>, <code>DCAR09</code></span>
            </div>
            <input id="dcarId" type="text" placeholder="DCAR01" autocomplete="off" />
          </div>

          <div class="field-group">
            <div class="inline-label-row">
              <label for="dcarYear">연도 / Year</label>
              <span class="hint">예: <code>2025</code></span>
            </div>
            <input id="dcarYear" type="number" min="1990" max="2100" placeholder="2025" />
          </div>

          <div class="field-group">
            <label for="dcarCategory">Category</label>
            <select id="dcarCategory">
              <option value="Theory">Theory</option>
              <option value="Archive">Archive</option>
              <option value="Practice">Practice</option>
            </select>
          </div>

          <div class="field-group">
            <label for="dcarTitleKr">제목 (KR)</label>
            <input
              id="dcarTitleKr"
              type="text"
              placeholder="빛 · 기억 · 존재에 대한 미학 보고서"
              autocomplete="off"
            />
          </div>

          <div class="field-group">
            <label for="dcarTitleEn">Title (EN)</label>
            <input
              id="dcarTitleEn"
              type="text"
              placeholder="On Light, Memory, and Being"
              autocomplete="off"
            />
          </div>

          <div class="field-group">
            <div class="inline-label-row">
              <label for="dcarSlug">파일 슬러그 / File slug</label>
              <span class="hint">Index에서 불러올 md 파일명. 예: <code>DCAR-01-2025</code></span>
            </div>
            <input
              id="dcarSlug"
              type="text"
              placeholder="DCAR-01-2025"
              autocomplete="off"
            />
          </div>

          <div class="field-group">
            <label for="dcarSummaryKr">요약 (KR)</label>
            <textarea
              id="dcarSummaryKr"
              placeholder="보고서의 핵심 개요를 한국어로 간단히 적습니다."
              rows="3"
            ></textarea>
          </div>

          <div class="field-group">
            <label for="dcarSummaryEn">Summary (EN)</label>
            <textarea
              id="dcarSummaryEn"
              placeholder="Brief abstract of the report in English."
              rows="3"
            ></textarea>
          </div>

          <div class="btn-row">
            <button type="button" class="btn primary" id="btnSaveReport">현재 보고서 저장 / Update</button>
            <button type="button" class="btn subtle" id="btnNewReport">새 보고서 / New</button>
            <button type="button" class="btn danger" id="btnDeleteReport">삭제 / Delete</button>
          </div>

          <div class="status-line" id="dcarStatus">상태: 아직 저장되지 않음.</div>
        </div>

        <!-- 오른쪽: 원문 & 리스트 -->
        <div>
          <div class="field-group">
            <div class="inline-label-row">
              <label for="dcarFullText">Full Text · KR+EN 원문 전체</label>
              <span class="badge">
                ⓘ 원문 그대로 붙여넣기
              </span>
            </div>
            <textarea
              id="dcarFullText"
              placeholder="등작 燈酌 DUNGZAK CESTLAVIE&#10;&#10;On Light, Memory, and Being&#10;루메라 Lumera / Aesthetic Theorist&#10;..."
            ></textarea>
            <div class="hint">
              • 시 / 문단 / 구분선(⸻) / 공백을 모두 유지합니다. <br />
              • Admin은 이 내용을 그대로
              <code>slug.md</code> (예: <code>DCAR-01-2025.md</code>) 로 저장할 수 있게 도와줍니다.
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn" id="btnExportJson">모든 보고서 JSON 다운로드</button>
            <button type="button" class="btn" id="btnExportMd">현재 보고서 MD 다운로드</button>
          </div>

          <div class="field-group" style="margin-top: 14px;">
            <label>저장된 DCAR 목록</label>
            <div class="report-list" id="reportList">
              <div class="report-empty">아직 저장된 보고서가 없습니다.</div>
            </div>
            <div class="hint">
              목록에서 항목을 탭하면 해당 보고서가 왼쪽 폼에 로드됩니다.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="panel-settings" class="panel" hidden>
      <div class="panel-header">
        <div>
          <div class="panel-title">Settings / Notes</div>
          <div class="panel-sub">간단한 메모 및 Admin 사용 안내.</div>
        </div>
      </div>
      <p class="panel-note">
        • 이 Admin은 어디까지나 <strong>로컬 편집기</strong>이므로, 실제 웹에 반영하려면<br />
        1) <code>artworks.json</code>, 2) <code>reports.json</code>, 3) 각 <code>*.md</code> 파일을 GitHub
        저장소에 업로드해야 합니다.<br /><br />
        • DCAR A안: 등작이 정리한
        <strong>한·영 혼용 원문 전체</strong>를 Admin에서 한 번만 관리하고, MD 파일을 내려받아
        사용합니다.
      </p>
    </section>
  </main>
</body> <!-- ③ SCRIPT — DUNGZAK Admin Ω.20 (DCAR A안) -->
<script>
  /* ===== 작은 도우미 ===== */
  const $ = (q, sc) => (sc || document).querySelector(q);
  const $$ = (q, sc) => Array.from((sc || document).querySelectorAll(q));

  /* ===== 상단 탭 전환 ===== */
  (function () {
    const buttons = $$('.admin-tab-btn');
    const panels = {
      dashboard: $('#panel-dashboard'),
      works: $('#panel-works'),
      dcar: $('#panel-dcar'),
      settings: $('#panel-settings')
    };
    function show(id) {
      buttons.forEach((b) => b.classList.toggle('active', b.dataset.adminPanel === id));
      Object.entries(panels).forEach(([key, el]) => {
        if (!el) return;
        el.hidden = key !== id;
      });
    }
    buttons.forEach((b) =>
      b.addEventListener('click', () => {
        show(b.dataset.adminPanel || 'dashboard');
      })
    );
    show('dashboard');
  })();

  /* ===== LocalStorage 상태 체크 ===== */
  (function () {
    const el = $('#lsState');
    try {
      const testKey = '__dz_admin_test__';
      localStorage.setItem(testKey, 'ok');
      localStorage.removeItem(testKey);
      el.textContent = 'Local Storage: active';
      el.classList.remove('state-warn');
      el.classList.add('state-ok');
    } catch (e) {
      el.textContent = 'Local Storage: unavailable';
      el.classList.remove('state-ok');
      el.classList.add('state-warn');
    }
  })();

  /* ===== DCAR REPORTS (A안: Full Text 1개 필드) ===== */
  (function () {
    const LS_KEY = 'dz_admin_dcar_reports_v20';

    const idEl = $('#dcarId');
    const yearEl = $('#dcarYear');
    const catEl = $('#dcarCategory');
    const titleKrEl = $('#dcarTitleKr');
    const titleEnEl = $('#dcarTitleEn');
    const slugEl = $('#dcarSlug');
    const sumKrEl = $('#dcarSummaryKr');
    const sumEnEl = $('#dcarSummaryEn');
    const fullEl = $('#dcarFullText');
    const statusEl = $('#dcarStatus');
    const listEl = $('#reportList');

    const btnSave = $('#btnSaveReport');
    const btnNew = $('#btnNewReport');
    const btnDel = $('#btnDeleteReport');
    const btnJson = $('#btnExportJson');
    const btnMd = $('#btnExportMd');

    /** @type {{id:string,year:number,category:string,titleKr:string,titleEn:string,slug:string,summaryKr:string,summaryEn:string,fullText:string}[]} */
    let reports = [];
    let currentId = null;

    function loadFromLS() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) reports = parsed;
      } catch (e) {
        console.warn('Failed to parse DCAR LS', e);
      }
    }

    function saveToLS() {
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(reports));
      } catch (e) {
        console.warn('Failed to save DCAR LS', e);
      }
    }

    function clearForm() {
      idEl.value = '';
      yearEl.value = '';
      catEl.value = 'Theory';
      titleKrEl.value = '';
      titleEnEl.value = '';
      slugEl.value = '';
      sumKrEl.value = '';
      sumEnEl.value = '';
      fullEl.value = '';
      currentId = null;
      statusEl.textContent = '상태: 아직 저장되지 않음.';
      $$('.report-item', listEl).forEach((li) => li.classList.remove('active'));
    }

    function fillForm(r) {
      if (!r) return;
      idEl.value = r.id || '';
      yearEl.value = r.year || '';
      catEl.value = r.category || 'Theory';
      titleKrEl.value = r.titleKr || '';
      titleEnEl.value = r.titleEn || '';
      slugEl.value = r.slug || '';
      sumKrEl.value = r.summaryKr || '';
      sumEnEl.value = r.summaryEn || '';
      fullEl.value = r.fullText || '';
      currentId = r.id || null;
      statusEl.textContent = `상태: ${r.id} 로드됨.`;
    }

    function renderList() {
      listEl.innerHTML = '';
      if (!reports.length) {
        const div = document.createElement('div');
        div.className = 'report-empty';
        div.textContent = '아직 저장된 보고서가 없습니다.';
        listEl.appendChild(div);
        return;
      }
      reports
        .slice()
        .sort((a, b) => (a.id > b.id ? 1 : -1))
        .forEach((r) => {
          const item = document.createElement('div');
          item.className = 'report-item';
          if (r.id === currentId) item.classList.add('active');

          const idSpan = document.createElement('span');
          idSpan.className = 'id';
          idSpan.textContent = r.id || '(ID?)';

          const titleSpan = document.createElement('span');
          titleSpan.className = 'title';
          titleSpan.textContent =
            r.titleKr || r.titleEn || (r.slug ? r.slug : '(제목 없음 / Untitled)');

          const catSpan = document.createElement('span');
          catSpan.className = 'cat';
          catSpan.textContent = r.category || 'Theory';

          item.appendChild(idSpan);
          item.appendChild(titleSpan);
          item.appendChild(catSpan);

          item.addEventListener('click', () => {
            currentId = r.id;
            fillForm(r);
            $$('.report-item', listEl).forEach((li) => li.classList.remove('active'));
            item.classList.add('active');
          });

          listEl.appendChild(item);
        });
    }

    function buildFromForm() {
      const id = idEl.value.trim();
      if (!id) {
        alert('ID(예: DCAR01)를 입력해 주세요.');
        idEl.focus();
        return null;
      }
      const year = parseInt(yearEl.value, 10) || new Date().getFullYear();
      const category = catEl.value || 'Theory';
      const titleKr = titleKrEl.value.trim();
      const titleEn = titleEnEl.value.trim();
      const slug = (slugEl.value || id).trim() || id;
      const summaryKr = sumKrEl.value;
      const summaryEn = sumEnEl.value;
      const fullText = fullEl.value;

      if (!fullText.trim()) {
        if (!confirm('Full Text가 비어 있습니다. 그래도 저장할까요?')) {
          return null;
        }
      }

      return {
        id,
        year,
        category,
        titleKr,
        titleEn,
        slug,
        summaryKr,
        summaryEn,
        fullText
      };
    }

    function upsertReport() {
      const data = buildFromForm();
      if (!data) return;
      const idx = reports.findIndex((r) => r.id === data.id);
      if (idx >= 0) reports[idx] = data;
      else reports.push(data);
      currentId = data.id;
      saveToLS();
      renderList();
      statusEl.textContent = `상태: ${data.id} 저장 완료 (LocalStorage).`;
    }

    function deleteReport() {
      const id = idEl.value.trim();
      if (!id) {
        alert('삭제할 보고서 ID가 없습니다.');
        return;
      }
      if (!confirm(`${id} 보고서를 정말 삭제할까요? (LocalStorage에서 제거)`)) return;
      reports = reports.filter((r) => r.id !== id);
      saveToLS();
      clearForm();
      renderList();
      statusEl.textContent = `상태: ${id} 삭제됨.`;
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportJson() {
      if (!reports.length) {
        alert('내보낼 보고서가 없습니다.');
        return;
      }
      const payload = {
        generated_at: new Date().toISOString(),
        items: reports
      };
      downloadFile('reports.json', JSON.stringify(payload, null, 2));
    }

    function exportCurrentMd() {
      const data = buildFromForm();
      if (!data) return;
      const fileName = `${data.slug || data.id}.md`;
      const text = data.fullText || '';
      downloadFile(fileName, text);
      statusEl.textContent = `상태: ${fileName} MD 파일 다운로드 완료.`;
    }

    // 이벤트 연결
    btnSave?.addEventListener('click', upsertReport);
    btnNew?.addEventListener('click', () => {
      if (fullEl.value.trim() || idEl.value.trim()) {
        if (!confirm('입력 중인 내용을 지우고 새 보고서를 시작할까요?')) return;
      }
      clearForm();
    });
    btnDel?.addEventListener('click', deleteReport);
    btnJson?.addEventListener('click', exportJson);
    btnMd?.addEventListener('click', exportCurrentMd);

    // 초기 로드
    loadFromLS();
    renderList();
  })();
</script>