<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1" />
<title>Lightflow Admin — Batch Uploader (Ω.10.1 · iPhone-Stable)</title>
<meta name="theme-color" content="#070c1a" />
<style>
:root{
  --bg:#070c1a;--panel:#0b1020;--soft:#0f1730;--fg:#e8edf7;--muted:#9fa8c0;
  --accent:#d4b97a;--ok:#74e0a1;--warn:#ffb04d;--bad:#ff6b6b;--border:#1e2744;
  --radius:14px;--shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
.header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0a1022,.78,#0a1022,0);
  padding:14px 12px 10px;border-bottom:1px solid var(--border);backdrop-filter:saturate(120%) blur(8px)}
.h1{margin:0;color:var(--accent);font-weight:800;font-size:26px}
.sub{color:var(--muted);font-size:13px;margin-top:4px}
.container{max-width:980px;margin:0 auto;padding:12px 12px 120px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin:10px 0;box-shadow:var(--shadow)}
.card h3{margin:4px 0 12px;color:var(--accent);font-size:1.05rem}
.row{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:860px){.row{grid-template-columns:1.3fr 1fr}}
input,select,button{width:100%;min-height:48px;border-radius:12px;border:1px solid var(--border);background:var(--soft);color:var(--fg);padding:12px;font-size:15px}
button{border:none;cursor:pointer;font-weight:800}
.btn{background:var(--accent);color:#08101f}
.btn-ok{background:var(--ok);color:#062519}
.btn-ghost{background:#203055;color:var(--fg);border:1px solid rgba(255,255,255,.08)}
.btn-bad{background:var(--bad);color:#2a0000}
.btnbar{display:grid;grid-template-columns:1fr 1fr;gap:8px}
small{color:var(--muted);font-size:12px}
.drop{border:2px dashed var(--border);border-radius:12px;background:#0a142b;padding:16px;text-align:center}
.drop.drag{background:#14224a;border-color:#7fa1ff}
.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:10px}
.item{background:#0b1428;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.thumb{width:100%;height:150px;object-fit:cover;background:#0a1022;display:block}
.meta{padding:8px 10px;font-size:12px;color:#cfe0ff;display:grid;gap:4px}
.prog-wrap{background:#0a1022;border-radius:999px;overflow:hidden;border:1px solid #1a2548}
.prog{height:8px;width:0%;background:var(--ok)}
.state{font-weight:700}
.toast{position:fixed;left:50%;bottom:calc(18px + env(safe-area-inset-bottom));transform:translateX(-50%);
  background:#0b1223;border:1px solid var(--border);color:var(--fg);padding:10px 16px;border-radius:12px;opacity:0;transition:.22s;pointer-events:none;z-index:999}
.toast.show{opacity:1;transform:translate(-50%,-6px)}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px}
.k{color:var(--muted)}
</style>
</head>
<body>
<header class="header">
  <div class="h1">✨ Batch Uploader — Lightflow Ω.10.1</div>
  <div class="sub">등작 燈酌 DUNGZAK CESTLAVIE × Lumera · iPhone-Stable</div>
</header>

<main class="container">
  <section class="card">
    <h3>0️⃣ 연결 상태</h3>
    <div class="kv">
      <div class="k">Owner</div><div id="sOwner">—</div>
      <div class="k">Repo</div><div id="sRepo">—</div>
      <div class="k">Branch</div><div id="sBranch">—</div>
      <div class="k">Token</div><div id="sToken">—</div>
    </div>
    <div class="btnbar" style="margin-top:10px">
      <button type="button" class="btn-ghost" id="refresh">↻ 상태 새로고침</button>
      <button type="button" class="btn" id="test">🔗 연결 테스트</button>
    </div>
    <small>설정은 <code>admin.html</code>에서 저장한 값(<code>localStorage</code>)을 그대로 사용합니다.</small>
  </section>

  <section class="card">
    <h3>1️⃣ 업로드 대상 선택</h3>
    <div class="row">
      <div>
        <label>섹션</label>
        <select id="sec">
          <option value="light">Ⅰ Light & Memory (light)</option>
          <option value="human">Ⅱ Human Being (human)</option>
          <option value="rebirth">Ⅲ Rebirth of Mind (rebirth)</option>
          <option value="restore">Ⅳ Restoration of Being (restore)</option>
          <option value="meta">Ⅴ Metaconsciousness (meta)</option>
        </select>
      </div>
      <div>
        <label>시작 번호 (예: 1 → id는 human-01)</label>
        <input id="start" type="number" value="1" inputmode="numeric" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <div id="drop" class="drop">📥 이미지를 드롭하거나 탭해서 선택</div>
        <input id="files" type="file" accept="image/*" multiple style="display:none" />
      </div>
      <div>
        <div class="btnbar">
          <button type="button" class="btn-ok" id="uploadAll">📤 일괄 업로드</button>
          <button type="button" class="btn-bad" id="clearList">🧹 목록 비우기</button>
        </div>
        <small>업로드 경로: <code>/img/{section}/{id}.ext</code> · 메타(JSON): <code>/data/artworks.json</code></small>
      </div>
    </div>
    <div id="list" class="list"></div>
  </section>

  <section class="card">
    <h3>2️⃣ 결과</h3>
    <div class="kv">
      <div class="k">업로드 성공</div><div id="sOK">0</div>
      <div class="k">실패</div><div id="sFail">0</div>
      <div class="k">artworks.json</div><div id="sJson">—</div>
    </div>
  </section>
</main>

<div id="toast" class="toast">Ready.</div>

<script>
/* ===== helpers / storage ===== */
const $=q=>document.querySelector(q), $$=q=>document.querySelectorAll(q);
const on=(el,ev,fn,opt)=>el.addEventListener(ev,fn,opt||{passive:true});
const say=(m,err=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=err?"#ff6b6b":"#22304f";t.classList.add("show");clearTimeout(say._t);say._t=setTimeout(()=>t.classList.remove("show"),1800);};
const storageKey="lf_admin_cfg_v101";
function readCfg(){try{return JSON.parse(localStorage.getItem(storageKey)||"{}");}catch(e){return {};}}
function cfg(k){return (readCfg()[k]||"");}

/* ===== GitHub API ===== */
async function gh(method,path,body=null,isJson=true){
  const token=cfg("token"); if(!token) throw new Error("토큰 없음");
  const r=await fetch(`https://api.github.com/${path}`,{
    method, headers:{ "Accept":"application/vnd.github+json","Authorization":`token ${token}`},
    body: body? (isJson? JSON.stringify(body):body) : null
  });
  if(!r.ok){const t=await r.text();throw new Error(`GitHub ${r.status}: ${t.slice(0,180)}`);}
  return r.json();
}
function b64(s){return btoa(unescape(encodeURIComponent(s)));}
function fileToB64(f){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result.split(",")[1]);fr.onerror=rej;fr.readAsDataURL(f);});}
async function getContent(p){
  const o=cfg("owner"),r=cfg("repo"),b=cfg("branch")||"main";
  try{const j=await gh("GET",`repos/${o}/${r}/contents/${encodeURIComponent(p)}?ref=${b}`);return {sha:j.sha,content:j.content?atob(j.content.replace(/\n/g,"")):null,exists:true};}
  catch(e){return {sha:null,content:null,exists:false};}
}
async function putFile(p,b64data,msg){
  const o=cfg("owner"),r=cfg("repo"),b=cfg("branch")||"main";
  const old=await getContent(p); const body={message:msg||`update ${p}`,content:b64data,branch:b}; if(old.exists) body.sha=old.sha;
  return gh("PUT",`repos/${o}/${r}/contents/${encodeURIComponent(p)}`,body);
}

/* ===== state ===== */
let queue=[]; // {file, id, ext, el}
let artworks={light:[],human:[],rebirth:[],restore:[],meta:[]};
let ok=0, fail=0;

/* ===== UI hydrate ===== */
function hydrate(){
  $("#sOwner").textContent=cfg("owner")||"—";
  $("#sRepo").textContent=cfg("repo")||"—";
  $("#sBranch").textContent=cfg("branch")||"—";
  $("#sToken").textContent=cfg("token")?"••••••••":"—";
}
async function testConn(){
  try{ await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}`); say("연결 OK (200)"); }
  catch(e){ say("연결 실패: "+e.message,true); }
}

/* ===== artworks.json load/save ===== */
async function loadArtworks(){
  try{
    const r=await getContent("data/artworks.json");
    if(r.exists) artworks=JSON.parse(r.content);
    $("#sJson").textContent = r.exists ? "loaded" : "new (will create)";
  }catch(e){ say("artworks.json 로드 실패: "+e.message,true);}
}

/* ===== queue build / previews ===== */
function addFiles(files){
  const sec=$("#sec").value;
  let n=parseInt($("#start").value||"1",10);
  [...files].forEach(f=>{
    const ext=(f.name.match(/\.\w+$/)?.[0]||".jpg").toLowerCase();
    const id=`${sec}-${String(n++).padStart(2,"0")}`;
    const el=document.createElement("div"); el.className="item";
    el.innerHTML=`
      <img class="thumb" alt="">
      <div class="meta">
        <div><b>${id}</b> <span style="opacity:.8">(${Math.round(f.size/1024)} KB)</span></div>
        <div>→ <code>img/${sec}/${id}${ext}</code></div>
        <div class="prog-wrap"><div class="prog"></div></div>
        <div class="state">대기</div>
      </div>`;
    const img=el.querySelector(".thumb"); img.src=URL.createObjectURL(f);
    $("#list").appendChild(el);
    queue.push({file:f,id,ext,el,sec});
  });
  $("#start").value = String(n);
}
function clearList(){ queue=[]; $("#list").innerHTML=""; ok=0; fail=0; $("#sOK").textContent=0; $("#sFail").textContent=0; }

/* ===== upload pipeline ===== */
async function uploadAll(){
  if(!queue.length) return say("대상 파일 없음",true);
  await loadArtworks(); // ensure fresh
  ok=0; fail=0;
  for(const q of queue){
    const stateEl=q.el.querySelector(".state");
    const progEl=q.el.querySelector(".prog");
    try{
      stateEl.textContent="업로드 중…";
      const b=await fileToB64(q.file);
      const path=`img/${q.sec}/${q.id}${q.ext}`;
      await putFile(path,b,`add ${path}`);
      progEl.style.width="100%";
      // update artworks json
      const rec={id:q.id,title:"",year:"",medium:"",size:"",image:`/${path}`};
      const arr = artworks[q.sec] || (artworks[q.sec]=[]);
      const i = arr.findIndex(x=>x.id===rec.id);
      if(i>=0) arr[i]=rec; else arr.push(rec);
      stateEl.textContent="완료";
      ok++; $("#sOK").textContent=ok;
    }catch(e){
      stateEl.textContent="실패: "+e.message;
      progEl.style.background= "#ff6b6b";
      fail++; $("#sFail").textContent=fail;
    }
  }
  try{
    await putFile("data/artworks.json", b64(JSON.stringify(artworks,null,2)),"update artworks.json");
    $("#sJson").textContent="saved";
    say(`완료: ${ok} 성공 / ${fail} 실패`);
  }catch(e){ say("JSON 저장 실패: "+e.message,true); }
}

/* ===== events (iOS safe) ===== */
function bindTap(id,fn){
  const el=$(id); on(el,"click",e=>{e.preventDefault();e.stopPropagation();fn();},{passive:false});
  on(el,"pointerup",e=>{ if(e.pointerType==="touch"){e.preventDefault();e.stopPropagation();fn();}}, {passive:false});
}
function initDnD(){
  const dz=$("#drop"), fi=$("#files");
  dz.onclick=()=>fi.click();
  ["dragenter","dragover"].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add("drag");}));
  ["dragleave","drop"].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove("drag");}));
  dz.addEventListener("drop",e=>{ if(e.dataTransfer?.files?.length){ addFiles(e.dataTransfer.files); }});
  on(fi,"change",e=>{ if(e.target.files?.length){ addFiles(e.target.files); fi.value=""; }});
}

/* ===== boot ===== */
function boot(){
  hydrate(); loadArtworks();
  bindTap("#refresh", hydrate);
  bindTap("#test", testConn);
  bindTap("#uploadAll", uploadAll);
  bindTap("#clearList", clearList);
  initDnD();
}
window.addEventListener("error",e=>{try{say("JS 오류: "+e.message,true);}catch{}});
window.addEventListener("load", boot);
</script>
</body>
</html>