<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1" />
<title>Lightflow Admin Ω.10.1 — Final iPhone-Stable</title>
<meta name="theme-color" content="#0a0f1e" />
<style>
:root{
  --bg:#0a0f1e;--panel:#0f1426;--accent:#e9c86b;--fg:#d7def4;--muted:#8fa1c9;--ok:#41d695;--warn:#ffb04d;--danger:#ff6b6b;--ink:#0b0f18;
  --radius:14px;--gap:14px;--shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:linear-gradient(180deg,var(--bg),#0b1122 60%,#0a0f1e);
  color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color:transparent;
}
#app{position:relative;z-index:1;isolation:isolate; padding:18px env(safe-area-inset-right) 60px env(safe-area-inset-left)}
.header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(10,15,30,.96),rgba(10,15,30,.78));
  backdrop-filter:saturate(120%) blur(8px); padding:16px 12px 12px}
.h1{font-size:28px;line-height:1.2;margin:0 0 4px;font-weight:800;letter-spacing:.2px;color:var(--accent)}
.sub{color:var(--muted);font-size:13px}

.section{margin:18px auto 0;max-width:820px;background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.section h2{margin:0 0 12px;font-size:18px;color:var(--fg)}
.row{display:flex;flex-direction:column;gap:10px}
label{font-size:13px;color:var(--muted)}
.input{
  width:100%;border:1px solid rgba(255,255,255,.08);background:#0c1224;color:var(--fg);
  border-radius:12px;padding:14px 14px;font-size:16px;outline:none;min-height:48px;
}
.input:focus{border-color:rgba(233,200,107,.6);box-shadow:0 0 0 3px rgba(233,200,107,.15)}
.btnbar{display:grid;grid-template-columns:1fr;gap:10px;margin-top:14px}

button.btn{
  appearance:none;-webkit-appearance:none;
  width:100%; border:none; border-radius:12px; padding:14px 16px; font-weight:700; font-size:16px;
  color:#07101f; background:var(--accent); cursor:pointer; position:relative; min-height:52px;
  touch-action:manipulation; user-select:none; outline:none; transform:translateZ(0);
}
button.btn:active{transform:scale(.98)}
.btn.secondary{background:#203055;color:var(--fg);border:1px solid rgba(255,255,255,.08)}
.btn.ok{background:var(--ok);color:#062519}
.btn.warn{background:var(--warn)}
.btn.danger{background:var(--danger)}
.note{font-size:12px;color:var(--muted)}

.kv{display:grid;grid-template-columns:130px 1fr;gap:8px;font-size:14px}
.kv .k{color:var(--muted)}
.kv .v{color:var(--fg);word-break:break-all}

.footer{max-width:820px;margin:18px auto 120px;color:var(--muted);font-size:12px}
.toast{
 position:fixed;left:50%;bottom:calc(18px + env(safe-area-inset-bottom));transform:translateX(-50%);
 background:#0c1428;color:#dff7ef;border:1px solid rgba(65,214,149,.35);
 padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:999;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s;
}
.toast.show{opacity:1;transform:translate(-50%,-6px)}
.hidden{display:none}

@media(min-width:720px){
  .btnbar{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div class="header">
  <div class="h1">✨ Lightflow Admin Ω.10.1 — Final iPhone-Stable</div>
  <div class="sub">등작 燈酌 DUNGZAK CESTLAVIE × Lumera · 2025-10 Build</div>
</div>

<main id="app" aria-live="polite">
  <section class="section" aria-label="GitHub 연결 / Connection">
    <h2>0. GitHub 연결 / Connection</h2>
    <div class="row">
      <div>
        <label for="owner">GitHub Owner (예: dungzakcestlavie)</label>
        <input id="owner" class="input" autocomplete="username" inputmode="text" />
      </div>
      <div>
        <label for="repo">Repository (예: dungzakcestlavie.github.io)</label>
        <input id="repo" class="input" autocomplete="off" inputmode="text" />
      </div>
      <div>
        <label for="branch">Branch</label>
        <input id="branch" class="input" value="main" autocomplete="off" inputmode="text" />
      </div>
      <div>
        <label for="token">Personal Access Token (repo 권한)</label>
        <input id="token" class="input" autocomplete="off" inputmode="text" />
        <div class="note">토큰/설정은 이 브라우저의 <b>localStorage</b> 에만 저장됩니다.</div>
      </div>

      <div class="btnbar" role="group" aria-label="Actions">
        <button type="button" class="btn secondary" id="save">저장(로컬)</button>
        <button type="button" class="btn secondary" id="wipe">토큰 삭제</button>
        <button type="button" class="btn ok" id="test">연결 테스트</button>
        <button type="button" class="btn warn" id="bust">캐시 무효화</button>
      </div>
    </div>
  </section>

  <section class="section" aria-label="현재 상태">
    <h2>상태 / Status</h2>
    <div class="kv">
      <div class="k">Owner</div><div class="v" id="sOwner">—</div>
      <div class="k">Repo</div><div class="v" id="sRepo">—</div>
      <div class="k">Branch</div><div class="v" id="sBranch">—</div>
      <div class="k">Token</div><div class="v" id="sToken">—</div>
      <div class="k">Last Check</div><div class="v" id="sPing">—</div>
    </div>
  </section>

  <div class="footer">
    iPhone Safari 대응: 겹침 레이어 제거, 버튼 타입 고정, 포인터 이벤트 보장, 클릭·포인터 이벤트 병행 처리, 폼 제출 전면 차단.
  </div>
</main>

<div id="toast" class="toast hidden" role="status" aria-live="assertive">Saved.</div>

<script>
/* ---------- iOS-safe helpers ---------- */
const $ = (q)=>document.querySelector(q);
const on = (el,ev,fn,opt)=>el.addEventListener(ev,fn,opt||{passive:true});
const showToast=(msg,ok=true)=>{
  const t=$("#toast"); t.textContent=msg;
  t.style.borderColor = ok ? "rgba(65,214,149,.35)" : "rgba(255,107,107,.45)";
  t.classList.remove("hidden"); requestAnimationFrame(()=>t.classList.add("show"));
  clearTimeout(showToast._t); showToast._t=setTimeout(()=>{t.classList.remove("show")},1800);
};
const storageKey="lf_admin_cfg_v101";

/* ---------- model ---------- */
function readCfg(){
  try{ return JSON.parse(localStorage.getItem(storageKey)||"{}"); }catch(e){ return {}; }
}
function writeCfg(cfg){
  localStorage.setItem(storageKey, JSON.stringify(cfg));
}

/* ---------- UI init ---------- */
function hydrate(){
  const cfg=readCfg();
  $("#owner").value=cfg.owner||"";
  $("#repo").value=cfg.repo||"";
  $("#branch").value=cfg.branch||"main";
  $("#token").value=cfg.token||"";
  renderStatus();
}
function renderStatus(){
  const cfg=readCfg();
  $("#sOwner").textContent = cfg.owner||"—";
  $("#sRepo").textContent = cfg.repo||"—";
  $("#sBranch").textContent = cfg.branch||"—";
  $("#sToken").textContent = (cfg.token? "••••••••" : "—");
}

/* ---------- actions ---------- */
async function doSave(){
  const cfg={
    owner: $("#owner").value.trim(),
    repo: $("#repo").value.trim(),
    branch: $("#branch").value.trim() || "main",
    token: $("#token").value.trim()
  };
  writeCfg(cfg); renderStatus();
  showToast("저장 완료", true);
}

function doWipe(){
  const cfg=readCfg(); cfg.token=""; writeCfg(cfg); $("#token").value="";
  renderStatus(); showToast("토큰 삭제", true);
}

async function doTest(){
  const {owner,repo,token}=readCfg();
  if(!owner||!repo){ showToast("Owner/Repo 입력 필요", false); return; }
  try{
    $("#sPing").textContent="확인 중…";
    const res=await fetch(`https://api.github.com/repos/${owner}/${repo}`,{
      headers: token? {Authorization:`token ${token}`} : {}
    });
    const ok = res.ok;
    $("#sPing").textContent = `${new Date().toLocaleString()} · ${ok?"OK":"Fail"} (${res.status})`;
    showToast(ok?"연결 성공":"연결 실패: 권한/이름 확인", ok);
  }catch(e){
    $("#sPing").textContent=`${new Date().toLocaleString()} · Error`;
    showToast("네트워크 오류", false);
  }
}

function doBust(){
  try{
    const url=new URL(location.href);
    url.searchParams.set("v", String(Date.now()));
    history.replaceState(null,"",url.toString());
    if('serviceWorker' in navigator){
      caches.keys().then(keys=>Promise.all(keys.map(k=>caches.delete(k))));
    }
    showToast("캐시 무효화 적용됨 · 새로고침", true);
  }catch(e){
    showToast("캐시 무효화 중 오류", false);
  }
}

/* ---------- event wiring (click + pointerup) ---------- */
function bindTap(el, handler){
  on(el,"click",e=>{e.preventDefault();e.stopPropagation();handler();},{passive:false});
  on(el,"pointerup",e=>{ if(e.pointerType==="touch"){ e.preventDefault(); e.stopPropagation(); handler(); }},{passive:false});
}

bindTap($("#save"), doSave);
bindTap($("#wipe"), doWipe);
bindTap($("#test"), doTest);
bindTap($("#bust"), doBust);

/* ---------- guard: prevent form submits anywhere ---------- */
on(document,"submit",e=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});

/* ---------- layout safety: ensure inputs are not covered ---------- */
function ensureNoOverlay(){
  const app=$("#app");
  app.style.pointerEvents="auto";
  app.style.zIndex="1";
}
ensureNoOverlay();

hydrate();
</script>
</body>
</html>