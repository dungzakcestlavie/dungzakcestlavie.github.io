<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>등작 燈酌 DUNGZAK CESTLAVIE · Lightflow Admin Ω.Unified</title>
<meta name="theme-color" content="#070c1a">
<style>
:root{--bg:#070c1a;--panel:#0b1326;--line:#1c2745;--fg:#e8e8ea;--mut:#95a1b5;--accent:#e7c36f;--btn:#2a6bff;--bad:#d64545}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Apple Color Emoji}
h1{margin:18px 14px 0;font-size:20px;color:var(--accent)}
h2{margin:16px 0 8px;font-size:16px;color:var(--accent)}
.container{padding:14px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px;margin:12px 0}
.grid{display:grid;gap:12px}
@media (min-width:880px){.two{grid-template-columns:1fr 1fr}}
label{display:block;margin:8px 0 4px;color:var(--mut)}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#0f1b34;color:#fff}
textarea{min-height:120px}
button{cursor:pointer;border:0;border-radius:8px;padding:10px 12px;background:var(--btn);color:#fff}
button.ghost{background:#223355} button.bad{background:var(--bad)}
.row{display:flex;gap:8px;flex-wrap:wrap}
.small{color:var(--mut);font-size:12px}
.item{border:1px dashed var(--line);padding:10px;border-radius:8px;margin:10px 0}
.kv{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center}
code.inline{background:#0a1226;border:1px solid #1a2442;padding:2px 6px;border-radius:6px}
hr{border:0;border-top:1px solid var(--line);margin:12px 0}
.badge{padding:2px 8px;border-radius:999px;background:#0f223f;border:1px solid #233c70;color:#9dc0ff;font-size:12px}
</style>
</head>
<body>
<h1>등작 燈酌 DUNGZAK CESTLAVIE · Lightflow Admin Ω.Unified</h1>
<div class="container">

<!-- 1) 연결 -->
<div class="panel">
  <h2>1) Settings · 연결</h2>
  <div class="grid two">
    <div>
      <label>Owner</label><input id="owner" placeholder="ex) dungzakcestlavie">
      <label>Repository</label><input id="repo" placeholder="ex) dungzakcestlavie.github.io">
      <label>Branch</label><input id="branch" value="main">
    </div>
    <div>
      <label>Personal Access Token (로컬 저장 전용)</label>
      <input id="token" type="password" placeholder="ghp_… (fine-grained, contents:read/write)">
      <div class="row">
        <button onclick="saveCfg()">저장(로컬)</button>
        <button class="ghost" onclick="testConn()">연결 테스트</button>
        <button class="bad" onclick="logout()">로그아웃/토큰삭제</button>
        <button class="ghost" onclick="openRepo()">GitHub Pages 열기</button>
      </div>
      <div id="status" class="small">상태: -</div>
    </div>
  </div>
  <div class="small">보안: 토큰은 이 브라우저의 <code class="inline">localStorage</code>에만 저장된다.</div>
</div>

<!-- 2) 작품 아카이브 -->
<div class="panel">
  <h2>2) 작품 아카이브 · 5섹션 × 20 = 100</h2>
  <div class="row">
    <select id="sectionSel"></select>
    <button class="ghost" onclick="addWork()">+ 작품 추가</button>
    <button class="ghost" onclick="importWorks()">JSON 불러오기</button>
    <button class="ghost" onclick="exportWorks()">JSON 내보내기</button>
    <span class="badge" id="workCount">0/20</span>
  </div>
  <div id="worksWrap"></div>
  <div class="row">
    <button onclick="saveWorksLocal()">저장(로컬)</button>
    <button onclick="pushWorks()">GitHub 반영(works.json + cachebust)</button>
  </div>
</div>

<!-- 3) 이미지 업로드 -->
<div class="panel">
  <h2>3) 이미지 업로드 · 자동 압축(1600/2560)</h2>
  <div class="row">
    <input type="file" id="imgInput" accept="image/*" multiple>
    <button onclick="uploadImages()">업로드</button>
    <button class="ghost" onclick="toggleWebP()">JPEG/WebP 전환</button>
  </div>
  <div id="imgLog" class="small">표준 1600px(품질 0.85) + 줌 2560px(품질 0.9) 업로드. 파일명은 공백→언더바.</div>
  <canvas id="canvas" style="display:none"></canvas>
</div>

<!-- 4) DCAR 01–08 -->
<div class="panel">
  <h2>4) 미학 보고서 · Aesthetic Reports (DCAR01–08)</h2>
  <div class="row">
    <select id="dcarSel"></select>
    <button class="ghost" onclick="newDCAR()">초기화</button>
  </div>
  <div class="grid two">
    <div>
      <label>제목(한국어)</label><input id="dcarTitleKR">
      <label>본문(한국어)</label><textarea id="dcarBodyKR" placeholder="KR 본문"></textarea>
    </div>
    <div>
      <label>Title (English)</label><input id="dcarTitleEN">
      <label>Body (English)</label><textarea id="dcarBodyEN" placeholder="EN body"></textarea>
    </div>
  </div>
  <div class="row">
    <button onclick="saveDCARLocal()">저장(로컬)</button>
    <button onclick="pushDCAR()">GitHub 반영(DCARxx.md + cachebust)</button>
    <button class="bad" onclick="deleteDCAR()">삭제(로컬만)</button>
  </div>
</div>

<!-- 5) 도움말 -->
<div class="panel">
  <h2>5) 반영 규칙</h2>
  <ul class="small">
    <li>작품 데이터 저장: <code class="inline">data/works.json</code> (섹션·작품 배열)</li>
    <li>DCAR 저장: <code class="inline">reports/DCAR01.md … DCAR08.md</code> (YAML front-matter)</li>
    <li>이미지: <code class="inline">images/standard/</code>, <code class="inline">images/zoom/</code></li>
    <li>캐시 무효화: <code class="inline">data/cachebust.json</code>의 <code class="inline">ts</code> 값 갱신</li>
  </ul>
</div>

</div>

<script>
/* ========= 기본 데이터 ========= */
const SECTIONS=[
 "Light & Memory","Human Prayer","Rebirth","Existence","Cosmos"
];
const MAX_PER_SECTION=20;
const DCAR_IDS=["DCAR01","DCAR02","DCAR03","DCAR04","DCAR05","DCAR06","DCAR07","DCAR08"];

/* ========= 설정 로드/저장 ========= */
function el(id){return document.getElementById(id)}
function saveCfg(){
 localStorage.setItem('cfg_owner',el('owner').value.trim());
 localStorage.setItem('cfg_repo',el('repo').value.trim());
 localStorage.setItem('cfg_branch',el('branch').value.trim());
 localStorage.setItem('cfg_token',el('token').value.trim());
 setStatus('저장 완료');
}
function loadCfg(){
 el('owner').value=localStorage.getItem('cfg_owner')||'';
 el('repo').value=localStorage.getItem('cfg_repo')||'';
 el('branch').value=localStorage.getItem('cfg_branch')||'main';
 el('token').value=localStorage.getItem('cfg_token')||'';
}
function logout(){localStorage.removeItem('cfg_token');el('token').value='';setStatus('토큰 삭제')}
function openRepo(){
 const o=el('owner').value.trim(), r=el('repo').value.trim();
 if(o&&r) window.open(`https://github.com/${o}/${r}`,'_blank');
}

/* ========= 상태 ========= */
function setStatus(t){el('status').textContent='상태: '+t}

/* ========= 연결 테스트 ========= */
async function testConn(){
 try{
  const res=await ghFetch(`repos/${el('owner').value}/${el('repo').value}`);
  setStatus(res.ok?'연결 성공':'연결 실패');
 }catch(e){setStatus('오류')}
}

/* ========= GitHub API 래퍼 ========= */
function cfg(){return{
 owner:el('owner').value.trim(),
 repo:el('repo').value.trim(),
 branch:el('branch').value.trim(),
 token:el('token').value.trim()
}}
function apiBase(){return 'https://api.github.com/'}
async function ghFetch(path,opts={}){
 const {token}=cfg();
 opts.headers=Object.assign({},opts.headers||{},{
  'Authorization': 'token '+token,
  'Accept':'application/vnd.github+json'
 });
 return fetch(apiBase()+path,opts);
}
async function ghGetContent(path){
 const {owner,repo}=cfg();
 const r=await ghFetch(`repos/${owner}/${repo}/contents/${path}`);
 if(!r.ok) return {sha:null,content:null};
 const j=await r.json();
 return {sha:j.sha,content:j.content};
}
async function ghPut(path,rawContent,isBinary=false){
 const {owner,repo,branch}=cfg();
 // get sha if exists
 const prev=await ghGetContent(path);
 const body={
  message:`update ${path}`,
  content: isBinary ? rawContent : btoa(unescape(encodeURIComponent(rawContent))),
  sha: prev.sha||undefined,
  branch
 };
 const r=await ghFetch(`repos/${owner}/${repo}/contents/${path}`,{
  method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
 });
 if(!r.ok){throw new Error('PUT 실패 '+path)}
}

/* ========= 캐시버스트 ========= */
async function bumpCacheBust(){
 const ts=Date.now();
 await ghPut('data/cachebust.json', JSON.stringify({ts},null,2));
}

/* ========= 작품 데이터 ========= */
let WORKS = JSON.parse(localStorage.getItem('works_json')||'{}');
function ensureSection(name){if(!WORKS[name]) WORKS[name]=[]}
function initSections(){
 const sel=el('sectionSel'); sel.innerHTML='';
 SECTIONS.forEach((s,i)=>{const o=document.createElement('option');o.value=s;o.textContent=`${i+1}) ${s}`;sel.appendChild(o)});
 sel.onchange=renderWorks;
 if(!WORKS || Object.keys(WORKS).length===0){SECTIONS.forEach(ensureSection)}
 renderWorks();
}
function renderWorks(){
 const sec=el('sectionSel').value||SECTIONS[0];
 ensureSection(sec);
 const arr=WORKS[sec];
 el('workCount').textContent=`${arr.length}/${MAX_PER_SECTION}`;
 const wrap=el('worksWrap'); wrap.innerHTML='';
 arr.forEach((w,i)=>{
  const div=document.createElement('div'); div.className='item';
  div.innerHTML=`
   <div class="kv"><div>제목(KR)</div><input value="${escapeHtml(w.titleKR||'')}" oninput="wUpd('${sec}',${i},'titleKR',this.value)"></div>
   <div class="kv"><div>Title(EN)</div><input value="${escapeHtml(w.titleEN||'')}" oninput="wUpd('${sec}',${i},'titleEN',this.value)"></div>
   <div class="kv"><div>재료(KR)</div><input value="${escapeHtml(w.mediumKR||'')}" oninput="wUpd('${sec}',${i},'mediumKR',this.value)"></div>
   <div class="kv"><div>Medium(EN)</div><input value="${escapeHtml(w.mediumEN||'')}" oninput="wUpd('${sec}',${i},'mediumEN',this.value)"></div>
   <div class="kv"><div>크기</div><input value="${escapeHtml(w.size||'')}" oninput="wUpd('${sec}',${i},'size',this.value)" placeholder="예: 162.2×130.3cm"></div>
   <div class="kv"><div>년도</div><input value="${escapeHtml(w.year||'')}" oninput="wUpd('${sec}',${i},'year',this.value)"></div>
   <div class="kv"><div>이미지</div><input value="${escapeHtml(w.image||'')}" oninput="wUpd('${sec}',${i},'image',this.value)" placeholder="파일명.ext"></div>
   <div class="row"><button class="bad" onclick="delWork('${sec}',${i})">삭제</button></div>
  `;
  wrap.appendChild(div);
 });
}
function escapeHtml(s){return (s||'').replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function addWork(){
 const sec=el('sectionSel').value||SECTIONS[0];
 ensureSection(sec);
 if(WORKS[sec].length>=MAX_PER_SECTION){alert('해당 섹션은 20개가 최대');return}
 WORKS[sec].push({}); renderWorks();
}
function delWork(sec,i){WORKS[sec].splice(i,1);renderWorks()}
function wUpd(sec,i,k,v){WORKS[sec][i][k]=v}
function saveWorksLocal(){localStorage.setItem('works_json',JSON.stringify(WORKS));setStatus('작품 로컬 저장')}
function exportWorks(){
 const blob=new Blob([JSON.stringify(WORKS,null,2)],{type:'application/json'});
 const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='works.json'; a.click();
}
function importWorks(){
 const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
 inp.onchange=()=>{const f=inp.files[0]; const fr=new FileReader(); fr.onload=()=>{WORKS=JSON.parse(fr.result); saveWorksLocal(); renderWorks()}; fr.readAsText(f)}
 inp.click();
}
async function pushWorks(){
 try{
  await ghPut('data/works.json', JSON.stringify(WORKS,null,2));
  await bumpCacheBust();
  setStatus('works.json 업로드 완료 + cachebust 갱신');
 }catch(e){alert('업로드 실패: '+e.message)}
}

/* ========= DCAR ========= */
let DCAR = JSON.parse(localStorage.getItem('dcar_json')||'{}');
function initDCAR(){
 const sel=el('dcarSel'); sel.innerHTML='';
 DCAR_IDS.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;sel.appendChild(o)});
 sel.onchange=renderDCAR;
 renderDCAR();
}
function newDCAR(){el('dcarTitleKR').value='';el('dcarBodyKR').value='';el('dcarTitleEN').value='';el('dcarBodyEN').value=''}
function renderDCAR(){
 const id=el('dcarSel').value||DCAR_IDS[0];
 const d=DCAR[id]||{};
 el('dcarTitleKR').value=d.titleKR||'';
 el('dcarBodyKR').value=d.bodyKR||'';
 el('dcarTitleEN').value=d.titleEN||'';
 el('dcarBodyEN').value=d.bodyEN||'';
}
function saveDCARLocal(){
 const id=el('dcarSel').value;
 DCAR[id]={titleKR:el('dcarTitleKR').value, bodyKR:el('dcarBodyKR').value, titleEN:el('dcarTitleEN').value, bodyEN:el('dcarBodyEN').value};
 localStorage.setItem('dcar_json',JSON.stringify(DCAR));
 setStatus('DCAR 로컬 저장');
}
function deleteDCAR(){
 const id=el('dcarSel').value; delete DCAR[id];
 localStorage.setItem('dcar_json',JSON.stringify(DCAR)); newDCAR(); setStatus('DCAR 로컬 삭제');
}
function buildDCARMarkdown(d,id){
 return `---\nid: ${id}\ntitle_kr: "${(d.titleKR||'').replace(/"/g,'\\"')}"\ntitle_en: "${(d.titleEN||'').replace(/"/g,'\\"')}"\n---\n\n# ${d.titleKR||''}\n\n${d.bodyKR||''}\n\n---\n\n# ${d.titleEN||''}\n\n${d.bodyEN||''}\n`;
}
async function pushDCAR(){
 try{
  const id=el('dcarSel').value;
  const d=DCAR[id]||{titleKR:'',titleEN:'',bodyKR:'',bodyEN:''};
  await ghPut(`reports/${id}.md`, buildDCARMarkdown(d,id));
  await bumpCacheBust();
  setStatus(`${id} 업로드 완료 + cachebust 갱신`);
 }catch(e){alert('DCAR 업로드 실패: '+e.message)}
}

/* ========= 이미지 업로드 & 압축 ========= */
let useWebP=false;
function toggleWebP(){useWebP=!useWebP; el('imgLog').textContent=useWebP?'현재: WebP 업로드':'현재: JPEG 업로드'}
async function uploadImages(){
 const files=[...el('imgInput').files]; if(!files.length){alert('파일 선택');return}
 for(const f of files){
  const base=f.name.replace(/\s+/g,'_');
  try{
    const std=await resizeImage(f,1600,useWebP? 'image/webp':'image/jpeg',useWebP?0.9:0.85);
    const zoom=await resizeImage(f,2560,useWebP? 'image/webp':'image/jpeg',useWebP?0.92:0.90);
    await ghPut(`images/standard/${base.replace(/\.[^.]+$/,'')}${useWebP?'.webp':''}`, std, true);
    await ghPut(`images/zoom/${base.replace(/\.[^.]+$/,'')}${useWebP?'.webp':''}`, zoom, true);
    el('imgLog').innerHTML += `<div>업로드 완료: ${base}</div>`;
  }catch(e){
    el('imgLog').innerHTML += `<div style="color:#ff9e9e">실패: ${base} - ${e.message}</div>`;
  }
 }
 await bumpCacheBust(); setStatus('이미지 업로드 및 cachebust 완료');
}
function resizeImage(file,maxW,type,quality){
 return new Promise((resolve,reject)=>{
  const img=new Image(); const url=URL.createObjectURL(file);
  img.onload=()=>{
   const scale=maxW/img.width; const w=maxW; const h=Math.round(img.height*scale);
   const c=el('canvas'); c.width=w; c.height=h;
   const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
   ctx.drawImage(img,0,0,w,h);
   c.toBlob(async blob=>{
     try{
       const arr=await blob.arrayBuffer();
       const b64=btoa(String.fromCharCode(...new Uint8Array(arr)));
       resolve(b64);
     }catch(e){reject(e)}
   }, type, quality);
  };
  img.onerror=()=>reject(new Error('이미지 로드 실패'));
  img.src=url;
 });
}

/* ========= 초기화 ========= */
function init(){
 loadCfg();
 // 섹션
 initSections();
 // DCAR
 initDCAR();
}
init();

/* ========= 유틸 ========= */
</script>
</body>
</html>