<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>등작 燈酌 DUNGZAK CESTLAVIE · Admin Ω.17 — Unified & Self-Healing</title>
<meta name="theme-color" content="#070c1a" />
<style>
:root{--bg:#0a1024;--fg:#eaf0ff;--gold:#e6c777;--line:#1a2758;--panel:#0f1632;--ok:#31d0a5;--bad:#ff6b6b;--max:980px}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.55 system-ui,-apple-system,'Noto Sans KR',Segoe UI,Roboto,sans-serif}
h1{margin:18px 12px;font-size:18px;color:var(--gold)} h2{margin:0 0 8px}
.wrap{max-width:var(--max);margin:0 auto;padding:0 12px 80px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,button,textarea{font:inherit}
input,select,textarea{background:#0b1636;color:var(--fg);border:1px solid #223564;border-radius:10px;padding:8px 10px}
input[type=text]{min-width:180px}
button{border:1px solid #3a4d88;background:#14245a;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
button.primary{background:linear-gradient(180deg,#f7e4a5,#e6c777);color:#0a1230;border-color:#e6c777;font-weight:700}
button:disabled{opacity:.55;cursor:not-allowed}
textarea{width:100%;min-height:200px;border-radius:12px}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
.badge{display:inline-block;border:1px solid #3a4d88;background:#0c1b45;padding:2px 8px;border-radius:999px;font-size:12px}
.note{opacity:.75} hr{border:0;border-top:1px solid #223564;margin:10px 0}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#061132;color:#cfe0ff;border:1px solid #294;box-shadow:0 10px 40px #0006;border-radius:12px;padding:10px 14px;z-index:99;opacity:0;transition:opacity .25s}
.toast.on{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>등작 燈酌 DUNGZAK CESTLAVIE · Admin Ω.17 — Unified & Self-Healing</h1>

  <!-- 1) 연결 -->
  <section class="card">
    <h2>1) Settings · 연결</h2>
    <div class="row">
      <div><label>Owner</label><input id="owner" type="text" placeholder="dungzakcestlavie"></div>
      <div><label>Repository</label><input id="repo" type="text" placeholder="dungzakcestlavie.github.io"></div>
      <div><label>Branch</label><input id="branch" type="text" value="main"></div>
      <div style="flex:1 1 100%">
        <label>Personal Access Token (PAT) — 로컬 저장만</label>
        <input id="token" type="password" inputmode="text" autocapitalize="off" autocorrect="off" spellcheck="false" placeholder="ghp_..." style="width:100%">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="saveLocal">저장(로컬)</button>
      <button id="test" class="primary">연결 테스트</button>
      <span id="state" class="badge">상태: -</span>
    </div>
    <small class="note">PAT는 이 브라우저 localStorage에만 저장. 서버 전송 없음.</small>
  </section>

  <!-- 2) 작품 데이터 -->
  <section class="card">
    <h2>2) Works — 작품 메타데이터 (data/works.json)</h2>
    <div class="row">
      <button id="loadWorks">불러오기</button>
      <button id="saveWorks" class="primary">저장</button>
      <button id="formatWorks">예시 스켈레톤</button>
    </div>
    <textarea id="works" class="mono" placeholder='{"pray":[],"human":[],"rebirth":[],"exist":[],"cosmos":[]}'></textarea>
    <small class="note">필드 예시: {"title_kr":"","title_en":"","material_kr":"","material_en":"","size":"162.2×130.3cm","year":2025,"file":"Pray_for_Us_01.jpg"}</small>
  </section>

  <!-- 3) 미학 보고서 -->
  <section class="card">
    <h2>3) Aesthetic Reports (reports/DCARxx.md)</h2>
    <div class="row">
      <select id="reportId">
        <option>DCAR01</option><option>DCAR02</option><option>DCAR03</option><option>DCAR04</option>
        <option>DCAR05</option><option>DCAR06</option><option>DCAR07</option><option>DCAR08</option>
      </select>
      <button id="loadReport">불러오기</button>
      <button id="saveReport" class="primary">저장</button>
      <button id="templateReport">템플릿</button>
    </div>
    <textarea id="reportBody" class="mono" placeholder="---&#10;id: DCAR01&#10;title_kr: &quot;&quot;&#10;title_en: &quot;&quot;&#10;---&#10;# (KR)&#10;...&#10;---&#10;# (EN)&#10;..."></textarea>
  </section>

  <!-- 4) 캐시 무효화 -->
  <section class="card">
    <h2>4) 캐시 무효화 (data/cachebust.json)</h2>
    <div class="row">
      <button id="bust" class="primary">지금 갱신</button>
      <span class="note">Index는 이 값으로 즉시 새 데이터 로드.</span>
    </div>
  </section>

  <p class="note">파일이 없으면 자동으로 생성하고, 있으면 안전하게 업데이트합니다. 오류 메시지는 원인과 해결책을 함께 표시합니다.</p>
</div>

<div id="toast" class="toast"></div>

<script>
/* ========== helpers ========== */
const $=s=>document.querySelector(s);
const store={get:k=>localStorage.getItem(k)||'',set:(k,v)=>localStorage.setItem(k,v||'')};
function toast(msg,ok=true){const t=$("#toast");t.innerHTML=msg; t.style.borderColor=ok?"#2a6":"#a33"; t.classList.add("on"); setTimeout(()=>t.classList.remove("on"),2000)}
function b64(s){return btoa(unescape(encodeURIComponent(s)))}

/* ========== GitHub API (Self-Healing) ========== */
function cfg(){
  const owner=$("#owner").value.trim(), repo=$("#repo").value.trim(), branch=$("#branch").value.trim()||"main", token=$("#token").value.trim();
  if(!owner||!repo||!token) throw new Error("설정이 비었습니다. Owner/Repo/Branch/Token 확인");
  const base=`https://api.github.com/repos/${owner}/${repo}/contents`;
  const headers={"Authorization":`Bearer ${token}`,"Accept":"application/vnd.github+json"};
  return {base,headers,branch};
}
async function ghGet(path){
  const {base,headers,branch}=cfg();
  const r=await fetch(`${base}/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`,{headers});
  if(r.status===404) return null;
  if(!r.ok) throw new Error(`GET 실패 ${path} (HTTP ${r.status})`);
  return r.json();
}
async function ghPut(path,content,message){
  const {base,headers,branch}=cfg();
  let sha=null; try{const cur=await ghGet(path); sha=cur?.sha||null;}catch{}
  const body={message,content:b64(content),branch}; if(sha) body.sha=sha;
  const r=await fetch(`${base}/${encodeURIComponent(path)}`,{method:"PUT",headers,body:JSON.stringify(body)});
  if(!r.ok){
    let tip=""; if(r.status===401) tip="토큰 만료/오타 가능";
    if(r.status===403) tip="토큰 권한(Contents: Read&Write) 또는 브랜치 보호 규칙";
    if(r.status===409) tip="브랜치 보호 규칙/필수 리뷰로 직접 커밋 차단";
    throw new Error(`PUT 실패 ${path} (HTTP ${r.status}) ${tip}`);
  }
  return r.json();
}
async function ensureFile(path,defaultContent){ const cur=await ghGet(path); if(cur===null){ await ghPut(path, defaultContent, `create ${path}`); return {created:true} } return {created:false, sha:cur.sha} }
async function ensureFolderReports(){ await ensureFile("reports/.keep","keep\n"); }

/* ========== UI wiring ========== */
(function init(){
  /* restore */
  $("#owner").value=store.get("dz_owner")||"dungzakcestlavie";
  $("#repo").value =store.get("dz_repo") ||"dungzakcestlavie.github.io";
  $("#branch").value=store.get("dz_branch")||"main";
  $("#token").value =store.get("dz_token") ||"";

  $("#saveLocal").onclick=()=>{ ["dz_owner","dz_repo","dz_branch","dz_token"].forEach((k,i)=>{ const v=[$("#owner").value,$("#repo").value,$("#branch").value,$("#token").value][i]; store.set(k,v);}); toast("로컬 저장 완료"); };

  $("#test").onclick=async()=>{
    try{
      await ensureFile("data/cachebust.json", '{ "ts": 0 }\n');
      await ensureFile("data/works.json", JSON.stringify({pray:[],human:[],rebirth:[],exist:[],cosmos:[]},null,2)+"\n");
      await ensureFolderReports();
      $("#state").textContent="상태: 연결 OK";
      toast("<b>연결 성공</b> · 기본 파일/폴더 확인");
    }catch(e){ $("#state").textContent="상태: 오류"; toast("연결 실패: "+e.message,false); }
  };

  /* Works */
  $("#formatWorks").onclick=()=>{
    $("#works").value=JSON.stringify({pray:[],human:[],rebirth:[],exist:[],cosmos:[]},null,2);
  };
  $("#loadWorks").onclick=async()=>{
    try{
      const j=await ghGet("data/works.json");
      if(!j){ $("#works").value=""; toast("파일 없음(새로 생성 예정)"); return; }
      $("#works").value=atob(j.content||""); toast("불러오기 완료");
    }catch(e){ toast("불러오기 실패: "+e.message,false); }
  };
  $("#saveWorks").onclick=async()=>{
    try{
      let text=$("#works").value.trim();
      if(!text) text=JSON.stringify({pray:[],human:[],rebirth:[],exist:[],cosmos:[]},null,2)+"\n";
      JSON.parse(text); /* 유효성 검증 */
      await ensureFile("data/cachebust.json", '{ "ts": 0 }\n');
      await ghPut("data/works.json", text, "update data/works.json");
      const ts=Date.now(); await ghPut("data/cachebust.json", JSON.stringify({ts},null,2)+"\n", "cache bust");
      toast("<b>works 저장</b> + 캐시 무효화 OK");
    }catch(e){ toast("저장 실패: "+e.message,false); }
  };

  /* Reports */
  $("#templateReport").onclick=()=>{
    const id=$("#reportId").value;
    $("#reportBody").value =
`---
id: ${id}
title_kr: ""
title_en: ""
---
# (KR)
여기에 한국어 본문

---
# (EN)
Here goes the English body
`;
  };
  $("#loadReport").onclick=async()=>{
    try{
      await ensureFolderReports();
      const id=$("#reportId").value;
      const j=await ghGet(`reports/${id}.md`);
      if(!j){ $("#reportBody").value=""; toast("파일 없음(새로 생성 예정)"); return; }
      $("#reportBody").value=atob(j.content||""); toast("불러오기 완료");
    }catch(e){ toast("불러오기 실패: "+e.message,false); }
  };
  $("#saveReport").onclick=async()=>{
    try{
      const id=$("#reportId").value;
      let body=$("#reportBody").value.trim();
      if(!body){ $("#templateReport").click(); body=$("#reportBody").value.trim(); }
      await ensureFile("data/cachebust.json", '{ "ts": 0 }\n');
      await ensureFolderReports();
      await ghPut(`reports/${id}.md`, body+"\n", `update reports/${id}.md`);
      const ts=Date.now(); await ghPut("data/cachebust.json", JSON.stringify({ts},null,2)+"\n", "cache bust");
      toast(`<b>${id} 저장</b> + 캐시 무효화 OK`);
    }catch(e){ toast("보고서 저장 실패: "+e.message,false); }
  };

  /* Cache bust only */
  $("#bust").onclick=async()=>{
    try{
      await ensureFile("data/cachebust.json", '{ "ts": 0 }\n');
      const ts=Date.now(); await ghPut("data/cachebust.json", JSON.stringify({ts},null,2)+"\n", "cache bust");
      toast("캐시 무효화 OK");
    }catch(e){ toast("캐시 무효화 실패: "+e.message,false); }
  };
})();
</script>
</body>
</html>