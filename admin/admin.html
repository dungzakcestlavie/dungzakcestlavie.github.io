<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>✨ Lightflow Admin Ω.13 — Unified · iPhone-Stable</title>
<meta name="theme-color" content="#070c1a">

<style>
:root{
  --bg:#070c1a; --panel:#0b1020; --soft:#10182d; --border:#1e2744;
  --fg:#e8edf7; --muted:#9fa8c0;
  --accent:#d4b97a; --accent2:#a3c2ff;
  --good:#74e0a1; --bad:#ff6b6b;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0;background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Pretendard,sans-serif;
  padding-top:72px;
}
h3{margin:0 0 12px;color:var(--accent);font-size:1.05rem;font-weight:700}
input,select,textarea,button{
  width:100%;padding:10px 12px;font-size:15px;border-radius:10px;
  border:1px solid var(--border);background:var(--soft);color:var(--fg)
}
button{cursor:pointer;font-weight:700;border:none;touch-action:manipulation}
button:disabled{opacity:.6}
.btn{background:var(--accent);color:#000}
.btn-ok{background:var(--good);color:#00321d}
.btn-ghost{background:#0f172c;color:var(--accent2)}
.btn-bad{background:var(--bad);color:#000}
.card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:14px;margin:12px 0
}
.admin-nav{
  position:sticky;top:0;padding:8px;background:#000a16;
  border-bottom:1px solid var(--border);z-index:9999;
  display:flex;gap:8px;overflow-x:auto
}
.admin-nav button{
  flex:0 0 auto;padding:8px 14px;border-radius:999px;
  background:#0d142b;color:#cfe0ff;border:1px solid var(--border)
}
.admin-nav button.active{background:var(--accent);color:#000}
.toast{
  position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
  background:#0b1223;border:1px solid var(--border);
  padding:10px 16px;border-radius:12px;opacity:0;
  pointer-events:none;transition:opacity .2s;z-index:9999
}
.toast.show{opacity:1}

/* iPhone tap fix */
.header,.admin-nav,.container,.card{pointer-events:auto}
button{pointer-events:auto}
</style>
</head>

<body>

<div class="admin-nav">
<button type="button" data-tab="home" class="active">Home</button>
<button type="button" data-tab="art">Artworks</button>
<button type="button" data-tab="dcar">DCAR</button>
<button type="button" data-tab="upload">Upload</button>
<button type="button" data-tab="settings">Settings</button>
</div>

<div class="container">

<!-- Home -->
<div id="home" class="tab">
<div class="card">
<h3>0️⃣ GitHub 연결</h3>
<input id="owner" placeholder="Owner (예: dungzakcestlavie)">
<input id="repo" placeholder="Repo (예: dungzakcestlavie.github.io)">
<input id="branch" value="main">
<input id="token" placeholder="GitHub Token">

<div style="display:flex;gap:8px;margin-top:8px;">
<button type="button" class="btn" onclick="saveCfg()">저장</button>
<button type="button" class="btn-ok" onclick="testConn()">연결 테스트</button>
</div>
<div style="display:flex;gap:8px;margin-top:8px;">
<button type="button" class="btn-ghost" onclick="touchPages()">🚀 Pages 캐시 무효화</button>
<button type="button" class="btn-bad" onclick="logout()">토큰 삭제</button>
</div>
</div>
</div>

<!-- Artworks -->
<div id="art" class="tab" style="display:none;">
<h3>1️⃣ 작품 관리</h3>
<div class="card">
<select id="art-sec">
<option value="light">Ⅰ Light & Memory</option>
<option value="human">Ⅱ Human Being</option>
<option value="rebirth">Ⅲ Rebirth of Mind</option>
<option value="restore">Ⅳ Restoration of Being</option>
<option value="meta">Ⅴ Metaconsciousness</option>
</select>
<input id="w-id" placeholder="ID (예: light-01)">
<input id="w-title" placeholder="Title">
<input id="w-year" placeholder="Year">
<input id="w-medium" placeholder="Medium">
<input id="w-size" placeholder="Size">
<input id="w-file" type="file" accept="image/*">

<button type="button" class="btn" onclick="uploadArtwork()">업로드+등록</button>
<button type="button" class="btn-bad" onclick="deleteArtwork()">삭제</button>
</div>
</div>

<!-- DCAR -->
<div id="dcar" class="tab" style="display:none;">
<h3>2️⃣ 미학 보고서 (DCAR)</h3>
<div class="card">
<select id="dcar-id">
<option value="dcar01">DCAR-01</option>
<option value="dcar02">DCAR-02</option>
<option value="dcar03">DCAR-03</option>
<option value="dcar04">DCAR-04</option>
<option value="dcar05">DCAR-05</option>
<option value="dcar06">DCAR-06</option>
<option value="dcar07">DCAR-07</option>
<option value="dcar08">DCAR-08</option>
</select>

<textarea id="dcar-text" style="height:180px"
placeholder="DCAR 전체 텍스트 붙여넣기 (영문→한글 순 자동 인식)">
</textarea>

<button type="button" class="btn" onclick="saveDCAR()">📝 저장 (자동 EN/KR 분리)</button>
<button type="button" class="btn-bad" onclick="deleteDCAR()">삭제</button>
</div>
</div>

<!-- Upload / Trigger -->
<div id="upload" class="tab" style="display:none;">
<h3>3️⃣ Pages Trigger</h3>
<div class="card">
<button type="button" class="btn-ghost" onclick="touchPages()">📄 Commit Touch</button>
<button type="button" class="btn-ok" onclick="pagesBuild()">🚀 Pages Build 요청</button>
<button type="button" class="btn-bad" onclick="localStorage.clear();location.reload()">localStorage 초기화</button>
</div>
</div>

<!-- Settings -->
<div id="settings" class="tab" style="display:none;">
<div class="card">
<h3>정보</h3>
<div id="status"></div>
</div>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
/* UI */
document.querySelectorAll('.admin-nav button').forEach(btn=>{
 btn.addEventListener('click',()=>{
  document.querySelectorAll('.admin-nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const t=btn.dataset.tab;
  document.querySelectorAll('.tab').forEach(x=>x.style.display='none');
  document.getElementById(t).style.display='block';
 });
});

/* Toast */
const say=(m,e=false)=>{let t=document.getElementById('toast');
t.textContent=m;t.style.borderColor=e?'#ff6b6b':'#22304f';
t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
const cfg=k=>localStorage.getItem(k)||"";const setcfg=(k,v)=>localStorage.setItem(k,v);

/* GitHub Core */
async function gh(m,p,b=null,j=true){
 const token=cfg("token");if(!token)throw"토큰 없음";
 let r=await fetch(`https://api.github.com/${p}`,{
  method:m,headers:{Accept:"application/vnd.github+json",Authorization:`token ${token}`},
  body:b?(j?JSON.stringify(b):b):null });
 if(!r.ok)throw(await r.text());return r.json();
}
async function putFile(path,b64,msg){
 let {sha}=await getFile(path);
 return gh("PUT",`repos/${cfg("owner")}/${cfg("repo")}/contents/${path}`,{
  message:msg||`update ${path}`,content:b64,branch:cfg("branch"),sha});
}
async function getFile(path){
 try{
  let j=await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}/contents/${path}?ref=${cfg("branch")}`);
  return {exists:true,sha:j.sha,content:j.content?atob(j.content.replace(/\n/g,'')):null};
 }catch{return{exists:false};}
}
const b64=s=>btoa(unescape(encodeURIComponent(s)));

/* Config */
function saveCfg(){["owner","repo","branch","token"].forEach(id=>setcfg(id,document.getElementById(id).value.trim()));say("저장됨")}
async function testConn(){try{await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}`);say("연결 OK")}catch(e){say("실패:"+e,true)}}
function logout(){localStorage.removeItem("token");say("토큰 삭제")}

/* Pages */
async function touchPages(){await putFile("data/.touch",b64(Date.now()),"touch");say("Touch OK")}
async function pagesBuild(){try{await gh("POST",`repos/${cfg("owner")}/${cfg("repo")}/pages/builds`,{});say("Pages Build 요청됨")}catch(e){say("권한 없음, touch로 대체")}}

function loadStatus(){
 document.getElementById("status").innerHTML=
 `Owner: ${cfg("owner")}<br>Repo: ${cfg("repo")}<br>Branch: ${cfg("branch")}`;
}

/* Artworks */
async function uploadArtwork(){
 let id=document.getElementById("w-id").value.trim();
 let sec=document.getElementById("art-sec").value;
 let f=document.getElementById("w-file").files[0];
 if(!id){say("ID 필요",true);return;}
 let fileName=id+(f?f.name.match(/\.\w+$/)[0]:"");
 let imgPath=`img/${sec}/${fileName}`;
 if(f){
  let r=new FileReader();r.onload=async()=>{
   let c=r.result.split(",")[1];
   await putFile(imgPath,c,`upload ${id}`);
   await saveArtworkMeta(sec,id);
  };r.readAsDataURL(f);
 }else await saveArtworkMeta(sec,id);
}
async function saveArtworkMeta(sec,id){
 let entry={
  id,title:w("w-title"),year:w("w-year"),medium:w("w-medium"),size:w("w-size"),
  image:`/img/${sec}/${id}.jpg`
 };
 let j=await getFile("data/artworks.json");
 let a=j.exists?JSON.parse(j.content):{light:[],human:[],rebirth:[],restore:[],meta:[]};
 let i=a[sec].findIndex(x=>x.id===id);if(i>=0)a[sec][i]=entry;else a[sec].push(entry);
 await putFile("data/artworks.json",b64(JSON.stringify(a,null,2)),"update artworks");
 say("작품 저장 완료");
}
async function deleteArtwork(){
 let id=w("w-id");if(!id)return;
 await gh("DELETE",`repos/${cfg("owner")}/${cfg("repo")}/contents/img/${w("art-sec")}/${id}.jpg`,{
  message:`delete ${id}`,sha:(await getFile(`img/${w("art-sec")}/${id}.jpg`)).sha,branch:cfg("branch")
 });
 say("삭제됨");
}
function w(x){return document.getElementById(x).value.trim()}

/* DCAR */
function splitKR_EN(txt){
 // 두 줄 연속 공백 기준 분리
 let parts=txt.split(/\n\s*\n/);
 return {en:parts[0]||"",kr:parts.slice(1).join("\n\n")||""};
}
async function saveDCAR(){
 let id=w("dcar-id");let txt=w("dcar-text");
 if(!txt)return say("내용 없음",true);
 let {en,kr}=splitKR_EN(txt);

 await putFile(`reports/${id}.md`,b64(txt),`save ${id}.md`);

 let j=await getFile("data/reports.json");
 let r=j.exists?JSON.parse(j.content):{};
 r[id]={id,text:txt,titleEN:en.split("\n")[0]||"",titleKO:kr.split("\n")[0]||""};
 await putFile("data/reports.json",b64(JSON.stringify(r,null,2)),"update reports");
 say("DCAR 저장 완료");
}
async function deleteDCAR(){
 let id=w("dcar-id");
 try{await gh("DELETE",`repos/${cfg("owner")}/${cfg("repo")}/contents/reports/${id}.md`,{
  message:`delete ${id}`,sha:(await getFile(`reports/${id}.md`)).sha,branch:cfg("branch")
 })}catch{}
 say("삭제 완료");
}

/* Auto bind touch→click for iOS */
(function(){
 const sel="[onclick],button";
 function bind(el){
  if(el.__done)return;el.__done=true;
  el.addEventListener("touchend",e=>{el.click();e.preventDefault()},{passive:false});
 }
 function scan(){document.querySelectorAll(sel).forEach(bind);}
 document.addEventListener("DOMContentLoaded",scan);
 new MutationObserver(scan).observe(document.body,{childList:true,subtree:true});
})();

window.onload=()=>{
 ["owner","repo","branch","token"].forEach(id=>{if(cfg(id))document.getElementById(id).value=cfg(id)});
 loadStatus();
};
</script>

</body>
</html>