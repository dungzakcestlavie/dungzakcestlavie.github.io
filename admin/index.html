<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Console · dungzak.art</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0c0f14; --card:#121722; --ink:#e7ebf4; --muted:#91a0b6; --accent:#c9ff55;
  --ok:#38d39f; --err:#ff6b6b; --line:#1f2937;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 Pretendard,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
.wrap{max-width:960px;margin:40px auto;padding:0 16px}
h1{font-size:26px;margin:0 0 16px;font-weight:800;letter-spacing:.2px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;margin:16px 0;padding:18px}
.row{display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:center;margin:10px 0}
input,select,textarea{width:100%;background:#0b0f16;border:1px solid #253043;color:var(--ink);
  border-radius:10px;padding:10px 12px;outline:none}
label{color:var(--muted)}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;cursor:pointer;border:1px solid #2b384b;background:#101724;color:var(--ink);
  padding:10px 14px;border-radius:10px}
.btn.primary{background:linear-gradient(180deg,#1a2434,#0f1624);border-color:#3a4a62}
.btn.accent{background:var(--accent);color:#0a0f16;border-color:#a4e23a;font-weight:700}
.note{font-size:12px;color:var(--muted)}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;margin:6px 0}
hr{border:none;border-top:1px solid #1e2735;margin:18px 0}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #28354a;background:#0d1320;color:var(--muted)}
#repMsg{margin-left:8px;font-weight:600}
#repMsg.ok{color:var(--ok)} #repMsg.err{color:var(--err)}
img.preview{max-width:100%;border-radius:10px;border:1px solid #1f2a3d}
small.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;color:#b7c4d9}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin Console <span class="badge">dungzak.art</span></h1>

  <!-- (1) 연결 설정 -->
  <div class="card">
    <h3>1) 연결 설정 · Connection</h3>
    <div class="row"><label>GitHub Owner</label><input id="owner" placeholder="ex) dungzakcestlavie"></div>
    <div class="row"><label>Repository</label><input id="repo" placeholder="ex) dungzakcestlavie.github.io"></div>
    <div class="row"><label>Branch</label><input id="branch" value="main"></div>
    <div class="row"><label>Personal Access Token</label><input id="token" type="password" placeholder="github_pat_..."></div>
    <div class="btns">
      <button class="btn" id="saveLocal">저장(로컬)</button>
      <button class="btn" id="logout">로그아웃/토큰삭제</button>
      <button class="btn primary" id="testConn">연결 테스트</button>
      <span id="repMsg" class=""></span>
    </div>
    <div class="note">토큰은 <b>이 브라우저의 localStorage</b>에만 저장됩니다.</div>
  </div>

  <!-- (2) 작품 업로드 -->
  <div class="card">
    <h3>2) 작품 업로드 · Artworks</h3>
    <div class="row"><label>Series</label>
      <select id="awSeries">
        <option>I Light & Memory</option>
        <option>II Human Prayer</option>
        <option>III Rebirth</option>
        <option>IV Existence</option>
        <option>V Cosmos</option>
      </select></div>
    <div class="row"><label>Artwork ID</label><input id="awId" placeholder="영문-하이픈 권장 (ex. light-memory-1)"></div>
    <div class="row"><label>Title</label><input id="awTitle" placeholder="작품 제목"></div>
    <div class="row"><label>Year</label><input id="awYear" value="2025"></div>
    <div class="row"><label>Medium</label><input id="awMedium" value="Acrylic on Canvas"></div>
    <div class="row"><label>Size</label><input id="awSize" placeholder="120x90 cm"></div>
    <div class="row"><label>Image (.jpg/.png)</label>
      <input id="awImage" type="file" accept=".jpg,.jpeg,.png"></div>
    <div class="btns">
      <button class="btn accent" id="btnUploadAw">이미지 업로드 + artworks.json 저장</button>
      <button class="btn" id="btnRefreshAw">목록 새로고침</button>
    </div>
    <div id="awPreview"></div>
  </div>

  <!-- (3) 미학 보고서 -->
  <div class="card">
    <h3>3) 미학 보고서 · Reports</h3>
    <div class="row"><label>Report ID</label><input id="rpId" placeholder="ex. dcar01"></div>
    <div class="row"><label>Title (EN)</label><input id="rpTitleEn" placeholder="On Light, Memory, and Being"></div>
    <div class="row"><label>Title (KO)</label><input id="rpTitleKo" placeholder="빛, 기억, 존재에 관하여"></div>
    <div class="row"><label>Series</label><input id="rpSeries" value="Aesthetic Reports"></div>
    <div class="row"><label>Year</label><input id="rpYear" value="2025"></div>
    <div class="row"><label>Abstract</label><textarea id="rpAbstract" rows="3" placeholder="요약"></textarea></div>

    <details class="card" style="background:#0b1019;border-color:#1e2637;">
      <summary>섹션(최대 3개 예시) — 필요 갯수만 입력</summary>
      <div id="secWrap">
        <div class="kv"><label>Ⅰ Title</label><input class="sec-title" value="Light"></div>
        <div class="kv"><label>Ⅰ Body</label><textarea class="sec-body" rows="2">…</textarea></div>
        <div class="kv"><label>Ⅱ Title</label><input class="sec-title" value="Memory"></div>
        <div class="kv"><label>Ⅱ Body</label><textarea class="sec-body" rows="2">…</textarea></div>
        <div class="kv"><label>Ⅲ Title</label><input class="sec-title" value="Being"></div>
        <div class="kv"><label>Ⅲ Body</label><textarea class="sec-body" rows="2">…</textarea></div>
      </div>
    </details>

    <div class="btns">
      <button class="btn accent" id="btnSaveReport">리포트 저장 (reports.json)</button>
      <a class="btn" href="/reports/report-manager.html" target="_blank">리포트 관리자/인쇄</a>
    </div>
  </div>

</div>

<script>
// ----------------- 상태 & 유틸 -----------------
const $ = s=>document.querySelector(s);
const state = { owner:'', repo:'', branch:'main', token:'' };
const API = path => `https://api.github.com/repos/${state.owner}/${state.repo}/${path}`;

function loadLocal(){
  const s = JSON.parse(localStorage.getItem('adminState')||'{}');
  Object.assign(state, s);
  $('#owner').value = state.owner||'';
  $('#repo').value = state.repo||'';
  $('#branch').value = state.branch||'main';
  $('#token').value = state.token||'';
}
function saveLocal(){
  Object.assign(state,{
    owner:$('#owner').value.trim(),
    repo:$('#repo').value.trim(),
    branch:$('#branch').value.trim()||'main',
    token:$('#token').value.trim()
  });
  localStorage.setItem('adminState', JSON.stringify(state));
  ok('저장되었습니다.');
}
function logout(){
  localStorage.removeItem('adminState');
  $('#token').value=''; state.token='';
  info('토큰 삭제됨');
}
function ok(msg){ const n=$('#repMsg'); n.className='ok'; n.textContent=msg; }
function err(msg){ const n=$('#repMsg'); n.className='err'; n.textContent=msg; }
async function getJson(rel){ const r = await fetch(rel+`?_${Date.now()}`); if(!r.ok) throw 'HTTP '+r.status; return r.json(); }

// GitHub contents API helpers
async function getFile(path){
  const r = await fetch(API(`contents/${path}`), { headers: {Authorization:`Bearer ${state.token}`}});
  if(!r.ok) throw await r.text();
  return r.json(); // includes sha, content (base64)
}
async function commitFile(path, message, base64, sha/*optional*/){
  const body = { message, content: base64, branch: state.branch };
  if(sha) body.sha = sha;
  const r = await fetch(API(`contents/${path}`), {
    method:'PUT',
    headers:{'Authorization':`Bearer ${state.token}`,'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok) throw await r.text();
  return r.json();
}
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload=()=>res(fr.result.split(',')[1]);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}

// ----------------- (1) 연결 테스트 -----------------
$('#saveLocal').onclick = saveLocal;
$('#logout').onclick = logout;
$('#testConn').onclick = async ()=>{
  try{
    saveLocal();
    const j = await getFile('README.md'); // repo 존재 확인 용
    ok('연결 성공 · README.md 확인됨');
  }catch(e){ console.error(e); err('연결 실패: '+(e?.message||e)); }
};

// ----------------- (2) 작품 업로드 -----------------
$('#awImage').onchange = async e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  $('#awPreview').innerHTML = `<img class="preview" src="${url}">`;
};

$('#btnUploadAw').onclick = async ()=>{
  try{
    saveLocal();
    const id = $('#awId').value.trim();
    if(!id) throw 'Artwork ID 필수';
    const file = $('#awImage').files?.[0];
    if(!file) throw '이미지 파일을 선택하세요.';

    // 1) 이미지 업로드
    const imgPath = `images/artworks/${id}${file.name.toLowerCase().endsWith('.png')?'.png':'.jpg'}`;
    const base64 = await fileToBase64(file);
    let prev = null;
    try{ const ex = await getFile(imgPath); prev = ex.sha; }catch(_){} // 없으면 무시
    await commitFile(imgPath, `upload artwork image: ${id}`, base64, prev);

    // 2) artworks.json 업데이트
    const dataPath = 'data/artworks.json';
    let art = { items:[] }, sha = null;
    try{ const raw = await getFile(dataPath); sha = raw.sha; art = JSON.parse(atob(raw.content)); }catch(_){}
    const item = {
      id, title: $('#awTitle').value.trim(),
      series: $('#awSeries').value, year: $('#awYear').value.trim(),
      medium: $('#awMedium').value.trim(), size: $('#awSize').value.trim(),
      image: '/'+imgPath
    };
    const found = art.items.find(x=>x.id===id);
    if(found) Object.assign(found, item); else art.items.push(item);
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(art,null,2))));
    await commitFile(dataPath, `update artworks.json : ${id}`, b64, sha);

    ok('이미지 업로드 + artworks.json 저장 완료');
  }catch(e){ console.error(e); err('오류: '+(e?.message||e)); }
};

$('#btnRefreshAw').onclick = async ()=>{
  try{
    const j = await getJson('/data/artworks.json');
    $('#awPreview').innerHTML = `<small class="code">현재 작품 수: ${j.items.length}</small>`;
    ok('목록 새로고침 완료');
  }catch(e){ err('목록 로드 실패'); }
};

// ----------------- (3) 미학 보고서 저장 -----------------
$('#btnSaveReport').onclick = async ()=>{
  try{
    saveLocal();
    const id = $('#rpId').value.trim();
    if(!id) throw 'Report ID 필수';

    const sections = [...document.querySelectorAll('.sec-title')].map((el,i)=>({
      title: el.value.trim(),
      body: document.querySelectorAll('.sec-body')[i].value.trim()
    })).filter(s=>s.title || s.body);

    const r = {
      id,
      title_en: $('#rpTitleEn').value.trim(),
      title_ko: $('#rpTitleKo').value.trim(),
      series: $('#rpSeries').value.trim(),
      year: $('#rpYear').value.trim(),
      abstract: $('#rpAbstract').value.trim(),
      sections
    };

    const dataPath = 'data/reports.json';
    let json = { reports:[] }, sha = null;
    try{ const raw = await getFile(dataPath); sha = raw.sha; json = JSON.parse(atob(raw.content)); }catch(_){}
    const found = json.reports.find(x=>x.id===id);
    if(found) Object.assign(found, r); else json.reports.push(r);
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(json,null,2))));
    await commitFile(dataPath, `update reports.json : ${id}`, b64, sha);

    ok(`리포트 저장 완료: ${id}`);
  }catch(e){ console.error(e); err('오류: '+(e?.message||e)); }
};

// 초기화
loadLocal();
</script>
</body>
</html>
