<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Â· Admin Î©.23 â€” Works & DCAR Auto Manager</title>
  <meta name="color-scheme" content="dark light">

  <style>
  :root{
    --bg:#0b1020; --panel:#111a37; --ink:#eaf0ff; --sub:#9faee6;
    --accent:#f4c96b; --accent-soft:rgba(244,201,107,0.16);
    --danger:#ff5c7a; --ok:#5dd39e; --border:#1f2750;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New",monospace;
    --sans:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
  }

  *{box-sizing:border-box;}

  html,body{
    margin:0; padding:0;
    width:100%; height:100%;
    background:radial-gradient(circle at 10% 0%, #202c60 0, #050814 40%, #030510 100%);
    color:var(--ink);
    font-family:var(--sans);
  }

  body{
    -webkit-font-smoothing:antialiased;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  main{
    width:100%; max-width:1240px;
    padding:16px 12px 80px;
  }
  @media (min-width:768px){
    main{padding:24px 24px 96px;}
  }

  .hero-title{
    font-size:22px;
    font-weight:700;
    letter-spacing:.04em;
    color:var(--accent);
  }
  .hero-sub{
    margin-top:4px;
    font-size:13px;
    color:var(--sub);
  }

  .badge-row{
    margin-top:6px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(244,201,107,0.5);
    background:rgba(0,0,0,.3);
    color:var(--accent);
    font-size:11px;
  }

  .grid{
    margin-top:20px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  @media(min-width:900px){
    .grid{
      display:grid;
      grid-template-columns:minmax(260px,320px) minmax(0,1fr);
      align-items:flex-start;
    }
  }

  .card{
    background:linear-gradient(145deg,rgba(17,26,55,0.96),rgba(5,9,30,0.98));
    border-radius:18px;
    border:1px solid var(--border);
    padding:14px 14px 16px;
    box-shadow:0 18px 40px rgba(0,0,0,0.55);
  }

  .card h2{
    font-size:15px;
    margin:0 0 8px;
  }
  .card h3{
    font-size:14px;
    margin:10px 0 6px;
  }
  .card p.helper{
    font-size:12px;
    color:var(--sub);
    margin:0 0 10px;
  }

  .field{
    margin-bottom:10px;
  }
  .field label{
    display:block;
    font-size:12px;
    margin-bottom:3px;
    color:var(--sub);
  }
  .field small{
    display:block;
    font-size:11px;
    color:var(--sub);
  }

  input,select,textarea{
    width:100%;
    border-radius:10px;
    border:1px solid #222a55;
    background:#050716;
    color:var(--ink);
    padding:7px 9px;
    font-size:13px;
    font-family:inherit;
  }
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(244,201,107,0.3);
  }
  textarea{
    min-height:120px;
    resize:vertical;
  }

  textarea.full-text{
    font-family:var(--mono);
    font-size:12px;
    line-height:1.5;
    white-space:pre-wrap;
  }

  .token-input{
    font-family:var(--mono);
    font-size:11px;
  }

  .btn-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
  }
  button{
    border-radius:999px;
    border:1px solid transparent;
    padding:7px 14px;
    font-size:13px;
    font-weight:500;
    cursor:pointer;
    background:var(--accent-soft);
    color:var(--accent);
  }
  button.primary{
    background:var(--accent);
    color:#050714;
  }
  button.subtle{
    background:transparent;
    border-color:#343c70;
    color:var(--sub);
  }
  button.danger{
    background:rgba(255,92,122,0.12);
    border-color:rgba(255,92,122,0.7);
    color:var(--danger);
  }
  button:disabled{
    opacity:0.5;
    cursor:default;
  }

  .status-bar{
    margin-top:10px;
    font-size:12px;
    padding:7px 9px;
    border-radius:999px;
    background:rgba(9,16,40,0.9);
    border:1px solid #202953;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .status-dot{
    width:8px; height:8px; border-radius:50%;
    background:#666;
  }
  .status-bar.ok .status-dot{background:var(--ok);}
  .status-bar.err .status-dot{background:var(--danger);}
  .status-text{flex:1; color:var(--sub);}

  .list{
    border-radius:12px;
    border:1px solid #202953;
    background:rgba(2,5,20,0.7);
    max-height:360px;
    overflow:auto;
    margin-top:8px;
  }
  .list-item{
    padding:8px 10px;
    border-bottom:1px solid #151b3d;
    font-size:12px;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .list-item:last-child{border-bottom:none;}
  .list-item strong{
    font-size:13px;
  }
  .list-item span.meta{
    color:var(--sub);
  }
  .list-item button{
    margin-top:4px;
    align-self:flex-start;
    font-size:11px;
    padding:4px 10px;
  }

  .tab-bar{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-bottom:10px;
  }
  .tab-bar .tab{
    border-radius:999px;
    border:1px solid #343c70;
    padding:6px 12px;
    font-size:12px;
    background:rgba(5,8,24,0.8);
    color:var(--sub);
    cursor:pointer;
  }
  .tab-bar .tab.active{
    background:var(--accent);
    border-color:var(--accent);
    color:#050714;
  }
  .tab-content{display:none;}
  .tab-content.active{display:block;}

  @supports(padding:max(0px)){
    body{
      padding-bottom:max(16px,env(safe-area-inset-bottom));
      padding-top:max(0px,env(safe-area-inset-top));
    }
  }

  @media (prefers-reduced-motion: reduce){
    *{scroll-behavior:auto !important; animation:none !important;transition:none !important;}
  }
  </style>
</head> <body data-theme="dark">
  <main>
    <header class="top-head">
      <div class="hero-title">ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Â· Admin Î©.23</div>
      <div class="hero-sub">100 ì‘í’ˆ Â· DCAR ë¯¸í•™ ë³´ê³ ì„œ Â· GitHub ìë™ ì—°ë™ ì‹œìŠ¤í…œ</div>
      <div class="badge-row">
        <div class="badge">
          <span>âš™ï¸ Auto GitHub Manager</span>
          <span>Works(100) + DCAR Reports ì™„ì „ ìë™í™”</span>
        </div>
      </div>
    </header>

    <section class="grid">

      <!-- LEFT: GITHUB -->
      <section class="card left">
        <h2>â… . GitHub ì—°ê²° ì„¤ì •</h2>
        <p class="helper">í•œë²ˆë§Œ ì„¤ì •í•˜ë©´ ìë™ ì—…ë¡œë“œë©ë‹ˆë‹¤.</p>

        <div class="field">
          <label>GitHub Owner</label>
          <input id="ownerInput" value="dungzakcestlavie">
        </div>

        <div class="field">
          <label>Repository</label>
          <input id="repoInput" value="dungzakcestlavie.github.io">
        </div>

        <div class="field">
          <label>Branch</label>
          <input id="branchInput" value="main">
        </div>

        <div class="field">
          <label>Personal Access Token</label>
          <input id="tokenInput" type="password" class="token-input" placeholder="ghp_...">
        </div>

        <div class="btn-row">
          <button id="btnSaveConfig" class="primary">ğŸ” ì„¤ì • ì €ì¥</button>
          <button id="btnLoadConfig" class="subtle">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="btnClearConfig" class="danger">ì´ˆê¸°í™”</button>
        </div>

        <div id="statusBar" class="status-bar">
          <div id="statusDot" class="status-dot"></div>
          <div id="statusText" class="status-text">ì¤€ë¹„ë¨.</div>
        </div>
      </section>

      <!-- RIGHT: WORKS + REPORTS -->
      <section class="card right">

        <div class="tab-bar">
          <button class="tab active" data-tab="works">ğŸ¨ ì‘í’ˆ(Works) 100 ìë™ê´€ë¦¬</button>
          <button class="tab" data-tab="reports">ğŸ“š ë¯¸í•™ ë³´ê³ ì„œ DCAR ìë™ê´€ë¦¬</button>
        </div>

        <!-- WORKS -->
        <div id="tab-works" class="tab-content active">
          <h2>â…¡. ì‘í’ˆ ì—…ë¡œë“œ / ë©”íƒ€ë°ì´í„° ìë™ ê´€ë¦¬</h2>
          <p class="helper">ì´ 100ì , 5ì„¹ì…˜ Ã— 20ì </p>

          <div class="field">
            <label>ì„¹ì…˜ ì„ íƒ (í™ˆí˜ì´ì§€ì™€ ë™ì¼)</label>
            <select id="worksSection">
              <option value="â…  ìš°ë¦¬ë¥¼ ìœ„í•´ ê¸°ë„í•´ ì£¼ì„¸ìš” Â· Pray for Us">â…  ìš°ë¦¬ë¥¼ ìœ„í•´ ê¸°ë„í•´ ì£¼ì„¸ìš” Â· Pray for Us</option>
              <option value="â…¡ ì¸ê°„ Â· Human Being">â…¡ ì¸ê°„ Â· Human Being</option>
              <option value="â…¢ ì •ì‹ ì˜ ì¬íƒ„ìƒ Â· Rebirth of Mind">â…¢ ì •ì‹ ì˜ ì¬íƒ„ìƒ Â· Rebirth of Mind</option>
              <option value="â…£ ì¡´ì¬ì˜ íšŒë³µ Â· Restoration of Being">â…£ ì¡´ì¬ì˜ íšŒë³µ Â· Restoration of Being</option>
              <option value="â…¤ ë¹›ì˜ ì´ˆì˜ì‹ Â· Metaconsciousness of Light">â…¤ ë¹›ì˜ ì´ˆì˜ì‹ Â· Metaconsciousness of Light</option>
            </select>
          </div>

          <div class="field">
            <label>ì‘í’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
            <input id="worksFiles" type="file" accept="image/*" multiple>
          </div>

          <div class="field">
            <label>ì‘í’ˆëª… (KO)</label>
            <input id="worksTitleKo">
          </div>

          <div class="field">
            <label>ì‘í’ˆëª… (EN)</label>
            <input id="worksTitleEn">
          </div>

          <div class="field">
            <label>ì¬ë£Œ (KO)</label>
            <input id="worksMediumKo">
          </div>

          <div class="field">
            <label>Material (EN)</label>
            <input id="worksMediumEn">
          </div>

          <div class="field">
            <label>í¬ê¸° (KO)</label>
            <input id="worksSizeKo">
          </div>

          <div class="field">
            <label>Size (EN)</label>
            <input id="worksSizeEn">
          </div>

          <div class="field">
            <label>ì œì‘ë…„ë„</label>
            <input id="worksYear" value="2025">
          </div>

          <div class="btn-row">
            <button id="btnUploadWorks" class="primary">ğŸ“¤ ì‘í’ˆ ì—…ë¡œë“œ</button>
            <button id="btnUpdateMetaOnly" class="subtle">âœï¸ ë©”íƒ€ë°ì´í„° ìˆ˜ì •</button>
            <button id="btnReloadWorks" class="subtle">ğŸ“¥ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>

          <h3 style="margin-top:14px;">ğŸ“‘ ì—…ë¡œë“œëœ ì‘í’ˆ ëª©ë¡</h3>
          <div id="worksList" class="list"></div>
        </div>

        <!-- REPORTS -->
        <div id="tab-reports" class="tab-content">
          <!-- âš  DCAR ë¯¸í•™ ë³´ê³ ì„œ: ë°ì´í„° êµ¬ì¡°/í…ìŠ¤íŠ¸ ì ˆëŒ€ ë³€ê²½ ì—†ìŒ -->
          <h2>â…¢. ë¯¸í•™ ë³´ê³ ì„œ DCAR ìë™ ê´€ë¦¬</h2>
          <p class="helper">ê¸°ì¡´ DCAR êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. (ID Â· ìš”ì•½ Â· ì „ì²´ í…ìŠ¤íŠ¸)</p>

          <div class="field">
            <label>Report ID (ì˜ˆ: DCAR-03-2025)</label>
            <input id="rId" placeholder="DCAR-03-2025">
          </div>

          <div class="field">
            <label>Category</label>
            <select id="rCategory">
              <option value="Theory">Theory</option>
              <option value="Practice">Practice</option>
              <option value="Note">Note</option>
            </select>
          </div>

          <div class="field">
            <label>Year</label>
            <input id="rYear" value="2025">
          </div>

          <div class="field">
            <label>ì œëª© (KO)</label>
            <input id="rTitleKo">
          </div>

          <div class="field">
            <label>Title (EN)</label>
            <input id="rTitleEn">
          </div>

          <div class="field">
            <label>ìš”ì•½ (KO)</label>
            <textarea id="rSummaryKo"></textarea>
          </div>

          <div class="field">
            <label>Summary (EN)</label>
            <textarea id="rSummaryEn"></textarea>
          </div>

          <div class="field">
            <label>ì „ì²´ ë³¸ë¬¸ (Markdown Â· í•œì˜ í˜¼ìš© ê°€ëŠ¥)</label>
            <textarea id="rFull" class="full-text"></textarea>
          </div>

          <div class="btn-row">
            <button id="btnSaveReport" class="primary">ğŸ’¾ ë³´ê³ ì„œ ì €ì¥</button>
            <button id="btnNewReport" class="subtle">ğŸ†• ìƒˆ ë³´ê³ ì„œ</button>
            <button id="btnReloadReports" class="subtle">ğŸ“¥ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>

          <h3 style="margin-top:14px;">ğŸ“‘ ë“±ë¡ëœ DCAR ë³´ê³ ì„œ ëª©ë¡</h3>
          <div id="reportsList" class="list"></div>
        </div>

      </section>
    </section>
  </main>

  <!-- SCRIPTëŠ” ì•„ë˜ì— -->
  <script> // =========================
// ê³µí†µ: DOM & ìƒíƒœ
// =========================
const ownerInput   = document.getElementById('ownerInput');
const repoInput    = document.getElementById('repoInput');
const branchInput  = document.getElementById('branchInput');
const tokenInput   = document.getElementById('tokenInput');

const statusBar    = document.getElementById('statusBar');
const statusDot    = document.getElementById('statusDot');
const statusText   = document.getElementById('statusText');

// Works DOM
const worksSectionSel = document.getElementById('worksSection');
const worksFilesInput = document.getElementById('worksFiles');
const worksTitleKo    = document.getElementById('worksTitleKo');
const worksTitleEn    = document.getElementById('worksTitleEn');
const worksMediumKo   = document.getElementById('worksMediumKo');
const worksMediumEn   = document.getElementById('worksMediumEn');
const worksSizeKo     = document.getElementById('worksSizeKo');
const worksSizeEn     = document.getElementById('worksSizeEn');
const worksYear       = document.getElementById('worksYear');
const worksListEl     = document.getElementById('worksList');

const btnUploadWorks   = document.getElementById('btnUploadWorks');
const btnReloadWorks   = document.getElementById('btnReloadWorks');
const btnUpdateMeta    = document.getElementById('btnUpdateMetaOnly');

// Reports DOM (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
const rId        = document.getElementById('rId');
const rCategory  = document.getElementById('rCategory');
const rYear      = document.getElementById('rYear');
const rTitleKo   = document.getElementById('rTitleKo');
const rTitleEn   = document.getElementById('rTitleEn');
const rSummaryKo = document.getElementById('rSummaryKo');
const rSummaryEn = document.getElementById('rSummaryEn');
const rFull      = document.getElementById('rFull');
const reportsListEl = document.getElementById('reportsList');

const btnSaveConfig   = document.getElementById('btnSaveConfig');
const btnLoadConfig   = document.getElementById('btnLoadConfig');
const btnClearConfig  = document.getElementById('btnClearConfig');

const btnSaveReport   = document.getElementById('btnSaveReport');
const btnNewReport    = document.getElementById('btnNewReport');
const btnReloadReports= document.getElementById('btnReloadReports');

// Tabs
const tabButtons  = Array.from(document.querySelectorAll('.tab-bar .tab'));
const tabWorks    = document.getElementById('tab-works');
const tabReports  = document.getElementById('tab-reports');

// GitHub paths
const WORKS_JSON_PATH   = 'data/works.json';
const REPORTS_JSON_PATH = 'reports/reports.json';

// Works & Reports ìƒíƒœ
const EMPTY_WORKS = {
  "â…  ìš°ë¦¬ë¥¼ ìœ„í•´ ê¸°ë„í•´ ì£¼ì„¸ìš” Â· Pray for Us": [],
  "â…¡ ì¸ê°„ Â· Human Being": [],
  "â…¢ ì •ì‹ ì˜ ì¬íƒ„ìƒ Â· Rebirth of Mind": [],
  "â…£ ì¡´ì¬ì˜ íšŒë³µ Â· Restoration of Being": [],
  "â…¤ ë¹›ì˜ ì´ˆì˜ì‹ Â· Metaconsciousness of Light": []
};

let worksData      = JSON.parse(JSON.stringify(EMPTY_WORKS));
let worksJsonSha   = null;
let currentWorkId  = null;
let currentWorkSect= null;

let reportsData    = { reports: [] };
let reportsJsonSha = null;
let currentReportId= null;

// ì„¹ì…˜-í”„ë¦¬í”½ìŠ¤ ë§µ (ìƒˆ ê·œì¹™)
const SECTION_PREFIX = {
  "â…  ìš°ë¦¬ë¥¼ ìœ„í•´ ê¸°ë„í•´ ì£¼ì„¸ìš” Â· Pray for Us": "PFU",
  "â…¡ ì¸ê°„ Â· Human Being": "HB",
  "â…¢ ì •ì‹ ì˜ ì¬íƒ„ìƒ Â· Rebirth of Mind": "RM",
  "â…£ ì¡´ì¬ì˜ íšŒë³µ Â· Restoration of Being": "RB",
  "â…¤ ë¹›ì˜ ì´ˆì˜ì‹ Â· Metaconsciousness of Light": "ML"
};

// =========================
// ê³µí†µ ìœ í‹¸
// =========================
function setStatus(msg, type){
  statusText.textContent = msg;
  statusBar.classList.remove('ok','err');
  if(type === 'ok')  statusBar.classList.add('ok');
  if(type === 'err') statusBar.classList.add('err');
}

function getConfig(){
  return {
    owner : ownerInput.value.trim(),
    repo  : repoInput.value.trim(),
    branch: branchInput.value.trim(),
    token : tokenInput.value.trim()
  };
}

function saveConfigToLocal(){
  const cfg = getConfig();
  localStorage.setItem('dz_admin_cfg', JSON.stringify({
    owner: cfg.owner,
    repo: cfg.repo,
    branch: cfg.branch
  }));
  if(cfg.token){
    localStorage.setItem('dz_admin_token', cfg.token);
  }
  setStatus('GitHub ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.', 'ok');
}

function loadConfigFromLocal(){
  try{
    const rawCfg   = localStorage.getItem('dz_admin_cfg');
    const rawToken = localStorage.getItem('dz_admin_token');
    if(rawCfg){
      const cfg = JSON.parse(rawCfg);
      if(cfg.owner)  ownerInput.value  = cfg.owner;
      if(cfg.repo)   repoInput.value   = cfg.repo;
      if(cfg.branch) branchInput.value = cfg.branch;
    }
    if(rawToken){
      tokenInput.value = rawToken;
    }
    setStatus('ì €ì¥ëœ ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'ok');
  }catch(e){
    console.error(e);
    setStatus('ì €ì¥ëœ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'err');
  }
}

function clearConfig(){
  localStorage.removeItem('dz_admin_cfg');
  localStorage.removeItem('dz_admin_token');
  tokenInput.value = '';
  setStatus('ì €ì¥ëœ ì„¤ì •ê³¼ í† í°ì„ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.', 'ok');
}

function encodeBase64(str){
  return btoa(unescape(encodeURIComponent(str)));
}
function decodeBase64(str){
  return decodeURIComponent(escape(atob(str)));
}

// GitHub Contents API GET
async function ghFetch(path, options = {}){
  const cfg = getConfig();
  if(!cfg.owner || !cfg.repo || !cfg.branch || !cfg.token){
    throw new Error('GitHub ì„¤ì •ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
  }
  const url =
    `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(cfg.branch)}`;

  const headers = Object.assign({
    'Accept':'application/vnd.github+json',
    'Authorization':`Bearer ${cfg.token}`
  }, options.headers || {});

  const res = await fetch(url, Object.assign({}, options, { headers }));
  return res;
}

async function ghGetSha(path){
  try{
    const res = await ghFetch(path,{method:'GET'});
    if(!res.ok) return null;
    const data = await res.json();
    return data.sha || null;
  }catch(e){
    return null;
  }
}

async function ghPutText(path, contentStr, message, existingSha){
  const cfg = getConfig();
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const bodyObj = {
    path,
    message,
    content: encodeBase64(contentStr),
    branch: cfg.branch
  };
  if(existingSha){
    bodyObj.sha = existingSha;
  }
  const res = await fetch(url,{
    method:'PUT',
    headers:{
      'Accept':'application/vnd.github+json',
      'Authorization':`Bearer ${cfg.token}`,
      'Content-Type':'application/json'
    },
    body: JSON.stringify(bodyObj)
  });
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    throw new Error((err && err.message) || `GitHub ì €ì¥ ì‹¤íŒ¨ (${res.status})`);
  }
  return res.json();
}

function readFileAsBase64(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = e=>{
      const result = String(e.target.result || '');
      const base64 = result.split(',')[1] || '';
      resolve(base64);
    };
    fr.onerror = ()=>reject(new Error('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
    fr.readAsDataURL(file);
  });
}

async function ghPutImage(path, base64, message){
  const cfg = getConfig();
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const existingSha = await ghGetSha(path);
  const bodyObj = {
    path,
    message,
    content: base64,
    branch: cfg.branch
  };
  if(existingSha){
    bodyObj.sha = existingSha;
  }
  const res = await fetch(url,{
    method:'PUT',
    headers:{
      'Accept':'application/vnd.github+json',
      'Authorization':`Bearer ${cfg.token}`,
      'Content-Type':'application/json'
    },
    body: JSON.stringify(bodyObj)
  });
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    throw new Error((err && err.message) || `ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨ (${res.status})`);
  }
  return res.json();
}

// =========================
// Works â€” data/works.json
// =========================
async function loadWorksJson(){
  setStatus('GitHubì—ì„œ data/works.json ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
  worksJsonSha = null;
  try{
    const res = await ghFetch(WORKS_JSON_PATH,{method:'GET'});
    if(res.status === 404){
      worksData = JSON.parse(JSON.stringify(EMPTY_WORKS));
      worksJsonSha = null;
      setStatus('data/works.json ì´ ì•„ì§ ì—†ì–´ ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.', 'ok');
      renderWorksList();
      return;
    }
    if(!res.ok){
      const err = await res.json().catch(()=>({}));
      throw new Error('data/works.json ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || res.status));
    }
    const data = await res.json();
    const content = decodeBase64(String(data.content || '').replace(/\n/g,''));
    let parsed = JSON.parse(content || '{}');
    if(typeof parsed !== 'object' || !parsed){
      parsed = {};
    }
    // ìƒˆ êµ¬ì¡° ê¸°ì¤€ìœ¼ë¡œ ë¨¸ì§€
    worksData = JSON.parse(JSON.stringify(EMPTY_WORKS));
    Object.keys(worksData).forEach(key=>{
      if(Array.isArray(parsed[key])){
        worksData[key] = parsed[key];
      }
    });

    worksJsonSha = data.sha || null;
    setStatus('data/works.json ë¡œë“œ ì„±ê³µ.', 'ok');
    renderWorksList();
  }catch(e){
    console.error(e);
    setStatus(e.message || 'ì‘í’ˆ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'err');
  }
}

async function saveWorksJson(){
  setStatus('data/works.json GitHubì— ì €ì¥ ì¤‘â€¦');
  const pretty = JSON.stringify(worksData, null, 2);
  const res = await ghPutText(
    WORKS_JSON_PATH,
    pretty,
    'Update data/works.json via Admin Î©.23',
    worksJsonSha
  );
  worksJsonSha = res && res.content && res.content.sha || worksJsonSha;
  setStatus('data/works.json ì €ì¥ ì™„ë£Œ.', 'ok');
}

function renderWorksList(){
  worksListEl.innerHTML = '';
  const sections = Object.keys(worksData);
  let any = false;

  sections.forEach(sec=>{
    const arr = Array.isArray(worksData[sec]) ? worksData[sec] : [];
    arr.forEach(w=>{
      any = true;
      const div = document.createElement('div');
      div.className = 'list-item';

      const title = document.createElement('strong');
      const idStr = w.id ? ` Â· ${w.id}` : '';
      title.textContent = `${sec}${idStr} Â· ${w.title_ko || w.title_en || ''}`;
      div.appendChild(title);

      const meta = document.createElement('span');
      meta.className = 'meta';
      const sizeStr = w.size_ko || w.size_en || '';
      const matStr  = w.material_ko || w.material_en || '';
      const yr      = w.year || '';
      meta.textContent = [matStr, sizeStr, yr].filter(Boolean).join(' Â· ');
      div.appendChild(meta);

      if(w.image){
        const imgSpan = document.createElement('span');
        imgSpan.className = 'meta';
        imgSpan.textContent = `íŒŒì¼: ${w.image}`;
        div.appendChild(imgSpan);
      }

      const btn = document.createElement('button');
      btn.textContent = 'ì´ ì‘í’ˆ ë¶ˆëŸ¬ì˜¤ê¸°';
      btn.addEventListener('click', ()=>{
        loadWorkIntoForm(sec, w.id);
      });
      div.appendChild(btn);

      worksListEl.appendChild(div);
    });
  });

  if(!any){
    const empty = document.createElement('div');
    empty.className = 'list-item';
    empty.innerHTML = '<span class="meta">ì•„ì§ ë“±ë¡ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</span>';
    worksListEl.appendChild(empty);
  }
}

function findWork(sec, id){
  const arr = Array.isArray(worksData[sec]) ? worksData[sec] : [];
  return arr.find(w=>w.id === id) || null;
}

function loadWorkIntoForm(sec, id){
  const w = findWork(sec, id);
  if(!w){
    setStatus(`${sec} ì—ì„œ ${id} ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'err');
    return;
  }
  worksSectionSel.value = sec;
  worksTitleKo.value  = w.title_ko || '';
  worksTitleEn.value  = w.title_en || '';
  worksMediumKo.value = w.material_ko || '';
  worksMediumEn.value = w.material_en || '';
  worksSizeKo.value   = w.size_ko || '';
  worksSizeEn.value   = w.size_en || '';
  worksYear.value     = w.year || '';
  currentWorkId       = w.id || null;
  currentWorkSect     = sec;
  setStatus(`ì‘í’ˆ ${sec} Â· ${w.id} ë©”íƒ€ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'ok');
}

function getNextIndex(sec){
  const arr = Array.isArray(worksData[sec]) ? worksData[sec] : [];
  return arr.length + 1;
}

async function handleUploadWorks(){
  const sec = worksSectionSel.value;
  if(!sec){
    setStatus('ì„¹ì…˜ì„ ì„ íƒí•˜ì„¸ìš”.', 'err');
    return;
  }
  const files   = Array.from(worksFilesInput.files || []);
  const titleKo = worksTitleKo.value.trim();
  const yearVal = worksYear.value.trim();

  if(!files.length && !currentWorkId){
    setStatus('ìƒˆ ì‘í’ˆì„ ì¶”ê°€í•˜ë ¤ë©´ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜, ê¸°ì¡´ ì‘í’ˆì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'err');
    return;
  }

  // ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  if(files.length){
    try{
      btnUploadWorks.disabled = true;
      setStatus('ì‘í’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° data/works.json ê°±ì‹  ì¤‘â€¦');

      if(!Array.isArray(worksData[sec])){
        worksData[sec] = [];
      }
      let baseCount = worksData[sec].length;
      const prefix  = SECTION_PREFIX[sec] || 'WK';

      for(let i=0;i<files.length;i++){
        const file = files[i];
        const extMatch = file.name.match(/\.[^.]+$/);
        const ext = extMatch ? extMatch[0].toLowerCase() : '.jpg';

        const idx = baseCount + 1;
        if(idx > 20){
          setStatus(`${sec} ì„¹ì…˜ì€ 20ì ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'err');
          break;
        }

        const id    = `${prefix}-${String(idx).padStart(2,'0')}`;
        const fname = `${id}${ext}`;
        const base64 = await readFileAsBase64(file);

        await ghPutImage(`images/standard/${fname}`, base64, `Upload standard image ${fname} via Admin Î©.23`);
        await ghPutImage(`images/zoom/${fname}`,     base64, `Upload zoom image ${fname} via Admin Î©.23`);

        const entry = {
          id,
          title_ko   : titleKo,
          title_en   : worksTitleEn.value.trim(),
          material_ko: worksMediumKo.value.trim(),
          material_en: worksMediumEn.value.trim().toLowerCase(), // í•­ìƒ ì†Œë¬¸ì
          size_ko    : worksSizeKo.value.trim(),
          size_en    : worksSizeEn.value.trim(),
          year       : yearVal || '',
          image      : fname
        };

        worksData[sec].push(entry);
        baseCount++;
        currentWorkId   = id;
        currentWorkSect = sec;
      }

      await saveWorksJson();
      renderWorksList();
      setStatus('ì‘í’ˆ ì—…ë¡œë“œ ë° data/works.json ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ok');

    }catch(e){
      console.error(e);
      setStatus(e.message || 'ì‘í’ˆ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'err');
    }finally{
      btnUploadWorks.disabled = false;
    }
    return;
  }

  // ë©”íƒ€ë°ì´í„°ë§Œ ìˆ˜ì •
  if(!currentWorkId || !currentWorkSect){
    setStatus('ë©”íƒ€ë°ì´í„°ë§Œ ìˆ˜ì •í•˜ë ¤ë©´ ë¨¼ì € ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš”.', 'err');
    return;
  }
  try{
    const arr = Array.isArray(worksData[currentWorkSect]) ? worksData[currentWorkSect] : [];
    const idx = arr.findIndex(w=>w.id === currentWorkId);
    if(idx < 0){
      setStatus('ì„ íƒëœ ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'err');
      return;
    }
    const old = arr[idx];
    arr[idx] = Object.assign({}, old, {
      title_ko   : worksTitleKo.value.trim(),
      title_en   : worksTitleEn.value.trim(),
      material_ko: worksMediumKo.value.trim(),
      material_en: worksMediumEn.value.trim().toLowerCase(),
      size_ko    : worksSizeKo.value.trim(),
      size_en    : worksSizeEn.value.trim(),
      year       : worksYear.value.trim()
    });
    worksData[currentWorkSect] = arr;

    await saveWorksJson();
    renderWorksList();
    setStatus(`ì‘í’ˆ ${currentWorkSect} Â· ${currentWorkId} ë©”íƒ€ë°ì´í„°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.`, 'ok');

  }catch(e){
    console.error(e);
    setStatus(e.message || 'ë©”íƒ€ë°ì´í„° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'err');
  }
}

async function handleUpdateMetaOnly(){
  if(!currentWorkId || !currentWorkSect){
    setStatus('ë©”íƒ€ë°ì´í„°ë§Œ ìˆ˜ì •í•˜ë ¤ë©´ ë¨¼ì € ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš”.', 'err');
    return;
  }
  await handleUploadWorks();
}

// =========================
// Reports â€” reports.json + markdown
// (ê¸°ì¡´ êµ¬ì¡° ê·¸ëŒ€ë¡œ ìœ ì§€)
// =========================
async function loadReportsJson(){
  setStatus('GitHubì—ì„œ reports.json ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
  reportsJsonSha = null;
  try{
    const res = await ghFetch(REPORTS_JSON_PATH,{method:'GET'});
    if(res.status === 404){
      reportsData = { reports: [] };
      reportsJsonSha = null;
      setStatus('reports.json ì´ ì•„ì§ ì—†ì–´ ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.', 'ok');
      renderReportsList();
      return;
    }
    if(!res.ok){
      const err = await res.json().catch(()=>({}));
      throw new Error('reports.json ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || res.status));
    }
    const data = await res.json();
    const content = decodeBase64(String(data.content || '').replace(/\n/g,''));
    let parsed = JSON.parse(content || '{"reports":[]}');
    if(!parsed || !Array.isArray(parsed.reports)){
      parsed = { reports: [] };
    }
    reportsData = parsed;
    reportsJsonSha = data.sha || null;

    setStatus('reports.json ë¡œë“œ ì„±ê³µ.', 'ok');
    renderReportsList();
  }catch(e){
    console.error(e);
    setStatus(e.message || 'ë³´ê³ ì„œ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'err');
  }
}

async function saveReportsJson(){
  setStatus('reports.json GitHubì— ì €ì¥ ì¤‘â€¦');
  const pretty = JSON.stringify(reportsData, null, 2);
  const res = await ghPutText(
    REPORTS_JSON_PATH,
    pretty,
    'Update reports.json via Admin Î©.23',
    reportsJsonSha
  );
  reportsJsonSha = res && res.content && res.content.sha || reportsJsonSha;
  setStatus('reports.json ì €ì¥ ì™„ë£Œ.', 'ok');
}

function renderReportsList(){
  reportsListEl.innerHTML = '';
  if(!Array.isArray(reportsData.reports) || !reportsData.reports.length){
    const empty = document.createElement('div');
    empty.className = 'list-item';
    empty.innerHTML = '<span class="meta">ì•„ì§ ë“±ë¡ëœ ë¯¸í•™ ë³´ê³ ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
    reportsListEl.appendChild(empty);
    return;
  }
  reportsData.reports
    .slice()
    .sort((a,b)=> (a.id||'').localeCompare(b.id||''))
    .forEach(r=>{
      const div = document.createElement('div');
      div.className = 'list-item';

      const title = document.createElement('strong');
      title.textContent = `${r.id || ''} Â· ${r.title_ko || r.title_en || ''}`;
      div.appendChild(title);

      const meta = document.createElement('span');
      meta.className = 'meta';
      meta.textContent = `${r.year || ''} Â· ${r.category || ''}`;
      div.appendChild(meta);

      const btn = document.createElement('button');
      btn.textContent = 'ì´ ë³´ê³ ì„œ ë¶ˆëŸ¬ì˜¤ê¸°';
      btn.addEventListener('click', ()=>loadReportIntoForm(r.id));
      div.appendChild(btn);

      reportsListEl.appendChild(div);
    });
}

async function loadMarkdownForReport(id){
  const mdPath = `reports/${id}.md`;
  setStatus(`${mdPath} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
  const res = await ghFetch(mdPath,{method:'GET'});
  if(res.status === 404){
    rFull.value = '';
    setStatus(`${mdPath} ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ìƒˆ íŒŒì¼ë¡œ ì €ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'ok');
    return { sha:null, content:'' };
  }
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    throw new Error('Markdown ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || res.status));
  }
  const data = await res.json();
  const text = decodeBase64(String(data.content || '').replace(/\n/g,''));
  rFull.value = text;
  setStatus(`${mdPath} ë¡œë“œ ì™„ë£Œ.`, 'ok');
  return { sha:data.sha || null, content:text };
}

async function saveMarkdownForReport(id, existingSha){
  const mdPath = `reports/${id}.md`;
  setStatus(`${mdPath} GitHubì— ì €ì¥ ì¤‘â€¦`);
  await ghPutText(
    mdPath,
    rFull.value || '',
    `Update ${mdPath} via Admin Î©.23`,
    existingSha || null
  );
  setStatus(`${mdPath} ì €ì¥ ì™„ë£Œ.`, 'ok');
}

function clearReportForm(){
  rId.value        = '';
  rCategory.value  = 'Theory';
  rYear.value      = '2025';
  rTitleKo.value   = '';
  rTitleEn.value   = '';
  rSummaryKo.value = '';
  rSummaryEn.value = '';
  rFull.value      = '';
  currentReportId  = null;
  setStatus('ìƒˆ ë³´ê³ ì„œ ì…ë ¥ ì¤€ë¹„ ì™„ë£Œ.', 'ok');
}

async function loadReportIntoForm(id){
  const r = Array.isArray(reportsData.reports)
    ? reportsData.reports.find(x=>x.id === id)
    : null;
  if(!r){
    setStatus(`reports.json ì—ì„œ ${id} ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'err');
    return;
  }
  rId.value        = r.id || '';
  rCategory.value  = r.category || 'Theory';
  rYear.value      = r.year || '';
  rTitleKo.value   = r.title_ko || '';
  rTitleEn.value   = r.title_en || '';
  rSummaryKo.value = r.summary_kr || r.summary_ko || '';
  rSummaryEn.value = r.summary_en || '';
  currentReportId  = r.id || '';

  try{
    await loadMarkdownForReport(currentReportId);
  }catch(e){
    console.error(e);
    setStatus(e.message || 'Markdown ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'err');
  }
}

async function handleSaveReport(){
  const id = rId.value.trim();
  if(!id){
    setStatus('Report IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: DCAR-03-2025)', 'err');
    return;
  }
  const reportObj = {
    id,
    slug      : id,
    year      : rYear.value.trim() || '2025',
    category  : rCategory.value || 'Theory',
    title_ko  : rTitleKo.value.trim(),
    title_en  : rTitleEn.value.trim(),
    summary_kr: rSummaryKo.value.trim(),
    summary_en: rSummaryEn.value.trim(),
    md_path   : `reports/${id}.md`
  };

  if(!Array.isArray(reportsData.reports)){
    reportsData.reports = [];
  }
  const idx = reportsData.reports.findIndex(x=>x.id === id);
  if(idx >= 0){
    reportsData.reports[idx] = reportObj;
  }else{
    reportsData.reports.push(reportObj);
  }

  try{
    btnSaveReport.disabled = true;
    await saveReportsJson();

    let mdSha = null;
    try{
      const res = await ghFetch(`reports/${id}.md`,{method:'GET'});
      if(res.ok){
        const data = await res.json();
        mdSha = data.sha || null;
      }
    }catch(e){
      // ì—†ìŒ â†’ ì‹ ê·œ ìƒì„±
    }

    await saveMarkdownForReport(id, mdSha);
    await loadReportsJson();

    currentReportId = id;
    setStatus(`ë³´ê³ ì„œ ${id} ì €ì¥ ì™„ë£Œ.`, 'ok');

  }catch(e){
    console.error(e);
    setStatus(e.message || 'ë³´ê³ ì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'err');
  }finally{
    btnSaveReport.disabled = false;
  }
}

// =========================
// Tabs
// =========================
function switchTab(name){
  tabButtons.forEach(btn=>{
    const target = btn.getAttribute('data-tab');
    const active = (target === name);
    btn.classList.toggle('active', active);
  });
  tabWorks.classList.toggle('active', name === 'works');
  tabReports.classList.toggle('active', name === 'reports');
}

tabButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.getAttribute('data-tab');
    if(target) switchTab(target);
  });
});

// =========================
// ì´ë²¤íŠ¸ ë°”ì¸ë”©
// =========================
btnSaveConfig.addEventListener('click', saveConfigToLocal);
btnLoadConfig.addEventListener('click', loadConfigFromLocal);
btnClearConfig.addEventListener('click', ()=>{
  if(confirm('ì €ì¥ëœ Owner / Repo / Branch / Tokenì„ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')){
    clearConfig();
  }
});

btnUploadWorks.addEventListener('click', handleUploadWorks);
btnUpdateMeta.addEventListener('click', handleUpdateMetaOnly);
btnReloadWorks.addEventListener('click', loadWorksJson);

btnSaveReport.addEventListener('click', handleSaveReport);
btnNewReport.addEventListener('click', clearReportForm);
btnReloadReports.addEventListener('click', loadReportsJson);

// =========================
// ì´ˆê¸°í™”
// =========================
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    loadConfigFromLocal();
  }catch(e){}
  setStatus('Admin Î©.23 ë¡œë“œ ì™„ë£Œ. GitHub ì„¤ì • í™•ì¸ í›„ ì§„í–‰í•˜ì„¸ìš”.', 'ok');
});
  </script>
</body>
</html>