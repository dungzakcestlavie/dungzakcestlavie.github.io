<!doctype html>
<html lang="ko" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ë“±ì‘ Â· Admin Î©.19 â€” Works & DCAR</title>
<meta name="description" content="DUNGZAK CESTLAVIE Admin Â· Works JSON & DCAR ê´€ë¦¬" />
<meta name="color-scheme" content="dark light" />
<style>
:root{
  --bg:#050716;
  --panel:#0c1124;
  --panel-soft:#0f1732;
  --line:#1c2646;
  --accent:#f0cf7e;
  --accent-soft:#f6e6b0;
  --fg:#e9f0ff;
  --muted:#9cabd8;
  --danger:#f36c8a;
  --ok:#5bd2a1;
  --max:1280px;
  --radius:12px;
  --radius-sm:9px;
  --shadow:0 14px 40px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  background:radial-gradient(circle at top,#172549 0,#050716 48%,#02030b 100%);
  color:var(--fg);
  font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
  min-height:100vh;
}

/* top bar */
.app-shell{
  max-width:var(--max);
  margin:0 auto;
  padding:14px 12px 80px;
}
.app-header{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
}
.app-title{
  font-weight:800;
  letter-spacing:.03em;
  font-size:15px;
}
.app-title span{
  color:var(--accent);
}
.badge{
  padding:3px 9px;
  border-radius:999px;
  border:1px solid rgba(240,207,126,.6);
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
}
.chip{
  padding:3px 8px;
  border-radius:999px;
  border:1px solid var(--line);
  font-size:11px;
  color:var(--muted);
}
.app-spacer{flex:1}
.app-mini{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:4px;
  font-size:11px;
  color:var(--muted);
}
.app-mini span strong{color:var(--accent-soft);}

/* layout */
.app-main{
  display:grid;
  grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
  gap:14px;
}
@media(max-width:960px){
  .app-main{grid-template-columns:1fr}
}

/* panels */
.panel{
  background:linear-gradient(180deg,#0b1023,#050716);
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,.04);
  box-shadow:var(--shadow);
  padding:12px 12px 14px;
}
.panel-header{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.panel-title{
  font-size:13px;
  font-weight:700;
}
.panel-header small{
  font-size:11px;
  color:var(--muted);
}
.tag{
  font-size:10px;
  border-radius:999px;
  padding:3px 7px;
  border:1px solid var(--line);
  color:var(--muted);
}

/* nav tabs inside left panel */
.subtabs{
  margin:4px 0 10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.subtabs button{
  all:unset;
  cursor:pointer;
  font-size:11px;
  padding:5px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
}
.subtabs button.active{
  background:linear-gradient(180deg,var(--accent-soft),var(--accent));
  color:#050716;
  border-color:var(--accent);
}

/* tool strip */
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-bottom:8px;
}
.btn{
  all:unset;
  cursor:pointer;
  font-size:11px;
  padding:6px 11px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--fg);
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.btn span.icon{
  font-size:12px;
}
.btn.primary{
  border-color:var(--accent);
  background:radial-gradient(circle at top,var(--accent-soft),var(--accent));
  color:#070a18;
}
.btn.danger{
  border-color:rgba(243,108,138,.78);
  color:var(--danger);
}
.btn[disabled]{
  opacity:.45;
  cursor:not-allowed;
}
input[type="file"]{
  display:none;
}

/* works table */
.table-wrap{
  border-radius:var(--radius-sm);
  border:1px solid var(--line);
  background:radial-gradient(circle at top left,#182445,#050716);
  overflow:auto;
  max-height:54vh;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:11px;
}
thead{
  position:sticky;
  top:0;
  background:linear-gradient(180deg,#111731,#050716);
  z-index:1;
}
th,td{
  padding:5px 6px;
  border-bottom:1px solid #111527;
  text-align:left;
  white-space:nowrap;
}
th{
  font-weight:600;
  color:var(--muted);
}
tbody tr{
  cursor:pointer;
}
tbody tr:nth-child(even){
  background:rgba(8,12,30,.55);
}
tbody tr:hover{
  background:rgba(18,24,52,.85);
}
tbody tr.selected{
  outline:1px solid var(--accent);
}

/* small status bar */
.statusbar{
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
  display:flex;
  justify-content:space-between;
  gap:8px;
}
.statusbar span strong{color:var(--accent-soft);}

/* forms */
.form{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 10px;
  margin-top:4px;
}
.form label{
  font-size:11px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  gap:3px;
}
.form input,.form select,.form textarea{
  border-radius:8px;
  border:1px solid #1d2646;
  background:#050818;
  color:var(--fg);
  font-size:12px;
  padding:6px 8px;
}
.form textarea{
  resize:vertical;
  min-height:46px;
}
.form .full{
  grid-column:1 / -1;
}
.form-row{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.form-row .btn{
  flex:1;
  justify-content:center;
}

/* right panel DCAR */
.dcar-list{
  border-radius:var(--radius-sm);
  border:1px solid var(--line);
  background:radial-gradient(circle at top,#1a2346,#050716);
  max-height:28vh;
  overflow:auto;
  margin-bottom:8px;
}
.dcar-item{
  padding:6px 8px;
  border-bottom:1px solid #141a2e;
  cursor:pointer;
}
.dcar-item:hover{
  background:rgba(21,30,68,.9);
}
.dcar-item.active{
  outline:1px solid var(--accent);
}
.dcar-item small{
  font-size:10px;
  color:var(--muted);
}
.dcar-item strong{
  font-size:11px;
}

/* toast */
#toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(14px + env(safe-area-inset-bottom));
  background:rgba(5,10,28,.96);
  color:var(--fg);
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(240,207,126,.7);
  font-size:11px;
  display:none;
  z-index:50;
}

/* small */
.note{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
}
.code{
  font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:11px;
  padding:1px 4px;
  border-radius:4px;
  background:#02040c;
  border:1px solid #171c30;
}
</style>
</head> <body>
<div class="app-shell">
  <header class="app-header">
    <div class="app-title">
      ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Â· <span>Admin Î©.19</span>
    </div>
    <div class="badge">Works & DCAR</div>
    <div class="chip">JSON Â· Local editing Â· Download</div>
    <div class="app-spacer"></div>
    <div class="app-mini">
      <span>JSON path: <span class="code">/data/works.json</span></span>
      <span>Images: <strong>/images/standard Â· /images/zoom</strong></span>
    </div>
  </header>

  <main class="app-main">
    <!-- LEFT: WORKS -->
    <section class="panel" aria-label="Works manager">
      <div class="panel-header">
        <div>
          <div class="panel-title">Works Â· ì‘í’ˆ ê´€ë¦¬</div>
          <small>ì„¹ì…˜ë³„ë¡œ ì‘í’ˆì„ í¸ì§‘í•˜ê³ , ìˆ˜ì •ëœ JSONì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</small>
        </div>
      </div>

      <!-- subtabs -->
      <div class="subtabs" id="sectionTabs">
        <button data-key="Light & Memory" class="active">â…  Light & Memory</button>
        <button data-key="Human Prayer">â…¡ Human Prayer</button>
        <button data-key="Rebirth">â…¢ Rebirth</button>
        <button data-key="Existence">â…£ Existence</button>
        <button data-key="Cosmos">â…¤ Cosmos</button>
      </div>

      <!-- toolbar -->
      <div class="toolbar">
        <label class="btn">
          <span class="icon">ğŸ“‚</span>
          JSON ë¶ˆëŸ¬ì˜¤ê¸° (local)
          <input type="file" id="fileInput" accept="application/json">
        </label>
        <button class="btn" id="btnFetch">
          <span class="icon">â˜ï¸</span> /data/works.json ì½ê¸°
        </button>
        <button class="btn primary" id="btnDownload">
          <span class="icon">ğŸ’¾</span> works.json ë‹¤ìš´ë¡œë“œ
        </button>
        <button class="btn" id="btnCopy">
          <span class="icon">ğŸ“‹</span> JSON ë³µì‚¬
        </button>
        <button class="btn danger" id="btnReset">
          <span class="icon">â†º</span> í˜„ì¬ ì„¹ì…˜ ì´ˆê¸°í™”
        </button>
      </div>

      <!-- table -->
      <div class="table-wrap" aria-label="Works list">
        <table>
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th style="width:90px">ì—°ë„</th>
              <th>ì œëª©(KR)</th>
              <th>ì œëª©(EN)</th>
              <th style="width:120px">Size</th>
              <th style="width:120px">Image</th>
            </tr>
          </thead>
          <tbody id="worksTbody">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>

      <div class="statusbar">
        <span id="statusCount">í˜„ì¬ ì„¹ì…˜ ì‘í’ˆ: 0</span>
        <span id="statusHint">í–‰ì„ í´ë¦­í•˜ë©´ ì•„ë˜ í¼ì—ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
      </div>

      <!-- form -->
      <form class="form" id="worksForm" autocomplete="off">
        <label>
          Section
          <select id="f_section">
            <option value="Light & Memory">â…  Light & Memory</option>
            <option value="Human Prayer">â…¡ Human Prayer</option>
            <option value="Rebirth">â…¢ Rebirth</option>
            <option value="Existence">â…£ Existence</option>
            <option value="Cosmos">â…¤ Cosmos</option>
          </select>
        </label>
        <label>
          ID
          <input id="f_id" placeholder="ì˜ˆ: DZ-003">
        </label>
        <label>
          ì—°ë„(Year)
          <input id="f_year" placeholder="2025">
        </label>
        <label>
          íŒŒì¼ëª…(Image)
          <input id="f_image" placeholder="ì˜ˆ: DZ-003.jpg">
        </label>
        <label class="full">
          ì œëª©(KR)
          <input id="f_title_kr" placeholder="ì‘í’ˆ ì œëª© (í•œêµ­ì–´)">
        </label>
        <label class="full">
          Title (EN)
          <input id="f_title_en" placeholder="Title in English">
        </label>
        <label>
          ì¬ë£Œ(KR)
          <input id="f_mat_kr" placeholder="ì˜ˆ: Acrylic on Canvas">
        </label>
        <label>
          Material (EN)
          <input id="f_mat_en" placeholder="Acrylic on Canvas">
        </label>
        <label>
          í¬ê¸°(KR)
          <input id="f_size_kr" placeholder="ì˜ˆ: 162.2Ã—130.3cm">
        </label>
        <label>
          Size (EN)
          <input id="f_size_en" placeholder="162.2Ã—130.3cm">
        </label>
        <div class="form-row full">
          <button type="button" class="btn primary" id="btnSaveRow">
            <span class="icon">âœ…</span> ì„ íƒ í–‰ ì €ì¥ / ì¶”ê°€
          </button>
          <button type="button" class="btn danger" id="btnDeleteRow">
            <span class="icon">ğŸ—‘</span> ì„ íƒ í–‰ ì‚­ì œ
          </button>
        </div>
        <p class="note full">
          â€¢ ì´ë¯¸ì§€ ê²½ë¡œëŠ” ìë™ìœ¼ë¡œ
          <span class="code>/images/standard/íŒŒì¼ëª…</span>,
          <span class="code>/images/zoom/íŒŒì¼ëª…</span> ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
          <br>â€¢ IDì™€ ì—°ë„ë¥¼ ë¹„ì›Œë‘ë©´ ìë™ ë²ˆí˜¸ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.
        </p>
      </form>
    </section>

    <!-- RIGHT: DCAR & NOTES -->
    <aside class="panel" aria-label="DCAR manager">
      <div class="panel-header">
        <div>
          <div class="panel-title">DCAR Â· ë¯¸í•™ ë³´ê³ ì„œ ë©”ëª¨</div>
          <small>ê°„ë‹¨ ë²„ì „: ì œëª© ëª©ë¡ ê´€ë¦¬ì™€ ë…¸íŠ¸, JSON ë‹¤ìš´ë¡œë“œ.</small>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="btnLoadDcar">
          <span class="icon">â˜ï¸</span> /data/dcar.json ì½ê¸° (ì„ íƒ)
        </button>
        <button class="btn primary" id="btnDownloadDcar">
          <span class="icon">ğŸ’¾</span> dcar.json ë‹¤ìš´ë¡œë“œ
        </button>
      </div>

      <div class="dcar-list" id="dcarList">
        <!-- items -->
      </div>

      <form class="form" id="dcarForm">
        <label>
          ID
          <input id="d_id" placeholder="ì˜ˆ: DCAR-01-2025">
        </label>
        <label>
          Category
          <select id="d_cat">
            <option value="theory">Theory</option>
            <option value="archive">Archive</option>
            <option value="practice">Practice</option>
          </select>
        </label>
        <label class="full">
          ì œëª©(KR)
          <input id="d_title_kr" placeholder="ë³´ê³ ì„œ ì œëª© (í•œêµ­ì–´)">
        </label>
        <label class="full">
          Title (EN)
          <input id="d_title_en" placeholder="Title in English">
        </label>
        <label class="full">
          ë©”ëª¨ / Notes
          <textarea id="d_note" placeholder="ê°„ë‹¨ ê°œìš”, ì§„í–‰ìƒí™© ë©”ëª¨"></textarea>
        </label>
        <div class="form-row full">
          <button type="button" class="btn primary" id="btnSaveDcar">
            <span class="icon">âœ…</span> í•­ëª© ì €ì¥ / ì¶”ê°€
          </button>
          <button type="button" class="btn danger" id="btnDeleteDcar">
            <span class="icon">ğŸ—‘</span> í•­ëª© ì‚­ì œ
          </button>
        </div>
        <p class="note full">
          â€¢ dcar.jsonì€ Admin ì „ìš© ë©”ëª¨ íŒŒì¼ë¡œ ì‚¬ìš©í•´ë„ ë˜ê³ ,<br>
          &nbsp;&nbsp;í•„ìš”í•˜ë©´ Index Reports ë°ì´í„°ì™€ ì—°ê²°í•  ë•Œ ì°¸ê³ ìš©ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
      </form>
    </aside>
  </main>
</div>

<div id="toast" role="status" aria-live="polite"></div> <script>
const $ = (q, sc=document) => sc.querySelector(q);
const $$ = (q, sc=document) => Array.from(sc.querySelectorAll(q));

/* ---------- Toast ---------- */
function showToast(msg, ms=2200){
  const t = $('#toast');
  if(!t) return;
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=>{ t.style.display = 'none'; }, ms);
}

/* ---------- Works state ---------- */
const SECTION_KEYS = [
  "Light & Memory",
  "Human Prayer",
  "Rebirth",
  "Existence",
  "Cosmos"
];

let worksData = {
  "Light & Memory": [],
  "Human Prayer": [],
  "Rebirth": [],
  "Existence": [],
  "Cosmos": []
};
let currentSection = "Light & Memory";
let selectedIndex = -1;

function renderWorksTable(){
  const tbody = $('#worksTbody');
  if(!tbody) return;
  const list = worksData[currentSection] || [];
  tbody.innerHTML = '';
  list.forEach((w, idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    if(idx === selectedIndex) tr.classList.add('selected');
    const shortId = w.id || '';
    const year = w.year || '';
    const tkr = w.title_kr || '';
    const ten = w.title_en || '';
    const size = w.size_kr || w.size_en || '';
    const img = w.image || '';
    tr.innerHTML = `
      <td>${shortId}</td>
      <td>${year}</td>
      <td>${tkr}</td>
      <td>${ten}</td>
      <td>${size}</td>
      <td>${img}</td>
    `;
    tbody.appendChild(tr);
  });
  $('#statusCount').innerHTML = `í˜„ì¬ ì„¹ì…˜ ì‘í’ˆ: <strong>${list.length}</strong>`;
  if(list.length === 0){
    $('#statusHint').textContent = 'ì•„ì§ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ í¼ì— ì…ë ¥ í›„ "ì €ì¥ / ì¶”ê°€"ë¥¼ ëˆŒëŸ¬ ì²« í–‰ì„ ë§Œë“œì„¸ìš”.';
  }else{
    $('#statusHint').textContent = 'í–‰ì„ í´ë¦­í•˜ë©´ í¼ì— ë¶ˆëŸ¬ì™€ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
  }
}

function fillWorksForm(item){
  $('#f_section').value   = currentSection;
  $('#f_id').value        = item?.id || '';
  $('#f_year').value      = item?.year || '';
  $('#f_image').value     = item?.image || '';
  $('#f_title_kr').value  = item?.title_kr || '';
  $('#f_title_en').value  = item?.title_en || '';
  $('#f_mat_kr').value    = item?.material_kr || '';
  $('#f_mat_en').value    = item?.material_en || '';
  $('#f_size_kr').value   = item?.size_kr || '';
  $('#f_size_en').value   = item?.size_en || '';
}

function collectWorksForm(){
  const section   = $('#f_section').value || currentSection;
  const id        = $('#f_id').value.trim();
  const year      = $('#f_year').value.trim();
  const imageName = $('#f_image').value.trim();
  const obj = {
    id : id || undefined,
    title_kr : $('#f_title_kr').value.trim() || undefined,
    title_en : $('#f_title_en').value.trim() || undefined,
    material_kr : $('#f_mat_kr').value.trim() || undefined,
    material_en : $('#f_mat_en').value.trim() || undefined,
    size_kr : $('#f_size_kr').value.trim() || undefined,
    size_en : $('#f_size_en').value.trim() || undefined,
    year : year || undefined,
    image : imageName || undefined,
    zoom  : imageName ? `/images/zoom/${imageName}` : undefined
  };
  // cleanup undefined keys
  Object.keys(obj).forEach(k => obj[k] === undefined && delete obj[k]);
  return {section, data:obj};
}

/* ---------- Works handlers ---------- */
function bindWorks(){
  // section tabs
  $$('#sectionTabs button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      $$('#sectionTabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentSection = btn.dataset.key;
      selectedIndex = -1;
      fillWorksForm({});
      $('#f_section').value = currentSection;
      renderWorksTable();
    });
  });

  // table click
  $('#worksTbody').addEventListener('click',e=>{
    const tr = e.target.closest('tr');
    if(!tr) return;
    selectedIndex = Number(tr.dataset.index);
    const list = worksData[currentSection] || [];
    fillWorksForm(list[selectedIndex] || {});
    renderWorksTable();
  });

  // save / add
  $('#btnSaveRow').addEventListener('click',()=>{
    const res = collectWorksForm();
    const sec = res.section;
    const list = worksData[sec] || (worksData[sec]=[]);
    // auto id if missing
    if(!res.data.id){
      const base = "DZ-";
      const nums = list
        .map(x=>String(x.id||'').replace(/^[^\d]*/,''))
        .map(n=>parseInt(n,10))
        .filter(n=>!isNaN(n));
      const next = (nums.length?Math.max(...nums):0)+1;
      const padded = String(next).padStart(3,'0');
      res.data.id = base + padded;
    }
    // update or push
    if(selectedIndex >= 0 && selectedIndex < list.length){
      list[selectedIndex] = res.data;
    }else{
      list.push(res.data);
      selectedIndex = list.length-1;
    }
    currentSection = sec;
    $('#f_section').value = sec;
    showToast('ì‘í’ˆ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderWorksTable();
  });

  // delete
  $('#btnDeleteRow').addEventListener('click',()=>{
    const list = worksData[currentSection] || [];
    if(selectedIndex < 0 || selectedIndex >= list.length){
      showToast('ì‚­ì œí•  í–‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    if(!confirm('ì„ íƒí•œ ì‘í’ˆì„ ì‚­ì œí• ê¹Œìš”?')) return;
    list.splice(selectedIndex,1);
    selectedIndex = -1;
    fillWorksForm({});
    renderWorksTable();
    showToast('í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  });

  // reset current section
  $('#btnReset').addEventListener('click',()=>{
    if(!confirm(`í˜„ì¬ ì„¹ì…˜ "${currentSection}"ì˜ ëª©ë¡ì„ ëª¨ë‘ ë¹„ìš¸ê¹Œìš”?`)) return;
    worksData[currentSection] = [];
    selectedIndex = -1;
    fillWorksForm({});
    renderWorksTable();
    showToast('ì„¹ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });

  // fetch from server
  $('#btnFetch').addEventListener('click',async()=>{
    try{
      const res = await fetch('/data/works.json',{cache:'no-store'});
      if(!res.ok) throw new Error(res.statusText);
      const json = await res.json();
      normalizeWorks(json);
      showToast('/data/works.json ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    }catch(err){
      console.error(err);
      showToast('ì„œë²„ì—ì„œ works.jsonì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
    renderWorksTable();
  });

  // load from local file
  $('#fileInput').addEventListener('change',e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const json = JSON.parse(ev.target.result);
        normalizeWorks(json);
        renderWorksTable();
        showToast('ë¡œì»¬ JSONì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(err){
        console.error(err);
        showToast('JSON íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };
    reader.readAsText(file,'utf-8');
    // reset so same íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥
    e.target.value = '';
  });

  // download JSON
  $('#btnDownload').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(worksData,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'works.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast('works.json íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
  });

  // copy JSON
  $('#btnCopy').addEventListener('click',async()=>{
    const text = JSON.stringify(worksData,null,2);
    try{
      await navigator.clipboard.writeText(text);
      showToast('JSONì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }catch(err){
      console.error(err);
      showToast('ë³µì‚¬ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  });

  // section select inside form ë°”ê¾¸ë©´ ì„¹ì…˜ë„ í•¨ê»˜ ì´ë™
  $('#f_section').addEventListener('change',e=>{
    currentSection = e.target.value;
    $$('#sectionTabs button').forEach(b=>{
      b.classList.toggle('active',b.dataset.key === currentSection);
    });
    selectedIndex = -1;
    renderWorksTable();
  });

  // ì´ˆê¸° ë Œë”
  renderWorksTable();
}

/* normalize incoming works.json êµ¬ì¡° */
function normalizeWorks(json){
  const base = {
    "Light & Memory": [],
    "Human Prayer": [],
    "Rebirth": [],
    "Existence": [],
    "Cosmos": []
  };
  SECTION_KEYS.forEach(k=>{
    if(Array.isArray(json[k])){
      base[k] = json[k].map(x=>({
        id:x.id || x.ID || '',
        title_kr:x.title_kr || x.titleKR || '',
        title_en:x.title_en || x.titleEN || '',
        material_kr:x.material_kr || x.materialKR || x.material || '',
        material_en:x.material_en || x.materialEN || x.material || '',
        size_kr:x.size_kr || x.sizeKR || x.size || '',
        size_en:x.size_en || x.sizeEN || x.size || '',
        year:x.year || '',
        image:(x.image || '').replace(/^.*\//,''),
        zoom:x.zoom || undefined
      }));
    }
  });
  worksData = base;
  selectedIndex = -1;
  fillWorksForm({});
}

/* ---------- DCAR state ---------- */
let dcarData = [];
let dcarIndex = -1;

function renderDcar(){
  const listEl = $('#dcarList');
  if(!listEl) return;
  listEl.innerHTML = '';
  dcarData.forEach((r,idx)=>{
    const div = document.createElement('div');
    div.className = 'dcar-item' + (idx===dcarIndex?' active':'');
    div.dataset.index = idx;
    div.innerHTML = `
      <strong>${r.id || '(no id)'}</strong><br>
      <small>${r.title_kr || ''}</small><br>
      <small>${r.title_en || ''}</small>
    `;
    listEl.appendChild(div);
  });
}

function fillDcarForm(item){
  $('#d_id').value       = item?.id || '';
  $('#d_cat').value      = item?.cat || 'theory';
  $('#d_title_kr').value = item?.title_kr || '';
  $('#d_title_en').value = item?.title_en || '';
  $('#d_note').value     = item?.note || '';
}

function collectDcarForm(){
  return {
    id: $('#d_id').value.trim() || undefined,
    cat: $('#d_cat').value || 'theory',
    title_kr: $('#d_title_kr').value.trim() || undefined,
    title_en: $('#d_title_en').value.trim() || undefined,
    note: $('#d_note').value.trim() || undefined
  };
}

/* ---------- DCAR handlers ---------- */
function bindDcar(){
  $('#dcarList').addEventListener('click',e=>{
    const item = e.target.closest('.dcar-item');
    if(!item) return;
    dcarIndex = Number(item.dataset.index);
    fillDcarForm(dcarData[dcarIndex] || {});
    renderDcar();
  });

  $('#btnSaveDcar').addEventListener('click',()=>{
    const obj = collectDcarForm();
    if(!obj.id){
      obj.id = `DCAR-${String(dcarData.length+1).padStart(2,'0')}-2025`;
    }
    if(dcarIndex >=0 && dcarIndex < dcarData.length){
      dcarData[dcarIndex] = obj;
    }else{
      dcarData.push(obj);
      dcarIndex = dcarData.length-1;
    }
    renderDcar();
    showToast('DCAR í•­ëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  });

  $('#btnDeleteDcar').addEventListener('click',()=>{
    if(dcarIndex<0 || dcarIndex>=dcarData.length){
      showToast('ì‚­ì œí•  ë³´ê³ ì„œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    if(!confirm('ì„ íƒí•œ DCAR í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    dcarData.splice(dcarIndex,1);
    dcarIndex = -1;
    fillDcarForm({});
    renderDcar();
    showToast('DCAR í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  });

  $('#btnDownloadDcar').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(dcarData,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dcar.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast('dcar.json íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
  });

  $('#btnLoadDcar').addEventListener('click',async()=>{
    try{
      const res = await fetch('/data/dcar.json',{cache:'no-store'});
      if(!res.ok) throw new Error(res.statusText);
      const json = await res.json();
      if(Array.isArray(json)) dcarData = json;
      else if(Array.isArray(json.items)) dcarData = json.items;
      else dcarData = [];
      dcarIndex = -1;
      fillDcarForm({});
      renderDcar();
      showToast('/data/dcar.json ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    }catch(err){
      console.error(err);
      showToast('dcar.json ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (íŒŒì¼ì´ ì—†ì–´ë„ ê´œì°®ìŠµë‹ˆë‹¤).');
    }
  });

  renderDcar();
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  bindWorks();
  bindDcar();
});
</script>
</body>
</html>