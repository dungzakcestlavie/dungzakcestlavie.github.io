<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lightflow Admin Î©.12 â€” Unified (Artworks + DCAR Paste)</title>
<meta name="theme-color" content="#070c1a" />
<style>
:root{--bg:#070c1a;--panel:#0b1020;--soft:#10182d;--fg:#e8edf7;--muted:#9fa8c0;
--accent:#d4b97a;--accent2:#a3c2ff;--ok:#74e0a1;--bad:#ff6b6b;--border:#1e2744;--r:14px}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,system-ui,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;padding-top:72px}
.header{position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(180deg,#0a0f1f,transparent);
  padding:12px 14px 10px;border-bottom:1px solid var(--border)}
h1{margin:0;color:var(--accent);font-weight:800;font-size:22px}
.sub{font-size:13px;color:var(--muted);margin-top:4px}

/* Nav */
.admin-nav{position:sticky;top:56px;z-index:9999;background:rgba(10,16,34,.92);
  border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
.admin-nav .bar{max-width:980px;margin:0 auto;display:flex;gap:8px;overflow-x:auto;padding:8px 12px}
.admin-nav a{flex:0 0 auto;text-decoration:none;font-weight:700;font-size:14px;padding:8px 12px;border-radius:999px;background:#0d142b;color:#cfe0ff;border:1px solid var(--border)}
.admin-nav a.active{background:var(--accent);color:#000}

/* Layout */
.container{max-width:980px;margin:0 auto;padding:12px 12px 120px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin:12px 0}
.card h3{margin:0 0 12px;color:var(--accent);font-size:1.05rem;font-weight:800}
.grid2{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:860px){.grid2{grid-template-columns:1fr 1fr;gap:10px}}

/* Form */
input,textarea,select,button{width:100%;padding:10px;font-size:15px;border-radius:10px;border:1px solid var(--border);background:var(--soft);color:var(--fg)}
textarea{min-height:160px;resize:vertical}
button{border:none;font-weight:800;cursor:pointer}
.btn{background:var(--accent);color:#07101f}
.btn-ok{background:var(--ok);color:#06251a}
.btn-ghost{background:#1b2748;color:#e8edf7}
.btn-bad{background:var(--bad);color:#200}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

/* DCAR preview / mirror */
.preview{border:1px solid var(--border);border-radius:10px;background:#0b1428;padding:10px;max-height:320px;overflow:auto;font-size:14px}
.mirror{display:none;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.mirror .box{border:1px solid var(--border);border-radius:10px;background:#0b1428;padding:10px;min-height:200px}

/* Toast */
.toast{position:fixed;left:50%;bottom:calc(18px + env(safe-area-inset-bottom));transform:translateX(-50%);
 background:#0b1223;border:1px solid var(--border);padding:10px 16px;border-radius:12px;color:var(--fg);
 opacity:0;transition:.2s;pointer-events:none;z-index:10001}
.toast.show{opacity:1;transform:translate(-50%,-6px)}
small{color:var(--muted)}
</style>
</head>
<body>
<header class="header">
  <h1>âœ¨ Lightflow Admin Î©.12 â€” Unified</h1>
  <div class="sub">ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Ã— Lumera Â· iPhone-Stable</div>
</header>

<nav class="admin-nav">
  <div class="bar">
    <a href="#home" data-k="home">Home</a>
    <a href="#art" data-k="art">Artworks</a>
    <a href="#dcar" data-k="dcar">DCAR</a>
    <a href="/admin/batch.html" data-k="upload">Upload</a>
    <a href="#settings" data-k="settings">Settings</a>
  </div>
</nav>

<main class="container">
  <!-- 0) ì—°ê²° -->
  <section class="card" id="home">
    <h3>0ï¸âƒ£ GitHub ì—°ê²°</h3>
    <div class="grid2">
      <input id="owner" placeholder="Owner (ì˜ˆ: dungzakcestlavie)">
      <input id="repo" placeholder="Repo (ì˜ˆ: dungzakcestlavie.github.io)">
      <input id="branch" value="main" placeholder="Branch">
      <input id="token" placeholder="Personal Access Token (repo ê¶Œí•œ)">
    </div>
    <div class="btn-row">
      <button class="btn" onclick="saveCfg()">ì €ì¥</button>
      <button class="btn-ok" onclick="testConn()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <button class="btn-ghost" onclick="pagesTouch()">ğŸš€ Pages ìºì‹œ ë¬´íš¨í™”</button>
      <button class="btn-bad" onclick="logout()">í† í° ì‚­ì œ</button>
    </div>
    <small>ê°’ì€ ì´ ë¸Œë¼ìš°ì €ì˜ <code>localStorage</code>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</small>
  </section>

  <!-- 1) ì‘í’ˆ ê´€ë¦¬: ê¸°ì¡´ í˜•íƒœ ìœ ì§€ -->
  <section class="card" id="art">
    <h3>1ï¸âƒ£ ì‘í’ˆ ê´€ë¦¬</h3>
    <div class="grid2" style="margin-bottom:8px">
      <select id="sec">
        <option value="light">â…  Light & Memory</option>
        <option value="human">â…¡ Human Being</option>
        <option value="rebirth">â…¢ Rebirth of Mind</option>
        <option value="restore">â…£ Restoration of Being</option>
        <option value="meta">â…¤ Metaconsciousness</option>
      </select>
      <input id="wid" placeholder="ID (ì˜ˆ: light-01)">
    </div>
    <div class="grid2" style="margin-bottom:8px">
      <input id="wtitle" placeholder="Title">
      <input id="wyear" placeholder="Year">
      <input id="wmed" placeholder="Medium">
      <input id="wsize" placeholder="Size">
    </div>
    <div class="btn-row">
      <input id="wfile" type="file" accept="image/*">
      <button class="btn" onclick="uploadOne()">ì—…ë¡œë“œ+ë“±ë¡</button>
      <button class="btn-bad" onclick="removeOne()">ì‚­ì œ</button>
    </div>
    <small>ì´ë¯¸ì§€ â†’ <code>/img/{section}/{id}.(jpg/webp)</code>, ë©”íƒ€ â†’ <code>/data/artworks.json</code></small>
  </section>

  <!-- 2) DCAR: ì œëª©KO/ì œëª©EN/ë³¸ë¬¸ í•œ ë²ˆì— ë¶™ì—¬ë„£ê¸° -->
  <section class="card" id="dcar">
    <h3>2ï¸âƒ£ ë¯¸í•™ ë³´ê³ ì„œ (DCAR) â€” ì œëª©Â·ë³¸ë¬¸ â€˜ë¶™ì—¬ë„£ê¸° í•œ ë²ˆâ€™</h3>
    <div class="grid2" style="margin-bottom:8px">
      <div>
        <label>Report ID</label>
        <select id="rid">
          <option>dcar01</option><option>dcar02</option><option>dcar03</option><option>dcar04</option>
          <option>dcar05</option><option>dcar06</option><option>dcar07</option><option>dcar08</option>
        </select>
      </div>
      <div>
        <label>ìë™ ì €ì¥</label>
        <select id="auto">
          <option value="on" selected>ON (ì…ë ¥/ë¶™ì—¬ë„£ê¸° 1.5ì´ˆ í›„)</option>
          <option value="off">OFF (ìˆ˜ë™ ì €ì¥)</option>
        </select>
      </div>
    </div>

    <textarea id="paste" placeholder="1ì¤„: í•œêµ­ì–´ ì œëª©
2ì¤„: ì˜ì–´ ì œëª©
ë¹ˆ ì¤„
ê·¸ ì•„ë˜ë¶€í„° ë³¸ë¬¸ (í•œ/ì˜ ì„ì—¬ë„ OK)"></textarea>

    <div class="btn-row">
      <button class="btn" onclick="parseAndSave()">ğŸ“ ë¶™ì—¬ë„£ê¸° ì €ì¥</button>
      <button class="btn-ghost" onclick="preview()">ë¯¸ë¦¬ë³´ê¸°</button>
      <button class="btn-ok" onclick="openPDF()">ğŸ“„ PDFë¡œ ì—´ê¸°(ì¸ì‡„)</button>
      <button class="btn-ghost" onclick="toggleMirror()">ğŸª ë¯¸ëŸ¬ ë³´ê¸°</button>
    </div>

    <div id="meta" style="margin-top:8px;font-size:14px;color:#cfe0ff"></div>
    <div id="pv" class="preview" style="margin-top:8px"></div>

    <div id="mirror" class="mirror">
      <div class="box"><div style="font-weight:800;color:#a3c2ff;margin-bottom:6px">KO</div><div id="koBox"></div></div>
      <div class="box"><div style="font-weight:800;color:#a3c2ff;margin-bottom:6px">EN</div><div id="enBox"></div></div>
    </div>
  </section>

  <!-- 3) Settings -->
  <section class="card" id="settings">
    <h3>3ï¸âƒ£ Settings / Pages</h3>
    <div class="btn-row">
      <button class="btn-ghost" onclick="pagesTouch()">ğŸš€ Pages ìºì‹œ ë¬´íš¨í™”</button>
      <button class="btn-ghost" onclick="window.location='/admin/trigger.html'">Trigger ì—´ê¸°</button>
      <button class="btn-bad" onclick="localStorage.removeItem(KEY);location.reload()">localStorage ì´ˆê¸°í™”</button>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
/* ========== helpers ========== */
const $=q=>document.querySelector(q), $$=q=>document.querySelectorAll(q);
const say=(m,err=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=err?"#ff6b6b":"#22304f";
  t.classList.add("show");clearTimeout(say._t);say._t=setTimeout(()=>t.classList.remove("show"),1700);};
const md2html=md=>md.replace(/</g,"&lt;").replace(/>/g,"&gt;").split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,"<br>")}</p>`).join("");
const hasKO=s=>/[ã„±-ã…ê°€-í£]/.test(s); const hasEN=s=>/[A-Za-z]/.test(s);
function navActive(){const h=location.hash||"#home"; $$(".admin-nav a").forEach(a=>a.classList.toggle("active",a.getAttribute("href")===h));}
window.addEventListener("hashchange",navActive);

/* ========== config (localStorage) ========== */
const KEY="lf_admin_cfg_v101";
const readCfg=()=>{try{return JSON.parse(localStorage.getItem(KEY)||"{}")}catch{return{}}};
const cfg=k=>readCfg()[k]||""; const setCfg=(k,v)=>{const j=readCfg(); j[k]=v; localStorage.setItem(KEY,JSON.stringify(j));};
function saveCfg(){["owner","repo","branch","token"].forEach(id=>setCfg(id,$("#"+id).value.trim())); say("ì €ì¥ ì™„ë£Œ");}
function logout(){const j=readCfg(); delete j.token; localStorage.setItem(KEY,JSON.stringify(j)); $("#token").value=""; say("í† í° ì‚­ì œ ì™„ë£Œ");}

/* ========== GitHub API ========== */
async function gh(m,p,b=null,isJson=true){
  const token=cfg("token"); if(!token) throw new Error("í† í° ì—†ìŒ");
  const r=await fetch(`https://api.github.com/${p}`,{
    method:m, headers:{Accept:"application/vnd.github+json",Authorization:`token ${token}`},
    body:b?(isJson?JSON.stringify(b):b):null
  });
  if(!r.ok){const t=await r.text();throw new Error(`GitHub ${r.status}: ${t.slice(0,200)}`);}
  return r.json();
}
function b64(s){return btoa(unescape(encodeURIComponent(s)));}
async function getContent(path){
  const o=cfg("owner"),r=cfg("repo"),b=cfg("branch")||"main";
  try{const j=await gh("GET",`repos/${o}/${r}/contents/${encodeURIComponent(path)}?ref=${b}`);
      return {sha:j.sha,text:j.content?atob(j.content.replace(/\n/g,"")):"",exists:true};}
  catch{return {sha:null,text:"",exists:false};}
}
async function putText(path,text,msg){
  const o=cfg("owner"),r=cfg("repo"),b=cfg("branch")||"main";
  const old=await getContent(path);
  const body={message:msg||`update ${path}`,content:b64(text),branch:b};
  if(old.exists) body.sha=old.sha;
  return gh("PUT",`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body);
}

/* ========== Pages touch ========== */
async function pagesTouch(){
  try{
    const stamp=new Date().toISOString();
    await putText("data/.touch",`touch ${stamp}`,`touch ${stamp}`);
    try{await gh("POST",`repos/${cfg("owner")}/${cfg("repo")}/pages/builds`,{});say("Pages ë¹Œë“œ ìš”ì²­ ì™„ë£Œ");}
    catch{say("touch ì»¤ë°‹ ì™„ë£Œ (Pages API ê¶Œí•œ ì—†ìŒ)");}
  }catch(e){say("ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨: "+e.message,true);}
}
async function testConn(){try{await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}`);say("ì—°ê²° OK (200)");}catch(e){say("ì—°ê²° ì‹¤íŒ¨: "+e.message,true);}}

/* ========== Artworks (ê¸°ì¡´ íë¦„) ========== */
let artworks={light:[],human:[],rebirth:[],restore:[],meta:[]};
async function loadArt(){try{const f=await getContent("data/artworks.json"); if(f.text) artworks=JSON.parse(f.text);}catch{}}
async function uploadOne(){
  try{
    const sec=$("#sec").value, id=$("#wid").value.trim(); if(!id) return say("ID í•„ìš”",true);
    const f=$("#wfile").files[0]; let url="";
    if(f){
      const ext=(f.name.match(/\.\w+$/)?.[0]||".jpg").toLowerCase();
      const b64data=await new Promise(res=>{const fr=new FileReader();fr.onload=()=>res(fr.result.split(",")[1]);fr.readAsDataURL(f);});
      const path=`img/${sec}/${id}${ext}`;
      await gh("PUT",`repos/${cfg("owner")}/${cfg("repo")}/contents/${path}`,{message:`upload ${path}`,content:b64data,branch:cfg("branch")||"main"});
      url=`/${path}`;
    }
    await loadArt();
    const rec={id,title:$("#wtitle").value,year:$("#wyear").value,medium:$("#wmed").value,size:$("#wsize").value,image:url};
    const arr=artworks[sec]||(artworks[sec]=[]); const i=arr.findIndex(x=>x.id===id); if(i>=0) arr[i]=rec; else arr.push(rec);
    await putText("data/artworks.json",JSON.stringify(artworks,null,2),"update artworks.json");
    say("ì—…ë¡œë“œ+ë“±ë¡ ì™„ë£Œ");
  }catch(e){say("ì—…ë¡œë“œ ì‹¤íŒ¨: "+e.message,true);}
}
async function removeOne(){
  try{
    await loadArt();
    const sec=$("#sec").value, id=$("#wid").value.trim(); if(!id) return;
    const arr=artworks[sec]||(artworks[sec]=[]); const i=arr.findIndex(x=>x.id===id); if(i>=0) arr.splice(i,1);
    await putText("data/artworks.json",JSON.stringify(artworks,null,2),"delete artwork record");
    say("ë©”íƒ€ ì‚­ì œ ì™„ë£Œ");
  }catch(e){say("ì‚­ì œ ì‹¤íŒ¨: "+e.message,true);}
}

/* ========== DCAR paste-only ========== */
let reports={}; const AUTOSAVE_MS=1500;
async function loadReports(){try{const f=await getContent("data/reports.json"); if(f.text) reports=JSON.parse(f.text);}catch{}}

function parseDcar(text){
  const lines=text.replace(/\r/g,"").split("\n");
  let titleKO="",titleEN=""; let i=0;
  if(lines[i] && lines[i].trim()){ if(hasKO(lines[i])){titleKO=lines[i].trim(); i++;} }
  if(lines[i] && lines[i].trim()){ if(hasEN(lines[i])){titleEN=lines[i].trim(); i++;} }
  while(lines[i] && !lines[i].trim()) i++;
  const body=lines.slice(i).join("\n").trim();
  return {titleKO,titleEN,body};
}
function setMetaView(id,ko,en){
  $("#meta").innerHTML=
    `<b>${id.toUpperCase()}</b> Â· <span style="color:#a3c2ff">${en||"â€”"}</span><br>`+
    `<span style="color:#d9e2ff">${ko||"â€”"}</span>`;
}
function preview(){const {body}=parseDcar($("#paste").value); $("#pv").innerHTML=md2html(body);}
function toggleMirror(){
  const el=$("#mirror"); el.style.display = (el.style.display==="grid")?"none":"grid";
  const {body}=parseDcar($("#paste").value);
  // ê°„ë‹¨ ë¶„ë¦¬: ë¬¸ë‹¨ì„ í•œ/ì˜ ì¶”ì •ìœ¼ë¡œ ë¶„ë°°
  const paras=body.split(/\n{2,}/);
  const ko=[] , en=[];
  paras.forEach(p=>{ if(hasKO(p)&&!hasEN(p)) ko.push(p); else if(hasEN(p)&&!hasKO(p)) en.push(p); else {ko.push(p); en.push(p);} });
  $("#koBox").innerHTML=md2html(ko.join("\n\n"));
  $("#enBox").innerHTML=md2html(en.join("\n\n"));
}
async function saveDcarParts(id,ko,en,body){
  await putText(`reports/${id}.md`, body, `save ${id}.md`);
  reports[id]={...(reports[id]||{}),titleKO:ko,titleEN:en,text:body,updated:new Date().toISOString()};
  await putText("data/reports.json", JSON.stringify(reports,null,2), "update reports.json");
}
async function parseAndSave(){
  try{
    const id=$("#rid").value;
    const {titleKO,titleEN,body}=parseDcar($("#paste").value);
    if(!body) return say("ë³¸ë¬¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤",true);
    await saveDcarParts(id,titleKO,titleEN,body);
    setMetaView(id,titleKO,titleEN); preview();
    say("ì œëª©+ë³¸ë¬¸ ì €ì¥ ì™„ë£Œ");
  }catch(e){say("DCAR ì €ì¥ ì‹¤íŒ¨: "+e.message,true);}
}
$("#paste").addEventListener("input",()=>{
  if($("#auto").value!=="on") return;
  clearTimeout(window.__dcarT);
  window.__dcarT=setTimeout(parseAndSave, AUTOSAVE_MS);
});
$("#paste").addEventListener("paste",(e)=>{
  // iOSì—ì„œ ë¶™ì—¬ë„£ê¸° ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸°
  setTimeout(()=>{preview();},0);
});

/* ê°„ë‹¨ PDF: ìƒˆ ì°½ìœ¼ë¡œ í”„ë¦°íŠ¸ìš© HTML ì—´ê¸°(ë¸Œë¼ìš°ì € ì €ì¥-PDF) */
function openPDF(){
  const id=$("#rid").value;
  const {titleKO,titleEN,body}=parseDcar($("#paste").value);
  const html=`<!doctype html><html><head><meta charset="utf-8">
  <title>${id.toUpperCase()} â€” ${titleEN||titleKO||"DCAR"}</title>
  <style>
    @page{size:A4;margin:20mm}
    body{font:12pt/1.6 -apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",serif;color:#111}
    h1{font-size:18pt;margin:0 0 4mm}
    h2{font-size:12pt;color:#444;margin:0 0 8mm}
    p{margin:0 0 4mm;orphans:3;widows:3}
  </style></head><body>
  <h1>${titleKO?titleKO:""}</h1>
  <h2>${titleEN?titleEN:""}</h2>
  ${md2html(body)}
  <script>window.onload=()=>window.print()</script>
  </body></html>`;
  const w=window.open("", "_blank"); w.document.write(html); w.document.close();
}

/* ========== boot ========== */
window.addEventListener("load", async ()=>{
  // hydrate
  ["owner","repo","branch","token"].forEach(id=>{const v=cfg(id); if(v) $("#"+id).value=v;});
  navActive();
  await loadArt(); await loadReports();
  // ì„ íƒ ë³€ê²½ ì‹œ ê¸°ì¡´ ë³¸ë¬¸ ë¡œë“œ
  $("#rid").addEventListener("change", async ()=>{
    const id=$("#rid").value;
    const rec=reports[id]||{};
    $("#paste").value = rec.text||"";
    setMetaView(id,rec.titleKO||"",rec.titleEN||"");
    preview();
  });
  // ì´ˆê¸° ì„ íƒ ë°˜ì˜
  $("#rid").dispatchEvent(new Event("change"));
});
</script>
</body>
</html>