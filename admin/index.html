<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>✨ Lightflow Admin Ω.13 — One-File Final (KR·EN)</title>
<meta name="color-scheme" content="dark light" />
<style>
:root{
  --bg:#0b132b;--panel:#0f1c3b;--soft:#142751;
  --fg:#f2f6ff;--muted:#9fb2d9;--accent:#ffd782;
  --good:#78f0b0;--bad:#ff6b6b;--line:#1d3158;--chip:#0f234a;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Pretendard,sans-serif;font-size:16px;line-height:1.45}
.header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,19,43,.96),rgba(11,19,43,0));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06);padding:12px 14px}
h1{margin:0;font-size:1.12rem;color:var(--accent);font-weight:800}
.container{max-width:1024px;margin:0 auto;padding:10px 14px 140px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.card h3{margin:4px 0 10px;font-size:1.02rem;color:#ffe9a5}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:1fr}
@media(min-width:900px){.grid-2{grid-template-columns:1.05fr .95fr}}
.kv{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
.kv label{font-size:13px;color:#cfe0ff}
input,textarea,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--soft);color:var(--fg);font-size:15.5px}
textarea{min-height:130px;resize:none}
button{background:var(--accent);color:#000;font-weight:800;border:none;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
.btn-row{display:flex;gap:10px;flex-wrap:wrap}
.btn-ghost{background:var(--chip);color:var(--fg);border:1px solid var(--line)}
.btn-good{background:var(--good);color:#002a14}
.btn-bad{background:var(--bad);color:#000}
.small{font-size:12.5px;color:var(--muted)}
pre.log{background:#0b214b;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;word-break:break-word;max-height:300px;overflow:auto}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0c1f43;border:1px solid var(--line);color:var(--fg);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:9;opacity:0;pointer-events:none;transition:opacity .22s}
.toast.show{opacity:1}
.spinner{display:none;margin-left:6px;width:14px;height:14px;border:2px solid #cfe0ff;border-top-color:transparent;border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
.tabs button{flex:0 0 auto;background:#102657;color:#e7efff;border:1px solid var(--line);border-radius:999px;padding:10px 14px;font-size:14px}
.tabs button.active{background:var(--accent);color:#000}
.drop{border:2px dashed var(--line);border-radius:12px;padding:12px;text-align:center;background:#0c1f43}
.drop.drag{background:#103064}
.preview{width:100%;max-height:260px;object-fit:contain;border-radius:12px;border:1px solid var(--line);background:#0b1733}
.gallery{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(min-width:900px){.gallery{grid-template-columns:repeat(4,minmax(0,1fr))}}
.cardThumb{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1c3b}
.cardThumb img{width:100%;height:120px;object-fit:cover;display:block}
.cardThumb .cap{padding:6px 8px;font-size:12.5px;color:#dff1ff}
.cardThumb .del{position:absolute;top:6px;right:6px;background:#ff6b6b;color:#000;border:none;border-radius:999px;font-weight:900;font-size:12px;padding:4px 7px}
.cardThumb:hover{outline:2px solid #35579f}
.previewBox{border:1px dashed var(--line);border-radius:12px;padding:12px;background:#0c1f43;overflow:auto;max-height:360px}
.previewBox h1,.previewBox h2,.previewBox h3{margin:.35em 0 .25em}
.previewBox p{margin:.35em 0;line-height:1.55}
</style>
</head>
<body>
<div class="header"><h1>✨ Lightflow Admin Ω.13 <span class="small">One-File Final · Gallery+Reports+Index · KR·EN</span></h1></div>
<div class="container">

  <!-- 0) GitHub 연결 -->
  <div class="card">
    <h3>0) GitHub 연결 · Connection</h3>
    <div class="grid grid-2">
      <div class="kv"><label>GitHub Owner</label><input id="owner" placeholder="예: dungzakcestlavie" /></div>
      <div class="kv"><label>Repository</label><input id="repo" placeholder="예: dungzakcestlavie.github.io" /></div>
      <div class="kv"><label>Branch</label><input id="branch" placeholder="main" value="main" /></div>
      <div class="kv"><label>Personal Access Token</label><input id="token" placeholder="github_pat_..." /></div>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button data-act="save">저장(로컬) · Save (Local)</button>
      <button class="btn-ghost" data-act="logout">로그아웃/토큰삭제 · Logout</button>
      <button class="btn-good" data-act="test">연결 테스트 · Test <span id="spinTest" class="spinner"></span></button>
      <button class="btn-ghost" data-act="touch">GitHub Pages 캐시 무효화 · Cache Bust <span id="spinTouch" class="spinner"></span></button>
      <button class="btn-ghost" data-act="health">연결 진단 · Health</button>
    </div>
    <div class="small" style="margin-top:6px">토큰은 이 브라우저의 <b>localStorage</b>에만 저장됩니다. Token is stored locally only.</div>
  </div>

  <!-- 1) 작품 아카이브 -->
  <div class="card">
    <h3>1) 작품 아카이브 · Artworks (I–V)</h3>
    <div class="tabs" id="workTabs"></div>
    <div id="workForm"></div>
    <div class="gallery" id="workGallery" style="margin-top:10px"></div>
    <div class="small">JSON: <code>/data/artworks.json</code> · 이미지: <code>/img/{section}/</code> (섹션 폴더에 자동 저장)</div>
  </div>

  <!-- 2) 미학 보고서 -->
  <div class="card">
    <h3>2) 미학 보고서 · Aesthetic Reports (DCAR 01–08)</h3>

    <!-- Quick Paste -->
    <div class="card" style="background:#0b214a">
      <div class="grid grid-2">
        <div class="kv"><label>Report</label><select id="quick-id"></select></div>
        <div class="kv"><label>Auto Save</label>
          <select id="quick-auto"><option value="on" selected>ON (붙여넣기 1.5s 후 저장)</option><option value="off">OFF</option></select>
        </div>
      </div>
      <textarea id="quick-text" placeholder="여기에 DCAR 본문(한/영 무제한)을 붙여넣으세요. Paste full text (KR/EN, unlimited). 저장 시 /reports/DCAR-XX.md로 전문 저장, /data/reports.json에는 1000자 요약 저장."></textarea>
      <div class="btn-row" style="margin-top:6px">
        <button data-act="qsave">📝 붙여넣기 저장 · Save Paste (.md + JSON)</button>
        <button class="btn-ghost" data-act="qrebuild">🔁 버튼 재생성 · Rebuild Tabs</button>
      </div>
      <div id="qpv" class="previewBox" style="margin-top:8px"></div>
    </div>

    <!-- Tabs + Editor -->
    <div class="tabs" id="reportTabs" style="margin-top:6px"></div>
    <div id="reportForm"></div>
  </div>

  <!-- 3) Index Commit -->
  <div class="card">
    <h3>3) Index Commit · index.html 편집/커밋</h3>
    <div class="btn-row">
      <button class="btn-ghost" data-act="idx-load">📥 index.html 불러오기</button>
      <button data-act="idx-commit">🚀 index.html 커밋하기</button>
    </div>
    <textarea id="idx-content" placeholder="index.html 내용을 불러와 수정 후, 커밋하기 버튼을 누르세요."></textarea>
    <pre class="log" id="idx-log">Ready.</pre>
  </div>

  <!-- 4) 유틸 -->
  <div class="card">
    <h3>4) 유틸 · Utilities</h3>
    <div class="btn-row" id="utilButtons">
      <button data-act="openSite">사이트 열기 · Open Site</button>
      <button class="btn-ghost" data-act="touch">GitHub Pages 캐시 무효화 · Cache Bust</button>
      <button class="btn-ghost" data-act="diag">PING 파일 쓰기 · Ping</button>
    </div>
  </div>

  <div class="small" style="text-align:center;padding:22px 0">© 2025 DUNGZAK CESTLAVIE · Orchestrated with Lumera</div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== 기본값 내장 ===== */
const DEFAULTS={ owner:"dungzakcestlavie", repo:"dungzakcestlavie.github.io", branch:"main" };
const SECTIONS=[{id:'light',label:'Ⅰ Light & Memory / 빛과 기억'},{id:'human',label:'Ⅱ Human Being / 인간'},{id:'rebirth',label:'Ⅲ Rebirth of Mind / 마음의 재생'},{id:'restore',label:'Ⅳ Restoration of Being / 존재의 복원'},{id:'meta',label:'Ⅴ Metaconsciousness of Light / 빛의 초의식'}];
const DCAR_IDS=Array.from({length:8},(_,i)=>`dcar${String(i+1).padStart(2,'0')}`);

const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const say=(m,err=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=err?'#ff6b6b':'#1d3158';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2300)};
const cfgGet=k=>localStorage.getItem(k)||DEFAULTS[k]||""; const cfgSet=(k,v)=>localStorage.setItem(k,v||"");
function saveCfg(){["owner","repo","branch","token"].forEach(id=>cfgSet(id,$("#"+id).value.trim())); say("✅ 저장 · Saved (Local)");}
function logout(){localStorage.removeItem("token"); $("#token").value=""; say("🔒 토큰 삭제됨");}
function baseUrl(){const loc=location, path=loc.pathname.replace(/\/admin\/.*$/,'/');return loc.origin+path;}
function b64utf8(s){return btoa(unescape(encodeURIComponent(s)));} function f2b64(f){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(f);});}

/* ===== GitHub API ===== */
async function gh(method,path,body,isJson=true){
  const token=cfgGet('token'); if(!token) throw new Error("Missing token");
  const res=await fetch(`https://api.github.com/${path}`,{method,headers:{Accept:"application/vnd.github+json","Authorization":`token ${token}`},body:body?(isJson?JSON.stringify(body):body):null,cache:"no-store",mode:"cors",redirect:"follow",referrerPolicy:"no-referrer",credentials:"omit",keepalive:true});
  if(!res.ok){const txt=await res.text().catch(()=>String(res.status));const msg=`GitHub ${res.status}: ${txt.slice(0,400)}`; if(/401/.test(msg))say("🔑 401 Unauthorized — 토큰/권한 확인",true); else if(/403/.test(msg))say("⛔ 403 Forbidden — repo / pages:builds 권한 필요",true); else if(/404/.test(msg))say("📦 404 Not Found — Owner/Repo/Branch 확인",true); else if(/409/.test(msg))say("🔁 409 Conflict — SHA 충돌. 자동 재시도",true); else say("⚠️ "+msg,true); throw new Error(msg);}
  return res.json();
}
async function getContent(path){ const o=cfgGet('owner'), r=cfgGet('repo'), b=cfgGet('branch')||'main'; try{const j=await gh('GET',`repos/${o}/${r}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(b)}`); const c=j.content?atob(j.content.replace(/\n/g,'')):null; return {sha:j.sha,content:c,exists:true};}catch(e){return{sha:null,content:null,exists:false}}}
async function putFile(path,b64,message){ const o=cfgGet('owner'), r=cfgGet('repo'), b=cfgGet('branch')||'main'; let prev=await getContent(path); const body={message:message||`Update ${path}`,content:b64,branch:b}; if(prev.exists) body.sha=prev.sha; try{ return await gh('PUT',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body);}catch(e){prev=await getContent(path); if(prev.exists) body.sha=prev.sha; else delete body.sha; return gh('PUT',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body);} }
async function delFile(path,message){ const o=cfgGet('owner'), r=cfgGet('repo'), b=cfgGet('branch')||'main'; const prev=await getContent(path); if(!prev.exists) return; return gh('DELETE',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,{message:message||`Delete ${path}`,sha:prev.sha,branch:b});}
async function testConn(){ $("#spinTest").style.display='inline-block'; try{await gh('GET',`repos/${cfgGet('owner')}/${cfgGet('repo')}`); say("✅ 연결 성공");}catch(e){} finally{$("#spinTest").style.display='none';}}

/* ===== Cache / Health / Ping ===== */
async function touchPages(){ const owner=cfgGet('owner'), repo=cfgGet('repo'), tok=cfgGet('token'); if(!owner||!repo||!tok){say("⚠️ Owner/Repo/Token 저장 필요",true);return;} $("#spinTouch").style.display='inline-block'; try{ const stamp=new Date().toISOString(), msg=`touch ${stamp}`; await putFile('data/.touch',b64utf8('touch '+stamp),msg+' [.touch]'); await putFile('data/.pages-touch',b64utf8('pages-touch '+stamp),msg+' [.pages-touch]'); await putFile('data/.ping',b64utf8('ping '+stamp),msg+' [.ping]'); try{await gh('POST',`repos/${owner}/${repo}/pages/builds`,{}); say("🚀 Cache commit + Pages build 요청");}catch(_){say("✅ Cache commit 완료(빌드 요청 생략)");}}catch(e){} finally{$("#spinTouch").style.display='none';}}
async function health(){ try{await gh('GET',`repos/${cfgGet('owner')}/${cfgGet('repo')}`); say("🩺 Repo 접근 OK"); await putFile('data/.health',b64utf8('ok '+new Date().toISOString()),'health check'); say("🩺 쓰기 권한 OK (.health)"); fetch(baseUrl()+'?_health='+Date.now(),{mode:'no-cors'}).then(()=>say("🌐 사이트 접근 OK")).catch(()=>{});}catch(e){} }
async function diag(){ try{await putFile('data/.diag',b64utf8('diag '+new Date().toISOString()),'diag ping'); say("🛰 PING OK");}catch(e){} }

/* ===== Artworks ===== */
let artworks={light:[],human:[],rebirth:[],restore:[],meta:[]};
let currentSection='light';
const ART_JSON='data/artworks.json';

function buildWorkTabs(){ $("#workTabs").innerHTML=SECTIONS.map((s,i)=>`<button data-sec="${s.id}" class="${i?'' :'active'}">${s.label}</button>`).join(''); }
function selectSection(sec,btn){ currentSection=sec; $$('#workTabs button').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); renderWorkForm(sec); renderGallery(); }
function renderWorkForm(sec){
  $("#workForm").innerHTML=`
    <div class="grid grid-2">
      <div class="card">
        <div class="kv"><label>Section</label><input id="w-sec" value="${sec}" disabled></div>
        <div class="kv"><label>Artwork ID</label><input id="w-id" placeholder="${sec}-01"></div>
        <div class="kv"><label>Title</label><input id="w-title"></div>
        <div class="kv"><label>Year</label><input id="w-year" placeholder="2025"></div>
        <div class="kv"><label>Medium</label><input id="w-medium" placeholder="Acrylic on Canvas"></div>
        <div class="kv"><label>Size</label><input id="w-size" placeholder="120x90 cm"></div>
        <div class="kv"><label>Image</label><input id="w-file" type="file" accept="image/*"></div>
        <div id="w-drop" class="drop">📥 드롭/탭하여 선택 · Drop or tap</div>
        <img id="w-prev" class="preview" style="display:none">
        <div class="btn-row" style="margin-top:8px">
          <button data-act="w-upload">📤 이미지 업로드 + JSON</button>
          <button class="btn-ghost" data-act="w-meta">✏️ 메타만 저장</button>
          <button class="btn-ghost" data-act="w-replace">🖼 이미지 교체</button>
          <button class="btn-bad" data-act="w-delete">🗑 삭제</button>
        </div>
      </div>
      <div class="card">
        <div class="kv"><label>검색</label><input id="w-q" placeholder="ID/제목/연도…" oninput="renderGallery()"></div>
        <div class="small">섹션: <b>${sec}</b> · 총 <b id="w-count">0</b>개</div>
      </div>
    </div>`;
  $("#w-file").addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f) return; const p=$("#w-prev"); p.src=URL.createObjectURL(f); p.style.display='block';});
  const dz=$("#w-drop"); const setDrag=x=>dz.classList.toggle('drag',x);
  dz.addEventListener('click',()=>$("#w-file").click());
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();setDrag(true)}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();setDrag(false)}));
  dz.addEventListener('drop',e=>{const f=e.dataTransfer?.files?.[0]; if(!f) return; const dt=new DataTransfer();dt.items.add(f);$("#w-file").files=dt.files; const p=$("#w-prev"); p.src=URL.createObjectURL(f); p.style.display='block';});
}
function idxById(sec,id){return (artworks[sec]||[]).findIndex(x=>x.id===id)}
async function loadArtworks(){ try{const r=await getContent(ART_JSON); if(r.exists){artworks=JSON.parse(r.content||'{}')||artworks; say("✅ artworks.json 로드");} else say("ℹ️ artworks.json 없음 — 저장 시 생성"); renderGallery();}catch(e){} }
function renderGallery(){ const box=$("#workGallery"); if(!box) return; box.innerHTML=''; const sec=currentSection; const q=($("#w-q")?.value||'').toLowerCase(); const arr=(artworks[sec]||[]).filter(a=>`${a.id} ${a.title} ${a.year}`.toLowerCase().includes(q)); $("#w-count").textContent=(artworks[sec]||[]).length||0; arr.forEach(a=>{ const card=document.createElement('div'); card.className='cardThumb'; card.innerHTML=`<button type="button" class="del" aria-label="delete">×</button><img src="${a.image||''}" alt=""><div class="cap">${a.id}${a.title?` · ${a.title}`:''}</div>`; card.querySelector('.del').onclick=async(e)=>{e.stopPropagation(); $("#w-id").value=a.id; await deleteArtwork();}; card.onclick=()=>{ $("#w-id").value=a.id||''; $("#w-title").value=a.title||''; $("#w-year").value=a.year||''; $("#w-medium").value=a.medium||''; $("#w-size").value=a.size||''; const p=$("#w-prev"); if(a.image){p.src=a.image; p.style.display='block'} else p.style.display='none'; window.scrollTo({top:$("#workForm").offsetTop-70,behavior:'smooth'}); }; box.appendChild(card); });}
async function saveArtworksJson(){ await putFile(ART_JSON,b64utf8(JSON.stringify(artworks,null,2)),'Update artworks.json'); say("💾 저장 완료"); }
async function uploadArtwork(){ try{ const sec=currentSection, id=$("#w-id").value.trim(); if(!id) return say("ID 필요",true); const f=$("#w-file").files[0]; let url=(artworks[sec].find(x=>x.id===id)||{}).image||''; if(f){const b=await f2b64(f); const name=(id.replace(/\s+/g,'_')||'image')+(f.name.match(/\.\w+$/)?.[0]||'.jpg'); const path=`img/${sec}/${name}`; await putFile(path,b,`Add ${path}`); url=`/${path}`;} const e={id,title:$("#w-title").value.trim(),year:$("#w-year").value.trim(),medium:$("#w-medium").value.trim(),size:$("#w-size").value.trim(),image:url}; const i=idxById(sec,id); if(i>=0) artworks[sec][i]=e; else artworks[sec].push(e); await saveArtworksJson(); renderGallery(); say("✅ 작품 저장 완료"); }catch(e){} }
async function updateArtwork(){ const sec=currentSection, id=$("#w-id").value.trim(), i=idxById(sec,id); if(i<0) return say("목록에 없음",true); Object.assign(artworks[sec][i],{title:$("#w-title").value.trim(),year:$("#w-year").value.trim(),medium:$("#w-medium").value.trim(),size:$("#w-size").value.trim()}); await saveArtworksJson(); renderGallery(); say("✏️ 메타 저장 완료"); }
async function replaceImage(){ try{ const sec=currentSection, id=$("#w-id").value.trim(), i=idxById(sec,id); if(i<0) return say("목록에 없음",true); const f=$("#w-file").files[0]; if(!f) return say("이미지 선택",true); const b=await f2b64(f); const name=(id.replace(/\s+/g,'_')||'image')+(f.name.match(/\.\w+$/)?.[0]||'.jpg'); const path=`img/${sec}/${name}`; await putFile(path,b,`Replace ${path}`); artworks[sec][i].image=`/${path}`; await saveArtworksJson(); renderGallery(); say("🖼 교체 완료"); }catch(e){} }
async function deleteArtwork(){ try{ const sec=currentSection, id=$("#w-id").value.trim(), i=idxById(sec,id); if(i<0) return say("목록에 없음",true); const u=artworks[sec][i].image||''; if(u.startsWith('/img/')){try{await delFile(u.slice(1),`Delete ${u}`)}catch{}} artworks[sec].splice(i,1); await saveArtworksJson(); renderGallery(); say("🗑 삭제 완료"); }catch(e){} }

/* ===== Reports ===== */
let reports={}; const REP_JSON='data/reports.json'; const SUMMARY_LIMIT=1000;
function mdToHtml(md){ const esc=s=>s.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); return esc(md).split(/\n{2,}/).map(b=>/^#{1,6}\s/.test(b)?'<h3>'+b.replace(/^#{1,6}\s*/,'')+'</h3>':'<p>'+b.replace(/\n/g,'<br>')+'</p>').join(''); }
function initQuickBox(){ const sel=$("#quick-id"); sel.innerHTML=DCAR_IDS.map(id=>`<option value="${id}">${id.toUpperCase()}</option>`).join(''); $("#quick-text").addEventListener('input',()=>{ $("#qpv").innerHTML=mdToHtml($("#quick-text").value); if($("#quick-auto").value!=='on') return; clearTimeout(window.__qs); window.__qs=setTimeout(quickSave,1500); }); }
async function loadReports(){ try{const r=await getContent(REP_JSON); if(r.exists){reports=JSON.parse(r.content||'{}')||{}; say("✅ reports.json 로드");} else {reports={}; say("ℹ️ reports.json 없음 — 저장 시 생성");} rebuildReportTabs(); }catch(e){} }
function rebuildReportTabs(){ const tabs=$("#reportTabs"); tabs.innerHTML=''; DCAR_IDS.forEach(id=>{const b=document.createElement('button'); b.type='button'; b.dataset.rid=id; b.textContent=id.toUpperCase()+(reports[id]?' •':''); b.title=reports[id]?'Saved':'Empty'; tabs.appendChild(b);}); const first=tabs.querySelector('button'); if(first) openReport(first.dataset.rid,first); }
function openReport(id,btn){ $$('#reportTabs button').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); const d=reports[id]||{}; const pdf=`/reports/${id.toUpperCase()}.pdf`, md=`/reports/${id.toUpperCase()}.md`; $("#reportForm").innerHTML=`<div class="grid grid-2"> <div class="card"> <div class="kv"><label>Report</label><input id="r-id" value="${id}" disabled></div> <div class="kv"><label>Title (EN)</label><input id="r-en" value="${d.titleEN||''}" placeholder="On Light, Memory, and Being"></div> <div class="kv"><label>Title (KO)</label><input id="r-ko" value="${d.titleKO||''}" placeholder="빛, 기억, 존재에 관하여"></div> <div class="kv"><label>Series</label><input id="r-series" value="${d.series||'Aesthetic Reports'}"></div> <div class="kv"><label>Year</label><input id="r-year" value="${d.year||''}" placeholder="2025"></div> <div class="kv"><label>PDF</label><input id="r-pdf" type="file" accept=".pdf"></div> <div class="btn-row" style="margin-top:6px"> <button data-act="pdf">📤 PDF 업로드</button> <button class="btn-ghost" data-act="open">🔗 PDF 열기</button> <button class="btn-bad" data-act="delpdf">🗑 PDF 삭제</button> </div> </div> <div class="card"> <textarea id="r-text" placeholder="본문 붙여넣기 (한/영 무제한)">${d.text||''}</textarea> <div class="btn-row" style="margin-top:6px"> <button data-act="saveTxt">📝 텍스트 저장(.md + JSON) </button> <button class="btn-ghost" data-act="saveMeta">✏️ 메타만 저장(JSON)</button> <button class="btn-bad" data-act="delete">🗑 전체 삭제</button> </div> <div class="small">.md: <code>${md}</code> · 글자수: <b id="r-count">${(d.text||'').length.toLocaleString()}</b> · Updated: ${d.updatedAt||'-'}</div> <div class="previewBox" id="rpv">${mdToHtml(d.text||'')}</div> </div> </div>`; $("#r-text").addEventListener('input',e=>{ $("#r-count").textContent=e.target.value.length.toLocaleString(); $("#rpv").innerHTML=mdToHtml(e.target.value); }); }
async function quickSave(){ try{ const id=$("#quick-id").value, txt=$("#quick-text").value.trim(); if(!txt) return say("내용이 비어있어요",true); const fm=['---',`report_id: ${id.toUpperCase()}`,'---',''].join('\n'); await putFile(`reports/${id.toUpperCase()}.md`, b64utf8(fm+txt+'\n'), `Save ${id.toUpperCase()}.md`); const short=txt.slice(0,SUMMARY_LIMIT); reports[id]={...(reports[id]||{id}), text:txt, textShort:short, textUrl:`/reports/${id.toUpperCase()}.md`, textChars:txt.length, updatedAt:new Date().toISOString()}; await saveReportsJson(); rebuildReportTabs(); say("✅ 붙여넣기 저장 완료"); }catch(e){} }
function curRid(){return $("#r-id").value}
async function saveReportsJson(){ await putFile(REP_JSON,b64utf8(JSON.stringify(reports,null,2)),'Update reports.json'); }
async function saveReportText(){ try{ const id=curRid(), txt=$("#r-text").value; const meta={titleEN:$("#r-en").value.trim(),titleKO:$("#r-ko").value.trim(),series:$("#r-series").value.trim()||'Aesthetic Reports',year:$("#r-year").value.trim()}; const fm=['---',`report_id: ${id.toUpperCase()}`,`title_en: "${meta.titleEN||''}"`,`title_ko: "${meta.titleKO||''}"`,`year: "${meta.year||''}"`,'---',''].join('\n'); await putFile(`reports/${id.toUpperCase()}.md`, b64utf8(fm+txt+'\n'), `Save ${id.toUpperCase()}.md`); const short=txt.slice(0,SUMMARY_LIMIT); reports[id]={...(reports[id]||{id}),...meta,text:txt,textShort:short,textUrl:`/reports/${id.toUpperCase()}.md`,textChars:txt.length,updatedAt:new Date().toISOString()}; await saveReportsJson(); rebuildReportTabs(); say("✅ 텍스트 저장 완료"); }catch(e){} }
async function saveReportMeta(){ try{ const id=curRid(); if(!reports[id]) reports[id]={id}; Object.assign(reports[id],{titleEN:$("#r-en").value.trim(),titleKO:$("#r-ko").value.trim(),series:$("#r-series").value.trim()||'Aesthetic Reports',year:$("#r-year").value.trim(),updatedAt:new Date().toISOString()}); await saveReportsJson(); rebuildReportTabs(); say("✏️ 메타 저장 완료"); }catch(e){} }
async function uploadReportPDF(){ try{ const id=curRid(); const f=$("#r-pdf").files[0]; if(!f) return say("PDF 선택",true); await putFile(`reports/${id.toUpperCase()}.pdf`, await f2b64(f), `Add ${id.toUpperCase()}.pdf`); if(!reports[id]) reports[id]={id}; reports[id].pdfUrl=`/reports/${id.toUpperCase()}.pdf`; reports[id].updatedAt=new Date().toISOString(); await saveReportsJson(); say("✅ PDF 업로드 완료"); }catch(e){} }
async function deleteReportAll(){ try{ const id=curRid(); try{await delFile(`reports/${id.toUpperCase()}.md`,'delete md')}catch{} try{await delFile(`reports/${id.toUpperCase()}.pdf`,'delete pdf')}catch{} delete reports[id]; await saveReportsJson(); rebuildReportTabs(); say("🗑 삭제 완료"); }catch(e){} }
async function deletePDFOnly(){ try{ const id=curRid(); await delFile(`reports/${id.toUpperCase()}.pdf`,'delete pdf'); if(reports[id]){delete reports[id].pdfUrl; reports[id].updatedAt=new Date().toISOString(); await saveReportsJson();} say("🗑 PDF 삭제 완료"); }catch(e){} }

/* ===== Index Commit ===== */
async function idxLoad(){ $("#idx-log").textContent="Loading…"; try{const j=await getContent('index.html'); if(!j.exists) return $("#idx-log").textContent="⚠️ index.html 없음"; $("#idx-content").value=j.content||""; $("#idx-log").textContent="📥 index.html 불러옴"; }catch(e){ $("#idx-log").textContent="⚠️ "+(e.message||e);} }
async function idxCommit(){ $("#idx-log").textContent="Committing…"; try{ const content=$("#idx-content").value; if(!content) return $("#idx-log").textContent="⚠️ 내용 없음"; const b64=b64utf8(content); let sha=null; try{ const j=await getContent('index.html'); if(j.exists) sha=j.sha; }catch(_){ } const body={message:"Update index.html via Admin Ω.13",content:b64,branch:cfgGet('branch')}; if(sha) body.sha=sha; const o=cfgGet('owner'), r=cfgGet('repo'); const res=await gh('PUT',`repos/${o}/${r}/contents/index.html`,body); $("#idx-log").textContent="✅ 커밋 완료\n\n"+JSON.stringify(res,null,2); say("✅ index.html 커밋 성공"); }catch(e){ $("#idx-log").textContent="⚠️ "+(e.message||e);} }

/* ===== iOS 안전 바인더: 모든 버튼/탭을 click+touchstart+mousedown로 보강 ===== */
function doAct(a,el){ const map={
  save:saveCfg, logout:logout, test:testConn, touch:touchPages, health:health, diag:diag,
  'w-upload':uploadArtwork, 'w-meta':updateArtwork, 'w-replace':replaceImage, 'w-delete':deleteArtwork,
  qsave:quickSave, qrebuild:rebuildReportTabs,
  pdf:uploadReportPDF, open:()=>window.open(`/reports/${($("#r-id")?.value||'DCAR01').toUpperCase()}.pdf`,'_blank'),
  delpdf:deletePDFOnly, saveTxt:saveReportText, saveMeta:saveReportMeta, delete:deleteReportAll,
  'idx-load':idxLoad, 'idx-commit':idxCommit, openSite:()=>window.open(baseUrl(),'_blank','noopener')
}; map[a]?.();}
function bindAll(){ document.querySelectorAll('[data-act],[data-sec]').forEach(el=>{ if(el.__bound) return; el.__bound=true; ['click','touchstart','mousedown'].forEach(ev=>{ el.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); const act=el.dataset.act, sec=el.dataset.sec; if(act) return doAct(act,el); if(sec) return selectSection(sec,el); },{passive:false}); }); el.setAttribute('tabindex','0'); el.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }}); }); }
const mo=new MutationObserver(bindAll);

/* ===== Init ===== */
async function init(){
  ["owner","repo","branch","token"].forEach(id=>{$("#"+id).value=cfgGet(id);});
  buildWorkTabs(); selectSection('light',$('#workTabs button[data-sec="light"]')); await loadArtworks();
  initQuickBox(); await loadReports(); $("#qpv").innerHTML='';
  $("#quick-text").addEventListener('input',()=>{ if($("#quick-auto").value!=='on') return;});
  bindAll(); mo.observe(document.body,{childList:true,subtree:true});
}
window.addEventListener('load',init);
</script>
<div id="toast" class="toast"></div>
</body>
</html>