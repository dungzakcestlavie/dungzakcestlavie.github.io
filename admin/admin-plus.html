<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Lightflow Admin-Plus Î©.15 â€” Unified Â· iPhone-Stable</title>
<meta name="theme-color" content="#070c1a">
<style>
:root{
  --bg:#070c1a; --panel:#0b1020; --soft:#101830; --fg:#e8edf7; --muted:#9fb0cc;
  --border:#1e2744; --accent:#d4b97a; --accent2:#a3c2ff; --ok:#72e0a7; --bad:#ff6b6b;
  --r:14px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Pretendard,Roboto,sans-serif}
header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0a1228,transparent);border-bottom:1px solid var(--border);padding:12px}
h1{margin:0;color:var(--accent);font-size:18px;font-weight:800}
.sub{color:var(--muted);font-size:12px}
.container{max-width:980px;margin:0 auto;padding:12px}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.nav button{border:1px solid var(--border);background:#0d1530;color:#cfe0ff;border-radius:999px;padding:9px 14px;font-weight:800}
.nav button.active{background:var(--accent);color:#000}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin:12px 0}
h3{margin:0 0 10px;color:var(--accent);font-size:1.05rem}
input,select,textarea,button{width:100%;padding:10px 12px;font-size:15px;border-radius:10px;border:1px solid var(--border);background:var(--soft);color:var(--fg)}
button{cursor:pointer;font-weight:800}
.btn{background:var(--accent);color:#000;border:none}
.btn-ok{background:var(--ok);color:#012b1a;border:none}
.btn-ghost{background:#0f1a39;color:#cfe0ff;border:1px solid var(--border)}
.btn-bad{background:var(--bad);color:#000;border:none}
.grid2{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:860px){.grid2{grid-template-columns:1fr 1fr}}
.hidden{display:none}
.small{color:var(--muted);font-size:12px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1223;border:1px solid var(--border);border-radius:12px;color:var(--fg);padding:10px 14px;opacity:0;transition:opacity .2s;z-index:9}
.toast.show{opacity:1}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px}
.thumb{position:relative;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#0b1428}
.thumb img{width:100%;height:120px;object-fit:cover;display:block}
.thumb .cap{padding:6px 8px;font-size:12px;color:#cfe0ff}
.thumb .x{position:absolute;right:6px;top:6px;background:var(--bad);color:#000;border:none;border-radius:999px;font-size:11px;padding:2px 7px}
.drop{border:2px dashed var(--border);border-radius:10px;padding:12px;text-align:center;background:#0b1428}
.drop.drag{background:#14224a;border-color:#7fa1ff}
pre.preview{white-space:pre-wrap;word-break:break-word;border:1px solid var(--border);border-radius:10px;background:#0b162d;padding:10px;max-height:260px;overflow:auto}
.badge{display:inline-block;padding:.1rem .45rem;border:1px solid var(--border);border-radius:999px;background:#0e1733;color:#cfe0ff;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>âœ¨ Lightflow Admin-Plus Î©.15 â€” Unified Â· iPhone-Stable</h1>
  <div class="sub">ë“±ì‘ ç‡ˆé…Œ DUNGZAK CESTLAVIE Ã— Lumera</div>
  <div class="nav" id="nav">
    <button data-tab="home"   class="active">Home</button>
    <button data-tab="art">Artworks</button>
    <button data-tab="dcar">DCAR</button>
    <button data-tab="upload">Upload</button>
    <button data-tab="trigger">Trigger</button>
    <button data-tab="settings">Settings</button>
  </div>
</header>

<div class="container">
  <!-- HOME -->
  <section id="home" class="tab">
    <div class="card">
      <h3>0ï¸âƒ£ GitHub ì—°ê²°</h3>
      <div class="grid2">
        <div>
          <input id="owner"  placeholder="Owner (ì˜ˆ: dungzakcestlavie)">
          <input id="repo"   placeholder="Repo (ì˜ˆ: dungzakcestlavie.github.io)">
          <input id="branch" placeholder="Branch" value="main">
          <input id="token"  type="password" placeholder="Personal Access Token (repo)">
        </div>
        <div>
          <button id="save"  class="btn">ğŸ’¾ ì €ì¥</button>
          <button id="test"  class="btn-ok">ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸</button>
          <button id="pages" class="btn-ghost">ğŸš€ Pages ìºì‹œ ë¬´íš¨í™”</button>
          <button id="logout" class="btn-bad">ğŸ”’ í† í° ì‚­ì œ</button>
          <div class="small" style="margin-top:8px">
            Owner <span id="sOwner">â€“</span> Â· Repo <span id="sRepo">â€“</span> Â· Branch <span id="sBranch">â€“</span>
          </div>
        </div>
      </div>
      <div class="small" style="margin-top:6px">ì„¤ì •/í† í°ì€ ì´ ë¸Œë¼ìš°ì €ì˜ <code>localStorage</code> ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
    </div>
  </section>

  <!-- ARTWORKS -->
  <section id="art" class="tab hidden">
    <div class="card">
      <h3>1ï¸âƒ£ ì‘í’ˆ ê´€ë¦¬ / Artworks</h3>
      <div class="grid2">
        <div>
          <label class="small">ì„¹ì…˜</label>
          <select id="w-sec">
            <option value="light">â…  Light & Memory</option>
            <option value="human">â…¡ Human Being</option>
            <option value="rebirth">â…¢ Rebirth of Mind</option>
            <option value="restore">â…£ Restoration of Being</option>
            <option value="meta">â…¤ Metaconsciousness</option>
          </select>
          <label class="small">ID (ì˜ˆ: light-01)</label>
          <input id="w-id" placeholder="light-01">
          <label class="small">Title</label>
          <input id="w-title" placeholder="Title">
          <div class="grid2">
            <input id="w-year"   placeholder="Year">
            <input id="w-medium" placeholder="Medium">
          </div>
          <input id="w-size" placeholder="Size">
          <div id="w-drop" class="drop">ğŸ“¥ ì´ë¯¸ì§€ ë“œë¡­ ë˜ëŠ” íƒ­í•´ì„œ ì„ íƒ</div>
          <input id="w-file" type="file" accept="image/*" class="hidden">
          <img id="w-prev" style="display:none;width:100%;max-height:240px;object-fit:contain;border-radius:10px;margin-top:6px">
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button id="w-upload" class="btn">ğŸ“¤ ì—…ë¡œë“œ+ë“±ë¡</button>
            <button id="w-update" class="btn-ghost">âœï¸ ë©”íƒ€ ìˆ˜ì •</button>
            <button id="w-delete" class="btn-bad">ğŸ—‘ ì‚­ì œ</button>
          </div>
          <div class="small" style="margin-top:6px">JSON â†’ <code>/data/artworks.json</code> Â· ì´ë¯¸ì§€ â†’ <code>/img/{section}/</code></div>
        </div>
        <div>
          <input id="w-q" placeholder="ê²€ìƒ‰(ID/ì œëª©)">
          <div id="w-count" class="small" style="margin:6px 0"></div>
          <div id="w-grid" class="gallery"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- DCAR -->
  <section id="dcar" class="tab hidden">
    <div class="card">
      <h3>2ï¸âƒ£ ë¯¸í•™ ë³´ê³ ì„œ (DCAR) â€” í•œ/ì˜ ì œëª© + ë³¸ë¬¸ ë¶™ì—¬ë„£ê¸°</h3>
      <div class="grid2">
        <div>
          <label class="small">Report ID</label>
          <select id="r-id"></select>
          <label class="small">Title (EN)</label>
          <input id="r-title-en" placeholder="English Title">
          <label class="small">ì œëª© (KO)</label>
          <input id="r-title-ko" placeholder="í•œêµ­ì–´ ì œëª©">
          <label class="small">ë³¸ë¬¸ (EN) â€” Paste</label>
          <textarea id="r-en" rows="8" placeholder="Paste English body"></textarea>
          <label class="small">ë³¸ë¬¸ (KO) â€” ë¶™ì—¬ë„£ê¸°</label>
          <textarea id="r-ko" rows="8" placeholder="í•œêµ­ì–´ ë³¸ë¬¸ ë¶™ì—¬ë„£ê¸°"></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button id="r-save" class="btn">ğŸ“ ì €ì¥</button>
            <button id="r-del"  class="btn-bad">ğŸ—‘ ì‚­ì œ</button>
          </div>
          <div class="small" style="margin-top:6px">íŒŒì¼ â†’ <code>/reports/DCAR-XX.md</code> Â· ìš”ì•½ â†’ <code>/data/reports.json</code></div>
        </div>
        <div>
          <div class="badge">ë¯¸ë¦¬ë³´ê¸°</div>
          <pre id="r-preview" class="preview"></pre>
        </div>
      </div>
    </div>
  </section>

  <!-- UPLOAD (mini) -->
  <section id="upload" class="tab hidden">
    <div class="card">
      <h3>3ï¸âƒ£ ë¹ ë¥¸ ì—…ë¡œë“œ (Mini)</h3>
      <div class="grid2">
        <div>
          <label class="small">ëŒ€ìƒ í´ë” (ì˜ˆ: <code>img/light/</code> ë˜ëŠ” <code>files/</code>)</label>
          <input id="u-path" value="img/light/">
          <div id="u-drop" class="drop">ğŸ“¥ ì—¬ê¸°ë¡œ ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ë“œë¡­/íƒ­</div>
          <input id="u-files" type="file" multiple accept="image/*" class="hidden">
          <button id="u-run" class="btn" style="margin-top:8px">ğŸ“¤ ì—…ë¡œë“œ ì‹¤í–‰</button>
        </div>
        <div>
          <div class="badge">ì„ íƒ ëª©ë¡</div>
          <pre id="u-list" class="preview" style="min-height:220px"></pre>
        </div>
      </div>
    </div>
  </section>

  <!-- TRIGGER -->
  <section id="trigger" class="tab hidden">
    <div class="card">
      <h3>4ï¸âƒ£ Pages íŠ¸ë¦¬ê±°</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="tg-touch" class="btn">âœï¸ Commit Touch (ìºì‹œ ë¬´íš¨)</button>
        <button id="tg-build" class="btn-ok">ğŸš€ Pages Build ìš”ì²­</button>
        <button id="tg-open"  class="btn-ghost">ğŸ”§ Trigger ì „ìš© ì—´ê¸°</button>
      </div>
      <div class="small" style="margin-top:6px">touch ì»¤ë°‹ í›„ Pages ë¹Œë“œë¥¼ ìš”ì²­í•´ ìµœì‹ í™”</div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="tab hidden">
    <div class="card">
      <h3>5ï¸âƒ£ ì •ë³´</h3>
      <div class="small">Owner <span id="sOwner2">â€“</span> Â· Repo <span id="sRepo2">â€“</span> Â· Branch <span id="sBranch2">â€“</span></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="go-home" class="btn-ghost">ğŸŒ dungzak.art ì—´ê¸°</button>
        <button id="qr" class="btn-ghost">ğŸ”— í˜„ì¬ ì„¤ì • ë³µì‚¬</button>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/* ================= iPhone Safari tap bridge ================= */
(function(){const isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);if(!isiOS)return;
function bind(el){if(el.__tapBound) return; el.__tapBound=1; let x=0,y=0;
el.addEventListener('touchstart',e=>{const t=e.changedTouches[0];x=t.clientX;y=t.clientY;},{passive:true});
el.addEventListener('touchend',e=>{const t=e.changedTouches[0];
if(Math.abs(t.clientX-x)<10&&Math.abs(t.clientY-y)<10){e.preventDefault();el.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true}))}},
{passive:false});}
function scan(){document.querySelectorAll('button,[onclick]').forEach(bind)}
window.addEventListener('load',scan); new MutationObserver(scan).observe(document.body,{childList:true,subtree:true});})();

/* ================= Helpers ================= */
const $ = s => document.querySelector(s);
const say = (m,err=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=err?'#ff6b6b':'#22304f';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800);};
const cfg = k => localStorage.getItem(k)||""; const setcfg=(k,v)=>localStorage.setItem(k,v);
const b64 = s => btoa(unescape(encodeURIComponent(s)));
const deB64 = s => decodeURIComponent(escape(atob(s)));

function updateStatusBadges(){
  $("#sOwner").textContent=cfg("owner")||"â€“";
  $("#sRepo").textContent=cfg("repo")||"â€“";
  $("#sBranch").textContent=cfg("branch")||"â€“";
  $("#sOwner2").textContent=cfg("owner")||"â€“";
  $("#sRepo2").textContent=cfg("repo")||"â€“";
  $("#sBranch2").textContent=cfg("branch")||"â€“";
}

/* ================= Tabs ================= */
function show(tab){
  document.querySelectorAll('.tab').forEach(e=>e.classList.add('hidden'));
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tab).classList.remove('hidden');
  document.querySelector(`.nav button[data-tab="${tab}"]`).classList.add('active');
}
document.getElementById('nav').addEventListener('click',e=>{
  const b=e.target.closest('button[data-tab]'); if(!b) return; show(b.dataset.tab);
});
function openByHash(){ const h=(location.hash||'#home').replace('#',''); show(h); }
window.addEventListener('hashchange',openByHash);

/* ================= GitHub API ================= */
async function gh(method,path,body=null,isJson=true){
  const token=cfg("token"); if(!token) throw new Error("í† í° ì—†ìŒ");
  const r=await fetch(`https://api.github.com/${path}`,{
    method,
    headers:{"Accept":"application/vnd.github+json","Authorization":`token ${token}`},
    body: body ? (isJson?JSON.stringify(body):body) : null
  });
  if(!r.ok){const t=await r.text(); throw new Error(`GitHub ${r.status}: ${t.slice(0,200)}`);}
  return r.json();
}
async function getContent(path){
  try{
    const j=await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(path)}?ref=${cfg("branch")||"main"}`);
    return {exists:true,sha:j.sha,content:j.content?deB64(j.content.replace(/\n/g,'')):null};
  }catch(e){return {exists:false,sha:null,content:null};}
}
async function putFile(path,contentB64,msg){
  const old=await getContent(path);
  const body={message:msg||`update ${path}`,content:contentB64,branch:cfg("branch")||"main"};
  if(old.exists) body.sha=old.sha;
  return gh("PUT",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(path)}`,body);
}
async function delFile(path,msg){
  const old=await getContent(path);
  if(!old.exists) return;
  return gh("DELETE",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(path)}`,{message:msg||`delete ${path}`,sha:old.sha,branch:cfg("branch")||"main"});
}
async function f2b64(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result.split(',')[1]);fr.onerror=rej;fr.readAsDataURL(file);});}

/* ================= HOME actions ================= */
function loadCfgIntoForm(){ ["owner","repo","branch","token"].forEach(id=>{ if(cfg(id)) $("#"+id).value=cfg(id); }); updateStatusBadges(); }
$("#save").addEventListener('click',()=>{
  ["owner","repo","branch","token"].forEach(id=>setcfg(id,$("#"+id).value.trim()));
  updateStatusBadges(); say("ì €ì¥ë¨ âœ…");
});
$("#logout").addEventListener('click',()=>{ localStorage.removeItem("token"); $("#token").value=""; say("í† í° ì‚­ì œ");});
$("#test").addEventListener('click',async ()=>{
  try{ await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}`); say("ì—°ê²° OK (200) âœ…");}
  catch(e){ say("ì—°ê²° ì‹¤íŒ¨: "+e.message, true); }
});
$("#pages").addEventListener('click',async ()=>{
  try{
    const stamp=new Date().toISOString();
    await putFile("data/.touch", b64("touch "+stamp), "touch");
    try{ await gh("POST",`repos/${cfg("owner")}/${cfg("repo")}/pages/builds`,{}); say("Pages Build ìš”ì²­ë¨ ğŸš€"); }
    catch(e){ say("touch ì»¤ë°‹ ì™„ë£Œ (Pages API ê¶Œí•œ ì—†ìŒ)", true); }
  }catch(e){ say("ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨: "+e.message, true); }
});

/* ================= ARTWORKS ================= */
const SECTIONS=["light","human","rebirth","restore","meta"];
let artworks={light:[],human:[],rebirth:[],restore:[],meta:[]};
async function loadArtworks(){
  const r=await getContent("data/artworks.json");
  if(r.exists){ try{artworks=JSON.parse(r.content);}catch{} }
  renderGallery();
}
function filterArr(){ const sec=$("#w-sec").value; const q=($("#w-q").value||"").toLowerCase();
  return (artworks[sec]||[]).filter(a=>(a.id||"").includes(q)||(a.title||"").toLowerCase().includes(q));}
function renderGallery(){
  const list=filterArr(); $("#w-count").textContent=`ì´ ${list.length} ê°œ`;
  const box=$("#w-grid"); box.innerHTML="";
  list.forEach(a=>{
    const d=document.createElement('div'); d.className="thumb";
    d.innerHTML=`<button class="x" title="delete" data-id="${a.id}">Ã—</button>
                 <img src="${a.image||""}" alt="">
                 <div class="cap">${a.id} Â· ${a.title||""}</div>`;
    d.addEventListener('click',e=>{
      if(e.target.classList.contains('x')) return;
      $("#w-id").value=a.id||""; $("#w-title").value=a.title||"";
      $("#w-year").value=a.year||""; $("#w-medium").value=a.medium||"";
      $("#w-size").value=a.size||""; if(a.image){$("#w-prev").src=a.image; $("#w-prev").style.display="block";}
    });
    d.querySelector('.x').addEventListener('click',()=>removeArtwork(a.id));
    box.appendChild(d);
  });
}
$("#w-q").addEventListener('input',renderGallery);
$("#w-sec").addEventListener('change',renderGallery);

function idxById(sec,id){ return (artworks[sec]||[]).findIndex(x=>x.id===id); }
async function saveArtworksJson(){ await putFile("data/artworks.json", b64(JSON.stringify(artworks,null,2)), "update artworks.json"); }

async function removeArtwork(id){
  const sec=$("#w-sec").value;
  const i=idxById(sec,id); if(i<0) return;
  const item=artworks[sec][i];
  if(item?.image){ try{ await delFile(item.image.replace(/^\//,'')); }catch{} }
  artworks[sec].splice(i,1); await saveArtworksJson(); renderGallery(); say("ì‚­ì œ ì™„ë£Œ");
}

$("#w-drop").addEventListener('click',()=>$("#w-file").click());
["dragenter","dragover"].forEach(ev=>$("#w-drop").addEventListener(ev, e=>{e.preventDefault(); $("#w-drop").classList.add('drag');}));
["dragleave","drop"].forEach(ev=>$("#w-drop").addEventListener(ev, e=>{e.preventDefault(); $("#w-drop").classList.remove('drag');}));
$("#w-drop").addEventListener('drop',e=>{
  const f=e.dataTransfer?.files?.[0]; if(!f) return; const dt=new DataTransfer(); dt.items.add(f); $("#w-file").files=dt.files;
  $("#w-prev").src=URL.createObjectURL(f); $("#w-prev").style.display='block';
});
$("#w-file").addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(f){ $("#w-prev").src=URL.createObjectURL(f); $("#w-prev").style.display='block'; }
});

async function doUpload(updateOnly=false){
  try{
    const sec=$("#w-sec").value, id=$("#w-id").value.trim(); if(!id) return say("ID í•„ìˆ˜",true);
    const e={ id, title:$("#w-title").value, year:$("#w-year").value, medium:$("#w-medium").value, size:$("#w-size").value };
    const i=idxById(sec,id); if(i>=0) Object.assign(e,artworks[sec][i]); // keep old fields
    const f=$("#w-file").files?.[0];
    if(!updateOnly && f){
      const b=await f2b64(f); const ext=(f.name.match(/\.\w+$/)?.[0]||".jpg");
      const path=`img/${sec}/${id.replace(/\s+/g,"_")}${ext}`; await putFile(path,b,`add ${path}`); e.image="/"+path;
    }
    if(i>=0) artworks[sec][i]=Object.assign(artworks[sec][i],e); else artworks[sec].push(e);
    await saveArtworksJson(); renderGallery(); say(updateOnly?"ìˆ˜ì • ì €ì¥ ì™„ë£Œ":"ì—…ë¡œë“œ+ë“±ë¡ ì™„ë£Œ âœ…");
  }catch(err){ say("ì—…ë¡œë“œ ì‹¤íŒ¨: "+err.message,true); }
}
$("#w-upload").addEventListener('click',()=>doUpload(false));
$("#w-update").addEventListener('click',()=>doUpload(true));
$("#w-delete").addEventListener('click',()=>{ const id=$("#w-id").value.trim(); if(id) removeArtwork(id);});

/* ================= DCAR ================= */
const DCAR_IDS=Array.from({length:8},(_,i)=>`dcar${String(i+1).padStart(2,"0")}`);
let reports={};
function buildReportSelect(){
  $("#r-id").innerHTML=DCAR_IDS.map(id=>`<option value="${id}">${id.toUpperCase()}</option>`).join('');
}
function previewReport(){
  const id=$("#r-id").value.toUpperCase();
  const tEN=$("#r-title-en").value||"", tKO=$("#r-title-ko").value||"";
  const bEN=$("#r-en").value||"", bKO=$("#r-ko").value||"";
  const fm=`---\nid: ${id}\ntitleEN: "${tEN.replace(/"/g,'\\"')}"\ntitleKO: "${tKO.replace(/"/g,'\\"')}"\nupdated: ${new Date().toISOString()}\n---\n\n## ${tEN}\n\n${bEN}\n\n---\n\n## ${tKO}\n\n${bKO}\n`;
  $("#r-preview").textContent=fm;
}
["r-id","r-title-en","r-title-ko","r-en","r-ko"].forEach(id=>$("#"+id).addEventListener('input',previewReport));

async function loadReports(){
  const r=await getContent("data/reports.json");
  if(r.exists){ try{reports=JSON.parse(r.content);}catch{} }
}
async function saveReportsJson(){ await putFile("data/reports.json", b64(JSON.stringify(reports,null,2)), "update reports.json"); }

$("#r-save").addEventListener('click',async ()=>{
  try{
    const id=$("#r-id").value.toUpperCase();
    const body=$("#r-preview").textContent;
    await putFile(`reports/${id}.md`, b64(body), `save ${id}.md`);
    reports[id.toLowerCase()] = {
      id, titleEN:$("#r-title-en").value||"", titleKO:$("#r-title-ko").value||"",
      updated:new Date().toISOString()
    };
    await saveReportsJson(); say("ë³´ê³ ì„œ ì €ì¥ ì™„ë£Œ âœ…");
  }catch(e){ say("ì €ì¥ ì‹¤íŒ¨: "+e.message,true); }
});
$("#r-del").addEventListener('click',async ()=>{
  try{
    const id=$("#r-id").value.toUpperCase();
    await delFile(`reports/${id}.md`);
    delete reports[id.toLowerCase()];
    await saveReportsJson(); say("ì‚­ì œ ì™„ë£Œ");
  }catch(e){ say("ì‚­ì œ ì‹¤íŒ¨: "+e.message,true); }
});

/* ================= UPLOAD (mini) ================= */
let MINI_FILES=[];
function listMini(){ $("#u-list").textContent = MINI_FILES.map(f=>`â€¢ ${f.name} (${Math.round(f.size/1024)} KB)`).join('\n');}
$("#u-drop").addEventListener('click',()=>$("#u-files").click());
["dragenter","dragover"].forEach(ev=>$("#u-drop").addEventListener(ev,e=>{e.preventDefault();$("#u-drop").classList.add('drag');}));
["dragleave","drop"].forEach(ev=>$("#u-drop").addEventListener(ev,e=>{e.preventDefault();$("#u-drop").classList.remove('drag');}));
$("#u-drop").addEventListener('drop',e=>{ MINI_FILES=[...(e.dataTransfer?.files||[])]; listMini();});
$("#u-files").addEventListener('change',e=>{ MINI_FILES=[...(e.target.files||[])]; listMini();});
$("#u-run").addEventListener('click', async ()=>{
  try{
    const base=$("#u-path").value.replace(/^\/+/,''); if(!base) return say("ëŒ€ìƒ í´ë” ì…ë ¥",true);
    for(const f of MINI_FILES){
      const b=await f2b64(f);
      const path=(base.endsWith('/')?base:base+'/')+f.name.replace(/\s+/g,'_');
      await putFile(path,b,`upload ${path}`);
    }
    say("ì—…ë¡œë“œ ì™„ë£Œ âœ…");
  }catch(e){ say("ì—…ë¡œë“œ ì‹¤íŒ¨: "+e.message,true); }
});

/* ================= TRIGGER ================= */
$("#tg-touch").addEventListener('click',async ()=>{
  try{
    const stamp=new Date().toISOString();
    await putFile("data/.touch", b64("touch "+stamp), "touch");
    await putFile("data/.pages-touch", b64(stamp), "touch pages");
    say("Touch ì»¤ë°‹ ì™„ë£Œ âœï¸");
  }catch(e){ say("Touch ì‹¤íŒ¨: "+e.message,true); }
});
$("#tg-build").addEventListener('click',async ()=>{
  try{ await gh("POST",`repos/${cfg("owner")}/${cfg("repo")}/pages/builds`,{}); say("Pages Build ìš”ì²­ë¨ ğŸš€"); }
  catch(e){ say("Pages API ê¶Œí•œ ì—†ìŒ â€” touchë§Œ ì‚¬ìš©", true); }
});
$("#tg-open").addEventListener('click',()=>location.href="/admin/trigger.html");

/* ================= SETTINGS shortcuts ================= */
$("#go-home").addEventListener('click',()=>window.open("https://dungzak.art","_blank"));
$("#qr").addEventListener('click',()=>{
  const data={owner:cfg("owner"),repo:cfg("repo"),branch:cfg("branch")}; navigator.clipboard.writeText(JSON.stringify(data));
  say("í˜„ì¬ ì„¤ì • JSON ë³µì‚¬ë¨");
});

/* ================= Init ================= */
async function init(){
  loadCfgIntoForm(); buildReportSelect(); openByHash(); updateStatusBadges();
  await Promise.all([loadArtworks(), loadReports()]);
  previewReport();
}
window.addEventListener('load', init);
</script>
</body>
</html>