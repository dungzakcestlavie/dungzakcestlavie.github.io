<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lightflow Admin Ω.11.1 — Batch Uploader</title>
<meta name="theme-color" content="#070c1a" />
<style>
:root{--bg:#070c1a;--panel:#0b1020;--soft:#0f1730;--fg:#e8edf7;--muted:#9fa8c0;--accent:#d4b97a;--ok:#74e0a1;--bad:#ff6b6b;--border:#1e2744;--r:14px}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,system-ui,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
.header{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,#0a1022e6,#0a102200);padding:12px 14px 10px;border-bottom:1px solid var(--border)}
.h1{margin:0;color:var(--accent);font-weight:800;font-size:22px}
.sub{font-size:13px;color:var(--muted);margin-top:4px}
.admin-nav{position:sticky;top:56px;z-index:90;background:rgba(10,16,34,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
.admin-nav .bar{max-width:980px;margin:0 auto;display:flex;gap:8px;overflow-x:auto;padding:8px 12px}
.admin-nav a{flex:0 0 auto;text-decoration:none;font-weight:700;font-size:14px;color:#cfe0ff;background:#0d142b;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
.admin-nav a.active{background:var(--accent);color:#000}
.container{max-width:980px;margin:0 auto;padding:12px 12px 120px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin:12px 0}
.card h3{margin:0 0 12px;color:var(--accent);font-size:1.05rem}
input,select,button{width:100%;min-height:48px;border-radius:12px;border:1px solid var(--border);background:var(--soft);color:var(--fg);padding:12px;font-size:15px}
button{border:none;font-weight:800;cursor:pointer}
.btn{background:var(--accent);color:#08101f}
.btn-ok{background:var(--ok);color:#062519}
.btn-ghost{background:#203055;color:#e8edf7;border:1px solid rgba(255,255,255,.08)}
.btn-bad{background:var(--bad);color:#2a0000}
.btnbar{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.row{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:860px){.row{grid-template-columns:1.3fr 1fr}}
small{color:var(--muted);font-size:12px}
.drop{border:2px dashed var(--border);border-radius:12px;background:#0a142b;padding:16px;text-align:center}
.drop.drag{background:#14224a;border-color:#7fa1ff}
.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:10px}
.item{background:#0b1428;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.thumb{width:100%;height:150px;object-fit:cover;background:#0a1022;display:block}
.meta{padding:8px 10px;font-size:12px;color:#cfe0ff;display:grid;gap:4px}
.prog-wrap{background:#0a1022;border-radius:999px;overflow:hidden;border:1px solid #1a2548}
.prog{height:8px;width:0%;background:var(--ok);transition:width .2s}
.state{font-weight:700}
.toast{position:fixed;left:50%;bottom:calc(18px + env(safe-area-inset-bottom));transform:translateX(-50%);background:#0b1223;border:1px solid var(--border);color:var(--fg);padding:10px 16px;border-radius:12px;opacity:0;transition:.22s;pointer-events:none;z-index:999}
.toast.show{opacity:1;transform:translate(-50%,-6px)}
</style>
</head>
<body>
<header class="header">
  <div class="h1">✨ Lightflow Admin Ω.11.1 — Batch Uploader</div>
  <div class="sub">등작 燈酌 DUNGZAK CESTLAVIE × Lumera · Auto Resize · WebP · Retry</div>
</header>

<nav class="admin-nav">
  <div class="bar">
    <a href="/admin/admin.html#home" data-k="home">Home</a>
    <a href="/admin/admin.html#artworks" data-k="artworks">Artworks</a>
    <a href="/admin/admin.html#dcar" data-k="dcar">DCAR</a>
    <a href="/admin/batch.html" data-k="upload">Upload</a>
    <a href="/admin/admin.html#settings" data-k="settings">Settings</a>
  </div>
</nav>

<main class="container">
  <section class="card">
    <h3>0️⃣ 연결 상태</h3>
    <div class="btnbar" style="margin-bottom:8px">
      <button class="btn-ghost" id="refresh">↻ 상태 새로고침</button>
      <button class="btn" id="test">🔗 연결 테스트</button>
    </div>
    <small>설정은 admin.html 의 localStorage 값을 사용합니다.</small>
  </section>

  <section class="card">
    <h3>1️⃣ 업로드 대상</h3>
    <div class="row">
      <div>
        <label>섹션</label>
        <select id="sec">
          <option value="light">Ⅰ Light & Memory</option>
          <option value="human">Ⅱ Human Being</option>
          <option value="rebirth">Ⅲ Rebirth of Mind</option>
          <option value="restore">Ⅳ Restoration of Being</option>
          <option value="meta">Ⅴ Metaconsciousness</option>
        </select>
      </div>
      <div>
        <label>시작 번호</label>
        <input id="start" type="number" value="1" inputmode="numeric" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <div id="drop" class="drop">📥 이미지를 드롭/탭하여 선택</div>
        <input id="files" type="file" accept="image/*" multiple style="display:none" />
        <small>자동 리사이즈: 최대 가로 1800px · WebP 변환(작을 때만)</small>
      </div>
      <div>
        <div class="btnbar">
          <button class="btn-ok" id="uploadAll">📤 일괄 업로드</button>
          <button class="btn-bad" id="clearList">🧹 목록 비우기</button>
        </div>
        <small>저장 경로: <code>/img/{section}/{id}.(webp/jpg)</code> · 메타: <code>/data/artworks.json</code></small>
      </div>
    </div>
    <div id="list" class="list"></div>
  </section>

  <section class="card">
    <h3>2️⃣ 결과</h3>
    <div>성공 <b id="sOK">0</b> · 실패 <b id="sFail">0</b> · 메시지 <span id="sMsg">—</span></div>
  </section>
</main>

<div id="toast" class="toast">Ready.</div>

<script>
/* Helpers / Nav */
const $=q=>document.querySelector(q), $$=q=>document.querySelectorAll(q);
const toast=(m,err=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=err?"#ff6b6b":"#22304f";t.classList.add("show");clearTimeout(toast._t);toast._t=setTimeout(()=>t.classList.remove("show"),1800);};
(function(){ $$(".admin-nav a").forEach(a=>a.classList.toggle("active",a.dataset.k==="upload")); })();

/* Local cfg */
const KEY="lf_admin_cfg_v101";
const readCfg=()=>{try{return JSON.parse(localStorage.getItem(KEY)||"{}")}catch{return {}}};
const cfg=k=>readCfg()[k]||"";

/* GitHub API */
async function gh(m,p,b=null,j=true){
  const t=cfg("token"); if(!t) throw Error("토큰 없음");
  const r=await fetch(`https://api.github.com/${p}`,{method:m,headers:{Accept:"application/vnd.github+json",Authorization:`token ${t}`},body:b?(j?JSON.stringify(b):b):null});
  if(!r.ok){const t=await r.text(); throw Error(`GitHub ${r.status}: ${t.slice(0,160)}`);} return r.json();
}
async function getContent(path){
  const o=cfg("owner"),r=cfg("repo"),b=cfg("branch")||"main";
  try{const j=await gh("GET",`repos/${o}/${r}/contents/${encodeURIComponent(path)}?ref=${b}`);return {sha:j.sha,content:j.content?atob(j.content.replace(/\n/g,"")):null,exists:true}}catch{return {sha:null,content:null,exists:false}}
}
async function putFile(path,b64,msg){
  const o=cfg("owner"),r=cfg("repo"),b=cfg("branch")||"main";
  const old=await getContent(path);
  const body={message:msg||`update ${path}`,content:b64,branch:b}; if(old.exists) body.sha=old.sha;
  return gh("PUT",`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body);
}

/* Artworks JSON */
let artworks={light:[],human:[],rebirth:[],restore:[],meta:[]};
async function loadArtworks(){try{const r=await getContent("data/artworks.json"); if(r.exists) artworks=JSON.parse(r.content);}catch(e){toast("artworks.json 로드 실패: "+e.message,true);}}

/* Queue UI */
let queue=[], ok=0, fail=0;
function addFiles(files){
  const sec=$("#sec").value; let n=parseInt($("#start").value||"1",10);
  [...files].forEach(f=>{
    const id=`${sec}-${String(n++).padStart(2,"0")}`;
    const el=document.createElement("div"); el.className="item";
    el.innerHTML=`<img class="thumb"><div class="meta"><div><b>${id}</b> <span style="opacity:.75">(${Math.round(f.size/1024)} KB)</span></div><div class="prog-wrap"><div class="prog"></div></div><div class="state">대기</div></div>`;
    el.querySelector(".thumb").src=URL.createObjectURL(f);
    $("#list").appendChild(el);
    queue.push({file:f,id,sec,el});
  });
  $("#start").value=String(n);
}
function clearList(){queue=[];$("#list").innerHTML="";ok=0;fail=0;$("#sOK").textContent=0;$("#sFail").textContent=0;$("#sMsg").textContent="—";}
function initDnD(){const dz=$("#drop"),fi=$("#files"); dz.onclick=()=>fi.click(); ["dragenter","dragover"].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add("drag");})); ["dragleave","drop"].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove("drag");})); dz.addEventListener("drop",e=>{if(e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files)}); fi.addEventListener("change",e=>{if(e.target.files?.length){addFiles(e.target.files);fi.value=""}});}

/* Image process: resize->webp if smaller */
async function toOptimizedB64(file){
  const blob=await new Response(file).blob(); // original
  const img=await createImageBitmap(blob).catch(async()=>{return await new Promise((res,rej)=>{const im=new Image(); im.onload=()=>{res(im)}; im.onerror=rej; im.src=URL.createObjectURL(blob);});});
  const maxW=1800;
  let w=img.width, h=img.height;
  if(w>maxW){h=Math.round(h*maxW/w); w=maxW;}
  const cvs=document.createElement("canvas"); cvs.width=w; cvs.height=h; const ctx=cvs.getContext("2d"); ctx.drawImage(img,0,0,w,h);
  const webp=await new Promise(res=>cvs.toBlob(b=>res(b),'image/webp',0.9));
  const useWebp = webp && webp.size < blob.size;
  const chosen = useWebp ? webp : blob;
  const ext = useWebp ? ".webp" : (file.name.match(/\.\w+$/)?.[0]||".jpg").toLowerCase();
  const b64 = await new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(fr.result.split(",")[1]); fr.readAsDataURL(chosen);});
  return {ext,b64};
}

/* Upload all with retry */
async function uploadAll(){
  if(!queue.length) return toast("대상 파일 없음",true);
  await loadArtworks(); ok=0; fail=0;
  for(const q of queue){
    const state=q.el.querySelector(".state"), prog=q.el.querySelector(".prog");
    try{
      state.textContent="최적화…";
      const {ext,b64}=await toOptimizedB64(q.file);
      const path=`img/${q.sec}/${q.id}${ext}`;
      state.textContent="업로드…";
      await tryPut(path,b64,3);
      prog.style.width="100%";
      // JSON 기록
      const rec={id:q.id,title:"",year:"",medium:"",size:"",image:`/${path}`};
      const arr=artworks[q.sec]||(artworks[q.sec]=[]);
      const i=arr.findIndex(x=>x.id===rec.id); if(i>=0) arr[i]=rec; else arr.push(rec);
      state.textContent="완료"; ok++; $("#sOK").textContent=ok;
    }catch(e){
      state.textContent="실패: "+e.message; prog.style.background="#ff6b6b"; fail++; $("#sFail").textContent=fail;
    }
  }
  try{
    await putFile("data/artworks.json", btoa(unescape(encodeURIComponent(JSON.stringify(artworks,null,2)))), "update artworks.json");
    $("#sMsg").textContent=`done: ${ok} ok / ${fail} fail`; toast(`완료: ${ok} / 실패 ${fail}`);
  }catch(e){ toast("JSON 저장 실패: "+e.message,true); }
}
async function tryPut(path,b64,retry){
  for(let i=0;i<retry;i++){
    try{ await putFile(path,b64,`add ${path}`); return; }
    catch(e){ if(i===retry-1) throw e; await new Promise(r=>setTimeout(r,600)); }
  }
}

/* Status / Events */
async function testConn(){ try{ await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}`); toast("연결 OK (200)"); }catch(e){ toast("연결 실패: "+e.message,true); } }
function hydrate(){ /* placeholder for future details */ }
function bindTap(sel,fn){ const el=$(sel); el.addEventListener("click",e=>{e.preventDefault();e.stopPropagation();fn();},{passive:false}); el.addEventListener("pointerup",e=>{ if(e.pointerType==="touch"){e.preventDefault();e.stopPropagation();fn();}}, {passive:false}); }
function boot(){ hydrate(); initDnD(); bindTap("#refresh",hydrate); bindTap("#test",testConn); bindTap("#uploadAll",uploadAll); bindTap("#clearList",clearList); }
window.addEventListener("error",e=>{ try{ toast("JS 오류: "+e.message,true) }catch{} });
window.addEventListener("load", boot);
</script>
</body>
</html>