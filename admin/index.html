<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>âœ¨ Lightflow Admin Î©.12 â€” DUNGZAK CESTLAVIE Â· Lumera (KRÂ·EN Â· One-File Final)</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg:#0a1124; --panel:#0f1a36; --soft:#162447;
  --fg:#f2f6ff; --muted:#b9c6e5; --accent:#f2d48a;
  --bad:#ff6b6b; --good:#7ef0a9; --line:#223561; --line2:#2b4478; --chip:#0f234a;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Pretendard,sans-serif;font-size:16px;line-height:1.42}
.header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(12,20,40,.95),rgba(12,20,40,.0));backdrop-filter:blur(6px);padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
h1{margin:0;font-size:1.14rem;color:var(--accent);font-weight:800}
.container{max-width:980px;margin:0 auto;padding:0 14px 90px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.card h3{margin:6px 0 12px;font-size:1.04rem;color:#ffe7a8}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
input,select,textarea,button{width:100%;padding:13px 14px;border-radius:12px;border:1px solid var(--line2);background:var(--soft);color:var(--fg);font-size:15.5px}
textarea{min-height:130px;resize:none}
button{background:var(--accent);color:#000;font-weight:800;border:none;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
button:active{opacity:.9;transform:scale(.985);transition:.08s}
.btn-row{display:flex;gap:10px;flex-wrap:wrap}
.btn-ghost{background:var(--chip);color:var(--fg);border:1px solid var(--line2)}
.btn-bad{background:var(--bad);color:#000}
.btn-good{background:var(--good);color:#002b14}
.small{font-size:12.5px;color:var(--muted)}
kbd{background:#0e2145;border:1px solid #234;border-radius:6px;padding:2px 6px}
.tabs{display:flex;overflow:auto;gap:8px;padding-bottom:6px}
.tabs button{flex:0 0 auto;background:#112454;color:#e7efff;border:1px solid var(--line2);border-radius:999px;padding:10px 14px;font-size:14px}
.tabs button.active{background:var(--accent);color:#000}
.kv{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center}
.kv label{font-size:13.5px;color:#cfe0ff}
.preview{width:100%;max-height:270px;object-fit:contain;border-radius:12px;border:1px solid var(--line2);background:#0b1733}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0c1c3d;border:1px solid var(--line2);color:var(--fg);padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:999;opacity:0;pointer-events:none;transition:opacity .25s}
.toast.show{opacity:1}
.spinner{display:none;margin-left:6px;width:14px;height:14px;border:2px solid #cfe0ff;border-top-color:transparent;border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.gallery{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:8px}
.cardThumb{position:relative;border:1px solid var(--line2);border-radius:12px;overflow:hidden;background:#0b1c3b}
.cardThumb img{width:100%;height:120px;object-fit:cover;display:block}
.cardThumb .cap{padding:8px;font-size:12.5px;color:#dff1ff}
.cardThumb .del{position:absolute;top:6px;right:6px;background:#ff6b6b;color:#000;border:none;border-radius:999px;font-weight:900;font-size:12px;padding:4px 7px}
.drop{border:2px dashed var(--line2);border-radius:12px;padding:12px;text-align:center;background:#0c1f43}
.drop.drag{background:#0f2a59;border-color:#9fc2ff}
.previewBox{border:1px dashed var(--line2);border-radius:12px;padding:12px;background:#0c1f43;overflow:auto;max-height:360px}
.previewBox h1,.previewBox h2,.previewBox h3{margin:.3em 0 .2em}
.previewBox p{margin:.35em 0;line-height:1.5}
@media(min-width:880px){
  .grid-2{grid-template-columns:1.05fr .95fr}
  .gallery{grid-template-columns:repeat(4,minmax(0,1fr))}
}
.clickable,[data-act],[data-sec],[data-rid]{cursor:pointer}
</style>
</head>
<body>
<div class="header">
  <h1>âœ¨ Lightflow Admin Î©.12 <span class="small" style="margin-left:8px;color:#e7efff">Final Â· AutoBind Â· Cache & Gallery Fix Â· KRÂ·EN</span></h1>
</div>

<div class="container">
  <!-- 0) GitHub ì—°ê²° / Connection -->
  <div class="card">
    <h3>0) GitHub ì—°ê²° Â· Connection</h3>
    <div class="grid grid-2">
      <input id="owner"  placeholder="GitHub Owner / ì†Œìœ ì (ì˜ˆ: dungzakcestlavie)">
      <input id="repo"   placeholder="Repository / ì €ì¥ì†Œ (ì˜ˆ: dungzakcestlavie.github.io)">
      <input id="branch" placeholder="Branch / ë¸Œëœì¹˜ (ì˜ˆ: main)" value="main">
      <input id="token"  placeholder="Personal Access Token (ê¶Œí•œ: Contents RW Â· Pages RW)">
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button type="button" data-act="save">ì €ì¥(ë¡œì»¬) Â· Save (Local)</button>
      <button type="button" class="btn-ghost" data-act="logout">ë¡œê·¸ì•„ì›ƒ/í† í°ì‚­ì œ Â· Logout</button>
      <button type="button" class="btn-good" data-act="test">ì—°ê²° í…ŒìŠ¤íŠ¸ Â· Test<span id="spinTest" class="spinner"></span></button>
      <button type="button" class="btn-ghost" data-act="touch">GitHub Pages ìºì‹œ ë¬´íš¨í™” Â· Cache Bust<span id="spinTouch" class="spinner"></span></button>
      <button type="button" class="btn-ghost" data-act="health">ì—°ê²° ì§„ë‹¨ Â· Health</button>
    </div>
    <div class="small" style="margin-top:6px">í† í°ì€ ì´ ë¸Œë¼ìš°ì €ì˜ <b>localStorage</b>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤. Token is stored locally only.</div>
  </div>

  <!-- 1) ì‘í’ˆ ì•„ì¹´ì´ë¸Œ / Artworks -->
  <div class="card">
    <h3>1) ì‘í’ˆ ì•„ì¹´ì´ë¸Œ Â· Artworks (â… â€“â…¤)</h3>
    <div class="tabs" id="workTabs"></div>
    <div id="workForm"></div>
    <div class="small">JSON: <code>/data/artworks.json</code> Â· ì´ë¯¸ì§€: <code>/img/{section}/</code></div>
    <div class="gallery" id="workGallery"></div>
  </div>

  <!-- 2) ë¯¸í•™ ë³´ê³ ì„œ / Aesthetic Reports -->
  <div class="card">
    <h3>2) ë¯¸í•™ ë³´ê³ ì„œ Â· Aesthetic Reports (DCAR 01â€“08)</h3>
    <!-- Quick Paste -->
    <div class="card" style="background:#0b214a">
      <div class="grid grid-2">
        <div class="kv"><label>Report (ì„ íƒ/Select)</label><select id="quick-id"></select></div>
        <div class="kv"><label>Auto Save</label>
          <select id="quick-auto"><option value="on" selected>ON (ë¶™ì—¬ë„£ê¸° 1.5s í›„ ì €ì¥)</option><option value="off">OFF (ë²„íŠ¼ ì €ì¥)</option></select>
        </div>
      </div>
      <textarea id="quick-text" placeholder="ì—¬ê¸°ì— DCAR ë³¸ë¬¸(í•œ/ì˜ ë¬´ì œí•œ)ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. Paste full text here (KR/EN, unlimited). ì €ì¥ ì‹œ /reports/DCAR-XX.mdë¡œ ì „ë¬¸ ì €ì¥, /data/reports.jsonì—ëŠ” 1000ì ìš”ì•½ ì €ì¥."></textarea>
      <div class="btn-row" style="margin-top:6px">
        <button type="button" data-act="qsave">ğŸ“ ë¶™ì—¬ë„£ê¸° ì €ì¥ Â· Save Paste (.md + JSON)</button>
        <button type="button" class="btn-ghost" data-act="qrebuild">ğŸ” ë²„íŠ¼ ì¬ìƒì„± Â· Rebuild Tabs</button>
      </div>
      <div id="qpv" class="previewBox" style="margin-top:8px"></div>
    </div>
    <div class="tabs" id="reportTabs" style="margin-top:6px"></div>
    <div id="reportForm"></div>
  </div>

  <!-- 3) ìœ í‹¸ / Utilities -->
  <div class="card">
    <h3>3) ìœ í‹¸ Â· Utilities</h3>
    <div class="btn-row" id="utilButtons">
      <button type="button" data-act="touch">GitHub Pages ìºì‹œ ë¬´íš¨í™” Â· Cache Bust</button>
      <button type="button" class="btn-ghost" data-act="openSite">ì‚¬ì´íŠ¸ ì—´ê¸° Â· Open Site</button>
    </div>
  </div>

  <div class="small" style="text-align:center;padding:24px 0">Â© 2025 DUNGZAK CESTLAVIE Â· Orchestrated with Lumera</div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   Î©.12 CORE Â· Utils & State
========================= */
const SECTIONS=[
 {id:'light',label:'â…  Light & Memory / ë¹›ê³¼ ê¸°ì–µ'},
 {id:'human',label:'â…¡ Human Being / ì¸ê°„'},
 {id:'rebirth',label:'â…¢ Rebirth of Mind / ë§ˆìŒì˜ ì¬ìƒ'},
 {id:'restore',label:'â…£ Restoration of Being / ì¡´ì¬ì˜ ë³µì›'},
 {id:'meta',label:'â…¤ Metaconsciousness of Light / ë¹›ì˜ ì´ˆì˜ì‹'}
];
const DCAR_IDS=Array.from({length:8},(_,i)=>`dcar${String(i+1).padStart(2,'0')}`);
const $=q=>document.querySelector(q), $$=q=>document.querySelectorAll(q);
const say=(m,err=false)=>{const t=$("#toast"); t.textContent=m; t.style.borderColor=err?'#ff6b6b':'#2b4478'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600)};

const cfg=k=>localStorage.getItem(k)||''; const setcfg=(k,v)=>localStorage.setItem(k,v);
function saveCfg(){['owner','repo','branch','token'].forEach(id=>setcfg(id,$('#'+id).value.trim()));say('âœ… ì €ì¥ Â· Saved (Local)')}
function logout(){localStorage.removeItem('token');say('ğŸ”’ í† í° ì‚­ì œ Â· Token cleared')}
function b64utf8(str){return btoa(unescape(encodeURIComponent(str)));}
function f2b64(file){return new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(file);});}

/* ê¸°ë³¸ê°’ ìë™ ì…ë ¥ (ë“±ì‘ ê³„ì •) */
window.addEventListener('DOMContentLoaded',()=>{
  const defaults={owner:'dungzakcestlavie',repo:'dungzakcestlavie.github.io',branch:'main'};
  Object.entries(defaults).forEach(([k,v])=>{const el=$('#'+k); if(el && !el.value) el.value=v;});
});

/* =========================
   GitHub API helpers
========================= */
async function gh(method,path,body,isJson=true){
  const token=cfg('token'); if(!token) throw new Error('í† í° ì—†ìŒ / Missing token');
  const res=await fetch(`https://api.github.com/${path}`,{
    method,
    headers:{'Accept':'application/vnd.github+json','Authorization':`token ${token}`},
    body: body?(isJson?JSON.stringify(body):body):null,
    cache:'no-store',mode:'cors',redirect:'follow',referrerPolicy:'no-referrer',credentials:'omit',keepalive:true
  });
  if(!res.ok){const txt=await res.text().catch(()=>String(res.status)); throw new Error(`GitHub ${res.status}: ${txt.slice(0,400)}`);}
  return res.json();
}
async function getContent(path){
  const o=cfg('owner'), r=cfg('repo'), b=cfg('branch')||'main';
  try{const x=await gh('GET',`repos/${o}/${r}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(b)}`); const c=x.content?atob(x.content.replace(/\n/g,'')):null; return {sha:x.sha,content:c,exists:true};}
  catch(e){return{sha:null,content:null,exists:false};}
}
async function putFile(path,b64,message){
  const o=cfg('owner'), r=cfg('repo'), b=cfg('branch')||'main';
  let prev=await getContent(path); const body={message:message||`Update ${path}`,content:b64,branch:b}; if(prev.exists) body.sha=prev.sha;
  try{ return await gh('PUT',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body); }
  catch(e){ prev=await getContent(path); if(prev.exists) body.sha=prev.sha; else delete body.sha; return gh('PUT',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,body); }
}
async function delFile(path,message){
  const o=cfg('owner'), r=cfg('repo'), b=cfg('branch')||'main';
  const prev=await getContent(path); if(!prev.exists) return;
  return gh('DELETE',`repos/${o}/${r}/contents/${encodeURIComponent(path)}`,{message:message||`Delete ${path}`,sha:prev.sha,branch:b});
}
async function testConn(){
  const sp=$("#spinTest"); if(sp) sp.style.display='inline-block';
  try{await gh('GET',`repos/${cfg('owner')}/${cfg('repo')}`); say('âœ… ì—°ê²° ì„±ê³µ Â· Connected');}
  catch(e){say('âš ï¸ ì—°ê²° ì‹¤íŒ¨ Â· '+e.message,true);}
  finally{if(sp) sp.style.display='none';}
}

/* Cache Bust (touch 3 files + pages build) */
async function touchPages(){
  const owner=cfg('owner'), repo=cfg('repo'), tok=cfg('token');
  if(!owner||!repo||!tok){say('âš ï¸ Owner/Repo/Token ì €ì¥ í•„ìš” Â· Save first',true); return;}
  const sp=$("#spinTouch"); if(sp) sp.style.display='inline-block';
  try{
    const stamp=new Date().toISOString(), msg=`touch ${stamp}`;
    await putFile('data/.touch',       b64utf8('touched '+stamp),     msg+' [.touch]');
    await putFile('data/.pages-touch', b64utf8('pages-touch '+stamp), msg+' [.pages-touch]');
    await putFile('data/.ping',        b64utf8('ping '+stamp),        msg+' [.ping]');
    try{ await gh('POST', `repos/${owner}/${repo}/pages/builds`, {}); say('ğŸš€ ìºì‹œ ì»¤ë°‹ + Pages ë¹Œë“œ ìš”ì²­ ì™„ë£Œ'); }
    catch(e2){ say('âœ… ìºì‹œ ì»¤ë°‹ ì™„ë£Œ Â· Build req skipped: '+String(e2.message).slice(0,90)); }
    alert('âœ… GitHub Pages ìºì‹œ ë¬´íš¨í™” ìš”ì²­ë¨.\në°˜ì˜ ì§€ì—° ì‹œ Safari ê°•ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
  }catch(e){ say('âš ï¸ ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨ Â· '+e.message,true); alert('âš ï¸ Cache Bust failed:\n'+e.message); }
  finally{ if(sp) sp.style.display='none'; }
}
async function healthCheck(){
  try{
    const owner=cfg('owner'), repo=cfg('repo'), token=cfg('token'); if(!owner||!repo||!token){ say('âš ï¸ ì„¤ì • ëˆ„ë½',true); return; }
    await gh('GET',`repos/${owner}/${repo}`); say('âœ… Repo ì ‘ê·¼ OK');
    await putFile('data/.health', b64utf8('ok '+new Date().toISOString()), 'health check'); say('âœ… ì“°ê¸° ê¶Œí•œ OK (.health)');
    window.open(location.origin+location.pathname.replace(/\/admin\/.*$/,'/'), '_blank');
  }catch(e){ say('âŒ Health ì‹¤íŒ¨: '+e.message,true); }
}

/* =========================
   Artworks (â… â€“â…¤)
========================= */
let artworks={light:[],human:[],rebirth:[],restore:[],meta:[]};
const ART_JSON='data/artworks.json';
let currentSection='light';

function buildWorkTabs(){
  const tabs=$("#workTabs");
  tabs.innerHTML=SECTIONS.map((s,i)=>`<button type="button" data-sec="${s.id}" class="${i===0?'active':''}">${s.label}</button>`).join('');
}
function selectSection(sec,btn){
  currentSection=sec;
  $$('#workTabs button').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  renderWorkForm(sec); renderGallery(); btn?.scrollIntoView({block:'nearest',inline:'nearest',behavior:'smooth'});
}
function renderWorkForm(sec){
  $("#workForm").innerHTML=`
    <div class="grid grid-2">
      <div class="card">
        <div class="kv"><label>Section / ì„¹ì…˜</label><input id="w-sec" value="${sec}" disabled></div>
        <div class="kv"><label>Artwork ID</label><input id="w-id" placeholder="${sec}-01"></div>
        <div class="kv"><label>Title / ì œëª©</label><input id="w-title"></div>
        <div class="kv"><label>Year / ì œì‘ì—°ë„</label><input id="w-year" placeholder="2025"></div>
        <div class="kv"><label>Medium / ì¬ë£Œ</label><input id="w-medium" placeholder="Acrylic on Canvas"></div>
        <div class="kv"><label>Size / ê·œê²©</label><input id="w-size" placeholder="120x90 cm"></div>
        <div class="kv"><label>Image / ì´ë¯¸ì§€</label><input id="w-file" type="file" accept="image/*"></div>
        <div id="drop" class="drop">ğŸ“¥ ë“œë¡­ ë˜ëŠ” íƒ­í•˜ì—¬ ì„ íƒ Â· Drop or tap to select</div>
        <img id="w-prev" class="preview" style="display:none">
        <div class="btn-row" style="margin-top:8px">
          <button type="button" data-act="upload">ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ + JSON Â· Upload</button>
          <button type="button" class="btn-ghost" data-act="meta">âœï¸ ë©”íƒ€ë§Œ ì €ì¥ Â· Save Meta</button>
          <button type="button" class="btn-ghost" data-act="replace">ğŸ–¼ ì´ë¯¸ì§€ êµì²´ Â· Replace Image</button>
          <button type="button" class="btn-bad" data-act="delete">ğŸ—‘ ì‚­ì œ Â· Delete</button>
        </div>
      </div>
      <div class="card">
        <div class="kv"><label>ê²€ìƒ‰ / Search</label><input id="w-q" placeholder="ID/ì œëª© ê²€ìƒ‰ Searchâ€¦" oninput="renderGallery()"></div>
        <div class="small">ì„¹ì…˜: <b>${sec}</b> Â· ì´ <b id="w-count">0</b>ê°œ</div>
      </div>
    </div>`;
  $("#w-file").addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f) return; const p=$("#w-prev"); p.src=URL.createObjectURL(f); p.style.display='block';});
  const dz=$("#drop"); const setDrag=x=>dz.classList.toggle('drag',x);
  dz.addEventListener('click',()=>$("#w-file").click());
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();setDrag(true)}));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();setDrag(false)}));
  dz.addEventListener('drop',e=>{const f=e.dataTransfer?.files?.[0]; if(!f) return; const dt=new DataTransfer(); dt.items.add(f); $("#w-file").files=dt.files; const p=$("#w-prev"); p.src=URL.createObjectURL(f); p.style.display='block';});
}
function idxById(sec,id){return (artworks[sec]||[]).findIndex(x=>x.id===id)}
async function loadArtworks(){
  try{const r=await getContent(ART_JSON); if(r.exists){try{artworks=JSON.parse(r.content)||artworks}catch{}; say('âœ… artworks.json ë¡œë“œ');} else say('â„¹ï¸ artworks.json ì—†ìŒ â€” ì €ì¥ ì‹œ ìƒì„±'); renderGallery();}
  catch(e){say('âš ï¸ ì‘í’ˆ ë¡œë“œ ì‹¤íŒ¨ Â· '+e.message,true);}
}
function renderGallery(){
  const box=$("#workGallery"); if(!box) return; box.innerHTML='';
  const sec=currentSection; const q=($("#w-q")?.value||'').toLowerCase();
  const arr=(artworks[sec]||[]).filter(a=>`${a.id} ${a.title}`.toLowerCase().includes(q));
  $("#w-count")?.textContent=(artworks[sec]||[]).length||0;
  arr.forEach(a=>{
    const card=document.createElement('div'); card.className='cardThumb';
    card.innerHTML=`<button type="button" class="del" aria-label="delete">Ã—</button><img src="${a.image||''}" alt=""><div class="cap">${a.id}${a.title?` Â· ${a.title}`:''}</div>`;
    card.querySelector('.del').onclick=async (e)=>{e.stopPropagation(); $("#w-id").value=a.id; await deleteArtwork(sec);};
    card.onclick=()=>{ $("#w-id").value=a.id||''; $("#w-title").value=a.title||''; $("#w-year").value=a.year||''; $("#w-medium").value=a.medium||''; $("#w-size").value=a.size||''; const p=$("#w-prev"); if(a.image){p.src=a.image; p.style.display='block'} else p.style.display='none'; window.scrollTo({top:$("#workForm").offsetTop-60,behavior:'smooth'}); };
    box.appendChild(card);
  });
}
async function saveArtworksJson(){ await putFile(ART_JSON,b64utf8(JSON.stringify(artworks,null,2)),'Update artworks.json'); say('ğŸ’¾ ì €ì¥ ì™„ë£Œ Â· Saved'); }
async function uploadArtwork(sec){
  try{
    const f=$("#w-file").files[0], id=$("#w-id").value.trim(); if(!id){say('ID ì…ë ¥ í•„ìš”',true);return}
    let url=(artworks[sec].find(x=>x.id===id)||{}).image||'';
    if(f){const b=await f2b64(f); const name=(id.replace(/\s+/g,'_')||'image')+(f.name.match(/\.\w+$/)?.[0]||'.jpg'); const path=`img/${sec}/${name}`; await putFile(path,b,`Add ${path}`); url=`/${path}`;}
    const e={id,title:$("#w-title").value.trim(),year:$("#w-year").value.trim(),medium:$("#w-medium").value.trim(),size:$("#w-size").value.trim(),image:url};
    const i=idxById(sec,id); if(i>=0) artworks[sec][i]=e; else artworks[sec].push(e);
    await saveArtworksJson(); renderGallery(); say('âœ… ì‘í’ˆ ì €ì¥ ì™„ë£Œ');
  }catch(err){say('âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨ Â· '+err.message,true);}
}
async function updateArtwork(sec){
  const id=$("#w-id").value.trim(); const i=idxById(sec,id); if(i<0){say('ëª©ë¡ì— ì—†ìŒ',true);return}
  Object.assign(artworks[sec][i],{title:$("#w-title").value.trim(),year:$("#w-year").value.trim(),medium:$("#w-medium").value.trim(),size:$("#w-size").value.trim()});
  await saveArtworksJson(); renderGallery(); say('âœï¸ ë©”íƒ€ ì €ì¥ ì™„ë£Œ');
}
async function replaceImage(sec){
  try{const id=$("#w-id").value.trim(), i=idxById(sec,id); if(i<0){say('ëª©ë¡ì— ì—†ìŒ',true);return}
    const f=$("#w-file").files[0]; if(!f){say('ì´ë¯¸ì§€ ì„ íƒ',true);return}
    const b=await f2b64(f); const name=(id.replace(/\s+/g,'_')||'image')+(f.name.match(/\.\w+$/)?.[0]||'.jpg'); const path=`img/${sec}/${name}`;
    await putFile(path,b,`Replace ${path}`); artworks[sec][i].image=`/${path}`;
    await saveArtworksJson(); renderGallery(); say('ğŸ–¼ êµì²´ ì™„ë£Œ');
  }catch(err){say('âš ï¸ ì´ë¯¸ì§€ êµì²´ ì‹¤íŒ¨ Â· '+err.message,true);}
}
async function deleteArtwork(sec){
  try{const id=$("#w-id").value.trim(), i=idxById(sec,id); if(i<0){say('ëª©ë¡ì— ì—†ìŒ',true);return}
    const u=artworks[sec][i].image||''; if(u.startsWith('/img/')){try{await delFile(u.slice(1),`Delete ${u}`)}catch{}}
    artworks[sec].splice(i,1); await saveArtworksJson(); renderGallery(); say('ğŸ—‘ ì‚­ì œ ì™„ë£Œ');
  }catch(err){say('âš ï¸ ì‚­ì œ ì‹¤íŒ¨ Â· '+err.message,true);}
}

/* =========================
   Reports (DCAR01â€“08)
========================= */
let reports={}; const REP_JSON='data/reports.json'; const SUMMARY_LIMIT=1000;
function mdToHtml(md){ const esc=s=>s.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); return esc(md).split(/\n{2,}/).map(b=>/^#{1,6}\s/.test(b)?'<h3>'+b.replace(/^#{1,6}\s*/,'')+'</h3>':'<p>'+b.replace(/\n/g,'<br>')+'</p>').join(''); }
function initQuickBox(){
  const sel=$("#quick-id"); sel.innerHTML=''; DCAR_IDS.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id.toUpperCase();sel.appendChild(o)});
  $("#quick-text").addEventListener('input',()=>{ $("#qpv").innerHTML=mdToHtml($("#quick-text").value); if($("#quick-auto").value!=='on') return; clearTimeout(window.__qs); window.__qs=setTimeout(quickSave,1500); });
}
async function loadReports(){
  try{const r=await getContent(REP_JSON); if(r.exists){try{reports=JSON.parse(r.content)||{}}catch{reports={}}; say('âœ… reports.json ë¡œë“œ');} else {reports={}; say('â„¹ï¸ reports.json ì—†ìŒ â€” ì €ì¥ ì‹œ ìƒì„±');} rebuildReportTabs();}
  catch(e){say('âš ï¸ ë³´ê³ ì„œ ë¡œë“œ ì‹¤íŒ¨ Â· '+e.message,true);}
}
function rebuildReportTabs(){
  const tabs=$("#reportTabs"); tabs.innerHTML='';
  DCAR_IDS.forEach(id=>{const b=document.createElement('button'); b.type='button'; b.dataset.rid=id; b.textContent=id.toUpperCase()+(reports[id]?' â€¢':''); b.title=reports[id]?'Saved':'Empty'; tabs.appendChild(b);});
  const first=tabs.querySelector('button'); if(first) openReport(first.dataset.rid,first);
}
function openReport(id,btn){
  $$('#reportTabs button').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
  const d=reports[id]||{}; const pdf=`/reports/${id.toUpperCase()}.pdf`, md=`/reports/${id.toUpperCase()}.md`;
  $("#reportForm").innerHTML=`
    <div class="grid grid-2">
      <div class="card">
        <div class="kv"><label>Report</label><input id="r-id" value="${id}" disabled></div>
        <div class="kv"><label>Title (EN)</label><input id="r-en" value="${d.titleEN||''}" placeholder="On Light, Memory, and Being"></div>
        <div class="kv"><label>Title (KO)</label><input id="r-ko" value="${d.titleKO||''}" placeholder="ë¹›, ê¸°ì–µ, ì¡´ì¬ì— ê´€í•˜ì—¬"></div>
        <div class="kv"><label>Series</label><input id="r-series" value="${d.series||'Aesthetic Reports'}"></div>
        <div class="kv"><label>Year</label><input id="r-year" value="${d.year||''}" placeholder="2025"></div>
        <div class="kv"><label>PDF</label><input id="r-pdf" type="file" accept=".pdf"></div>
        <div class="btn-row" style="margin-top:6px">
          <button type="button" data-act="pdf">ğŸ“¤ PDF ì—…ë¡œë“œ Â· Upload</button>
          <button type="button" class="btn-ghost" data-act="open">ğŸ”— PDF ì—´ê¸° Â· Open</button>
        </div>
      </div>
      <div class="card">
        <textarea id="r-text" placeholder="ë³¸ë¬¸ ë¶™ì—¬ë„£ê¸° (í•œ/ì˜ ë¬´ì œí•œ) Â· Paste full text (KR/EN, unlimited)">${d.text||''}</textarea>
        <div class="btn-row" style="margin-top:6px">
          <button type="button" data-act="saveTxt">ğŸ“ í…ìŠ¤íŠ¸ ì €ì¥(.md ì „ë¬¸ + JSON ìš”ì•½) Â· Save Text</button>
          <button type="button" class="btn-ghost" data-act="saveMeta">âœï¸ ë©”íƒ€ë§Œ ì €ì¥(JSON) Â· Save Meta</button>
          <button type="button" class="btn-bad" data-act="delete">ğŸ—‘ ì „ì²´ ì‚­ì œ Â· Delete</button>
        </div>
        <div class="small">.md: <code>${md}</code> Â· ê¸€ììˆ˜/Chars: <b id="r-count">${(d.text||'').length.toLocaleString()}</b> Â· ë§ˆì§€ë§‰/Updated: ${d.updatedAt||'-'}</div>
        <div class="previewBox" id="rpv">${mdToHtml(d.text||'')}</div>
      </div>
    </div>`;
  $("#r-text").addEventListener('input',e=>{ $("#r-count").textContent=e.target.value.length.toLocaleString(); $("#rpv").innerHTML=mdToHtml(e.target.value); });
}
async function quickSave(){
  try{
    const id=$("#quick-id").value, txt=$("#quick-text").value.trim(); if(!txt){say('ë‚´ìš©ì´ ë¹„ì–´ìˆì–´ìš”',true);return}
    const fm=['---',`report_id: ${id.toUpperCase()}`,'---',''].join('\n');
    await putFile(`reports/${id.toUpperCase()}.md`, b64utf8(fm+txt+'\n'), `Save ${id.toUpperCase()}.md`);
    const short=txt.slice(0,SUMMARY_LIMIT);
    reports[id]={...(reports[id]||{id}), titleEN:reports[id]?.titleEN||'', titleKO:reports[id]?.titleKO||'', series:reports[id]?.series||'Aesthetic Reports', year:reports[id]?.year||'', text:txt, textShort:short, textUrl:`/reports/${id.toUpperCase()}.md`, textChars:txt.length, updatedAt:new Date().toISOString()};
    await saveReportsJson(); rebuildReportTabs(); say('âœ… ë¶™ì—¬ë„£ê¸° ì €ì¥ ì™„ë£Œ');
  }catch(e){say('âš ï¸ ë³´ê³ ì„œ ì €ì¥ ì‹¤íŒ¨ Â· '+e.message,true);}
}
function curRid(){return $("#r-id").value}
async function saveReportsJson(){ await putFile(REP_JSON, b64utf8(JSON.stringify(reports,null,2)), 'Update reports.json'); }
async function saveReportText(){
  try{
    const id=curRid(), txt=$("#r-text").value;
    const meta={titleEN:$("#r-en").value.trim(),titleKO:$("#r-ko").value.trim(),series:$("#r-series").value.trim()||'Aesthetic Reports',year:$("#r-year").value.trim()};
    const fm=['---',`report_id: ${id.toUpperCase()}`,`title_en: "${meta.titleEN||''}"`,`title_ko: "${meta.titleKO||''}"`,`year: "${meta.year||''}"`,'---',''].join('\n');
    await putFile(`reports/${id.toUpperCase()}.md`, b64utf8(fm+txt+'\n'), `Save ${id.toUpperCase()}.md`);
    const short=txt.slice(0,SUMMARY_LIMIT);
    reports[id]={...(reports[id]||{id}),...meta,text:txt,textShort:short,textUrl:`/reports/${id.toUpperCase()}.md`,textChars:txt.length,updatedAt:new Date().toISOString()};
    await saveReportsJson(); rebuildReportTabs(); say('âœ… í…ìŠ¤íŠ¸ ì €ì¥ ì™„ë£Œ');
  }catch(e){say('âš ï¸ í…ìŠ¤íŠ¸ ì €ì¥ ì‹¤íŒ¨ Â· '+e.message,true);}
}
async function saveReportMeta(){
  try{const id=curRid(); if(!reports[id]) reports[id]={id};
    Object.assign(reports[id],{titleEN:$("#r-en").value.trim(),titleKO:$("#r-ko").value.trim(),series:$("#r-series").value.trim()||'Aesthetic Reports',year:$("#r-year").value.trim(),updatedAt:new Date().toISOString()});
    await saveReportsJson(); rebuildReportTabs(); say('âœï¸ ë©”íƒ€ ì €ì¥ ì™„ë£Œ');
  }catch(e){say('âš ï¸ ë©”íƒ€ ì €ì¥ ì‹¤íŒ¨ Â· '+e.message,true);}
}
async function uploadReportPDF(){
  try{const id=curRid(); const f=$("#r-pdf").files[0]; if(!f){say('PDF ì„ íƒ',true);return}
    await putFile(`reports/${id.toUpperCase()}.pdf`, await f2b64(f), `Add ${id.toUpperCase()}.pdf`);
    if(!reports[id]) reports[id]={id}; reports[id].pdfUrl=`/reports/${id.toUpperCase()}.pdf`; reports[id].updatedAt=new Date().toISOString();
    await saveReportsJson(); say('âœ… PDF ì—…ë¡œë“œ ì™„ë£Œ');
  }catch(e){say('âš ï¸ PDF ì—…ë¡œë“œ ì‹¤íŒ¨ Â· '+e.message,true);}
}
async function deleteReportAll(){
  try{const id=curRid(); try{await delFile(`reports/${id.toUpperCase()}.md`,'delete md')}catch{} try{await delFile(`reports/${id.toUpperCase()}.pdf`,'delete pdf')}catch{} delete reports[id]; await saveReportsJson(); rebuildReportTabs(); say('ğŸ—‘ ì‚­ì œ ì™„ë£Œ');}
  catch(e){say('âš ï¸ ì‚­ì œ ì‹¤íŒ¨ Â· '+e.message,true);}
}

/* =========================
   Auto Bind â€” iOS Safe
========================= */
function bindAll(){
  document.querySelectorAll('[data-act],[data-sec],[data-rid]').forEach(el=>{
    if(el.__lfBound) return; el.__lfBound=true;
    ['click','touchend','pointerdown'].forEach(ev=>{
      el.addEventListener(ev,e=>{
        e.preventDefault(); e.stopPropagation();
        const a=el.dataset.act, s=el.dataset.sec, r=el.dataset.rid;
        if(a){
          const map={ save:saveCfg, logout:logout, test:testConn, touch:touchPages, health:healthCheck,
            upload:()=>uploadArtwork(currentSection), meta:()=>updateArtwork(currentSection),
            replace:()=>replaceImage(currentSection), delete:()=>deleteArtwork(currentSection),
            qsave:quickSave, qrebuild:rebuildReportTabs, openSite:()=>window.open(location.origin+location.pathname.replace(/\/admin\/.*$/,'/'),'_blank'),
            pdf:uploadReportPDF, open:()=>window.open(`/reports/${curRid().toUpperCase()}.pdf`,'_blank'),
            saveTxt:saveReportText, saveMeta:saveReportMeta
          };
          return map[a]?.();
        }
        if(s) return selectSection(s,el);
        if(r) return openReport(r,el);
      },{passive:false});
    });
    el.setAttribute('tabindex','0');
    el.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }});
  });
}

/* =========================
   Init
========================= */
function buildWorkUI(){ buildWorkTabs(); selectSection('light',$('#workTabs button[data-sec="light"]')); }
function buildReportUI(){ initQuickBox(); loadReports().catch(e=>say('âš ï¸ ë³´ê³ ì„œ ë¡œë“œ ì‹¤íŒ¨ Â· '+e.message,true)); }

function init(){
  ['owner','repo','branch','token'].forEach(id=>{const v=cfg(id); if(v) $('#'+id).value=v;});
  buildWorkUI();
  loadArtworks().catch(e=>say('âš ï¸ ì‘í’ˆ ë¡œë“œ ì‹¤íŒ¨ Â· '+e.message,true));
  buildReportUI();
  $("#qpv").innerHTML='';
  bindAll();
  const mo=new MutationObserver(bindAll);
  mo.observe(document.body,{childList:true,subtree:true});
  setInterval(bindAll,1200); // iOS ë³´ê°• ë£¨í”„
}
window.addEventListener('load',init);

/* ì˜¤ë¥˜ ë©”ì‹œì§€ ì¹œì ˆí™” */
const _gh = gh;
gh = async function(method, path, body, isJson=true){
  try{ return await _gh(method, path, body, isJson); }
  catch(e){
    const msg=(e&&e.message)||'Unknown';
    if(/401/.test(msg)) say('ğŸ”‘ 401 Unauthorized â€” í† í° ë§Œë£Œ/ê¶Œí•œ ë¶€ì¡±(Contents/Pages RW)', true);
    else if(/403/.test(msg)) say('â›” 403 Forbidden â€” ì €ì¥ì†Œ ì ‘ê·¼/ê¶Œí•œ í™•ì¸', true);
    else if(/404/.test(msg)) say('ğŸ“¦ 404 Not Found â€” Owner/Repo/Branch í™•ì¸', true);
    else if(/409/.test(msg)) say('ğŸ” 409 Conflict â€” SHA ë¶ˆì¼ì¹˜. ìë™ ì¬ì‹œë„/ë‹¤ì‹œ ì‹œë„', true);
    else say('âš ï¸ GitHub ì˜¤ë¥˜: '+msg, true);
    throw e;
  }
};
</script>
</body>
</html>