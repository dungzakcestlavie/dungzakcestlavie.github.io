<!-- ==========================================================
Lightflow ∮27 — ADMIN Ω (Works / Reports JSON Manager)
① HEAD / STYLE
② BODY / HTML
③ SCRIPTS
========================================================== -->
<!doctype html>
<html lang="ko">

<!-- ==========================================================
① HEAD / STYLE  (Index ∮27 디자인에 맞춘 Admin)
========================================================== -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#070A14" />
  <meta name="format-detection" content="telephone=no,address=no,email=no" />

  <title>등작 燈酌 DUNGZAK CESTLAVIE ∮27 · Admin Ω</title>
  <meta name="description" content="LIGHTFLOW · LIGHT · MEMORY · BEING — Admin Ω · Works & DCAR JSON Manager" />

  <link rel="canonical" href="https://dungzak.art/" />

  <!-- OG / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="등작 ∮27 · Admin Ω" />
  <meta property="og:description" content="Works / DCAR Reports JSON Manager" />
  <meta property="og:url" content="https://dungzak.art/admin.html" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Google Translate bar 차단 -->
  <meta name="google" content="notranslate" />
  <meta name="googlebot" content="notranslate" />

  <style>
    /* =========================================================
       Base / Reset — index와 동일 팔레트
    ========================================================= */
    :root{
      --bg0:#050812;
      --bg1:#070A14;
      --bg2:#0A1022;

      --gold:#D7B86A;
      --gold2:#E9D59B;
      --blue:#79A7FF;

      --ink:#EDE3C9;
      --muted:rgba(237,227,201,.72);
      --muted2:rgba(237,227,201,.55);

      --card:rgba(255,255,255,.035);
      --card2:rgba(255,255,255,.055);
      --line:rgba(215,184,106,.22);
      --line2:rgba(121,167,255,.18);

      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --shadow2: 0 10px 26px rgba(0,0,0,.35);
      --r:18px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);

      --maxw: 1200px;

      --gold-edge: rgba(0,0,0,.70);
      --gold-edge2: rgba(0,0,0,.42);

      --btnH: 40px;
      --btnPadX: 12px;
      --btnFont: 12.6px;
      --btnRadius: 999px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 50% 0%, rgba(215,184,106,.10), rgba(121,167,255,.06) 40%, rgba(0,0,0,0) 72%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 65%, #03040A);
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      letter-spacing:.2px;
      overflow-x:hidden;
    }

    header, main, footer{
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
    }

    a{ color:var(--gold2); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    img{ max-width:100%; display:block; }

    /* =========================================================
       Waves canvas (index와 동일)
    ========================================================= */
    #waves{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
      z-index:-2;
      pointer-events:none;
      opacity:1;
    }

    /* =========================================================
       Header / Nav (Admin)
    ========================================================= */
    header{
      position:sticky;
      top:0;
      z-index:20;
      padding-top: calc(10px + var(--safe-top));
      padding-bottom: 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(5,8,18,.94), rgba(5,8,18,.70));
      border-bottom:1px solid rgba(215,184,106,.22);
    }
    header .brand,
    header .brand-sub{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 0 18px;
    }
    header .brand{
      text-align:center;
      font-weight: 900;
      color: var(--gold2);
      letter-spacing: .78px;
      font-size: 15px;
      line-height: 1.25;
      -webkit-text-stroke: .35px rgba(0,0,0,.35);
      text-shadow:
        0 1px 0 var(--gold-edge),
        0 -1px 0 var(--gold-edge2);
    }
    header .brand-sub{
      margin-top: 4px;
      font-size: 12px;
      letter-spacing: .34px;
      color: rgba(237,227,201,.78);
      text-shadow: 0 1px 0 rgba(0,0,0,.55);
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand-sub-left{
      opacity:.92;
    }
    .brand-sub-right a{
      font-size: 11.4px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(215,184,106,.35);
      background: rgba(255,255,255,.02);
      box-shadow: 0 8px 18px rgba(0,0,0,.30);
      text-shadow: 0 1px 0 rgba(0,0,0,.60);
    }

    nav.admin-nav{
      max-width: var(--maxw);
      margin: 12px auto 0;
      padding: 0 18px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
    }
    nav.admin-nav button{
      appearance:none;
      border: 1px solid rgba(215,184,106,.30);
      background: rgba(255,255,255,.028);
      color: var(--gold2);
      padding: 8px var(--btnPadX);
      border-radius: var(--btnRadius);
      font-weight: 900;
      font-size: var(--btnFont);
      cursor:pointer;
      min-height: var(--btnH);
      box-shadow: 0 8px 18px rgba(0,0,0,.28);
      text-shadow: 0 1px 0 rgba(0,0,0,.64);
      touch-action: manipulation;
      transition: transform .06s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    nav.admin-nav button:hover{
      background: rgba(215,184,106,.08);
      border-color: rgba(215,184,106,.52);
      box-shadow: 0 10px 24px rgba(0,0,0,.36);
    }
    nav.admin-nav button.active{
      background: rgba(215,184,106,.12);
      border-color: rgba(215,184,106,.78);
      box-shadow: 0 12px 28px rgba(0,0,0,.40);
    }
    nav.admin-nav button:active{
      transform: translateY(1px);
    }

    /* =========================================================
       Main Layout (Admin)
    ========================================================= */
    main{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 18px 18px calc(24px + var(--safe-bot));
    }
    .admin-section{
      display:none;
      margin-bottom: 18px;
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.04);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
    }
    .admin-section.active{
      display:block;
    }
    .admin-section h2{
      margin: 0 0 8px;
      font-size: 16px;
      color: var(--gold2);
      -webkit-text-stroke: .25px rgba(0,0,0,.28);
      text-shadow: 0 1px 0 rgba(0,0,0,.62);
    }
    .admin-section .desc{
      margin: 4px 0 12px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.6;
    }

    /* Controls row */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .toolbar select,
    .toolbar input[type="text"]{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(121,167,255,.26);
      background: rgba(0,0,0,.40);
      color: var(--ink);
      font-size:12px;
      min-height: 34px;
    }
    .toolbar button{
      appearance:none;
      border-radius:999px;
      border:1px solid rgba(215,184,106,.40);
      background: rgba(215,184,106,.10);
      color:var(--gold2);
      font-size:12px;
      padding:7px 12px;
      min-height: 34px;
      cursor:pointer;
      font-weight:900;
      text-shadow: 0 1px 0 rgba(0,0,0,.60);
      box-shadow: 0 8px 18px rgba(0,0,0,.30);
      touch-action:manipulation;
    }
    .toolbar button.danger{
      border-color: rgba(255,120,120,.70);
      color:#ffdddd;
    }
    .toolbar button.secondary{
      border-color: rgba(121,167,255,.45);
      background: rgba(121,167,255,.12);
      color:#eaf1ff;
    }

    /* Small label */
    .hint{
      font-size:11px;
      color:var(--muted2);
      margin-top:2px;
    }

    /* =========================================================
       Works Table
    ========================================================= */
    .table-wrap{
      margin-top: 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.05);
      background: rgba(0,0,0,.35);
      overflow:auto;
      max-height: 60vh;
      -webkit-overflow-scrolling:touch;
    }
    table.admin-table{
      width:100%;
      border-collapse:collapse;
      font-size:11.5px;
      min-width: 900px;
    }
    table.admin-table thead{
      position:sticky;
      top:0;
      background: linear-gradient(180deg, rgba(10,16,34,.95), rgba(5,8,18,.98));
      z-index:1;
    }
    table.admin-table th,
    table.admin-table td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:6px 6px;
      text-align:left;
      vertical-align:top;
      color:rgba(237,227,201,.85);
    }
    table.admin-table th{
      font-weight:700;
      color:var(--gold2);
      white-space:nowrap;
      text-shadow: 0 1px 0 rgba(0,0,0,.65);
    }
    table.admin-table tr:nth-child(even) td{
      background: rgba(255,255,255,.02);
    }
    table.admin-table tr.selected td{
      background: rgba(121,167,255,.16);
    }

    table.admin-table input[type="text"],
    table.admin-table textarea,
    table.admin-table select{
      width:100%;
      box-sizing:border-box;
      border-radius:6px;
      border:1px solid rgba(121,167,255,.26);
      background: rgba(0,0,0,.60);
      color:var(--ink);
      font-size:11px;
      padding:4px 5px;
      resize:vertical;
    }
    table.admin-table textarea{
      min-height:40px;
      max-height:120px;
    }

    .col-narrow{
      width:50px;
    }
    .col-medium{
      width:110px;
    }

    /* =========================================================
       Reports textarea
    ========================================================= */
    .split{
      display:grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 4fr);
      gap:12px;
      margin-top: 8px;
    }
    @media (max-width: 900px){
      .split{
        grid-template-columns: 1fr;
      }
    }
    .field-group{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.35);
      padding:10px 12px;
    }
    .field-group h3{
      margin:0 0 6px;
      font-size:13px;
      color:var(--gold2);
    }
    .field-group label{
      display:block;
      margin-top:6px;
      font-size:11.5px;
      color:var(--muted);
    }
    .field-group input[type="text"],
    .field-group select{
      width:100%;
      padding:5px 7px;
      border-radius:8px;
      border:1px solid rgba(121,167,255,.26);
      background: rgba(0,0,0,.60);
      color:var(--ink);
      font-size:11.5px;
      min-height: 32px;
      box-sizing:border-box;
    }
    .field-group textarea{
      width:100%;
      padding:6px 7px;
      border-radius:8px;
      border:1px solid rgba(121,167,255,.26);
      background: rgba(0,0,0,.60);
      color:var(--ink);
      font-size:11.5px;
      resize:vertical;
      min-height:80px;
      box-sizing:border-box;
    }

    /* =========================================================
       Footer
    ========================================================= */
    footer{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 10px 18px calc(16px + var(--safe-bot));
      font-size:11px;
      color:var(--muted2);
      text-align:center;
    }
    footer small{
      display:block;
      margin-top:4px;
    }

    /* =========================================================
       Reduced motion
    ========================================================= */
    @media (prefers-reduced-motion: reduce){
      *{
        scroll-behavior:auto !important;
        transition:none !important;
        animation:none !important;
      }
    }
  </style>
</head>

<!-- ==========================================================
② BODY / HTML  (Admin 전용 · 데이터 편집 뷰)
========================================================== -->
<body>
  <!-- BACKGROUND -->
  <canvas id="waves" aria-hidden="true"></canvas>

  <!-- HEADER -->
  <header>
    <div class="brand">등작 燈酌 DUNGZAK CESTLAVIE ∮27 · Admin Ω</div>
    <div class="brand-sub">
      <span class="brand-sub-left">Works / DCAR Reports JSON Manager · (local에서 편집 후 JSON 다운로드 → GitHub에 업로드)</span>
      <span class="brand-sub-right">
        <a href="index.html" target="_blank" rel="noopener">Open index (View Site)</a>
      </span>
    </div>

    <nav class="admin-nav" aria-label="Admin Navigation">
      <button type="button" data-admin-target="works" class="active">Works Manager</button>
      <button type="button" data-admin-target="reports">Reports Manager (DCAR)</button>
      <button type="button" data-admin-target="tools">JSON Tools</button>
    </nav>
  </header>

  <!-- MAIN -->
  <main>
    <!-- 1) WORKS MANAGER -->
    <section id="admin-works" class="admin-section active">
      <h2>Works Manager · 작품 아카이브 JSON</h2>
      <p class="desc">
        <span class="ko">
          data/works.json을 불러와 섹션별로 편집합니다. 행을 수정하면 메모리 상에서 즉시 반영되며, 완료 후 "works.json 다운로드" 버튼으로 새 JSON 파일을 내려받아 GitHub에 업로드してください.
        </span>
      </p>

      <div class="toolbar">
        <label>
          <select id="worksSectionFilter">
            <option value="all">섹션 전체 보기 (All Sections)</option>
            <option value="pray">Ⅰ 우리를 위해 기도해 주세요 · Pray for Us</option>
            <option value="human">Ⅱ 인간 · Human Being</option>
            <option value="rebirth">Ⅲ 정신의 재탄생 · Rebirth of Mind</option>
            <option value="exist">Ⅳ 존재의 회복 · Restoration of Being</option>
            <option value="cosmos">Ⅴ 빛의 초의식 · Metaconsciousness of Light</option>
          </select>
        </label>

        <button type="button" id="btnAddWork">행 추가 (Add Row)</button>
        <button type="button" id="btnDeleteSelectedWork" class="danger">선택 행 삭제 (Delete Selected)</button>
        <button type="button" id="btnDownloadWorks" class="secondary">works.json 다운로드</button>
      </div>
      <div class="hint">
        * material_en은 자동으로 소문자로 정리됩니다. 이미지 경로는 <code>/images/standard/DZ-xxx.jpg</code> / <code>/images/zoom/DZ-xxx.jpg</code> 형식 권장.
      </div>

      <div class="table-wrap">
        <table class="admin-table" id="worksTable">
          <thead>
            <tr>
              <th class="col-narrow">선택</th>
              <th class="col-medium">섹션</th>
              <th>ID</th>
              <th>제목 (KR)</th>
              <th>Title (EN)</th>
              <th>재료 (KR)</th>
              <th>material_en</th>
              <th>크기 (KR)</th>
              <th>size_en</th>
              <th class="col-medium">연도</th>
              <th>image (standard)</th>
              <th>zoom (optional)</th>
            </tr>
          </thead>
          <tbody id="worksTableBody">
          </tbody>
        </table>
      </div>
    </section>

    <!-- 2) REPORTS MANAGER -->
    <section id="admin-reports" class="admin-section">
      <h2>Reports Manager · DCAR / 미학 보고서 JSON</h2>
      <p class="desc">
        <span class="ko">
          data/reports.json을 불러와 DCAR 시리즈를 관리합니다. 좌측 목록에서 보고서 선택 → 우측에서 내용 수정 후 저장 버튼으로 메모리 반영, 마지막에 "reports.json 다운로드"로 새 JSON 파일을 내려받아 GitHub에 업로드하십시오.
        </span>
      </p>

      <div class="toolbar">
        <button type="button" id="btnAddReport">보고서 추가 (Add Report)</button>
        <button type="button" id="btnDeleteReport" class="danger">선택 보고서 삭제</button>
        <button type="button" id="btnDownloadReports" class="secondary">reports.json 다운로드</button>
      </div>
      <div class="hint">
        * DCAR-09 ~ DCAR-13은 이미 확정된 축이므로 ID / 제목을 변경하지 않도록 주의. 요약(summary_ko / summary_en)은 길게 작성해도 됩니다.
      </div>

      <div class="split">
        <!-- Left: list -->
        <div class="field-group">
          <h3>보고서 목록 (Reports List)</h3>
          <div id="reportList" style="max-height:52vh;overflow:auto;-webkit-overflow-scrolling:touch;">
            <!-- JS로 채움 -->
          </div>
        </div>

        <!-- Right: editor -->
        <div class="field-group">
          <h3>선택한 보고서 편집 (Edit Selected Report)</h3>

          <label>
            ID
            <input type="text" id="r_id" />
          </label>
          <label>
            연도 (year)
            <input type="text" id="r_year" />
          </label>
          <label>
            카테고리 (category) — theory / archive / practice
            <input type="text" id="r_category" />
          </label>
          <label>
            제목 (KO)
            <input type="text" id="r_title_ko" />
          </label>
          <label>
            Title (EN)
            <input type="text" id="r_title_en" />
          </label>
          <label>
            요약 (summary_ko)
            <textarea id="r_summary_ko"></textarea>
          </label>
          <label>
            Summary (summary_en)
            <textarea id="r_summary_en"></textarea>
          </label>
          <label>
            md_path (또는 URL) — 예: reports/DCAR-09-2025.md
            <input type="text" id="r_md_path" />
          </label>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" id="btnSaveReport">현재 보고서 변경사항 저장</button>
            <span class="hint">* 저장 버튼은 메모리 내 배열에 반영합니다. 최종적으로 reports.json을 다운로드해야 GitHub에 업로드할 수 있습니다.</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 3) JSON TOOLS -->
    <section id="admin-tools" class="admin-section">
      <h2>JSON Tools · 임시 작업 공간</h2>
      <p class="desc">
        <span class="ko">
          아래 영역은 JSON 텍스트를 붙여넣고 포맷을 정리하거나, 브라우저에서 간단히 diff / 포맷 체크를 할 수 있는 임시 공간입니다.
          실제 사이트에는 영향을 주지 않습니다.
        </span>
      </p>

      <div class="split">
        <div class="field-group">
          <h3>입력 (Raw JSON)</h3>
          <textarea id="jsonInput" placeholder="여기에 JSON 텍스트를 붙여넣으세요."></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" id="btnFormatJson">포맷 (Pretty Print)</button>
            <button type="button" id="btnMinifyJson" class="secondary">Minify</button>
          </div>
        </div>
        <div class="field-group">
          <h3>결과 (Formatted JSON)</h3>
          <textarea id="jsonOutput" placeholder="포맷 결과가 여기에 표시됩니다."></textarea>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div>등작 ∮27 · Admin Ω — 이 페이지는 로컬 브라우저 메모리에서만 동작하며, 서버 데이터를 직접 수정하지 않습니다.</div>
    <small>1) data/works.json · data/reports.json 로드 → 2) 편집 → 3) 각각 JSON 다운로드 → 4) GitHub에 업로드.</small>
  </footer>
</body>

<!-- ==========================================================
③ SCRIPTS  (Works / Reports / JSON 툴 + 파동 배경)
========================================================== -->
<script>
(function(){
  'use strict';

  /* -------------------------------------------
   * Helper
   * ---------------------------------------- */
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function safeJSONFetch(url){
    return fetch(url, { cache: 'no-store' }).then(res => {
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    });
  }

  function downloadJSON(filename, data){
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* -------------------------------------------
   * Admin Nav
   * ---------------------------------------- */
  function initAdminNav(){
    const buttons = $$('nav.admin-nav button');
    const sections = $$('.admin-section');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.adminTarget;
        if(!target) return;
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sections.forEach(sec => {
          sec.classList.toggle('active', sec.id === 'admin-' + target);
        });
      });
    });
  }

  /* -------------------------------------------
   * WORKS MANAGER
   * ---------------------------------------- */
  let worksData = [];   // 전체 배열
  function initWorksManager(){
    const tbody = $('#worksTableBody');
    const filterSelect = $('#worksSectionFilter');
    const btnAdd = $('#btnAddWork');
    const btnDel = $('#btnDeleteSelectedWork');
    const btnDownload = $('#btnDownloadWorks');

    function normalizeSection(key){
      const k = (key || '').toLowerCase();
      if (k === 'pray' || k === 'Ⅰ' || k === '1') return 'pray';
      if (k === 'human' || k === 'ii' || k === '2') return 'human';
      if (k === 'rebirth' || k === 'iii' || k === '3') return 'rebirth';
      if (k === 'exist' || k === 'iv' || k === '4') return 'exist';
      if (k === 'cosmos' || k === 'v' || k === '5') return 'cosmos';
      return 'pray';
    }

    function renderTable(){
      if (!tbody) return;
      const filter = filterSelect ? filterSelect.value : 'all';
      const rows = worksData.map((item, idx) => {
        const sec = normalizeSection(item.section || item.panel || item.section_id);
        if (filter !== 'all' && sec !== filter) {
          return '';
        }
        const esc = s => String(s ?? '').replace(/"/g, '&quot;');

        return `
          <tr data-index="${idx}">
            <td class="col-narrow">
              <input type="checkbox" class="row-select" />
            </td>
            <td class="col-medium">
              <select class="w-section">
                <option value="pray"${sec==='pray'?' selected':''}>pray</option>
                <option value="human"${sec==='human'?' selected':''}>human</option>
                <option value="rebirth"${sec==='rebirth'?' selected':''}>rebirth</option>
                <option value="exist"${sec==='exist'?' selected':''}>exist</option>
                <option value="cosmos"${sec==='cosmos'?' selected':''}>cosmos</option>
              </select>
            </td>
            <td><input type="text" class="w-id" value="${esc(item.id || '')}" /></td>
            <td><input type="text" class="w-title-kr" value="${esc(item.title_kr || '')}" /></td>
            <td><input type="text" class="w-title-en" value="${esc(item.title_en || '')}" /></td>
            <td><input type="text" class="w-mat-kr" value="${esc(item.material_kr || '')}" /></td>
            <td><input type="text" class="w-mat-en" value="${esc(item.material_en || '')}" /></td>
            <td><input type="text" class="w-size-kr" value="${esc(item.size_kr || '')}" /></td>
            <td><input type="text" class="w-size-en" value="${esc(item.size_en || '')}" /></td>
            <td class="col-medium"><input type="text" class="w-year" value="${esc(item.year || '')}" /></td>
            <td><input type="text" class="w-image" value="${esc(item.image || item.image_standard || '')}" /></td>
            <td><input type="text" class="w-zoom" value="${esc(item.zoom || item.image_zoom || '')}" /></td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = rows;
    }

    function syncRowToData(tr){
      const idx = Number(tr.dataset.index);
      if (Number.isNaN(idx) || !worksData[idx]) return;
      const item = worksData[idx];

      const section = $('.w-section', tr)?.value || '';
      const id      = $('.w-id', tr)?.value || '';
      const tkr     = $('.w-title-kr', tr)?.value || '';
      const ten     = $('.w-title-en', tr)?.value || '';
      const mkr     = $('.w-mat-kr', tr)?.value || '';
      let men       = $('.w-mat-en', tr)?.value || '';
      const skr     = $('.w-size-kr', tr)?.value || '';
      const sen     = $('.w-size-en', tr)?.value || '';
      const year    = $('.w-year', tr)?.value || '';
      const img     = $('.w-image', tr)?.value || '';
      const zoom    = $('.w-zoom', tr)?.value || '';

      // material_en은 소문자로 정리
      men = (men || '').toLowerCase();

      item.section     = section;
      item.id          = id;
      item.title_kr    = tkr;
      item.title_en    = ten;
      item.material_kr = mkr;
      item.material_en = men;
      item.size_kr     = skr;
      item.size_en     = sen;
      item.year        = year;
      item.image       = img;
      item.zoom        = zoom;
    }

    // 초기 로드
    safeJSONFetch('data/works.json')
      .then(json => {
        const arr = Array.isArray(json) ? json : (json.works || json.items || []);
        if (!Array.isArray(arr)) {
          console.warn('works.json: 배열이 아닙니다.');
          worksData = [];
        } else {
          worksData = arr.slice();
        }
        renderTable();
      })
      .catch(err => {
        console.error('works.json load error:', err);
        worksData = [];
        renderTable();
      });

    // 변경 감지
    if (tbody) {
      tbody.addEventListener('change', e => {
        const tr = e.target.closest('tr[data-index]');
        if (!tr) return;
        syncRowToData(tr);
      });

      // 클릭 시 선택 행 강조
      tbody.addEventListener('click', e => {
        const tr = e.target.closest('tr[data-index]');
        if (!tr) return;
        // 체크 박스 누른 경우는 따로, 전체 선택 토글
        if (e.target.classList.contains('row-select')) {
          tr.classList.toggle('selected', e.target.checked);
        }
      });
    }

    if (filterSelect) {
      filterSelect.addEventListener('change', () => {
        renderTable();
      });
    }

    if (btnAdd) {
      btnAdd.addEventListener('click', () => {
        const newItem = {
          id: '',
          section: 'pray',
          title_kr: '',
          title_en: '',
          material_kr: '',
          material_en: '',
          size_kr: '',
          size_en: '',
          year: '',
          image: '',
          zoom: ''
        };
        worksData.push(newItem);
        renderTable();
      });
    }

    if (btnDel) {
      btnDel.addEventListener('click', () => {
        const rows = $$('#worksTableBody tr');
        const toDelete = [];
        rows.forEach((tr, i) => {
          const cb = $('.row-select', tr);
          if (cb && cb.checked) {
            toDelete.push(Number(tr.dataset.index));
          }
        });
        if (!toDelete.length) return;
        const keep = worksData.filter((_, idx) => !toDelete.includes(idx));
        worksData = keep;
        renderTable();
      });
    }

    if (btnDownload) {
      btnDownload.addEventListener('click', () => {
        downloadJSON('works.json', worksData);
      });
    }
  }

  /* -------------------------------------------
   * REPORTS MANAGER
   * ---------------------------------------- */
  let reportsData = [];
  let currentReportIndex = -1;

  function initReportsManager(){
    const listRoot = $('#reportList');

    const btnAdd       = $('#btnAddReport');
    const btnDelete    = $('#btnDeleteReport');
    const btnDownload  = $('#btnDownloadReports');
    const btnSave      = $('#btnSaveReport');

    const f_id         = $('#r_id');
    const f_year       = $('#r_year');
    const f_category   = $('#r_category');
    const f_title_ko   = $('#r_title_ko');
    const f_title_en   = $('#r_title_en');
    const f_summary_ko = $('#r_summary_ko');
    const f_summary_en = $('#r_summary_en');
    const f_md_path    = $('#r_md_path');

    function renderReportList(){
      if (!listRoot) return;
      const html = reportsData.map((item, idx) => {
        const id   = item.id || '';
        const year = item.year || '';
        const tko  = item.title_ko || item.title_kr || '';
        const ten  = item.title_en || '';
        const cat  = (item.category || '').toLowerCase();
        const active = idx === currentReportIndex;
        return `
          <button type="button"
                  data-r-index="${idx}"
                  style="
                    width:100%;
                    text-align:left;
                    margin:2px 0;
                    padding:6px 8px;
                    border-radius:8px;
                    border:1px solid ${active ? 'rgba(215,184,106,.80)' : 'rgba(255,255,255,.16)'};
                    background:${active ? 'rgba(215,184,106,.16)' : 'rgba(0,0,0,.45)'};
                    color:rgba(237,227,201,.92);
                    font-size:11.5px;
                    cursor:pointer;
                    text-shadow:0 1px 0 rgba(0,0,0,.65);
                  ">
            <div><strong>${id}</strong> · ${year} · ${cat}</div>
            <div style="margin-top:1px;">${tko}</div>
            <div style="opacity:.75;font-size:11px;">${ten}</div>
          </button>
        `;
      }).join('');
      listRoot.innerHTML = html || '<div style="font-size:11.5px;color:rgba(237,227,201,.72);">아직 보고서 항목이 없습니다.</div>';
    }

    function loadReportToForm(idx){
      currentReportIndex = idx;
      const item = reportsData[idx];
      if (!item) {
        f_id.value = '';
        f_year.value = '';
        f_category.value = '';
        f_title_ko.value = '';
        f_title_en.value = '';
        f_summary_ko.value = '';
        f_summary_en.value = '';
        f_md_path.value = '';
        renderReportList();
        return;
      }
      f_id.value         = item.id || '';
      f_year.value       = item.year || '';
      f_category.value   = item.category || '';
      f_title_ko.value   = item.title_ko || item.title_kr || '';
      f_title_en.value   = item.title_en || '';
      f_summary_ko.value = item.summary_ko || item.summary_kr || '';
      f_summary_en.value = item.summary_en || '';
      f_md_path.value    = item.md_path || item.url || item.link || '';
      renderReportList();
    }

    function saveFormToCurrent(){
      if (currentReportIndex < 0 || !reportsData[currentReportIndex]) return;
      const item = reportsData[currentReportIndex];
      item.id         = f_id.value.trim();
      item.year       = f_year.value.trim();
      item.category   = f_category.value.trim() || 'theory';
      item.title_ko   = f_title_ko.value.trim();
      item.title_en   = f_title_en.value.trim();
      item.summary_ko = f_summary_ko.value;
      item.summary_en = f_summary_en.value;
      item.md_path    = f_md_path.value.trim();
      renderReportList();
    }

    // 초기 로드
    safeJSONFetch('data/reports.json')
      .then(json => {
        const arr = Array.isArray(json) ? json : (json.reports || json.items || []);
        if (!Array.isArray(arr)) {
          console.warn('reports.json: 배열이 아닙니다.');
          reportsData = [];
        } else {
          reportsData = arr.slice();
        }
        if (reportsData.length > 0) {
          currentReportIndex = 0;
        }
        renderReportList();
        if (currentReportIndex >= 0) {
          loadReportToForm(currentReportIndex);
        }
      })
      .catch(err => {
        console.error('reports.json load error:', err);
        reportsData = [];
        renderReportList();
      });

    // 리스트 클릭
    if (listRoot) {
      listRoot.addEventListener('click', e => {
        const btn = e.target.closest('button[data-r-index]');
        if (!btn) return;
        const idx = Number(btn.dataset.rIndex);
        if (Number.isNaN(idx)) return;
        // 현재 내용 먼저 저장
        saveFormToCurrent();
        loadReportToForm(idx);
      });
    }

    if (btnAdd) {
      btnAdd.addEventListener('click', () => {
        const nextIdx = reportsData.length;
        const newItem = {
          id: 'DCAR-XX-2025',
          year: '2025',
          category: 'theory',
          title_ko: '',
          title_en: '',
          summary_ko: '',
          summary_en: '',
          md_path: ''
        };
        reportsData.push(newItem);
        currentReportIndex = nextIdx;
        renderReportList();
        loadReportToForm(currentReportIndex);
      });
    }

    if (btnDelete) {
      btnDelete.addEventListener('click', () => {
        if (currentReportIndex < 0) return;
        reportsData.splice(currentReportIndex, 1);
        if (reportsData.length === 0) {
          currentReportIndex = -1;
        } else if (currentReportIndex >= reportsData.length) {
          currentReportIndex = reportsData.length - 1;
        }
        renderReportList();
        if (currentReportIndex >= 0) {
          loadReportToForm(currentReportIndex);
        } else {
          loadReportToForm(-1);
        }
      });
    }

    if (btnSave) {
      btnSave.addEventListener('click', () => {
        saveFormToCurrent();
      });
    }

    if (btnDownload) {
      btnDownload.addEventListener('click', () => {
        // reports 키를 유지할지 여부는 현재 파일 구조에 따라 선택.
        // 여기서는 단순 배열로 내보낸다 → 필요하면 GitHub에서 { "reports": [...] }로 감쌀 수 있음.
        downloadJSON('reports.json', reportsData);
      });
    }
  }

  /* -------------------------------------------
   * JSON TOOLS
   * ---------------------------------------- */
  function initJsonTools(){
    const input  = $('#jsonInput');
    const output = $('#jsonOutput');
    const btnFmt = $('#btnFormatJson');
    const btnMin = $('#btnMinifyJson');

    if (btnFmt) {
      btnFmt.addEventListener('click', () => {
        if (!input) return;
        const text = input.value.trim();
        if (!text) {
          output.value = '';
          return;
        }
        try {
          const obj = JSON.parse(text);
          output.value = JSON.stringify(obj, null, 2);
        } catch (e) {
          output.value = '// JSON parse error: ' + e.message;
        }
      });
    }

    if (btnMin) {
      btnMin.addEventListener('click', () => {
        if (!input) return;
        const text = input.value.trim();
        if (!text) {
          output.value = '';
          return;
        }
        try {
          const obj = JSON.parse(text);
          output.value = JSON.stringify(obj);
        } catch (e) {
          output.value = '// JSON parse error: ' + e.message;
        }
      });
    }
  }

  /* -------------------------------------------
   * Waves 배경 (index 경량 버전과 동일 계열)
   * ---------------------------------------- */
  function initWaves(){
    const canvas = document.getElementById('waves');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const prefersReduced = window.matchMedia &&
      window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function resize(){
      const dpr = window.devicePixelRatio || 1;
      canvas.width  = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resize();
    window.addEventListener('resize', resize);

    let t = 0;
    let animId = null;

    const gradients = [
      { color: 'rgba(215,184,106,0.18)', amp: 22, freq: 0.0015, speed: 0.014 },
      { color: 'rgba(121,167,255,0.16)', amp: 34, freq: 0.0011, speed: -0.010 }
    ];

    function draw(){
      if (prefersReduced) return;
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.width / dpr;
      const h = canvas.height / dpr;

      ctx.clearRect(0,0,w,h);

      gradients.forEach((g, idx) => {
        ctx.beginPath();
        for (let x = 0; x <= w; x += 10) {
          const y = h*0.25 + idx*90 +
            Math.sin(x*g.freq + t*g.speed + idx) * g.amp;
          if (x === 0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.strokeStyle = g.color;
        ctx.lineWidth = 1.2;
        ctx.shadowColor = 'rgba(0,0,0,0.45)';
        ctx.shadowBlur = 6;
        ctx.stroke();
      });

      ctx.shadowBlur = 0;
      t += 1;
      animId = requestAnimationFrame(draw);
    }

    if (!prefersReduced) {
      animId = requestAnimationFrame(draw);
    }

    document.addEventListener('visibilitychange', () => {
      if (prefersReduced) return;
      if (document.hidden) {
        if (animId) {
          cancelAnimationFrame(animId);
          animId = null;
        }
      } else if (!animId) {
        animId = requestAnimationFrame(draw);
      }
    });
  }

  /* -------------------------------------------
   * INIT
   * ---------------------------------------- */
  document.addEventListener('DOMContentLoaded', () => {
    try { initAdminNav(); }      catch(e){ console.error(e); }
    try { initWorksManager(); }  catch(e){ console.error(e); }
    try { initReportsManager(); }catch(e){ console.error(e); }
    try { initJsonTools(); }     catch(e){ console.error(e); }
    try { initWaves(); }         catch(e){ console.error(e); }
  });

})();
</script>
</html>