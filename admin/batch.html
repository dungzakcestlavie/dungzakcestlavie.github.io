<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Lightflow Batch Ω.14 — Multi Uploader</title>
<meta name="theme-color" content="#070c1a">
<style>
:root{--bg:#070c1a;--panel:#0b1020;--soft:#0f1730;--fg:#e8edf7;--muted:#9fb0cc;--border:#1e2744;--ok:#72e0a7;--bad:#ff6b6b;--accent:#d4b97a}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Pretendard,system-ui,sans-serif}
header{position:sticky;top:0;z-index:9999;background:linear-gradient(180deg,#091227,transparent);border-bottom:1px solid var(--border);padding:14px 12px;font-weight:800;color:var(--accent)}
.container{max-width:980px;margin:0 auto;padding:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0}
h2{margin:0 0 10px;color:var(--accent);font-size:18px}
input,select,textarea,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--soft);color:var(--fg);font-size:15px}
button{font-weight:800}
.btn{background:var(--accent);color:#000;border:none}
.btn-ok{background:var(--ok);color:#012d1a;border:none}
.btn-bad{background:var(--bad);color:#000;border:none}
.grid2{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:900px){.grid2{grid-template-columns:1fr 1fr}}
.drop{border:2px dashed var(--border);border-radius:12px;padding:14px;text-align:center;background:#0a142a}
.drop.drag{background:#12204a;border-color:#85a2ff}
.thumb{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
.box{border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#0b152f}
.box .img{height:100px;background:#0a1329 center/cover no-repeat}
.box .cap{padding:6px 8px;font-size:12px;color:#cfe0ff}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1223;border:1px solid var(--border);border-radius:12px;color:var(--fg);padding:10px 14px;opacity:0;transition:opacity .2s;z-index:10000}
.toast.show{opacity:1}
/* tap fix */
header,.container,.card{pointer-events:auto}
button{pointer-events:auto;touch-action:manipulation}
</style>
</head>
<body>
<header>📦 Lightflow Batch Ω.14 — Multi Uploader</header>
<div class="container">

  <!-- 0. 연결 -->
  <div class="card">
    <h2>0. GitHub 연결</h2>
    <div class="grid2">
      <div>
        <input id="owner" placeholder="Owner">
        <input id="repo"  placeholder="Repo">
        <input id="branch" value="main" placeholder="Branch">
        <input id="token" type="password" placeholder="Token (repo)">
      </div>
      <div>
        <button type="button" class="btn" onclick="saveCfg()">저장</button>
        <button type="button" onclick="location.href='admin.html'">Admin 이동</button>
        <button type="button" class="btn-bad" onclick="resetLocal()">localStorage 초기화</button>
        <div id="status" class="small" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <!-- 1. 작품 이미지 배치 업로드 -->
  <div class="card">
    <h2>1. 작품 이미지 — 배치 업로드 + artworks.json 자동 추가</h2>
    <div class="grid2">
      <div>
        <select id="sec">
          <option value="light">Ⅰ Light & Memory</option>
          <option value="human">Ⅱ Human Being</option>
          <option value="rebirth">Ⅲ Rebirth of Mind</option>
          <option value="restore">Ⅳ Restoration of Being</option>
          <option value="meta">Ⅴ Metaconsciousness</option>
        </select>
        <input id="prefix" placeholder="ID 접두사 (예: light)">
        <input id="start" type="number" value="1" min="1" placeholder="시작 번호">
        <input id="year" placeholder="일괄 Year (선택)">
        <input id="medium" placeholder="일괄 Medium (선택)">
        <input id="size" placeholder="일괄 Size (선택)">
        <div id="drop" class="drop">여기에 다중 이미지 드롭 또는 탭하여 선택</div>
        <input id="files" type="file" accept="image/*" multiple style="display:none">
        <button type="button" class="btn-ok" onclick="runBatch()">업로드 시작</button>
      </div>
      <div>
        <div id="thumbs" class="thumb"></div>
        <div id="progress" class="small" style="margin-top:6px"></div>
      </div>
    </div>
    <div class="small" style="margin-top:6px">파일명에서 제목을 자동 추출(확장자 제외). 예) <code>Pray_for_us.jpg → Title: Pray for us</code></div>
  </div>

  <!-- 2. DCAR 붙여넣기 일괄 저장 -->
  <div class="card">
    <h2>2. 미학 보고서 — 붙여넣기 일괄 저장</h2>
    <div class="grid2">
      <div>
        <textarea id="bulk" placeholder="형식:
=== dcar02 ===
영문제목
영문 본문...

[빈 줄]

한글제목
한글 본문...

=== dcar05 ===
... 위와 동일 형식 반복"></textarea>
        <button type="button" class="btn" onclick="runBulkReports()">보고서 저장</button>
      </div>
      <div>
        <div id="log" class="small" style="white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

</div>
<div id="toast" class="toast"></div>

<script>
/* ------- helpers / cfg ------- */
const $=s=>document.querySelector(s);
const say=(m,e=false)=>{const t=$("#toast");t.textContent=m;t.style.borderColor=e?'#ff6b6b':'#22304f';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);};
const cfg=k=>localStorage.getItem(k)||""; const setcfg=(k,v)=>localStorage.setItem(k,v);
["owner","repo","branch","token"].forEach(id=>{if(cfg(id))$("#"+id).value=cfg(id);});
function saveCfg(){["owner","repo","branch","token"].forEach(id=>setcfg(id,$("#"+id).value.trim())); loadStatus(); say("저장됨");}
function resetLocal(){localStorage.clear();location.reload()}
function loadStatus(){ $("#status").textContent=`Owner ${cfg("owner")} · Repo ${cfg("repo")} · Branch ${cfg("branch")}`;}
loadStatus();

function b64(s){return btoa(unescape(encodeURIComponent(s)))}
function fileToB64(f){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result.split(',')[1]);fr.onerror=rej;fr.readAsDataURL(f);});}

async function gh(m,p,b=null,isJson=true){
  const tk=cfg("token"); if(!tk) throw new Error("토큰 없음");
  const r=await fetch(`https://api.github.com/${p}`,{method:m,headers:{Accept:"application/vnd.github+json","Authorization":`token ${tk}`},body:b?(isJson?JSON.stringify(b):b):null});
  if(!r.ok) throw new Error(`GitHub ${r.status}: ${(await r.text()).slice(0,200)}`);
  return r.json();
}
async function getContent(path){
  try{const j=await gh("GET",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(path)}?ref=${cfg("branch")}`);return{exists:true,sha:j.sha,content:j.content?atob(j.content.replace(/\n/g,"")):null}}catch(e){return{exists:false,sha:null,content:null}}
}
async function putFile(path,b64content,msg){
  const old=await getContent(path);
  const body={message:msg||`update ${path}`,content:b64content,branch:cfg("branch")};
  if(old.exists) body.sha=old.sha;
  return gh("PUT",`repos/${cfg("owner")}/${cfg("repo")}/contents/${encodeURIComponent(path)}`,body);
}

/* ------- batch images ------- */
let picked=[];
const drop=$("#drop"), files=$("#files"), thumbs=$("#thumbs"), progress=$("#progress");
drop.onclick=()=>files.click();
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag');}));
drop.addEventListener('drop',e=>{if(e.dataTransfer?.files){files.files=e.dataTransfer.files;preview()}});
files.addEventListener('change',preview);

function preview(){
  picked=[...files.files];
  thumbs.innerHTML="";
  picked.forEach(f=>{
    const d=document.createElement('div');d.className='box';
    const u=URL.createObjectURL(f);
    d.innerHTML=`<div class="img" style="background-image:url('${u}')"></div><div class="cap">${f.name}</div>`;
    thumbs.appendChild(d);
  });
  progress.textContent=`선택 ${picked.length} 개`;
}
function titleFromName(name){
  return name.replace(/\.[^.]+$/,'').replace(/[_\-]+/g,' ').trim();
}

async function loadArtworks(){
  const r=await getContent("data/artworks.json");
  return r.exists?JSON.parse(r.content):{light:[],human:[],rebirth:[],restore:[],meta:[]};
}
async function saveArtworksJson(data){
  await putFile("data/artworks.json", b64(JSON.stringify(data,null,2)), "update artworks.json");
}

async function runBatch(){
  try{
    if(picked.length===0) return say("이미지 선택",true);
    const sec=$("#sec").value, prefix=$("#prefix").value.trim()||sec;
    const start=parseInt($("#start").value||"1",10);
    const year=$("#year").value, medium=$("#medium").value, size=$("#size").value;

    let art=await loadArtworks(); art[sec] ||= [];
    let n=start;
    for(const f of picked){
      const id=`${prefix}-${String(n).padStart(2,'0')}`;
      const ext=(f.name.match(/\.\w+$/)||[".jpg"])[0];
      const name=id+ext;
      const path=`img/${sec}/${name}`;
      await putFile(path, await fileToB64(f), `upload ${path}`);
      const e={id,title:titleFromName(f.name),year,medium,size,image:`/${path}`};
      const idx=(art[sec]||[]).findIndex(x=>x.id===id);
      if(idx>=0) art[sec][idx]=e; else art[sec].push(e);
      progress.textContent=`업로드 중 ${n-start+1}/${picked.length} — ${name}`;
      n++;
    }
    await saveArtworksJson(art);
    progress.textContent=`완료: ${picked.length} 개 업로드/등록`;
    say("배치 업로드 완료");
  }catch(e){say("배치 실패: "+e.message,true)}
}

/* ------- batch DCAR ------- */
function splitENKR(txt){
  const blocks=txt.trim().split(/\n\s*\n/); let pivot=0;
  for(let i=0;i<blocks.length;i++){ if(/[가-힣]/.test(blocks[i])){pivot=i;break;} }
  const en=blocks.slice(0,Math.max(1,pivot)).join("\n\n").trim();
  const kr=blocks.slice(Math.max(1,pivot)).join("\n\n").trim();
  const titleEN=(en.split("\n")[0]||"").trim();
  const titleKO=(kr.split("\n")[0]||"").trim();
  return {en,kr,titleEN,titleKO};
}
async function runBulkReports(){
  try{
    const raw=$("#bulk").value; if(!raw.trim()) return say("내용 없음",true);
    const parts=raw.split(/^===\s*(dcar\d{2})\s*===/gmi).map(s=>s.trim()).filter(Boolean);
    // parts = [id, content, id, content, ...]
    const cur=await getContent("data/reports.json"); const repo=cur.exists?JSON.parse(cur.content):{};
    let done=0;
    for(let i=0;i<parts.length;i+=2){
      const id=parts[i].toLowerCase(); const body=parts[i+1]||"";
      const {titleEN,titleKO}=splitENKR(body);
      await putFile(`reports/${id.toUpperCase()}.md`, b64(body), `save ${id}.md`);
      repo[id]={id,titleEN,titleKO,updated:new Date().toISOString(),size:body.length};
      $("#log").textContent+=`• ${id} 저장\n`;
      done++;
    }
    await putFile("data/reports.json", b64(JSON.stringify(repo,null,2)), "update reports.json");
    say(`보고서 ${done}건 저장 완료`);
  }catch(e){say("보고서 배치 실패: "+e.message,true)}
}

/* iOS touch→click bridge */
(function(){const isiOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);if(!isiOS)return;function bind(el){if(el.__tap)return;el.__tap=1;let sx=0,sy=0;el.addEventListener("touchstart",e=>{const t=e.changedTouches[0];sx=t.clientX;sy=t.clientY;},{passive:true});el.addEventListener("touchend",e=>{const t=e.changedTouches[0];if(Math.abs(t.clientX-sx)<10&&Math.abs(t.clientY-sy)<10){e.preventDefault();el.dispatchEvent(new MouseEvent("click",{bubbles:true,cancelable:true}))}},{passive:false})}function scan(){document.querySelectorAll("button,[onclick],.drop").forEach(bind)}window.addEventListener("load",scan);new MutationObserver(scan).observe(document.body,{subtree:true,childList:true});})();
</script>
</body>
</html>